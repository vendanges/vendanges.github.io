<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta name="theme-color" content="#33474d">
	<title>Laravel Redis&amp;Command | 琼瑶</title>
	<link rel="stylesheet" href="/css/style.css" />
	
      <link rel="alternate" href="/atom.xml" title="琼瑶" type="application/atom+xml">
    
<meta name="generator" content="Hexo 6.1.0"></head>

<body>

	<header class="header">
		<nav class="header__nav">
			
				<a href="/" class="header__link" style="color: #fff">Home</a>
			
				<a href="/archives" class="header__link" style="color: #fff">Archive</a>
			
				<a href="/about" class="header__link" style="color: #fff">About</a>
			
		</nav>
		<!-- <h1 class="header__title"><a href="/">琼瑶</a></h1> -->
		<h1 class="header__title"><a href="/"><img style="width: 290px;" src="https://49812933408852955071488026628034-1301075051.cos.ap-nanjing.myqcloud.com/202204152017786.png"></a></h1>
		<h2 class="header__subtitle">梦入琼楼寒有月，行过石树冻无烟</h2>
	</header>

	<main>
		<article>
	
		<h1>Laravel Redis&amp;Command</h1>
	
	<div class="article__infos">
		<span class="article__date">2022-04-21</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-none-link" href="/tags/laravel/" rel="tag">laravel</a> <a class="article__tag-none-link" href="/tags/php/" rel="tag">php</a>
			</span>
		
	</div>

	

	
		<p>Laravel 可以通过 Command 以及相关方法来讲 Redis 进行存储并映射到 MySQL 数据库中，通过 <code>composer require predis/predis</code> 命令来安装 Laravel Redis 的扩展，前提是在 PHP 具有 redis 扩展。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">查看是否具有 Redis 的扩展我们可以通过 ```php -m``` 的命令来进行查看，如果没有我们可以通过集成环境或者直接到 pecl 所提供的 PHP 扩展下载站 [PECL](https://pecl.php.net/package/redis)中来进行下载，可以通过 ```php --verion``` 来查看当前的 PHP 类型和当前环境信息等。</span><br></pre></td></tr></table></figure>

<p>按照官方文档的示例，在安装完 Redis 扩展后，我们可以在 <code>.env</code> 文件中修改 <code>REDIS_PASSWORD</code> 等配置，此外，也可以建立多个 Redis 链接，但前提是在 <code>config/database.php</code> 中进行一定的配置。</p>
<p><img src="https://49812933408852955071488026628034-1301075051.cos.ap-nanjing.myqcloud.com/20220309210324.png"></p>
<p>我们也可以在 <code>config/database.php</code> 中配置 Redis 的相关的账号信息，比如账号密码和 Key 名等，都可以在 <code>redis</code>  中进行配置：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;redis&#x27;</span> =&gt; [  </span><br><span class="line">  </span><br><span class="line">    <span class="string">&#x27;client&#x27;</span> =&gt; <span class="title function_ invoke__">env</span>(<span class="string">&#x27;REDIS_CLIENT&#x27;</span>, <span class="string">&#x27;phpredis&#x27;</span>),  </span><br><span class="line">  </span><br><span class="line">    <span class="string">&#x27;options&#x27;</span> =&gt; [  </span><br><span class="line">        <span class="string">&#x27;cluster&#x27;</span> =&gt; <span class="title function_ invoke__">env</span>(<span class="string">&#x27;REDIS_CLUSTER&#x27;</span>, <span class="string">&#x27;redis&#x27;</span>),  </span><br><span class="line">        <span class="string">&#x27;prefix&#x27;</span> =&gt; <span class="title function_ invoke__">env</span>(<span class="string">&#x27;REDIS_PREFIX&#x27;</span>, <span class="title class_">Str</span>::<span class="title function_ invoke__">slug</span>(<span class="title function_ invoke__">env</span>(<span class="string">&#x27;APP_NAME&#x27;</span>, <span class="string">&#x27;laravel&#x27;</span>), <span class="string">&#x27;_&#x27;</span>).<span class="string">&#x27;_database_&#x27;</span>),  </span><br><span class="line">    ],  </span><br><span class="line">  </span><br><span class="line">    <span class="string">&#x27;default&#x27;</span> =&gt; [  </span><br><span class="line">        <span class="string">&#x27;url&#x27;</span> =&gt; <span class="title function_ invoke__">env</span>(<span class="string">&#x27;REDIS_URL&#x27;</span>),  </span><br><span class="line">        <span class="string">&#x27;host&#x27;</span> =&gt; <span class="title function_ invoke__">env</span>(<span class="string">&#x27;REDIS_HOST&#x27;</span>, <span class="string">&#x27;127.0.0.1&#x27;</span>),  </span><br><span class="line">        <span class="string">&#x27;password&#x27;</span> =&gt; <span class="title function_ invoke__">env</span>(<span class="string">&#x27;REDIS_PASSWORD&#x27;</span>, <span class="string">&#x27;redis&#x27;</span>),  </span><br><span class="line">        <span class="string">&#x27;port&#x27;</span> =&gt; <span class="title function_ invoke__">env</span>(<span class="string">&#x27;REDIS_PORT&#x27;</span>, <span class="string">&#x27;6379&#x27;</span>),  </span><br><span class="line">        <span class="string">&#x27;database&#x27;</span> =&gt; <span class="title function_ invoke__">env</span>(<span class="string">&#x27;REDIS_DB&#x27;</span>, <span class="string">&#x27;14&#x27;</span>),  </span><br><span class="line">    ],  </span><br><span class="line">  </span><br><span class="line">    <span class="string">&#x27;cache&#x27;</span> =&gt; [  </span><br><span class="line">        <span class="string">&#x27;url&#x27;</span> =&gt; <span class="title function_ invoke__">env</span>(<span class="string">&#x27;REDIS_URL&#x27;</span>),  </span><br><span class="line">        <span class="string">&#x27;host&#x27;</span> =&gt; <span class="title function_ invoke__">env</span>(<span class="string">&#x27;REDIS_HOST&#x27;</span>, <span class="string">&#x27;127.0.0.1&#x27;</span>),  </span><br><span class="line">        <span class="string">&#x27;password&#x27;</span> =&gt; <span class="title function_ invoke__">env</span>(<span class="string">&#x27;REDIS_PASSWORD&#x27;</span>, <span class="literal">null</span>),  </span><br><span class="line">        <span class="string">&#x27;port&#x27;</span> =&gt; <span class="title function_ invoke__">env</span>(<span class="string">&#x27;REDIS_PORT&#x27;</span>, <span class="string">&#x27;6379&#x27;</span>),  </span><br><span class="line">        <span class="string">&#x27;database&#x27;</span> =&gt; <span class="title function_ invoke__">env</span>(<span class="string">&#x27;REDIS_CACHE_DB&#x27;</span>, <span class="string">&#x27;15&#x27;</span>),  </span><br><span class="line">    ],  </span><br><span class="line">],</span><br></pre></td></tr></table></figure>

<p>之后，我们也可以在 <code>app/Http/Controllers/</code> 中定义一个名为 <code>RedisController.php</code> 的控制器，引入 <code>Illuminate\Support\Facades\Redis</code> 扩展并作为 <code>App\Http\Controllers\Controller</code> 的延伸，定义两个基础的 Redis 存储方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>\<span class="title class_">Http</span>\<span class="title class_">Controllers</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Facades</span>\<span class="title">Redis</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RedisController</span>  </span></span><br><span class="line"><span class="class"></span>&#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">set</span>(<span class="params"></span>) </span>&#123;  </span><br><span class="line">        <span class="title class_">Redis</span>::<span class="title function_ invoke__">set</span>(<span class="string">&#x27;key&#x27;</span>,<span class="string">&#x27;hello,redis!&#x27;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params"></span>) </span>&#123;  </span><br><span class="line">        <span class="variable">$name</span> = <span class="title class_">Redis</span>::<span class="title function_ invoke__">get</span>(<span class="string">&#x27;key&#x27;</span>);  </span><br><span class="line">        <span class="title function_ invoke__">var_dump</span>(<span class="variable">$name</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>之后，为了使得方法的正常执行，我们还需要通过路由来定义，在 <code>routes/web.php</code> 中写入：</p>
<p> <img src="https://49812933408852955071488026628034-1301075051.cos.ap-nanjing.myqcloud.com/20220309210258.png"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">get</span>(<span class="string">&#x27;/get&#x27;</span>, <span class="string">&#x27;RedisController@get&#x27;</span>);  </span><br><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">get</span>(<span class="string">&#x27;/set&#x27;</span>, <span class="string">&#x27;RedisController@set&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>最后，我们就可以通过 <a target="_blank" rel="noopener" href="http://127.0.0.1:8000/set">http://127.0.0.1:8000/set</a> 和 <a target="_blank" rel="noopener" href="http://127.0.0.1:8000/get">http://127.0.0.1:8000/get</a> 来进行对 Redis 的 Set 和 Get 的操作。</p>
<p>同样的 Laravel Predis 支持了 Redis 的命令，我们可以通过阅读 <a target="_blank" rel="noopener" href="https://www.redis.com.cn/redis-commands.html">Redis 官方文档</a> 或 <a target="_blank" rel="noopener" href="https://www.redis.com.cn/commands.html">Redis 速查表</a> 来配合 Laravel 来进行实现对 Redis 的操作。</p>
<p><img src="https://49812933408852955071488026628034-1301075051.cos.ap-nanjing.myqcloud.com/20220309212434.png"></p>
<p>对于 <code>hMset</code> 类型的插入，我们可以通过使用 <code>Redis:hMset</code> 的方式来进行插入，如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>\<span class="title class_">Http</span>\<span class="title class_">Controllers</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Facades</span>\<span class="title">Redis</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RedisController</span>  </span></span><br><span class="line"><span class="class"></span>&#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">set</span>(<span class="params"></span>) </span>&#123;  </span><br><span class="line">        <span class="variable">$key</span> = <span class="string">&#x27;HSET&#x27;</span>;  </span><br><span class="line">        <span class="variable">$value</span>= [  </span><br><span class="line">            <span class="string">&#x27;id&#x27;</span> =&gt;  <span class="string">&#x27;1&#x27;</span>,  </span><br><span class="line">            <span class="string">&#x27;name&#x27;</span> =&gt;  <span class="string">&#x27;test&#x27;</span>,  </span><br><span class="line">            <span class="string">&#x27;mess&#x27;</span> =&gt;  <span class="string">&#x27;This is test&#x27;</span>  </span><br><span class="line"> ];  </span><br><span class="line">        <span class="title class_">Redis</span>::<span class="title function_ invoke__">hMset</span>(<span class="variable">$key</span>,<span class="variable">$value</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Command-amp-Job"><a href="#Command-amp-Job" class="headerlink" title="Command &amp; Job"></a>Command &amp; Job</h2><p>Redis 通常是一个缓存服务，主要用于作为中间层进行，我们可以通过使用 Reids 配合 Laravel 作为队列，通过 Laravel 队列所支持的 Command 来将 Redis 信息提取后映射到 MySQL 或其他数据库中。</p>
<p>在本文中，我们主要理解 Laravel 队列以及 Job(工作线程) 和 Command 的使用，同样的我们也可以通过 Controller 来进行调用 Job。</p>
<p>我们可以使用 Laravel artisan 命令来创建一个工作线程，并命名为 <code>RedisJobTest</code> ：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php artisan make:job RedisJobTest</span><br></pre></td></tr></table></figure>

<p>创建完后他会在 <code>app/Jobs/</code> 目录下生成一个 <code>RedisJobTest.php</code> 的 PHP 类，我们需要在里面进行编辑：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>\<span class="title class_">Jobs</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Bus</span>\<span class="title">Queueable</span>;  </span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Queue</span>\<span class="title">ShouldQueue</span>;  </span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Bus</span>\<span class="title">Dispatchable</span>;  </span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Queue</span>\<span class="title">InteractsWithQueue</span>;  </span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Queue</span>\<span class="title">SerializesModels</span>;  </span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Facades</span>\<span class="title">Redis</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RedisJobTest</span> <span class="keyword">implements</span> <span class="title">ShouldQueue</span>  </span></span><br><span class="line"><span class="class"></span>&#123;  </span><br><span class="line">    <span class="keyword">use</span> <span class="title">Dispatchable</span>, <span class="title">InteractsWithQueue</span>, <span class="title">Queueable</span>, <span class="title">SerializesModels</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$key</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * Create a new job instance. * * <span class="doctag">@return</span> void  </span></span><br><span class="line"><span class="comment"> */</span> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$key</span></span>)  </span></span><br><span class="line"><span class="function">    </span>&#123;  </span><br><span class="line">        <span class="comment">// key  </span></span><br><span class="line"> <span class="variable language_">$this</span>-&gt;key = <span class="variable">$key</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * Execute the job. * * <span class="doctag">@return</span> void  </span></span><br><span class="line"><span class="comment"> */</span> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params"></span>)  </span></span><br><span class="line"><span class="function">    </span>&#123;  </span><br><span class="line">        <span class="variable">$llen</span>      = <span class="title class_">Redis</span>::<span class="title function_ invoke__">connection</span>()-&gt;<span class="title function_ invoke__">LLEN</span>(<span class="variable">$this</span>-&gt;key);  </span><br><span class="line">        <span class="variable">$lineToint</span> = (<span class="keyword">int</span>)<span class="variable">$llen</span>;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">dump</span>(<span class="variable">$lineToint</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>之后我们还需要创建一个命令，用于调用该队列，同样的我们也使用 Artisan 命令来进行创建：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php artisan make:command RedisJobCommand</span><br></pre></td></tr></table></figure>

<p>然后在 <code>app/Console/Commands/RedisJobCommand.php</code> 下，来调用我们的工作线程：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>\<span class="title class_">Console</span>\<span class="title class_">Commands</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Jobs</span>\<span class="title">RedisJobTest</span>;  </span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Console</span>\<span class="title">Command</span>;  </span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Facades</span>\<span class="title">Log</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RedisJobCommand</span> <span class="keyword">extends</span> <span class="title">Command</span>  </span></span><br><span class="line"><span class="class"></span>&#123;  </span><br><span class="line">    <span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * The name and signature of the console command. * * <span class="doctag">@var</span> string  </span></span><br><span class="line"><span class="comment"> */</span> <span class="keyword">protected</span> <span class="variable">$signature</span> = <span class="string">&#x27;command:redis_job_test&#x27;</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * The console command description. * * <span class="doctag">@var</span> string  </span></span><br><span class="line"><span class="comment"> */</span> <span class="keyword">protected</span> <span class="variable">$description</span> = <span class="string">&#x27;Command description&#x27;</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * Create a new command instance. * * <span class="doctag">@return</span> void  </span></span><br><span class="line"><span class="comment"> */</span> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)  </span></span><br><span class="line"><span class="function">    </span>&#123;  </span><br><span class="line">        <span class="built_in">parent</span>::<span class="title function_ invoke__">__construct</span>();  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * Execute the console command. * * <span class="doctag">@return</span> mixed  </span></span><br><span class="line"><span class="comment"> */</span> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params"></span>)  </span></span><br><span class="line"><span class="function">    </span>&#123;  </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;Redis run start&#x27;</span>;  </span><br><span class="line">  </span><br><span class="line">        <span class="title class_">RedisJobTest</span>::<span class="title function_ invoke__">dispatch</span>(<span class="string">&#x27;SET&#x27;</span>)  </span><br><span class="line">            -&gt;<span class="title function_ invoke__">delay</span>(<span class="title function_ invoke__">now</span>()-&gt;<span class="title function_ invoke__">addMinutes</span>(<span class="number">1</span>));  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;Redis run end&#x27;</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在上述的 Code 中，我们主要通过 <code>$signature</code> 类型来定义一个命令，同样的我们也可以在 <code>$description</code> 添加该命令的方法和描述，最后在 <code>handle</code> 方法中写入 <code>RedisJobTest::dispatch</code> 来调用 RedisJobTest 工作线程。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">通过上述的流程演示，我们可以通过工作线程来实现 Redis 锁，在 Laravel Job 中的 ```handle()``` 方法下，添加 Redis 锁即可：</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Redis</span>::<span class="title function_ invoke__">throttle</span>(<span class="string">&#x27;key&#x27;</span>)-&gt;<span class="title function_ invoke__">allow</span>(<span class="number">10</span>)-&gt;<span class="title function_ invoke__">every</span>(<span class="number">60</span>)-&gt;<span class="title function_ invoke__">then</span>(function () &#123;</span><br><span class="line">    <span class="comment">// 任务逻辑...</span></span><br><span class="line">&#125;, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 无法获得锁...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">release</span>(<span class="number">10</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>上述 code 中，主要 Redis 中的频率限制，也就是限制指定类型每 60 秒只执行10次，如果没有锁，那么一般情况下将会导致任务被放回队列使其被重试。</p>
<p>在大量的数据涌入的情况下可能会导致数据库的崩溃从而出现错误，因此我们需要使用到 Redis 锁，这些在 Laravel 中主要被称之为频率限制，我们可以翻阅官方文档来检索我们需要的 <a target="_blank" rel="noopener" href="https://learnku.com/docs/laravel/6.x/queues/5168#6b57e8">队列 | 综合话题 |《Laravel 6 中文文档 6.x》| Laravel China 社区 (learnku.com)</a>。</p>
<p>在官方文档中，我们也可以在调用队列的时候对其进行延迟分发，这主要通过 <code>delay</code> 方法来进行实现，详细的可以查阅官方文档的描述 <a target="_blank" rel="noopener" href="https://learnku.com/docs/laravel/6.x/queues/5168#2d054a">队列 | 综合话题 |《Laravel 6 中文文档 6.x》| Laravel China 社区 (learnku.com)</a>。</p>

	

	
		<span class="different-posts"><a href="/2022/04/21/php/laravel/23.Laravel%20Redis&Command%20and%20Job/" onclick="window.history.go(-1); return false;">⬅️ Go back </a></span>

	

</article>

	</main>

	<footer class="footer">
	<div class="footer-content">
		
	      <div class="footer__element">
	<p>欢迎来到我的 blog <br><br> 通过 <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>+<a target="_blank" rel="noopener" href="https://github.com/HoverBaum/meilidu-hexo">MeiliDu</a> 进行构建的，存放在 <a target="_blank" rel="noopener" href="https://github.com/vendanges/vendanges.github.io">Github</a> 上。</p>
</div>

	    
	      <div class="footer__element">
	<h5>Check out</h5>
	<ul class="footer-links">
		<li class="footer-links__link"><a href="/archives">Archive</a></li>
		
		  <li class="footer-links__link"><a href="/atom.xml">RSS</a></li>
	    
		<li class="footer-links__link"><a href="/about">about page</a></li>
		<li class="footer-links__link"><a href="/tags">Tags</a></li>
		<li class="footer-links__link"><a href="/categories">Categories</a></li>
	</ul>
</div>

	    

		<div class="footer-credit">
			<span>© 2022 John Doe | Powered by <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> | Theme <a target="_blank" rel="noopener" href="https://github.com/HoverBaum/meilidu-hexo">MeiliDu</a></span>
		</div>

	</div>


</footer>



</body>

</html>
