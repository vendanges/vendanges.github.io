<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta name="theme-color" content="#33474d">
	<title>琼瑶</title>
	<link rel="stylesheet" href="/css/style.css" />
	
      <link rel="alternate" href="/atom.xml" title="琼瑶" type="application/atom+xml">
    
<meta name="generator" content="Hexo 6.1.0"></head>

<body>

	<header class="header">
		<nav class="header__nav">
			
				<a href="/" class="header__link" style="color: #fff">Home</a>
			
				<a href="/archives" class="header__link" style="color: #fff">Archive</a>
			
				<a href="/about" class="header__link" style="color: #fff">About</a>
			
		</nav>
		<!-- <h1 class="header__title"><a href="/">琼瑶</a></h1> -->
		<h1 class="header__title"><a href="/"><img style="width: 290px;" src="https://49812933408852955071488026628034-1301075051.cos.ap-nanjing.myqcloud.com/202204152017786.png"></a></h1>
		<h2 class="header__subtitle">梦入琼楼寒有月，行过石树冻无烟</h2>
	</header>

	<main>
		
	<span class="different-posts different-posts_earlier">📖 <a href="/page/12">earlier posts</a> 📖</span>




	<article>
	
		<h1><a href="/2022/04/21/java/spring security/8.Spring security 跨域/">Spring security 跨域与CORS</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2022-04-21</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-none-link" href="/tags/java/" rel="tag">java</a> <a class="article__tag-none-link" href="/tags/spring-security/" rel="tag">spring security</a>
			</span>
		
	</div>

	

	
		<p>跨域即分为三种，分别为协议跨域、主机跨域、端口跨域等，其中主要根据协议不同、域名不同、端口不同，在这三种之中只要有一个不同，就算是跨域。就比如你访问 <a target="_blank" rel="noopener" href="http://pv.zsun.org.cn,然后还访问了https//pv.zsun.org.cn/%E8%BF%99%E5%B0%B1%E5%AF%B9%E5%BA%94%E4%BA%86%E8%B7%A8%E5%9F%9F%E4%B8%AD%E7%9A%84%E5%8D%8F%E8%AE%AE%E4%B8%8D%E5%90%8C%EF%BC%8C%E4%B8%80%E4%B8%AA%E6%97%B6http%E5%8D%8F%E8%AE%AE%E5%8F%A6%E4%B8%80%E4%B8%AA%E5%88%99%E6%98%AFhttps%E5%8D%8F%E8%AE%AE%EF%BC%8C%E6%89%80%E4%BB%A5%E9%80%A0%E6%88%90%E4%BA%86%E8%B7%A8%E5%9F%9F%E3%80%82%E4%B8%BA%E4%BA%86%E8%A7%A3%E5%86%B3%E8%B7%A8%E5%9F%9F%E7%9A%84%E9%97%AE%E9%A2%98%EF%BC%8C%E5%85%B6%E4%B8%AD%E4%B8%BB%E8%A6%81%E5%8C%85%E6%8B%AC%E4%BA%86JSONP%E3%80%81NGINX%E8%BD%AC%E5%8F%91%E3%80%81CORS%E7%AD%89%EF%BC%8C%E5%85%B6%E4%B8%ADJSONP%E5%92%8CCORS%E9%83%BD%E9%9C%80%E8%A6%81%E5%90%8E%E7%AB%AF%E8%BF%9B%E8%A1%8C%E5%8F%82%E4%B8%8E%E3%80%82">http://pv.zsun.org.cn，然后还访问了https://pv.zsun.org.cn/这就对应了跨域中的协议不同，一个时http协议另一个则是https协议，所以造成了跨域。为了解决跨域的问题，其中主要包括了JSONP、NGINX转发、CORS等，其中JSONP和CORS都需要后端进行参与。</a></p>
<h2 id="CORS"><a href="#CORS" class="headerlink" title="CORS"></a>CORS</h2><p>CORS（Cross-Origin Resource Sharing，跨域资源共享）是一个系统，他由一系列的传输HTTP头组成，这些HTTP头将会决定浏览器是否阻止前端JavaScript代码来获取请求相应，同源安全策略是默认阻止“跨域”请求，但是如果使用CORS则会给web服务器一个选择、允许和拒绝请求访问到他们的资源。</p>
<p>就比如Origin来发起请求域：</p>
<ol>
<li>Access-Control-Request-Method：将要发起跨域请求的方式（POST&#x2F;GET……）</li>
<li>Access-Control-Request-Headers：将要发起跨域请求中包含的请求头字段<ol>
<li>服务器在响应字段中来表明是否允许这个跨域请求，浏览器收到后如果检测到不合要求，就会拒绝后面的请求</li>
</ol>
</li>
<li>Access-Control-Allow-Origin：允许那些域来访问<ol>
<li><code>*</code>表示所有的域请求</li>
</ol>
</li>
<li>Access-Control-Allow-Method：允许那些请求方式</li>
<li>Access-Control-Allow-Headers：允许那些请求头字段</li>
<li>Access-Control-Credentials：是否允许携带Cookie</li>
</ol>
<h2 id="Spring-security-实现CORS"><a href="#Spring-security-实现CORS" class="headerlink" title="Spring security 实现CORS"></a>Spring security 实现CORS</h2><h3 id="CrossOrigin"><a href="#CrossOrigin" class="headerlink" title="CrossOrigin"></a>CrossOrigin</h3><h4 id="DemoApplication-java"><a href="#DemoApplication-java" class="headerlink" title="DemoApplication.java"></a>DemoApplication.java</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.CrossOrigin;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DemoApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&quot;)</span></span><br><span class="line">    <span class="meta">@CrossOrigin(origins = &quot;http://localhost:8080&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">index</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;The is Spring security world!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(DemoApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="WebMvcConfigurerAdapter"><a href="#WebMvcConfigurerAdapter" class="headerlink" title="WebMvcConfigurerAdapter"></a>WebMvcConfigurerAdapter</h3><h4 id="WebCorsConfig-java"><a href="#WebCorsConfig-java" class="headerlink" title="WebCorsConfig.java"></a>WebCorsConfig.java</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.CorsRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurerAdapter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebCorsConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> WebMvcConfigurer <span class="title function_">webMvcConfigurer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">WebMvcConfigurerAdapter</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addCorsMappings</span><span class="params">(CorsRegistry registry)</span> &#123;</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                    addMapping 所有域都能访问</span></span><br><span class="line"><span class="comment">                    allowedOrigins 那些域可以被访问</span></span><br><span class="line"><span class="comment">                    allowedMethods 允许那些请求</span></span><br><span class="line"><span class="comment">                    allowedHeaders 允许那些请求字段</span></span><br><span class="line"><span class="comment">                    allowCredentials 是否允许携带Cookie</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                registry.addMapping(<span class="string">&quot;/**&quot;</span>)</span><br><span class="line">                .allowedOrigins(<span class="string">&quot;http://localhost:8080&quot;</span>)</span><br><span class="line">                .allowedMethods(<span class="string">&quot;POST&quot;</span>,<span class="string">&quot;GET&quot;</span>)</span><br><span class="line">                .allowedHeaders(<span class="string">&quot;*&quot;</span>)</span><br><span class="line">                .allowCredentials(<span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
	

	

</article>




	<article>
	
		<h1><a href="/2022/04/21/java/spring security/7.Spring security 密码加密/">Spring security 密码加密</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2022-04-21</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-none-link" href="/tags/java/" rel="tag">java</a> <a class="article__tag-none-link" href="/tags/spring-security/" rel="tag">spring security</a>
			</span>
		
	</div>

	

	
		<p>在注册的过程中，通常会有一定的入库处理机制，以钟山计算机端口安全联合众测平台为例，密码入库时都是由MD5运算加密后的密文，以防止不法分子通过相关技术手段对站点进行脫库时明文密码的直接获取。通过使用密文给不法分子增加技术难度从而留有一定的解密时间来提醒用户尽快修改密码等公告的发布与通知。在目前，我们通常会使用MD5、SHA等摘要算法，尽管有很多在线解密的站点，通常在密码加密的场景中，我们会将用户输入的明文密码进行MD5或HAS运算后存储到数据库，之后在用户登录的时候将数据和数据库中的data进行对比的这种方案。</p>
<h2 id="密文的解密方式"><a href="#密文的解密方式" class="headerlink" title="密文的解密方式"></a>密文的解密方式</h2><p>通常我们可通过碰撞，即存在两个甚至多个得到同一直的情况下就会存在被碰撞的可能性。当然还有就是最直接的方法构建一张反查表，就是说将密码经过md5后运算出的直来进行穷举，如果该站点数据库中有部分密码和反查表中大部分数据收录，则很容易被进行破解至明文。在或者还有一种非常暴力的方式则是“暴力破解”，主要依靠的是强大的字典而不是使用者的技术实力，按照道理来讲，只要你的字典足够丰富且完善，成功率就越高，如果你的字典跑完了还没有破解成功的话，那基本上是意味着失败了。</p>
<h3 id="彩虹表"><a href="#彩虹表" class="headerlink" title="彩虹表"></a>彩虹表</h3><p>起初黑客们通过字典、碰撞的方式进行破解，对于简单的密码则非常有用，但是如果遇到复杂的密码和密码系统，就会产生较大的字典，为了解决逆向破解的难题，并增加表的容量，瑞士洛桑联邦技术学院的Philippe Oechslin就提出了一种优化型的时间与内存交换算法。</p>
<p>这让表不在是只存储米嗯问与密文的一一对应关系，而是一个密码对的集合，并在有限的内存中以极高的效率破解更多可能的密码，这也被一些黑客改进了部分流程，最后成为了一种彩虹表。</p>
<p>彩虹表的大小通常都超过了100g以上，彩虹表每一条散列链都会代表一组相同特征的铭文，但每一条散列链并不需要完整的存储，仅仅存储开始节点和结束节点即可。例如图中的H则代表一次散列计算，R1\R2\R3代表一次递归性质的约减计算R旁边的字母则会代表一条散列链会经历3次约减，也就是说这条散列链可以携带三条铭文，后面的都会由K所指代。当我们需要破解一个散列的时候，只需要对其做相应的约减计算，便可以推导出其所在的散列链，再有散列链正推就可能会得到该散列链的明文，由于K的存在，所以可以携带更多的数据。<code>虽然彩虹表看似如此强大，但是如果当遇到被加盐的时候，也是会变得弱不禁风的。</code></p>
<h2 id="实现密码加密"><a href="#实现密码加密" class="headerlink" title="实现密码加密"></a>实现密码加密</h2><h3 id="UserServiceImpl-java"><a href="#UserServiceImpl-java" class="headerlink" title="UserServiceImpl.java"></a>UserServiceImpl.java</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.zhongce.service;</span><br><span class="line"><span class="keyword">import</span> com.example.zhongce.model.User;</span><br><span class="line"><span class="keyword">import</span> com.example.zhongce.repository.RoleRepository;</span><br><span class="line"><span class="keyword">import</span> com.example.zhongce.repository.UserRepository;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserRepository userRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RoleRepository roleRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> BCryptPasswordEncoder bCryptPasswordEncoder;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">(User user)</span> &#123;</span><br><span class="line">        user.setPassword(bCryptPasswordEncoder.encode(user.getPassword()));</span><br><span class="line">        user.setRoles(<span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;(roleRepository.findAll()));</span><br><span class="line">        userRepository.save(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">findByUsername</span><span class="params">(String username)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userRepository.findByUsername(username);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>具体代码可通过阅读或浏览钟山计算机端口安全联合众测平台进行得知：<a target="_blank" rel="noopener" href="https://gitee.com/zhongshan_union/Zhongshan-computer-port-security-joint-public-testing-platform/blob/master/src/main/java/com/example/zhongce/service/UserServiceImpl.java">https://gitee.com/zhongshan_union/Zhongshan-computer-port-security-joint-public-testing-platform/blob/master/src/main/java/com/example/zhongce/service/UserServiceImpl.java</a></p>

	

	

</article>




	<article>
	
		<h1><a href="/2022/04/21/java/spring security/6.Spring security 会话管理/">Spring security 会话管理</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2022-04-21</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-none-link" href="/tags/java/" rel="tag">java</a> <a class="article__tag-none-link" href="/tags/spring-security/" rel="tag">spring security</a>
			</span>
		
	</div>

	

	
		<p>会话管理的基本概念可以理解为，管理会话的限制，就比如在大型的站点之中，基本上都是不允许多个帐号同时登录的，就比如腾讯QQ，假如PC1已经登入QQ，PC2再次登入QQ则会出现PC1QQ已经被踢下线的情况。而在网络设备中，只要该设备被登录，就不会允许再次登录的这种功能效果，Spring security为我们提供了完善的会话管理功能，和安全防御手段如：会话固定攻击，会话超时检测以及会话并发控制等。</p>
<h2 id="什么是会话？"><a href="#什么是会话？" class="headerlink" title="什么是会话？"></a>什么是会话？</h2><p>会话（session）即无状态的HTTP实现用户状态可维持的一种解决方案，在通常的情况每个请求之间都没有相互的关联性，也就是说用户访问的时候没有一个身份记录，也就是说谁都访问了，但是我不知道也查不到。session的出现解决了这个问题，服务器通过与用户达成一个约定，<code>每个请求之间都携带着一个id类的信息</code>。</p>
<p><strong>在用户首次访问的时候，系统会为该程序生成一个sessionId，并因此添加至cookie之中</strong>，当用户的会话期限内，每个请求都会自动携带该cookie，因此系统会轻易的判断这个识别是来此那个一个用户的请求。</p>
<h2 id="Spring-security-的会话固定攻击防御"><a href="#Spring-security-的会话固定攻击防御" class="headerlink" title="Spring security 的会话固定攻击防御"></a>Spring security 的会话固定攻击防御</h2><p>在spring security之中，会话固定个攻击的防御手段也可通过用户登录之后重新生成新的session，在继承WebSecurityConfigurationAdapter的时候，Spring security则已经启用了这种配置。</p>
<h3 id="sessionManagement"><a href="#sessionManagement" class="headerlink" title="sessionManagement"></a>sessionManagement</h3><p>sessionManagement是一个会话管理的配置器，其中防御会话固定攻击的策略分为四种分别为：</p>
<ul>
<li>1.nune：不做任何改动，登入之后沿用旧的session</li>
<li>2.newSession：登录后创建一个新的session</li>
<li>3.migrateSession：登入之后创建一个新的session，并将旧的session中的数据复制过来</li>
<li>4.changeSessionId：不创建新的会话，而是使用由Servlet容器提供的会话固定保护。</li>
</ul>
<h4 id="WebSecurityConfig-java"><a href="#WebSecurityConfig-java" class="headerlink" title="WebSecurityConfig.java"></a>WebSecurityConfig.java</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDetailsService userDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity httpSecurity)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        httpSecurity.authorizeRequests()</span><br><span class="line">               .anyRequest().authenticated()</span><br><span class="line">                .and().formLogin()</span><br><span class="line">                .and()</span><br><span class="line">                .rememberMe()</span><br><span class="line">                .userDetailsService(userDetailsService)</span><br><span class="line">                .and()</span><br><span class="line">             <span class="comment">// 开启session会话管理</span></span><br><span class="line">            .sessionManagement()</span><br><span class="line">                .sessionFixation().none();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 实际上在Spring security之中，即使没有配置，也不需要太过担心会话固定攻击，因为Security之中的HTTP防火墙或控制器会帮助我们拦截一定的不合法URL请求，就比如我压根没配置index，你访问了只能是Error Page的错误页。</p>
<h2 id="Spring-security-会话管理配置"><a href="#Spring-security-会话管理配置" class="headerlink" title="Spring security 会话管理配置"></a>Spring security 会话管理配置</h2><p>在Spring security之中，我们可通过<code>invalidSessionUrl</code>来指定会话的失效时重定向的URL(默认重定向登录页面)。当然也可通过<code>maximumSession</code>来指定用户最大的并发数量(-1表示无限制)，这里我们主要列举几个简单的例子来实现。</p>
<h3 id="失效处理与失效时间"><a href="#失效处理与失效时间" class="headerlink" title="失效处理与失效时间"></a>失效处理与失效时间</h3><p>通过<code>sessionManagement().invalidSessionUrl();</code>来设置会话失效后重定向的页面，这里我们在application.propertoes中分别设置session与cokie的生命周期：</p>
<h4 id="application-properties"><a href="#application-properties" class="headerlink" title="application.properties"></a>application.properties</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spring.security.user.name=kun</span><br><span class="line">spring.security.user.password=123</span><br><span class="line"></span><br><span class="line"># 根据提示默认时间是30min(单位为秒)，这里我们设置60m(一分钟），通过查看 TomcatServletWebServerFactory</span><br><span class="line"># 我们可以得知session的默认时间是1分钟</span><br><span class="line">server.servlet.session.timeout=60</span><br><span class="line"># 这里是cookie的生命周期，单位为秒,-1是无限制</span><br><span class="line">server.servlet.session.cookie.max-age=-1</span><br></pre></td></tr></table></figure>

<h4 id="WebSecurityConfig-java-1"><a href="#WebSecurityConfig-java-1" class="headerlink" title="WebSecurityConfig.java"></a>WebSecurityConfig.java</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDetailsService userDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity httpSecurity)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        httpSecurity.authorizeRequests()</span><br><span class="line">               .anyRequest().authenticated()</span><br><span class="line">                .and().formLogin()</span><br><span class="line">                .and()</span><br><span class="line">                .rememberMe()</span><br><span class="line">                .userDetailsService(userDetailsService)</span><br><span class="line">                .and()</span><br><span class="line">            .sessionManagement()</span><br><span class="line">                .invalidSessionUrl(<span class="string">&quot;/myLogin.html&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于我们并没有自定义登录页面所以&#96;&#96;&#96;&#x2F;myLogin.html &#96;&#96; &#96;文件坐在resource&#x2F;static目录下为空，所以在session会话失效的时候自然就跳转到了spring security为我们提供的默认登录页面之中，读者可根据需求自行进行修改与调整。</p>
<h3 id="session-最大会话数量"><a href="#session-最大会话数量" class="headerlink" title="session 最大会话数量"></a>session 最大会话数量</h3><p>通过.maximumSessions我们可以管理session中同一用户的最大会话数量，如果.maximumSessions设置为”-1“则表示无限制，除此之外的其他数字都将会被限制。而本次我们通过WebSecurityConfig.java中的.invalidSessionUrl来指定其同一用户登入后如session没过期的情况下跳转至&#x2F;myLogin.html页面，而.maxSessionsPreventsLogin所表示的则是，用户session会话达到.maximumSessions的限制后，新的请求session将会被拒绝登录。</p>
<h4 id="WebSecurityConfig-java-2"><a href="#WebSecurityConfig-java-2" class="headerlink" title="WebSecurityConfig.java"></a>WebSecurityConfig.java</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDetailsService userDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity httpSecurity)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        httpSecurity.authorizeRequests()</span><br><span class="line">               .anyRequest().authenticated()</span><br><span class="line">                .and().formLogin()</span><br><span class="line">                .and()</span><br><span class="line">                .rememberMe()</span><br><span class="line">                .userDetailsService(userDetailsService)</span><br><span class="line">                .and()</span><br><span class="line">            .sessionManagement()</span><br><span class="line">                .invalidSessionUrl(<span class="string">&quot;/myLogin.html&quot;</span>)</span><br><span class="line">                .maximumSessions(<span class="number">1</span>).maxSessionsPreventsLogin(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
	

	

</article>




	<article>
	
		<h1><a href="/2022/04/21/java/spring security/5.Spring security 自动登录/">Spring security 自动登录</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2022-04-21</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-none-link" href="/tags/java/" rel="tag">java</a>
			</span>
		
	</div>

	

	
		<p>自动登录在很多登入页面中都有一定的需求和存在，有时候处于站点的相关密码安全等级设置，所以会要求用户在输入密码的时候要大于或等于多少个数字或字母，有的甚至会要求大小写和一些符号混合。这就会改变我们经常使用的密码，比如我经常使用的密码是<code>wwcx2022.</code>，但该站点所要求的密码规范是大小写，所以就会改变成<code>Wwcx2022.</code>，有的甚至会要求不允许密码符号，如钟山计算机端口安全联合漏洞共享平台中的前端和后端验证都不允许标点符号的存在。<br>所以在登录的时候会多个密码进行重试，有的甚至会选择忘记密码而增加站点的处理，为减少用户重新提交表单和加程序处理的频率，在系统开发之中会要求用户记住密码（俗称自动登录）的功能体验，这样做的唯一好处就是可以减少程序的处理数量和给用户带来便利，本文我们使用Spring security来实现自动登录，当然还有一些使用数据库来实现的自动登录，网上有很多文章可以用于实现，读者可自行进行学习，在项目开发的过程中，我们一般建议较少的使用数据库，减少系统资源。</p>
<h2 id="DemoApplication-java"><a href="#DemoApplication-java" class="headerlink" title="DemoApplication.java"></a>DemoApplication.java</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DemoApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">index</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;The is Spring security world!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(DemoApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="WebSecurityConfig-java"><a href="#WebSecurityConfig-java" class="headerlink" title="WebSecurityConfig.java"></a>WebSecurityConfig.java</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDetailsService userDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity httpSecurity)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        httpSecurity.authorizeRequests()</span><br><span class="line">               .anyRequest().authenticated()</span><br><span class="line">                .and().formLogin()</span><br><span class="line">                .and()</span><br><span class="line">                .rememberMe()</span><br><span class="line">                .userDetailsService(userDetailsService)</span><br><span class="line">                .and()</span><br><span class="line">                .csrf().disable();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

	

	

</article>




	<article>
	
		<h1><a href="/2022/04/21/java/spring security/4.Spring security 验证码/">Spring security 验证码</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2022-04-21</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-none-link" href="/tags/java/" rel="tag">java</a> <a class="article__tag-none-link" href="/tags/spring-security/" rel="tag">spring security</a>
			</span>
		
	</div>

	

	
		<p>验证码（Completely Autmated Public Turing test to tell Computers and Humans Apart，CAPTCHA），中文全称为“全自动区分计算机和人类的图灵测试”，主要运用在登录、注册、提交等表单并以防止其暴力破解以及频繁提交的一种功能。<br>在目前，验证码技术已经衍生到滑块验证、图形验证、拼图验证等，但验证码依然被广泛使用，因其不美观而被滑块等隐藏的方式所替代，本书作者本来是不想将验证码加入进来，但实在是觉得不应该，所以才写，本书使用hutool工具集简单实现验证码。</p>
<p>再次之前我们需要在pom.xml文件下加入hutool的个依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-captcha<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.3.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h2><h3 id="CaptchaController-java"><a href="#CaptchaController-java" class="headerlink" title="CaptchaController.java"></a>CaptchaController.java</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.captcha.CaptchaUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.captcha.CircleCaptcha;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CaptchaController</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">SESSION_KEY_IMAGE_CODE</span> <span class="operator">=</span> <span class="string">&quot;SESSION_KEY_IMAGE_CODE&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/code/image&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createCode</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        response.setCharacterEncoding(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        response.setHeader(<span class="string">&quot;Pragma&quot;</span>,<span class="string">&quot;No-chache&quot;</span>);</span><br><span class="line">        response.setHeader(<span class="string">&quot;Cache-Control&quot;</span>,<span class="string">&quot;no-chache&quot;</span>);</span><br><span class="line">        response.setDateHeader(<span class="string">&quot;Expires&quot;</span>,<span class="number">0</span>);</span><br><span class="line">        response.setContentType(<span class="string">&quot;image/jpeg&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            width @宽</span></span><br><span class="line"><span class="comment">            height @高</span></span><br><span class="line"><span class="comment">            codeCount @验证码位数</span></span><br><span class="line"><span class="comment">            circleCount @循环次数</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">CircleCaptcha</span> <span class="variable">captcha</span> <span class="operator">=</span> CaptchaUtil.createCircleCaptcha(<span class="number">100</span>,<span class="number">20</span>,<span class="number">4</span>,<span class="number">3</span>);</span><br><span class="line">        System.out.println(captcha.getCode());</span><br><span class="line"></span><br><span class="line">        request.getSession().setAttribute(SESSION_KEY_IMAGE_CODE, captcha.getCode());</span><br><span class="line">        log.info(<span class="string">&quot;Captcha:&quot;</span> + captcha.getCode() + <span class="string">&quot;,already arrive deposit HttpSession&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">OutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> response.getOutputStream();</span><br><span class="line">        captcha.write(outputStream);</span><br><span class="line">        outputStream.flush();</span><br><span class="line">        outputStream.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="configuration"><a href="#configuration" class="headerlink" title="configuration"></a>configuration</h2><h3 id="WebSecurityConfiguration-java"><a href="#WebSecurityConfiguration-java" class="headerlink" title="WebSecurityConfiguration.java"></a>WebSecurityConfiguration.java</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span> <span class="params">(HttpSecurity httpSecurity)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        httpSecurity.authorizeRequests()</span><br><span class="line">                .antMatchers(<span class="string">&quot;/code/image&quot;</span>).permitAll()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">                .formLogin()</span><br><span class="line">                .loginPage(<span class="string">&quot;/myLogin.html&quot;</span>)</span><br><span class="line">                .permitAll()</span><br><span class="line">                .and()</span><br><span class="line">                .csrf().disable();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="resources"><a href="#resources" class="headerlink" title="resources"></a>resources</h2><h3 id="static"><a href="#static" class="headerlink" title="static"></a>static</h3><h4 id="myLogin-html"><a href="#myLogin-html" class="headerlink" title="myLogin.html"></a>myLogin.html</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Loing - by Spring security<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>The is Spring security by html<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;/myLogin&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;user&quot;</span>/&gt;</span><span class="symbol">&amp;nbsp;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;pass&quot;</span>/&gt;</span></span><br><span class="line">    <span class="symbol">&amp;nbsp;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;Captcha&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;/code/image&quot;</span>&gt;</span><span class="symbol">&amp;nbsp;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;login go&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

	

	

</article>




	<article>
	
		<h1><a href="/2022/04/21/java/spring security/3.Spring security 授权/">Spring security 授权</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2022-04-21</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-none-link" href="/tags/java/" rel="tag">java</a> <a class="article__tag-none-link" href="/tags/spring-security/" rel="tag">spring security</a>
			</span>
		
	</div>

	

	
		<h2 id="controller"><a href="#controller" class="headerlink" title="controller"></a>controller</h2><h3 id="AdminController-java"><a href="#AdminController-java" class="headerlink" title="AdminController.java"></a>AdminController.java</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.dome.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/admin/api&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AdminController</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;index&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">index</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello, admin&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Userontroller-java"><a href="#Userontroller-java" class="headerlink" title="Userontroller.java"></a>Userontroller.java</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.dome.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user/api&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;index&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">index</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello, user&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="AppController-java"><a href="#AppController-java" class="headerlink" title="AppController.java"></a>AppController.java</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.dome.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/app/api&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppController</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;index&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">index</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello, app&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="configuration"><a href="#configuration" class="headerlink" title="configuration"></a>configuration</h2><h3 id="WebSecurityConfig-java"><a href="#WebSecurityConfig-java" class="headerlink" title="WebSecurityConfig.java"></a>WebSecurityConfig.java</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.dome.configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span> <span class="params">(HttpSecurity httpSecurity)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        httpSecurity.authorizeRequests()</span><br><span class="line">                .antMatchers(<span class="string">&quot;/admin/api/**&quot;</span>).hasRole(<span class="string">&quot;ADMIN&quot;</span>)</span><br><span class="line">                .antMatchers(<span class="string">&quot;/user/aip/**&quot;</span>).hasRole(<span class="string">&quot;USER&quot;</span>)</span><br><span class="line">                .antMatchers(<span class="string">&quot;/app/api/**&quot;</span>).permitAll()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">        .formLogin();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过上述我们所定义的不同权限，分别为管理员、用户、匿名，所分配的权限不同，而管理员和用户是需要登入才可以访问的，匿名帐号app则可访问拥有权限下的所有资源。通过访问localhost:8080&#x2F;user&#x2F;api&#x2F;index我们可以得知，Spring security的默认帐号角色，就是user。</p>
<blockquote>
<p>HTTP 状态码（HTTP Status Code）是由RFC 2016定义的一种用于表示一个HTTP请求响应状态的规范，总共由三位数字组成。通常由2XX表示操作成功、4XX表示客户端导致的失败，5xx表示服务器引起错误。</p>
</blockquote>
<h2 id="多用户"><a href="#多用户" class="headerlink" title="多用户"></a>多用户</h2><h3 id="WebSecurityConfig-java-InMemoryUserDetailsManager"><a href="#WebSecurityConfig-java-InMemoryUserDetailsManager" class="headerlink" title="WebSecurityConfig.java (InMemoryUserDetailsManager)"></a>WebSecurityConfig.java (InMemoryUserDetailsManager)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.dome.configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.password.NoOpPasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.password.PasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.provisioning.InMemoryUserDetailsManager;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span> <span class="params">(HttpSecurity httpSecurity)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        httpSecurity.authorizeRequests()</span><br><span class="line">                .antMatchers(<span class="string">&quot;/admin/api/**&quot;</span>).hasRole(<span class="string">&quot;ADMIN&quot;</span>)</span><br><span class="line">                .antMatchers(<span class="string">&quot;/user/aip/**&quot;</span>).hasRole(<span class="string">&quot;USER&quot;</span>)</span><br><span class="line">                .antMatchers(<span class="string">&quot;/app/api/**&quot;</span>).permitAll()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">        .formLogin();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> UserDetailsService <span class="title function_">userDetailsService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">InMemoryUserDetailsManager</span> <span class="variable">inMemoryUserDetailsManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryUserDetailsManager</span>();</span><br><span class="line">        inMemoryUserDetailsManager.createUser(User.withUsername(<span class="string">&quot;user&quot;</span>).password(<span class="string">&quot;123&quot;</span>).roles(<span class="string">&quot;USER&quot;</span>).build());</span><br><span class="line">        inMemoryUserDetailsManager.createUser(User.withUsername(<span class="string">&quot;admin&quot;</span>).password(<span class="string">&quot;123&quot;</span>).roles(<span class="string">&quot;USER&quot;</span>,<span class="string">&quot;ADMIN&quot;</span>).build());</span><br><span class="line">        <span class="keyword">return</span> inMemoryUserDetailsManager;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> PasswordEncoder <span class="title function_">passwordEncoder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> NoOpPasswordEncoder.getInstance();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于Spring security中的多用户，实际上spring security主要拥有三种权限，分别为管理员（admin），用户（user）以及匿名&#x2F;访客（visitor），可通过数据库或Spring security中的配置类进行实现。在写项目的过程中建议这种授权情况不要使用数据库进行授权，通过配置文件就可以实现，首先确定管理员和用户，</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://gitee.com/zhongshan_union/Zhongshan-computer-port-security-joint-public-testing-platform/blob/master/src/main/java/com/example/zhongce/WebSecurityConfig.java">https://gitee.com/zhongshan_union/Zhongshan-computer-port-security-joint-public-testing-platform/blob/master/src/main/java/com/example/zhongce/WebSecurityConfig.java</a></p>
</blockquote>
<p>然后访客权限可通过<code>antMatchers</code>来实现访客权限可以访问的页面，这种方式也被开源项目钟山计算机端口安全联合众测平台使用。</p>

	

	

</article>




	<article>
	
		<h1><a href="/2022/04/21/java/spring security/2.Spring security 登录与自定义/">Spring security 创建项目与自定义登陆页</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2022-04-21</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-none-link" href="/tags/java/" rel="tag">java</a> <a class="article__tag-none-link" href="/tags/spring-security/" rel="tag">spring security</a>
			</span>
		
	</div>

	

	
		<p>本文通过idea进行一些实例演示，通过Spring Initializer工具来创建spring security项目的例子，首先我们在自动构建项目中选择 Spring security 以及 Spring Web，然后点击next即可进行下一步，通过Spring Initializer来选定一些常用的项目以来，当创建项目完成后，Idea将会自动生成pom.xml文件，我们可以通过该文件看出Spring Initializr总共引入了那些依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.security<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-security-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="DomeApplication-class"><a href="#DomeApplication-class" class="headerlink" title="DomeApplication.class"></a>DomeApplication.class</h2><p>在程序的启动类中，我们可以通过设置一个程序入口来访问，之后Spring security会在访问的时候直接使用其自带的登入页面，而登入页面的帐号及其密码则通过application.properties即spring全局配置文件中进行配置，启动类代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.dome;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DomeApplication</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">index</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Helo,world,the is Spring security world.&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(DomeApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="application-properties"><a href="#application-properties" class="headerlink" title="application.properties"></a>application.properties</h2><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">//</span> <span class="string">user@帐号 passowrd@密码</span></span><br><span class="line"><span class="attr">spring.security.user.name</span>=<span class="string">kun</span></span><br><span class="line"><span class="attr">spring.security.user.password</span>=<span class="string">123</span></span><br></pre></td></tr></table></figure>

<h2 id="自定义登陆页"><a href="#自定义登陆页" class="headerlink" title="自定义登陆页"></a>自定义登陆页</h2><h3 id="WebSecurityConfig-class"><a href="#WebSecurityConfig-class" class="headerlink" title="WebSecurityConfig.class"></a>WebSecurityConfig.class</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.dome.configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configurers.ExpressionUrlAuthorizationConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configurers.FormLoginConfigurer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span> <span class="params">(HttpSecurity httpSecurity)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ExpressionUrlAuthorizationConfigurer.<span class="type">ExpressionInterceptUrlRegistry</span> <span class="variable">expressionInterceptUrlRegistry</span> <span class="operator">=</span> httpSecurity.authorizeRequests();</span><br><span class="line">        ExpressionUrlAuthorizationConfigurer.<span class="type">AuthorizedUrl</span> <span class="variable">authorizedUrl</span> <span class="operator">=</span> (ExpressionUrlAuthorizationConfigurer.AuthorizedUrl) expressionInterceptUrlRegistry.anyRequest();</span><br><span class="line">        authorizedUrl.authenticated();</span><br><span class="line"></span><br><span class="line">        FormLoginConfigurer&lt;HttpSecurity&gt; formLoginConfigurer =</span><br><span class="line">                httpSecurity.formLogin();</span><br><span class="line">        formLoginConfigurer.loginPage(<span class="string">&quot;/myLogin.html&quot;</span>);</span><br><span class="line">        formLoginConfigurer.permitAll();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.dome.configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configurers.ExpressionUrlAuthorizationConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configurers.FormLoginConfigurer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span> <span class="params">(HttpSecurity httpSecurity)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        httpSecurity.authorizeRequests()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">        .formLogin()</span><br><span class="line">                .loginPage(<span class="string">&quot;/myLogin.html&quot;</span>)</span><br><span class="line">                .permitAll()</span><br><span class="line">                .and()</span><br><span class="line">        .csrf().disable();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这这里我们主要提供了两种方法，通常我们在写项目的时候都会使用第二种方法，而第一种方法这是一个非常令人无语的事情，使用了HttpSecurity实际上是对应了Spring security命名空间的配置方式，允许我们特定的HTTPP请求配置安全策略，所以相对第二种方法而讲，我们喜欢第二种，HttpSecurity提供了很多配置的相关方法。分别对应命名空间配置中的子标签分<http>如：</p>
<table>
<thead>
<tr>
<th>ID</th>
<th>DA</th>
</tr>
</thead>
<tbody><tr>
<td>authorizeRequest()</td>
<td><code>&lt;intercept-url&gt;</code></td>
</tr>
<tr>
<td>formLogin()</td>
<td><code>&lt;form-login&gt;</code></td>
</tr>
<tr>
<td>httpBasic()</td>
<td><code>&lt;http-basic&gt;</code></td>
</tr>
<tr>
<td>csrf()</td>
<td><code>&lt;csrf&gt;</code></td>
</tr>
</tbody></table>
<p>通过调用这些方法后，除了使用and()方法来结束当前标签，才会返回到Httpsecurity，否则将会自动进入对应标签域。authorizeRequests()方法实际撒汗功能返回了一个url拦截注册器，可以调用它提供的anyanyRequest()、antMatchers()和regexMatchers()方法来进行匹配系统的url，并为其指定安全策略。</p>
<p>formLogin()方法和httpBasic()方法都将声明需要Spring security提供表单认证方式，分别返回对应的配置器，其中formLogin().loginPage()为指定自定义登陆页面，同时Spring security会注册一个路由用于接受请求，而csrf()方法则是Spring security所提供的夸站请求伪造 防护公鞥，当WebSeecurityConfig继承WebSecurityConfigurerAdapter的时候将会默认开启csrf()方法。</p>
<h3 id="myLogin-html"><a href="#myLogin-html" class="headerlink" title="myLogin.html"></a>myLogin.html</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- static/myLogin.html --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Loing - by Spring security<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>The is Spring security by html<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;/login&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;user&quot;</span>/&gt;</span><span class="symbol">&amp;nbsp;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;pass&quot;</span>/&gt;</span></span><br><span class="line">    <span class="symbol">&amp;nbsp;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;login go&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="指定登陆处理路径"><a href="#指定登陆处理路径" class="headerlink" title="指定登陆处理路径"></a>指定登陆处理路径</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.dome.configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configurers.ExpressionUrlAuthorizationConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configurers.FormLoginConfigurer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span> <span class="params">(HttpSecurity httpSecurity)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        httpSecurity.authorizeRequests()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">        .formLogin()</span><br><span class="line">                .loginPage(<span class="string">&quot;/myLogin.html&quot;</span>)</span><br><span class="line">                .loginProcessingUrl(<span class="string">&quot;/login&quot;</span>) <span class="comment">// 指定处理路径</span></span><br><span class="line">                .permitAll()</span><br><span class="line">                .and()</span><br><span class="line">        .csrf().disable();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="登录成功与登入失败逻辑-successHandler-and-failureHandler"><a href="#登录成功与登入失败逻辑-successHandler-and-failureHandler" class="headerlink" title="登录成功与登入失败逻辑 (successHandler and failureHandler)"></a>登录成功与登入失败逻辑 (successHandler and failureHandler)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.dome.configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configurers.ExpressionUrlAuthorizationConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configurers.FormLoginConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.Authentication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.AuthenticationException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.AuthenticationFailureHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.AuthenticationSuccessHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span> <span class="params">(HttpSecurity httpSecurity)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        httpSecurity.authorizeRequests()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">        .formLogin()</span><br><span class="line">                .loginPage(<span class="string">&quot;/myLogin.html&quot;</span>)</span><br><span class="line">                .loginProcessingUrl(<span class="string">&quot;/login&quot;</span>) <span class="comment">// 指定处理路径</span></span><br><span class="line">                <span class="comment">// 登入成功处理</span></span><br><span class="line">                .successHandler(<span class="keyword">new</span> <span class="title class_">AuthenticationSuccessHandler</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAuthenticationSuccess</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Authentication authentication)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">                        httpServletResponse.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">                        <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> httpServletResponse.getWriter();</span><br><span class="line">                            out.write(<span class="string">&quot;&#123;\&quot;error_code\&quot;:\&quot;0\&quot;,\&quot;message\&quot;:\&quot;Hello login -by spring security\&quot;&#125;&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">                <span class="comment">// 登入失败处理</span></span><br><span class="line">                .failureHandler(<span class="keyword">new</span> <span class="title class_">AuthenticationFailureHandler</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAuthenticationFailure</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, AuthenticationException e)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">                        httpServletResponse.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">                        httpServletResponse.setStatus(<span class="number">401</span>);</span><br><span class="line">                        <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> httpServletResponse.getWriter();</span><br><span class="line">                        <span class="comment">// cause</span></span><br><span class="line">                        out.write(<span class="string">&quot;&#123;\&quot;error_code\&quot;:\&quot;401\&quot;,\&quot;name\&quot;:\&quot;&quot;</span> + e.getClass() + <span class="string">&quot;\&quot;, \&quot;message\&quot;:\&quot;&quot;</span> + e.getMessage() + <span class="string">&quot;\&quot;&#125;&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">                .permitAll()</span><br><span class="line">                .and()</span><br><span class="line">        .csrf().disable();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
	

	

</article>




	<article>
	
		<h1><a href="/2022/04/21/java/spring security/10.Spring Security OAuth/">Spring Security OAuth</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2022-04-21</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-none-link" href="/tags/java/" rel="tag">java</a> <a class="article__tag-none-link" href="/tags/spring-security/" rel="tag">spring security</a>
			</span>
		
	</div>

	

	
		<p>开放授权（Open Authorization）是一种开放的协议，即地桑房可以使用第三方应用代表资源所有者获取有限的访问授权机制，在整个授权的过程中，第三方站点无需涉及用户的密码即可获取部分的资源。在很多的站点场景之中，都提供了第三方登入等相关信息，如QQ、微信扫码登录等机制，而这当我们点击第三方登录时会跳转到授权的登录页面，然后登入成功就会跳转到访问的目标站点之中，而这过程中该站点就不会获取到用户的密码等相关信息，主要流程如下：</p>
<ol>
<li>客户端要求用户提供授权许可</li>
<li>用户同意向客户端提供授权许可</li>
<li>客户端携带用户所提供的授权许可向授权服务器申请访问令牌</li>
<li>授权服务器验证客户端是否携带授权许可，如有效则发放访问令牌</li>
<li>客户端使用访问令牌申请服务器资源</li>
<li>资源服务器验证访问令牌，确认正确后向客户端提供资源。</li>
</ol>
<h2 id="四种授权模式"><a href="#四种授权模式" class="headerlink" title="四种授权模式"></a>四种授权模式</h2><h3 id="授权码模式（Authorization-Code）"><a href="#授权码模式（Authorization-Code）" class="headerlink" title="授权码模式（Authorization Code）"></a>授权码模式（Authorization Code）</h3><p>授权码模式是功能较为完整，安全性和用户信息存在应用服务器宝楼风险小、服务器与服务器之间的访问难以被抓取等相关优点。</p>
<ol>
<li><p>重定向到认证服务器</p>
</li>
<li><p>认证服务器用户授权</p>
</li>
<li><p>认证服务器-&gt;应用服务器重定向应用服务器，带上授权码</p>
</li>
<li><p>应用服务器-&gt;认证服务器获取访问令牌（用授权码换得）</p>
</li>
<li><p>认证服务器-&gt;应用服务器认证服务器获取访问令牌</p>
</li>
<li><p>应用服务器-&gt;资源服务器访问资源服务器</p>
</li>
</ol>
<h3 id="隐式授权（Implicit-Grant）"><a href="#隐式授权（Implicit-Grant）" class="headerlink" title="隐式授权（Implicit Grant）"></a>隐式授权（Implicit Grant）</h3><p>隐式授权模式是指访问令牌通过重定向的方式传递到用户浏览器之中，之后通过js获取访问令牌。通过使用隐士验证我们可以免于后台和存储，将信息存储与Token或Cookie之中，基本上通过认证后可直接进行访问。</p>
<h3 id="密码授权模式（Password-Credentials）"><a href="#密码授权模式（Password-Credentials）" class="headerlink" title="密码授权模式（Password Credentials）"></a>密码授权模式（Password Credentials）</h3><p>密码授权模式即通过浏览器直接携带用户的密码向授权服务器申请令牌，这种授权模式不用通过跳转到授权服务器进行，而是通过资源服务器提供的页面进行。</p>
<h3 id="客户端授权模式（Client-Credentials）"><a href="#客户端授权模式（Client-Credentials）" class="headerlink" title="客户端授权模式（Client Credentials）"></a>客户端授权模式（Client Credentials）</h3><p>与上面三种模式相比之下，客户端授权模式相对于较为简单，只需要客户端请应用公钥、密钥等洗脑洗想授权服务器申请访问令牌，从而货渠道服务器所提供的资源。</p>
<h2 id="OAuth-2-0-github-and-login"><a href="#OAuth-2-0-github-and-login" class="headerlink" title="OAuth 2.0 github and login"></a>OAuth 2.0 github and login</h2><p>如果要接入github的授权，则需要访问<a target="_blank" rel="noopener" href="https://github.com/settings/applications/new%EF%BC%8C%E6%9D%A5%E7%94%B3%E8%AF%B7%E4%B8%80%E4%B8%AA%E5%BA%94%E7%94%A8%E5%B9%B6%E5%9C%A8%E6%AD%A4%E5%A1%AB%E5%86%99%E5%BA%94%E7%94%A8%E5%90%8D%E7%A7%B0%E3%80%81%E4%B8%BB%E9%A1%B5URL%E3%80%81%E5%BA%94%E7%94%A8%E8%AF%B4%E6%98%8E%E3%80%81%E8%AE%A4%E8%AF%81%E6%97%B6%E9%87%8D%E5%AE%9A%E5%90%91%E7%9A%84%E9%A1%B5%E9%9D%A2%E5%8D%B3%E5%8F%AF%E3%80%82%EF%BC%88%E9%9C%80%E8%A6%81%E6%B3%A8%E6%84%8F%E7%9A%84%E6%98%AF%E5%9C%A8%E6%9C%AC%E5%9C%B0%E5%BC%80%E5%8F%91%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E4%B8%BB%E9%A1%B5URL%E9%9C%80%E8%A6%81%E8%AE%BE%E7%BD%AE%E4%B8%BA%60%60%60http://localhost:8080%60%60%60%EF%BC%8C%E8%AE%A4%E8%AF%81%E9%87%8D%E5%AE%9A%E5%90%91%E5%9C%B0%E5%9D%80%E8%AE%BE%E7%BD%AE%E4%B8%BA%60%60%60http://localhost:8080/login/oauth2/code/github%60%60%60%EF%BC%89%E3%80%82">https://github.com/settings/applications/new，来申请一个应用并在此填写应用名称、主页URL、应用说明、认证时重定向的页面即可。（需要注意的是在本地开发的时候，主页URL需要设置为```http://localhost:8080```，认证重定向地址设置为```http://localhost:8080/login/oauth2/code/github```）。</a><br>点击确定后将会跳转至应用创建成功页面，并获得到客户端ID（Client ID）以及客户端密码（Client secrets）</p>
<blockquote>
<p>Client ID<br>****cd6dcb6f7289b5c56<br>****2a5b45fa0b528837b2181617e7</p>
</blockquote>
<p>Spring Security OAuth默认的重定向模板是<code>&#123;baseUrl&#125;/login/oauth2/code&#123;registrationId&#125;</code>registrationId是Client Registrationa的唯一ID，通常接入的OAuth服务提供商的简称来命名。</p>
<h3 id="resources"><a href="#resources" class="headerlink" title="resources"></a>resources</h3><h4 id="application-yml"><a href="#application-yml" class="headerlink" title="application.yml"></a>application.yml</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">security:</span></span><br><span class="line">    <span class="attr">oauth2:</span></span><br><span class="line">      <span class="attr">client:</span></span><br><span class="line">        <span class="attr">registration:</span></span><br><span class="line">          <span class="attr">github:</span></span><br><span class="line">            <span class="attr">clientId:</span> <span class="string">&lt;clientid&gt;</span></span><br><span class="line">            <span class="attr">clientSecret:</span> <span class="string">&lt;clientSecret&gt;</span></span><br><span class="line">            <span class="comment"># 需要获取的信息</span></span><br><span class="line">            <span class="attr">scope:</span> <span class="string">read:user,</span> <span class="string">user:email</span></span><br></pre></td></tr></table></figure>
<h3 id="static"><a href="#static" class="headerlink" title="static"></a>static</h3><h4 id="login-html"><a href="#login-html" class="headerlink" title="login.html"></a>login.html</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Spring boot security and OAuth2.0 github login<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Login github&gt; <span class="tag">&lt;/<span class="name">h1</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/oauth2/authorization/github&quot;</span>&gt;</span>Go<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h3><h4 id="IndexController-java"><a href="#IndexController-java" class="headerlink" title="IndexController.java"></a>IndexController.java</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.client.OAuth2AuthorizedClientService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.security.Principal;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">IndexController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OAuth2AuthorizedClientService auth2AuthorizedClientService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">index</span><span class="params">(Principal principal)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hey,&quot;</span> + principal.getName();        <span class="comment">// getName 为获取其github id</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Configuration"><a href="#Configuration" class="headerlink" title="Configuration"></a>Configuration</h3><h4 id="WebSecurityConfiguration-java"><a href="#WebSecurityConfiguration-java" class="headerlink" title="WebSecurityConfiguration.java"></a>WebSecurityConfiguration.java</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.util.matcher.AntPathRequestMatcher;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfiguration</span>  <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity httpSecurity)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        httpSecurity.authorizeRequests()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">            .oauth2Login()</span><br><span class="line">                .loginPage(<span class="string">&quot;/login.html&quot;</span>)</span><br><span class="line">                .defaultSuccessUrl(<span class="string">&quot;/&quot;</span>).permitAll()</span><br><span class="line">                .and()</span><br><span class="line">            .logout()</span><br><span class="line">                .logoutRequestMatcher(<span class="keyword">new</span> <span class="title class_">AntPathRequestMatcher</span>(<span class="string">&quot;/logout&quot;</span>,<span class="string">&quot;GET&quot;</span>))</span><br><span class="line">                .deleteCookies(<span class="string">&quot;true&quot;</span>)</span><br><span class="line">                .logoutSuccessUrl(<span class="string">&quot;/login.html?logout&quot;</span>)</span><br><span class="line">                .permitAll();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
	

	

</article>




	<article>
	
		<h1><a href="/2022/04/21/java/spring security/1.Spring security 简介/">Spring security</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2022-04-21</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-none-link" href="/tags/java/" rel="tag">java</a> <a class="article__tag-none-link" href="/tags/spring-security/" rel="tag">spring security</a>
			</span>
		
	</div>

	

	
		<p>Spring security 是一个功能呢个强大且高度可定制的身份验证和访问控制框架，主要用于保护Spring应用程序，并致力于为Java应用提供身份验证和授权。</p>
<blockquote>
<p>Spring Security is a powerful and highly customizable authentication and access-control framework. It is the de-facto standard for securing Spring-based applications.<br>Spring Security is a framework that focuses on providing both authentication and authorization to Java applications. Like all Spring projects, the real power of Spring Security is found in how easily it can be extended to meet custom requirements</p>
</blockquote>
<p>在Spring security成为 Spring 的子项目之前，他的前身名为“Acegi Security”，在成为spring的子项目之后更名为正式更名为“Spring security”。</p>
<h2 id="认证和授权"><a href="#认证和授权" class="headerlink" title="认证和授权"></a>认证和授权</h2><p>spring security主要针对的即是认证和授权，分别通过认证和授权来起到一定的保护性作用，而这些通常不是spring security所独有的：</p>
<h3 id="认证"><a href="#认证" class="headerlink" title="认证"></a>认证</h3><p>认证是用于确认用户或个人在某个系统或场合中是否合法，这里主要应用在登入系统的用户。可以从我们日常生活中所了解，开门需要钥匙，则通过钥匙进去则为合法，这里的钥匙泛指注册，开门的动作泛指登录。spring security支<br>持广泛的认证技术，而这些认证技术大多由第三方组织或相关标准化组织进行开发，并由spring security进行集成，目前已经集成的认证技术如下：</p>
<table>
<thead>
<tr>
<th>ID</th>
<th>DA</th>
<th>FA</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>HTTP BASIC authentication haders</td>
<td>基于IEFT RFC 的标准认证</td>
</tr>
<tr>
<td>2</td>
<td>HTTP Diget authentication headers</td>
<td>基于IETF RFC 的标准认证</td>
</tr>
<tr>
<td>3</td>
<td>HTTP X.509 client certificate exchange</td>
<td>基于IETF RFC 的标准认证</td>
</tr>
<tr>
<td>4</td>
<td>LDAP Lightweight Directory Access Protocol</td>
<td>常见的跨平台身份验证方式</td>
</tr>
<tr>
<td>5</td>
<td>Form-based authentiation</td>
<td>用于简单的用户界面需求</td>
</tr>
<tr>
<td>6</td>
<td>OpenID authentication</td>
<td>去中心化身份验证方式</td>
</tr>
<tr>
<td>7</td>
<td>Authentication based on pre-established request head</td>
<td>一种用户身份验证及授权的集中式的安全基础方案</td>
</tr>
<tr>
<td>8</td>
<td>Jasig Ceantral Authentication Service</td>
<td>单点登入解决方案</td>
</tr>
<tr>
<td>9</td>
<td>Transparent authentication context propagation for Remote Method Invocation (RIM) and HttpInvoker</td>
<td>Spring 远程调用协议</td>
</tr>
<tr>
<td>10</td>
<td>Automatic “remember-me” authentication</td>
<td>允许在指定到期前自行重新登入</td>
</tr>
<tr>
<td>11</td>
<td>Anonymous authentication</td>
<td>允许匿名用户使用特定的身份安全的访问资源</td>
</tr>
<tr>
<td>12</td>
<td>Run-as authentication</td>
<td>允许在会话中变换用户的身份机制</td>
</tr>
<tr>
<td>13</td>
<td>Java Authentication and Authorization Service JAAS</td>
<td>Java 验证和授权API</td>
</tr>
<tr>
<td>14</td>
<td>Java EE container authentication</td>
<td>允许系统继续使用容器管理这种身份验证方式</td>
</tr>
<tr>
<td>15</td>
<td>Kerberos</td>
<td>使用对称密钥机制，允许客户端与服务器相互确认身份验证协议</td>
</tr>
</tbody></table>
<h3 id="授权"><a href="#授权" class="headerlink" title="授权"></a>授权</h3><p>授权的过程是指用户通过认证之后，是否允许对某个功能的操作过程。我们可以假设授权是指你家里的客人开完门之后，是否可以进入你的主卧，需要征得你的同意。这里我们可分为用户和管理员两个核心的概念，你是家里的主人，即管理员，客人是用户，是否能进入某个地方需要征得你的同意。</p>
<p>除以上之外，Spring security还引入了很多的第三方包用于支持更多的认证技术，Spring security允许编写自己独一无二的认证技术，在绝大的情况下，既然使用 Spring boot 、 spring 开发项目，使用自家的spring security岂不是更好？且完美。除了认证以外，在授权上，Spring srcurity不仅仅支持基于URL的web请求授权，还支持方法访问授权对象授权等，覆盖了大部分的授权范围和场景。</p>

	

	

</article>




	<article>
	
		<h1><a href="/2022/04/21/java/spring cloud/9.Spring cloud Gateway/">Spring cloud Gateway</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2022-04-21</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-none-link" href="/tags/java/" rel="tag">java</a> <a class="article__tag-none-link" href="/tags/spring-cloud/" rel="tag">spring cloud</a>
			</span>
		
	</div>

	

	
		<p><img src="https://49812933408852955071488026628034-1301075051.cos.ap-nanjing.myqcloud.com/20210708123502.png"><br>Gateway 是 Spring cloud 官方所推出的第二代网关（API Gateway）框架，在为服务系统中，网关的主要作用就是当用户调用的所有微服务，都要经过网关。</p>
<blockquote>
<p>在为服务中，除于不同微服务可能会带来不同的开发语言和协议，因此需要通过网关来处理服务的调用</p>
</blockquote>
<p>网关统一向外部系统提供 REST API，在 Spring cloud 中，使用 Zuul、Gateway 等作为网关可以实现出动态路由、监控、回退、安全功能等。</p>
<h2 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h2><p>Gateway 基于 <code>Spring Framework 5、Project Reactor 、Spring boot 2.0</code> 构建，可以匹配任何请求属性的路由，能编写谓词（Predicates）以及过滤器（Filters）等。</p>
<blockquote>
<p>谓词主要是用于确定给定输入的 true 或 false，在网关中谓词和过滤器也可以用于特定的路由。</p>
<blockquote>
<p>过滤器可以重写数据，但由于 Gateway 是异步的，如果需要对响应的 body 进行修改需要使用 <code>writeWith()</code> 所提供的 <code>GlobalFilter、GatewayFilter</code> 类型。</p>
<blockquote>
<p>其中 <code>GlobalFilter</code> 是对所有路由有效的，而 <code> GatewayFilter</code> 类型仅对指定范围生效</p>
</blockquote>
</blockquote>
</blockquote>
<p>除此之外 Gateway 还支持路径重写、动态路由和集成了 Hystrix 断路器以及 <code>DiscoveryClient</code> 的集成和限流。</p>
<h2 id="工作流程"><a href="#工作流程" class="headerlink" title="工作流程"></a>工作流程</h2><p><img src="https://49812933408852955071488026628034-1301075051.cos.ap-nanjing.myqcloud.com/20210708123510.png"></p>
<p>首先 HTTP&#x2F;HTTPS 强求 Spring cloud Gateway，<code>DispatcherHandler</code> 接受请求，并通过 <code>RoutePredicateHandlerMapping</code> 进行路由匹配，<strong>如果网关路由与请求的路由进行匹配</strong> 则将请求发送到 <code>FilteringWebHandler</code>，如果不匹配，那么则将请求发送给 <code>DispatcherHandler</code> 进行处理。</p>
<p>最后 <code>FilteringWebHandler</code> 通过自定义的过滤器来发送请求，这会将请求转发到具体的服务中，最后处理结果给用户。</p>
<h2 id="谓词接口和谓词工厂"><a href="#谓词接口和谓词工厂" class="headerlink" title="谓词接口和谓词工厂"></a>谓词接口和谓词工厂</h2><p>谓词（Predicate），在 Java 8 中引入的一个函数式接口，<strong>主要用于接受输入参数并返回布尔值的结果</strong>，Spring cloud Gateway 通过 Predicate 接口来判断当前路由是否满足指定条件。</p>
<blockquote>
<p>谓词工厂（Route Predicate Factories）主要作用就是当符合谓词条件就使用该路由进行匹配，否则就忽略。</p>
</blockquote>
<p>Spring cloud Gateway 的路由规则是由 <code>RouteDefinitionLocator</code> 类进行管理，默认情况下使用 Spring Boot 的 <code>@ConfigurationProperties</code> 机制来加载属性。</p>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><h4 id="Java-API"><a href="#Java-API" class="headerlink" title="Java API"></a>Java API</h4><p><img src="https://49812933408852955071488026628034-1301075051.cos.ap-nanjing.myqcloud.com/20210708123517.png"><br>可以通过最简单的 Java API 的方式来构建路由，主要通过 <code>@Bean</code> 来实现一个自定义的 <code>RouteLocator</code> 类来实现 <strong>自定义路由转发规则</strong>。在此之前，需要通过添加 gateway 依赖来完成：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-gateway&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>由于 Spring cloud gateway 使用的是 <strong>Netty+WebFlux</strong> 实现的，因此不需要引入 Web 模块依赖。</p>
</blockquote>
<p>之后在启动类添加自定义 RouteLocator 类即可：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.route.RouteLocator;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.route.builder.RouteLocatorBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将请求转发给 baidu.com</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> kunlun</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/7/8</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DemoApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(DemoApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RouteLocator <span class="title function_">routeLocator</span> <span class="params">(RouteLocatorBuilder builder)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> builder.routes().</span><br><span class="line">                route(<span class="string">&quot;guonei&quot;</span>, r -&gt; r.path(<span class="string">&quot;/guonei/**&quot;</span>)</span><br><span class="line">                        .uri(<span class="string">&quot;http://news.baidu.com/&quot;</span>)).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在上述的过程中，<code>route</code> 主要将与 <strong>guonei</strong> 路由想匹配的通过 <code>Spring cloud Gateway</code> 转发到了 <a target="_blank" rel="noopener" href="http://news.baidu.com/guonei">http://news.baidu.com/guonei</a> 中，因此访问 <a target="_blank" rel="noopener" href="http://localhost:8081/guonei">http://localhost:8081/guonei</a> 就是访问 <a target="_blank" rel="noopener" href="http://news.baidu.com/guonei">http://news.baidu.com/guonei</a></p>
<p>其中 <code>r.path</code> 参数下的 <code>/guonei/**</code> 指的是这将会匹配包含所有任何后缀携带 <code>/guonei</code> 的路径模式，还需要注意的是 Spring cloud Gateway 支持两种的配置，上面所实现的是基于RouteLocator 的实现，还有 properties 配置文件的实现</p>
<h4 id="application-yml-x2F-application-proerties"><a href="#application-yml-x2F-application-proerties" class="headerlink" title="application.yml &#x2F; application.proerties"></a>application.yml &#x2F; application.proerties</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">guonei</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://news.baidu.com/</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/guonei</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">GatewayForward</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8081</span></span><br></pre></td></tr></table></figure>

<p>与 Java API 一样，访问 <a target="_blank" rel="noopener" href="http://localhost:8081/guonei">http://localhost:8081/guonei</a> 就是访问 <a target="_blank" rel="noopener" href="http://news.baidu.com/guonei">http://news.baidu.com/guonei</a>，同样的实现了路由的功能。</p>
<h3 id="路由谓词工厂或路由规则（RoutePredicateFactory）"><a href="#路由谓词工厂或路由规则（RoutePredicateFactory）" class="headerlink" title="路由谓词工厂或路由规则（RoutePredicateFactory）"></a>路由谓词工厂或路由规则（RoutePredicateFactory）</h3><p>在 Gateway 中，主要通过 RoutePredicateFactory（谓词工厂）来创建谓词（Predicate），因此也提供了很多种谓词工厂，这也是在上面所提到的：“谓词工厂（Route Predicate Factories）主要作用就是当符合谓词条件就使用该路由进行匹配，否则就忽略。” </p>
<p>通过谓词工厂，使得开发人员可以简单配置即可获得很多需要和想要的路由规则，及谓词（Predicate），这些路由规则会根据 HTTP 请求进行不同属性来匹配，其中最为主要的为下述几类：</p>
<table>
<thead>
<tr>
<th>RoutePredicateFactory</th>
<th>type</th>
<th>info</th>
</tr>
</thead>
<tbody><tr>
<td>AfterRoute……(省略 PredicateFactory)</td>
<td>datetime</td>
<td>请求时间满足在配置时间之后</td>
</tr>
<tr>
<td>BeforeRoute</td>
<td>datetime</td>
<td>请求时间满足在配置时间之前</td>
</tr>
<tr>
<td>BetweenRoute</td>
<td>datetime</td>
<td>请求时间满足在配置时间之前</td>
</tr>
<tr>
<td>CookieRoute</td>
<td>Cookie</td>
<td>请求指定了 Cookie 正则匹配的指定值</td>
</tr>
<tr>
<td>HeaderRoute</td>
<td>Header（数据头）</td>
<td>请求指定了请求上下文所匹配的指定值</td>
</tr>
<tr>
<td>CloudFoundryRouteServiceRoute</td>
<td>Header</td>
<td>请求 Headers 是否包含了指定的名称</td>
</tr>
<tr>
<td>MethodRoute</td>
<td>Method（方法）</td>
<td>请求的方法是否匹配配置的方法</td>
</tr>
<tr>
<td>PathRoute</td>
<td>Path（路径）</td>
<td>请求路径是否匹配指定值</td>
</tr>
<tr>
<td>Query</td>
<td>Queryparam（查询参数）</td>
<td>请求查询的查询参数与配置文件的相匹配</td>
</tr>
<tr>
<td>RemoteAddreRoute</td>
<td>Remoteaddr（远程地址）</td>
<td>远程地址是否匹配指定值</td>
</tr>
<tr>
<td>HostRoute</td>
<td>Host（主机）</td>
<td>请求主机是否匹配指定值</td>
</tr>
</tbody></table>
<h4 id="After"><a href="#After" class="headerlink" title="After"></a>After</h4><p>AfterRoutePredicateFactory（After路由谓词工厂）是一个 <code>datetime（日期时间）</code> 类型的为此，他主要表达的是如果请求在配置文件中 <strong>时间在配置文件之后</strong> 发生的请求允许。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">after</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://news.baidu.com/</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">After=2022-01-20T18:06:06+08:00[Asia/Shanghai]</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">GatewayForward</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8081</span></span><br></pre></td></tr></table></figure>

<p>After 的核心意思就是只能在配置规定后的时间进行访问，但只能通过 UTC + 时区的方式来添加规则，否则将直接报错。After 的主要作用就是在 2021 年 1 月 20 日之后才可进行访问，否则将会直接报错，直接访问 <a target="_blank" rel="noopener" href="http://localhost:8081/">http://localhost:8081/</a> 即可。</p>
<h4 id="Before"><a href="#Before" class="headerlink" title="Before"></a>Before</h4><p>Before 也是属于 <code>datetime</code> 类型之一，其核心含义是当请求满足配置时间之前，而之前的 <code>After</code> 路由谓词工厂只是满足配置时间之后：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">after</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://news.baidu.com/</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Before=2022-01-20T18:06:06+08:00[Asia/Shanghai]</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">GatewayForward</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8081</span></span><br></pre></td></tr></table></figure>

<h4 id="Between"><a href="#Between" class="headerlink" title="Between"></a>Between</h4><p>Between 可以理解为是两个 UTC 时间之间的请求，因此他有两个参数，分别是 datetime1 以及 datetime2 这是一个 ZonedDateTime 对线，因此请求需要满足 datetione1 之后且 datetime2 之前的请求：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">after</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://news.baidu.com/</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Between=2019-01-20T18:06:06+08:00[Asia/Shanghai],2022-01-20T18:06:06+08:00[Asia/Shanghai]</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">GatewayForward</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>如上面的 <code>Between</code> 路由规则是，在 2019-01-20T18:06:06+08:00[Asia&#x2F;Shanghai] 之后，2022-01-20T18:06:06+08:00[Asia&#x2F;Shanghai] 之前的请求将会进行匹配，否则将会忽视。</p>
<h4 id="Cookie"><a href="#Cookie" class="headerlink" title="Cookie"></a>Cookie</h4><p>CookieRoutePredicateFactory 主要用于匹配指定值，虽然很多作者说直接可以一条参数走到低：<code>mycookie,mycookievalue</code>，但很遗憾并没有作用，因此只能通过全展开的方式来实现：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">after</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://news.baidu.com/</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Cookie</span></span><br><span class="line">              <span class="attr">args:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">meteor_login_token</span></span><br><span class="line">                <span class="attr">regexp:</span> <span class="string">ipQdtc89kEO7-JaBWLdgwPHzX9oDy6l-2qXmZ_OeHye</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">GatewayForward</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8081</span></span><br></pre></td></tr></table></figure>

<p>在上述的 cookie 中，主要指定了 cookie 名字 <code>meteor_login_token</code>，以及 cookie_value <code>ipQdtc89kEO7-JaBWLdgwPHzX9oDy6l-2qXmZ_OeHye</code>，因此如果请求的 cookie 与配置文件相匹配则通过，否则将会忽略。</p>
<h4 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h4><p>Header 即请求上下文的头部信息，当请求与配置的 Header 一致时进行转发，在官方文档中被称之为：<code>X-Request-Id</code> 与正则表达式合在一起进行匹配，<strong>但并没有什么作用</strong>。因此我们可以理解为 Header 请求头是根据上下文头部信息来指定服务器的域名和服务器正在侦听的 TCP 端口号：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">after</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://news.baidu.com/</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Header=Host,localhost:8081</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">GatewayForward</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8081</span></span><br></pre></td></tr></table></figure>

<p>当请求的上下文头部信息与配置文件相互匹配则允许请求，否则将会直接进行忽略。</p>
<h4 id="Host"><a href="#Host" class="headerlink" title="Host"></a>Host</h4><p>Host 路由谓词工厂与 Header 类似，或者说两者都可以实现其效果，但 Host 路由谓词工厂很明显比 Hedaer 更加的简单且好理解。因此他主要的作用就是匹配所请求的主机是否和配置文件相互一致，否则将不具备转发功能：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">after</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://news.baidu.com/</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Host=localhost:8081</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">GatewayForward</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8081</span></span><br></pre></td></tr></table></figure>

<p>在上述配置文件中，请求的主机是 <code>localhost:8081</code> 因此与配置文件的信息相互匹配，可以通过网关使用路由进行跳转。</p>
<h4 id="Method"><a href="#Method" class="headerlink" title="Method"></a>Method</h4><p><img src="https://49812933408852955071488026628034-1301075051.cos.ap-nanjing.myqcloud.com/20210709153656.png"><br>Method 路由谓词工厂相比上述几个 <code>header</code> 类型的谓词工厂显得特别实用，他主要用指定访问资源以响应预检请求时允许的方法：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">after</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://news.baidu.com/</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Method=GET,POST</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">GatewayForward</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8081</span></span><br></pre></td></tr></table></figure>

<p>就比如上述的配置文件，我们允许了 <code>GET，POST</code> 方法请求，但不允许 <code>PUT</code> 方法请求，因此使用该方法请求将会直接被网关所进行拦截。</p>
<h4 id="Query"><a href="#Query" class="headerlink" title="Query"></a>Query</h4><p><img src="https://49812933408852955071488026628034-1301075051.cos.ap-nanjing.myqcloud.com/20210709230650.png"><br>Query 路由谓词工厂主要是当 <strong>请求查询的查询参数与配置文件的相匹配</strong>，就比如 <code>localhost:8081?name=111</code> 正好与配置文件中的 <code>query=name</code> 的 <code>name</code> 相互匹配，则允许请求：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">after</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://news.baidu.com/</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Query=name</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">GatewayForward</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8081</span></span><br></pre></td></tr></table></figure>

<h4 id="RemoteAddre"><a href="#RemoteAddre" class="headerlink" title="RemoteAddre"></a>RemoteAddre</h4><p><img src="https://49812933408852955071488026628034-1301075051.cos.ap-nanjing.myqcloud.com/20210709230658.png"></p>
<p>RemoteAddre 与 Header 路由谓词工厂类似，简单理解就是他们的进阶版，他可以根据 CIDR 表示法进行匹配，也就是说当你写入规则是 <code>192.168.0.1/24</code> 时，你 <code>192.168.0.104/24</code> 也可以请求此接口，但如果你不是这个网段下的，则会被拒绝</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">        - id: remoteaddr_route</span><br><span class="line">          uri: http:<span class="comment">//news.baidu.com</span></span><br><span class="line">          predicates:</span><br><span class="line">            - RemoteAddr=<span class="number">192.168</span><span class="number">.0</span><span class="number">.1</span>/<span class="number">24</span></span><br><span class="line"></span><br><span class="line">  application:</span><br><span class="line">    name: GatewayForward</span><br><span class="line"></span><br><span class="line">server:</span><br><span class="line">  port: <span class="number">8081</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>localhost 是 127.0.0.1 的地址映射，因此在 RemoteAddr 路由谓词工厂规则中他会被直接拒绝。</p>
</blockquote>
<h4 id="Weight"><a href="#Weight" class="headerlink" title="Weight"></a>Weight</h4><p><img src="https://49812933408852955071488026628034-1301075051.cos.ap-nanjing.myqcloud.com/20210709232130.png"><br>Weight 是权重路由谓词工厂，当 Gateway 中有多个路由网关配置时可以发挥作用，他主要分为 <strong>组（group）</strong> 以及 <strong>权重（weight）</strong> 进行组合：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">weight_one</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://news.baidu.com</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Weight=group1,</span> <span class="number">1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">weight_two</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://baidu.com</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Weight=group1,</span> <span class="number">8</span></span><br></pre></td></tr></table></figure>

<p>就比如上述的配置中，<code>weight_two</code> 的权重比 <code>weight_one</code> 高，因此网关匹配的是 <code>weight_two</code> 的路由。</p>
<h3 id="Gateway-consul-服务转发"><a href="#Gateway-consul-服务转发" class="headerlink" title="Gateway consul 服务转发"></a>Gateway consul 服务转发</h3><p><img src="https://49812933408852955071488026628034-1301075051.cos.ap-nanjing.myqcloud.com/20210710193849.png"><br>在正常的微服务架构中，都会选择依赖服务中心来进行注册，这通常需要对每个服务提供者进行单独的配置，Gateway 的出现爱你提供了默认转发的工作，<strong>当网关注册到服务中心后，网关则会代替服务中心来提供转发的服务</strong>：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-consul-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>


<h4 id="application-yml"><a href="#application-yml" class="headerlink" title="application.yml"></a>application.yml</h4><p>在 <code>application.yml</code> 配置文件中，需要开启服务转发的选项，即<code> spring.cloud.gateway.discovery.locator.enabled</code> 即可，之后在启动类中添加 <code>@EnableDiscoveryClient</code> 注解以此来实现服务发现：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">Gateway</span> <span class="string">Consul</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">consul:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8500</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">locator:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8515</span></span><br></pre></td></tr></table></figure>


<h2 id="过滤器（Filter）"><a href="#过滤器（Filter）" class="headerlink" title="过滤器（Filter）"></a>过滤器（Filter）</h2><h3 id="过滤器的存在"><a href="#过滤器的存在" class="headerlink" title="过滤器的存在"></a>过滤器的存在</h3><p>过滤器之所以在网关中存在，是因为在微服务系统中，服务提供者非常的多，因此如果在每个服务中都有诸如鉴权、限流以及日志输出等则会占用服务的消耗（也就是说每个服务我都要写一遍这些功能，则会让开发很烦躁）因此可以直接通过网关来进行处理。</p>
<blockquote>
<p>网关应可以处理鉴权、限流等工作</p>
</blockquote>
<h4 id="PRE-and-POST"><a href="#PRE-and-POST" class="headerlink" title="PRE and POST"></a>PRE and POST</h4><h5 id="PRE"><a href="#PRE" class="headerlink" title="PRE"></a>PRE</h5><p>根据请求的生命周期，在 Gateway 中，过滤器会分为 <strong>PRE、POST</strong> 两种，其中 PRE 代表 <strong>在路由执行之前的请求</strong> 执行该过滤，因此主要应用在参数校验、鉴权、流量监控、日志输出、协议转换功能。</p>
<h5 id="POST"><a href="#POST" class="headerlink" title="POST"></a>POST</h5><p>POST 主要是在 <strong>请求被路由跳到微服务之后所执行</strong> 的过滤器，因此这种过滤器可以实现出相应头（HTTP Header）以及收集统计信息和指标、响应转发、日志输出、流量监控等功能。</p>
<h4 id="GatewayFilter-and-GlobalFilter"><a href="#GatewayFilter-and-GlobalFilter" class="headerlink" title="GatewayFilter and GlobalFilter"></a>GatewayFilter and GlobalFilter</h4><h5 id="GatewayFilter-网关过滤器"><a href="#GatewayFilter-网关过滤器" class="headerlink" title="GatewayFilter (网关过滤器)"></a>GatewayFilter (网关过滤器)</h5><p>过滤器分为两类，其中网关过滤器（GatewayFilter）只会在 <strong>单个路由或者分组路由中</strong>。网关过滤器是一种 <strong>可以修改请求传入的 HTTP 请求或输出 HTTP 相应</strong> 的特定路由使用，Gateway 内置了 20 多种网关过滤器工厂来编写网关过滤器：</p>
<table>
<thead>
<tr>
<th>Id</th>
<th>Name</th>
<th>type</th>
<th>Info</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>AddRequestHeader</td>
<td>Request</td>
<td>用于在请求头中添加自定义的键值对</td>
</tr>
<tr>
<td>2</td>
<td>AddRequestParameter</td>
<td>Request</td>
<td>用于在请求参数中添加请求参数的键值对</td>
</tr>
<tr>
<td>3</td>
<td>AddResponseHeader</td>
<td>Response</td>
<td>用于在相应头中添加</td>
</tr>
<tr>
<td>4</td>
<td>Hystrix</td>
<td>断路器</td>
<td>用于将断路器引入网关路由中，可以让服务免受级联故障影响，并在故障时提供回退响应（使用时需要使用名为 <code>HystrixCommand</code> 的参数）</td>
</tr>
<tr>
<td>5</td>
<td>PrefixPath</td>
<td>Path</td>
<td>用于使用简单的 Prefix</td>
</tr>
<tr>
<td>6</td>
<td>PreserveHostHeader</td>
<td>Header</td>
<td>设置路由过滤器的请求属性，检查是否发送原主机头或由 HTTP 客户端确定主机头</td>
</tr>
<tr>
<td>7</td>
<td>RequestRateLimiter</td>
<td>Request</td>
<td>用于确定当前请求是否继续（如果不允许则会返回 <code>HTTP 429 - Too Many Request</code> ）</td>
</tr>
<tr>
<td>8</td>
<td>RedirectTo</td>
<td>Request</td>
<td>用于接受请求的状态和 URL 参数（该状态是一个重定向的 300 系列 HTTP 代码，类似与 301。但 URL 是 Location 头部的值）</td>
</tr>
<tr>
<td>9</td>
<td>RemoveNonProxyHeaders</td>
<td>Headers</td>
<td>从转发的请求中删除请求头</td>
</tr>
<tr>
<td>10</td>
<td>RemoveRequestHeader</td>
<td>Request</td>
<td>通过请求头名删除请求头</td>
</tr>
<tr>
<td>11</td>
<td>RemoveResponseHeader</td>
<td>Response</td>
<td>通过响应头名删除响应头</td>
</tr>
<tr>
<td>12</td>
<td>RewritePath</td>
<td>Path</td>
<td>通过 Java 正则表达式重写请求路径</td>
</tr>
<tr>
<td>13</td>
<td>SaveSession</td>
<td>Session</td>
<td>在转发下游调用之前，强制执行保存 Session 的操作</td>
</tr>
<tr>
<td>14</td>
<td>SecureHeaders</td>
<td>Headers</td>
<td>为响应头添加安全头</td>
</tr>
<tr>
<td>15</td>
<td>SetPath</td>
<td>Path</td>
<td>该方法允许通过路径的模板段来操作请求路径，使用 Spring 的 URI 模板，支持多种匹配</td>
</tr>
<tr>
<td>16</td>
<td>SetResponseHeader</td>
<td>Response</td>
<td>需要通过 Key-Value 对来设置响应头</td>
</tr>
<tr>
<td>17</td>
<td>SetStatus</td>
<td>Response</td>
<td>用于设置请求响应状态，但需要 <code>Status</code> 参数（需要有效的 <code>Spring HttpStatus</code>，例如整形的 404 或枚举类型字符串 <code>NOT_FOUND</code>）</td>
</tr>
<tr>
<td>18</td>
<td>StripPrefix</td>
<td>Request</td>
<td>用于剥离前缀（需要 <code>parts</code> 参数，用于表明请求被发送到下游之前从请求路径中所剥离的元素数量）</td>
</tr>
<tr>
<td>19</td>
<td>Retry</td>
<td>Request</td>
<td>主要用于重试，但需要 Retries、Statuses、Methods、Series 等参数</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td>Retries：重试的次数</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td>Statuses：重试的 HTTP 状态码（通过 <code>org.springframework.http.HttpStatus</code> 表示）</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td>Methods：重试的 HTTP 状态码（通过 <code>org.springframework.http.HttpMethod</code> 表示）</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td>Series：重试的状态码（通过 <code>org.springframework.http.HttpStatus.Series</code> 表示）</td>
</tr>
<tr>
<td>20</td>
<td>RequestSize</td>
<td>Request</td>
<td>用于限制请求大小，当请求超过限制时启用，限制请求达到下游服务，该过滤器将 RequestSize 作为参数</td>
</tr>
</tbody></table>
<h6 id="AddRequestHeader（在请求头中添加自定义的键值对）"><a href="#AddRequestHeader（在请求头中添加自定义的键值对）" class="headerlink" title="AddRequestHeader（在请求头中添加自定义的键值对）"></a>AddRequestHeader（在请求头中添加自定义的键值对）</h6><p><img src="https://49812933408852955071488026628034-1301075051.cos.ap-nanjing.myqcloud.com/20210713131356.png"></p>
<p>AddRequestHeader 即主要在请求头中来添加自定义的键值对，其主要将应用过滤器 <code>AddRequestHeader=X-Request-Name,X-Request-Value</code> 应用并添加至请求头中：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">Gateway</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">/guonei</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://news.baidu.com</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Method=GET</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">AddRequestHeader=X-Request-Name,X-Request-Value</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8210</span></span><br><span class="line"></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">ROOT:</span> <span class="string">DEBUG</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><figcaption><span>会将 ```X-Request-Name</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">###### AddRequestParameter (添加请求参数)</span><br><span class="line">![](https://49812933408852955071488026628034-1301075051.cos.ap-nanjing.myqcloud.com/20210713131345.png)</span><br><span class="line"></span><br><span class="line">AddRequestParameter 主要的作用就是在请求头（Header）中添加请求参数的键值对，即将 ```RouteDefinition /guonei``` 过滤器 ```_genkey_0=KEY_NAME, _genkey_1=KEY_VALUE``` 应用在 ```AddRequestParameter``` （添加请求参数）中</span><br><span class="line"></span><br><span class="line">```yml</span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: Gateway</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">        - id: /guonei</span><br><span class="line">          uri: http://news.baidu.com</span><br><span class="line">          predicates:</span><br><span class="line">            - Method=GET</span><br><span class="line">          filters:</span><br><span class="line">            - AddRequestParameter=KEY_NAME,KEY_VALUE</span><br><span class="line"></span><br><span class="line">server:</span><br><span class="line">  port: 8210</span><br><span class="line"></span><br><span class="line">logging:</span><br><span class="line">  level:</span><br><span class="line">    ROOT: DEBUG</span><br></pre></td></tr></table></figure>
<p>这回将 <code>KEY_NAME=KEY_VALUE</code> 添加到所有匹配请求的下游请求所查询的字符串中，<code>AddRequestParameter</code> 即添加请求参数会用于匹配路径或主机的 URI 变量。</p>
<h6 id="AddResponseHeader-添加响应头"><a href="#AddResponseHeader-添加响应头" class="headerlink" title="AddResponseHeader (添加响应头)"></a>AddResponseHeader (添加响应头)</h6><p><img src="https://49812933408852955071488026628034-1301075051.cos.ap-nanjing.myqcloud.com/20210713202834.png"></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">Gateway</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">/guonei</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://news.baidu.com</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Method=GET</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">AddResponseHeader=X-Response-Name,X-Response-Value</span>    </span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8210</span></span><br><span class="line"></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">ROOT:</span> <span class="string">DEBUG</span></span><br></pre></td></tr></table></figure>

<p>此刻 <code>AddResponseHeader</code> 会将 <code>X-Response-Name=X-Response-Value</code> 所添加至响应头中。</p>
<h6 id="Hystrix"><a href="#Hystrix" class="headerlink" title="Hystrix"></a>Hystrix</h6><p><img src="https://49812933408852955071488026628034-1301075051.cos.ap-nanjing.myqcloud.com/20210716191257.png"><br>路由容错控制器的主要的运用场景就是在遇到超时、服务器端错误来发挥作用，通过 Gateway 来集成 Hystrix（含 resilience4j）通过过滤器来加入 <code>fallbackUri</code> 得以实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 容错控制器</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> kunlun</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/7/16</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NotFoundController</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/fallback&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Map&lt;String, String&gt;&gt; <span class="title function_">notFound</span><span class="params">()</span> &#123;</span><br><span class="line">        Map&lt;String, String&gt; stringMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        stringMap.put(<span class="string">&quot;code&quot;</span>, <span class="string">&quot;503&quot;</span>);</span><br><span class="line">        stringMap.put(<span class="string">&quot;data&quot;</span>, <span class="string">&quot;Current service is unavailable&quot;</span>);</span><br><span class="line">        stringMap.put(<span class="string">&quot;gateway&quot;</span>, <span class="string">&quot;GatewayConfigurationFaultToleranceRouting&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> Mono.just(stringMap);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>.</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">GatewayConfigurationFaultToleranceRouting</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">hey</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://service-provider/hey</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/hey</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Method=GET</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">AddRequestParameter=name,key</span></span><br><span class="line">            <span class="comment"># 服务熔断后使用的地址 @RequestMapping(value = &quot;/fallback&quot;)</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CircuitBreaker</span></span><br><span class="line">              <span class="attr">args:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">fallback</span></span><br><span class="line">                <span class="attr">fallbackUri:</span> <span class="string">forward:/fallback</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">locator:</span></span><br><span class="line">          <span class="comment"># 允许服务发现</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">consul:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8500</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">service-name:</span> <span class="string">service-provider</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8210</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>需要注意的是由于我们这个是熔断，需要服务提供者的存在，因此你可以将服务提供者快速关闭来达到他短时间无法提供服务，之后网关才可认定这是由于服务出错导致的，如果直接关闭服务提供者那返回的只是 404</p>
</blockquote>
<p>最后启动 consul 集群以及服务提供者，通过 GET 方式请求 <code>http://localhost/hey</code> 即可完成路由容错控制器的实现，当然你也可以直接通过 <code>lb://service-provider</code> 来进行配置你的服务路由。</p>
<h5 id="GlobalFilter-全局过滤器"><a href="#GlobalFilter-全局过滤器" class="headerlink" title="GlobalFilter (全局过滤器)"></a>GlobalFilter (全局过滤器)</h5><p>另一种则为全局过滤器（GlobalFilter）这种过滤器与网关过滤器的区别是会 <strong>应用到所有路由中</strong>，在 Gateway 内置中，有九种全局过滤器：</p>
<table>
<thead>
<tr>
<th>Id</th>
<th>Name</th>
<th>Info</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>Forward Routing Filter</td>
<td>在 exchange 的 <code>ServerWebExchangeUtils.GATEWAY_REQUEST_URL_ATTR</code> 属性值中查找 URI（如果 URI 是 forward 协议，则将它用于 DispatcherHandler (调度程序处理程序) 处理请求）</td>
</tr>
<tr>
<td>2</td>
<td>LoadBalancerClient Filter</td>
<td>在 exchange 的 <code>ServerWebExchangeUtils.GATEWAY_REQUEST_URL_ATTR</code> 值中查找 URI，如果 URI 是 lb 协议，则会使用 Spring cloud LoadBalancerClient 将名称（lb:&#x2F;&#x2F;myservice 中的 myservice）解析为实际的主机和端口，并替换 URI 中相同属性。（除此过滤器还会查看 <code>ServerWebExchangeU体力是。GATEWAY_SCHEME_PREFIX_ATTR</code> 属性来判断他是否等于 <strong>lb</strong> ）</td>
</tr>
<tr>
<td>3</td>
<td>Netty Routing Filter</td>
<td>假设 <code>ServerWebExchangeUtils.GATEWAY_REQUEST_URL_ATTR</code> 中的 URI 使用的是 HTTP 或 HTTPS 协议，则运行 Netty Routing Filter。他用 Netty HttpClient 所发出的下游代理请求。相应应该放在 <code>ServerWebExchangeUtils.CLIENT_RESPONSE_ATTR</code> 的 exchange 中以便在以后的过滤器中使用</td>
</tr>
<tr>
<td>4</td>
<td>Netty Write Response Filter</td>
<td>当 <code>ServerWebExchangeUtils.CLIENT_RESPONSE_ATTR</code> 值中存在 <code>NettyHttpClientResponse</code> 则会运行 Netty Write Response Filter。（他在所有其他过滤器完成后运行，并将代理相应写回到网关客户端的响应数据中）</td>
</tr>
<tr>
<td>5</td>
<td>RouteToRequestUriFilter</td>
<td>如果 <code>ServerWebExchangeUtils.GATEWAY_ROUTE_ATTR</code> 值中存在 Route 对象，则会将路由到请求地址，他会根据请求 URI 创建一个新的 URI。新的 URI 则会位于 <code>ServerWebExchangeUtils.GATEWAY_REQUEST_URI_ATTR</code> 值中（假设 URI 具有协议前缀，如 <code>lb:ws://serviceid</code> 则会将从 URI 中所剥离 lb 协议，并防止在 <code>ServerWebExchangeUtils.GATEWAY_SCHEMEPREFIX_ATTR</code> 中以便稍后在过滤器中所使用）</td>
</tr>
<tr>
<td>6</td>
<td>Websocket Routing Filter</td>
<td>假设 <code>ServerWebExhcangeUtils.GATEWAY_REQUEST_URL_ATTR</code> 值中的 URI 是 ws 或 wss 协议，则运行 <code>Websocket Routing Filter</code> （利用 Spring Web Socket 底层代码将 WebSocket 请求转发到下游）</td>
</tr>
<tr>
<td></td>
<td></td>
<td>也可以通过 URI 前面添加 lb 来对 Websocket 来进行负载均衡，如 <code>lb:ws://serviceid</code>（需要注意的是如果在普通 HTTP 上使用 SockJS 来作为回退，则会匹配正常的 HTTP 路由以及 <code>Websocket</code> 路由）</td>
</tr>
<tr>
<td>7</td>
<td>Gateway Metrics Filter</td>
<td>使用需要添加 <code>spring-boot-starter-actuator</code> 依赖，默认会通过 <code>spring.cloud.gateway.mertics.enable</code> 设置为 <code>false</code> Gateway Metrics Filter 才会运行。该过滤器会添加一个名为 <code>gateway.request</code> 指标（Metrics），并包含四个属性：</td>
</tr>
<tr>
<td></td>
<td></td>
<td>routeId：路由器 ID</td>
</tr>
<tr>
<td></td>
<td></td>
<td>routeUri：API将会被路由转到 URI</td>
</tr>
<tr>
<td></td>
<td></td>
<td>outcome：由 <code>HttpStatus.Series</code> 所分类的结果</td>
</tr>
<tr>
<td></td>
<td></td>
<td>status：HTTP 请求返回给客户端的状态</td>
</tr>
<tr>
<td>8</td>
<td>Combined Global Filter and GatewayFilter Ordering（组合是全局过滤器和网管过滤器排序）</td>
<td>当请求进入并匹配到一个路由时， Filtering Web Handler 会将 GlobalFilter 的所有实例和 GatewayFilter 的所有路由特定实例添加到过滤器链中。（这个组合的过滤器链由 <code>org.springframeworking.core.Ordered</code> 接口的排序，并通过 <code>gegOrder()</code> 方法或注解 <code>@Order</code> 来设置）同时网关也会对过滤器逻辑执行的 “PRE” 和 ”POST“ 阶段来进行区分</td>
</tr>
<tr>
<td>9</td>
<td>Marking An Exchange As Routed （路由交换）</td>
<td>网关在路由 WEB 服务交换后（ServerWebExchange），会将 <code>Gateway Already Routed</code> 添加到 exchange 属性来将该交换标识为 ”路由”（一旦被请求标识为路由，则其他的路由过滤器会跳过该请求，也可以通过便携方法将交换标识为路由，或检查交换是否已经成为路由）</td>
</tr>
</tbody></table>
<blockquote>
<p>更多可以参考 <a target="_blank" rel="noopener" href="https://cloud.spring.io/spring-cloud-gateway/reference/html/#the-addrequestheader-gatewayfilter-factory">https://cloud.spring.io/spring-cloud-gateway/reference/html/#the-addrequestheader-gatewayfilter-factory</a> - Spring cloud gateway 官方文档</p>
</blockquote>
<h2 id="限流"><a href="#限流" class="headerlink" title="限流"></a>限流</h2><p><img src="https://49812933408852955071488026628034-1301075051.cos.ap-nanjing.myqcloud.com/20210723224018.png"></p>
<p>限流的主要目的是防止过渡的消耗资源，从而来保障服务对所有用户的可用性，常见的限流措施如诸以限制并发数为目的的数据库连接池&#x2F;线程池，以及瞬时并发数的限制，和限制每秒的平均速率都是最为常见的。而这些基本上都会在网关层上进行实现，如使用 nginx、zuul、gateway、openresty、kong 等方式进行限流。</p>
<blockquote>
<p>以维基百科的话来说就是在计算机网络中，控制网络接口请求速率</p>
</blockquote>
<p><img src="https://49812933408852955071488026628034-1301075051.cos.ap-nanjing.myqcloud.com/20210723224217.png"></p>
<p>如果没有进行限流的话，则有几率会被恶意提交，导致后续服务无法得到提供，从而达到拒绝服务攻击，而限流在高并发中，是一个必不可少的一个因素之一，通过限流发挥的作用从而保护用户的可用性，甚至防止一些恶意请求等问题的发生。</p>
<h3 id="限流算法"><a href="#限流算法" class="headerlink" title="限流算法"></a>限流算法</h3><h4 id="计数器算法（固定窗口）"><a href="#计数器算法（固定窗口）" class="headerlink" title="计数器算法（固定窗口）"></a>计数器算法（固定窗口）</h4><p>计数器算法是一个简单以及暴力的，他从第一个请求开始计数，在假设我们设置一个 QPS（每秒查询数为 100），一秒内请求超过了设定值，那么接下来的请求都会被拒绝，等过一秒后才可继续查询，这时会将计数恢复成0。</p>
<p>看似这个算法很好且可以解决一些简单的问题，但这个算法也存在的一些问题，如我在 100ms 内通过了 100 个请求，则后续的 900ms 内的请求都会被拒绝，因此这种现象也被称之为 “突刺现象”。虽然我们可以通过将单位时间设置的更短，但依旧无法解决核心的问题，这时就诞生了漏桶算法和令牌桶算法。</p>
<h4 id="计数器算法（滑动窗口）"><a href="#计数器算法（滑动窗口）" class="headerlink" title="计数器算法（滑动窗口）"></a>计数器算法（滑动窗口）</h4><p><img src="https://49812933408852955071488026628034-1301075051.cos.ap-nanjing.myqcloud.com/20210723224029.png"></p>
<p>滑动窗口又是计数器算法的一个改进，主要解决了固定窗口上的 <strong>临界值</strong> 的问题，将一个计时器分为了诺干个小的计时器，这些计时器都是独立的，当请求时间大于第一个计时器最大时间时，那么将会向前平移一个计时器（同时将前一个计时器丢弃，然后将当前的计时器设置为第一个计时器）。</p>
<p>如上图中，窗口大小为 1s，那么每过 0.2ms就会删除前一个格子，从而向右移一个格子，滑动窗口最为主要的就是他的滑动，使得可以控制的更加细密，以此来解决临界值的问题，但滑动窗口和固定窗口都无法解决突刺现象这一问题。</p>
<h4 id="漏桶算法"><a href="#漏桶算法" class="headerlink" title="漏桶算法"></a>漏桶算法</h4><p><img src="https://49812933408852955071488026628034-1301075051.cos.ap-nanjing.myqcloud.com/20210717200946.png"></p>
<p>漏桶算法（Leaky Bucket）内主要有两个变量，分别为 <strong>桶的大小以及漏洞（孔的大小）的大小</strong>，可以将请求比喻水，当水倒入漏桶中，需要有一定的处理速度（孔的大小决定处理的速度），而桶的大小决定了可以容纳请求的大小，如果请求太大，则会导致漏桶装不下请求从而拒绝后续的请求。</p>
<h4 id="令牌桶算法"><a href="#令牌桶算法" class="headerlink" title="令牌桶算法"></a>令牌桶算法</h4><p><img src="https://49812933408852955071488026628034-1301075051.cos.ap-nanjing.myqcloud.com/20210717200956.png"></p>
<p>令牌桶算法（Token Bucket）这种算法和我们在医院排队叫号比较相似，当请求到达的时候，会去令牌桶（由令牌工厂生产令牌）中取得一个令牌，之后等待响应。</p>
<p>这也达到了一定限流的目的，首先我们可以决定令牌工厂放入令牌的速率，也可以定时或者根据一些特定的规则来达到目的，从而达到增加&#x2F;减少令牌的数量达到限流的效果。</p>
<h3 id="限流的实现"><a href="#限流的实现" class="headerlink" title="限流的实现"></a>限流的实现</h3><p>Spring cloud Gateway 内置了限流工厂 <code>RequestRateLimiterGatewayFilterFactory</code> 底层使用 redis lua 脚本进行实现，因此需要添加 Consul、Gateway、Redis 的依赖：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-data-redis-reactive --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-data-redis-reactive&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;2.5.2&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-gateway&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-consul-discovery&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>之后编写我们的限流配置类，主要通过名称、地址、以及 API 进行限流三种，也可以根据不同的状况自定义配置（还有一个跟均 CPU 进行限流的？）</p>
<h4 id="LimitConfig-java"><a href="#LimitConfig-java" class="headerlink" title="LimitConfig.java"></a>LimitConfig.java</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.filter.ratelimit.KeyResolver;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Primary;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 限流配置文件，根据名称、地址、API</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> kunlun</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/7/23</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LimitConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    KeyResolver <span class="title function_">userKeyResolver</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> exchange -&gt;</span><br><span class="line">                Mono.just(exchange.getRequest().getQueryParams().</span><br><span class="line">                        getFirst(<span class="string">&quot;user&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    KeyResolver <span class="title function_">ipKeyResolver</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> exchange -&gt;</span><br><span class="line">                Mono.just(exchange.getRequest().getRemoteAddress().</span><br><span class="line">                        getHostName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    KeyResolver <span class="title function_">apiKeyResolver</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> exchange -&gt;</span><br><span class="line">                Mono.just(exchange.getRequest().getPath().</span><br><span class="line">                        value());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="application-yml-1"><a href="#application-yml-1" class="headerlink" title="application.yml"></a>application.yml</h5><p>最后通过配置文件 <code>application.yml</code> 来链接 consul、redis 以及配置路由规则和全局过滤等。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">GatewayLimit</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">    <span class="attr">database:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">toor</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">hey</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://service-provider/hey</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/hey</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Method=GET</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">RequestRateLimiter</span>                <span class="comment"># 用于确定当前请求是否继续（如果不允许则会返回 429</span></span><br><span class="line">              <span class="attr">args:</span></span><br><span class="line">                <span class="attr">key-resolver:</span> <span class="string">&#x27;#&#123;@ipKeyResolver&#125;&#x27;</span></span><br><span class="line">                <span class="attr">redis-rate-limiter.replenishRate:</span> <span class="number">1</span>   <span class="comment"># 令牌桶每秒填充的平均速率</span></span><br><span class="line">                <span class="attr">redis-rate-limiter.burstCapacity:</span> <span class="number">3</span>   <span class="comment"># 令牌桶总流量</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">locator:</span></span><br><span class="line">          <span class="comment"># 允许服务发现</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">consul:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8500</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">service-name:</span> <span class="string">service-provider</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8210</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>保证 redis、consul 等已经启动且可提供服务</p>
</blockquote>
<h3 id="端点"><a href="#端点" class="headerlink" title="端点"></a>端点</h3><p><img src="https://49812933408852955071488026628034-1301075051.cos.ap-nanjing.myqcloud.com/20210724001731.png"></p>
<p>端点在 Spring cloud Gateway 中主要提供的作用就是方便开发或者运维人员进行调试，以此来获取过滤器列表、路由列表、路由信息、刷新路由信息以及添加\删除路由等操作，这依赖于 <code>Spring boot Actuator</code> ，需要注意的是这些端点都会在 <code>/actuator/gateway</code> 路径下，分别提供对应的服务：</p>
<table>
<thead>
<tr>
<th>Id</th>
<th>Name</th>
<th>Method</th>
<th>Info</th>
<th>Uri</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>globalfilters</td>
<td>GET</td>
<td>展示所有全局过滤器</td>
<td><code>/actuator/gateway/globalfilters</code></td>
</tr>
<tr>
<td>2</td>
<td>routefilters</td>
<td>GET</td>
<td>展示所有过滤器工厂</td>
<td><code>/actuator/gateway/routefilters</code></td>
</tr>
<tr>
<td>3</td>
<td>refresh</td>
<td>POST</td>
<td>清空路由缓存</td>
<td><code>/actuator/gateway/refresh</code></td>
</tr>
<tr>
<td>4</td>
<td>routes</td>
<td>GET</td>
<td>获取路由列表</td>
<td><code>/actuator/gateway/routes</code></td>
</tr>
<tr>
<td>5</td>
<td>routes{name}</td>
<td>GET</td>
<td>获取指定的路由信息</td>
<td><code>/actuator/gateway/routes/&#123;name&#125;</code></td>
</tr>
<tr>
<td>6</td>
<td>routes{name}</td>
<td>POST</td>
<td>添加一个路由</td>
<td><code>/actuator/gateway/routes/&#123;name&#125;</code></td>
</tr>
<tr>
<td>7</td>
<td>routes{name}</td>
<td>DELETE</td>
<td>移出一个路由</td>
<td><code>/actuator/gateway/routes/&#123;name&#125;</code></td>
</tr>
</tbody></table>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">    &lt;!-- https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-data-redis-reactive --&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-data-redis-reactive&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.5.2&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-cloud-starter-gateway&lt;/artifactId&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-cloud-starter-consul-discovery&lt;/artifactId&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;!-- https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-actuator --&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.5.2&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>.</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">……</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span>  <span class="string">&#x27;*&#x27;</span></span><br></pre></td></tr></table></figure>

<p>开启后，可以访问 <a target="_blank" rel="noopener" href="http://localhost:8210/actuator/gateway/routes/hey">http://localhost:8210/actuator/gateway/routes/hey</a> 来进行测试是否可以该路由的信息，如果没有返回则可能是 Actuator 配置上有一点点的问题</p>
<p>在 <code>management</code> 中，默认只开启了两个端点，分别为 health、info 两个 因此我们可以通过上述配置开启全部的断点访问，更详细的可以查阅 Actuator API: <a target="_blank" rel="noopener" href="https://cloud.spring.io/spring-cloud-gateway/multi/multi__actuator_api.html">https://cloud.spring.io/spring-cloud-gateway/multi/multi__actuator_api.html</a></p>

	

	

</article>





	<span class="different-posts">📖 <a href="/page/14">more posts</a> 📖</span>



	</main>

	<footer class="footer">
	<div class="footer-content">
		
	      <div class="footer__element">
	<p>欢迎来到我的 blog <br><br> 通过 <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>+<a target="_blank" rel="noopener" href="https://github.com/HoverBaum/meilidu-hexo">MeiliDu</a> 进行构建的，存放在 <a target="_blank" rel="noopener" href="https://github.com/vendanges/vendanges.github.io">Github</a> 上。</p>
</div>

	    
	      <div class="footer__element">
	<h5>Check out</h5>
	<ul class="footer-links">
		<li class="footer-links__link"><a href="/archives">Archive</a></li>
		
		  <li class="footer-links__link"><a href="/atom.xml">RSS</a></li>
	    
		<li class="footer-links__link"><a href="/about">about page</a></li>
		<li class="footer-links__link"><a href="/tags">Tags</a></li>
		<li class="footer-links__link"><a href="/categories">Categories</a></li>
	</ul>
</div>

	    

		<div class="footer-credit">
			<span>© 2022 John Doe | Powered by <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> | Theme <a target="_blank" rel="noopener" href="https://github.com/HoverBaum/meilidu-hexo">MeiliDu</a></span>
		</div>

	</div>


</footer>



</body>

</html>
