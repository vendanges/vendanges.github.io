<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta name="theme-color" content="#33474d">
	<title>ç¼ç‘¶</title>
	<link rel="stylesheet" href="/css/style.css" />
	
      <link rel="alternate" href="/atom.xml" title="ç¼ç‘¶" type="application/atom+xml">
    
<meta name="generator" content="Hexo 6.1.0"></head>

<body>

	<header class="header">
		<nav class="header__nav">
			
				<a href="/" class="header__link" style="color: #fff">Home</a>
			
				<a href="/archives" class="header__link" style="color: #fff">Archive</a>
			
				<a href="/about" class="header__link" style="color: #fff">About</a>
			
		</nav>
		<!-- <h1 class="header__title"><a href="/">ç¼ç‘¶</a></h1> -->
		<h1 class="header__title"><a href="/"><img style="width: 290px;" src="https://49812933408852955071488026628034-1301075051.cos.ap-nanjing.myqcloud.com/202204152017786.png"></a></h1>
		<h2 class="header__subtitle">æ¢¦å…¥ç¼æ¥¼å¯’æœ‰æœˆï¼Œè¡Œè¿‡çŸ³æ ‘å†»æ— çƒŸ</h2>
	</header>

	<main>
		
	<span class="different-posts different-posts_earlier">ğŸ“– <a href="/page/12">earlier posts</a> ğŸ“–</span>




	<article>
	
		<h1><a href="/2022/04/21/java/spring security/8.Spring security è·¨åŸŸ/">Spring security è·¨åŸŸä¸CORS</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2022-04-21</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-none-link" href="/tags/java/" rel="tag">java</a> <a class="article__tag-none-link" href="/tags/spring-security/" rel="tag">spring security</a>
			</span>
		
	</div>

	

	
		<p>è·¨åŸŸå³åˆ†ä¸ºä¸‰ç§ï¼Œåˆ†åˆ«ä¸ºåè®®è·¨åŸŸã€ä¸»æœºè·¨åŸŸã€ç«¯å£è·¨åŸŸç­‰ï¼Œå…¶ä¸­ä¸»è¦æ ¹æ®åè®®ä¸åŒã€åŸŸåä¸åŒã€ç«¯å£ä¸åŒï¼Œåœ¨è¿™ä¸‰ç§ä¹‹ä¸­åªè¦æœ‰ä¸€ä¸ªä¸åŒï¼Œå°±ç®—æ˜¯è·¨åŸŸã€‚å°±æ¯”å¦‚ä½ è®¿é—® <a target="_blank" rel="noopener" href="http://pv.zsun.org.cn,ç„¶åè¿˜è®¿é—®äº†https//pv.zsun.org.cn/%E8%BF%99%E5%B0%B1%E5%AF%B9%E5%BA%94%E4%BA%86%E8%B7%A8%E5%9F%9F%E4%B8%AD%E7%9A%84%E5%8D%8F%E8%AE%AE%E4%B8%8D%E5%90%8C%EF%BC%8C%E4%B8%80%E4%B8%AA%E6%97%B6http%E5%8D%8F%E8%AE%AE%E5%8F%A6%E4%B8%80%E4%B8%AA%E5%88%99%E6%98%AFhttps%E5%8D%8F%E8%AE%AE%EF%BC%8C%E6%89%80%E4%BB%A5%E9%80%A0%E6%88%90%E4%BA%86%E8%B7%A8%E5%9F%9F%E3%80%82%E4%B8%BA%E4%BA%86%E8%A7%A3%E5%86%B3%E8%B7%A8%E5%9F%9F%E7%9A%84%E9%97%AE%E9%A2%98%EF%BC%8C%E5%85%B6%E4%B8%AD%E4%B8%BB%E8%A6%81%E5%8C%85%E6%8B%AC%E4%BA%86JSONP%E3%80%81NGINX%E8%BD%AC%E5%8F%91%E3%80%81CORS%E7%AD%89%EF%BC%8C%E5%85%B6%E4%B8%ADJSONP%E5%92%8CCORS%E9%83%BD%E9%9C%80%E8%A6%81%E5%90%8E%E7%AB%AF%E8%BF%9B%E8%A1%8C%E5%8F%82%E4%B8%8E%E3%80%82">http://pv.zsun.org.cnï¼Œç„¶åè¿˜è®¿é—®äº†https://pv.zsun.org.cn/è¿™å°±å¯¹åº”äº†è·¨åŸŸä¸­çš„åè®®ä¸åŒï¼Œä¸€ä¸ªæ—¶httpåè®®å¦ä¸€ä¸ªåˆ™æ˜¯httpsåè®®ï¼Œæ‰€ä»¥é€ æˆäº†è·¨åŸŸã€‚ä¸ºäº†è§£å†³è·¨åŸŸçš„é—®é¢˜ï¼Œå…¶ä¸­ä¸»è¦åŒ…æ‹¬äº†JSONPã€NGINXè½¬å‘ã€CORSç­‰ï¼Œå…¶ä¸­JSONPå’ŒCORSéƒ½éœ€è¦åç«¯è¿›è¡Œå‚ä¸ã€‚</a></p>
<h2 id="CORS"><a href="#CORS" class="headerlink" title="CORS"></a>CORS</h2><p>CORSï¼ˆCross-Origin Resource Sharingï¼Œè·¨åŸŸèµ„æºå…±äº«ï¼‰æ˜¯ä¸€ä¸ªç³»ç»Ÿï¼Œä»–ç”±ä¸€ç³»åˆ—çš„ä¼ è¾“HTTPå¤´ç»„æˆï¼Œè¿™äº›HTTPå¤´å°†ä¼šå†³å®šæµè§ˆå™¨æ˜¯å¦é˜»æ­¢å‰ç«¯JavaScriptä»£ç æ¥è·å–è¯·æ±‚ç›¸åº”ï¼ŒåŒæºå®‰å…¨ç­–ç•¥æ˜¯é»˜è®¤é˜»æ­¢â€œè·¨åŸŸâ€è¯·æ±‚ï¼Œä½†æ˜¯å¦‚æœä½¿ç”¨CORSåˆ™ä¼šç»™webæœåŠ¡å™¨ä¸€ä¸ªé€‰æ‹©ã€å…è®¸å’Œæ‹’ç»è¯·æ±‚è®¿é—®åˆ°ä»–ä»¬çš„èµ„æºã€‚</p>
<p>å°±æ¯”å¦‚Originæ¥å‘èµ·è¯·æ±‚åŸŸï¼š</p>
<ol>
<li>Access-Control-Request-Methodï¼šå°†è¦å‘èµ·è·¨åŸŸè¯·æ±‚çš„æ–¹å¼ï¼ˆPOST&#x2F;GETâ€¦â€¦ï¼‰</li>
<li>Access-Control-Request-Headersï¼šå°†è¦å‘èµ·è·¨åŸŸè¯·æ±‚ä¸­åŒ…å«çš„è¯·æ±‚å¤´å­—æ®µ<ol>
<li>æœåŠ¡å™¨åœ¨å“åº”å­—æ®µä¸­æ¥è¡¨æ˜æ˜¯å¦å…è®¸è¿™ä¸ªè·¨åŸŸè¯·æ±‚ï¼Œæµè§ˆå™¨æ”¶åˆ°åå¦‚æœæ£€æµ‹åˆ°ä¸åˆè¦æ±‚ï¼Œå°±ä¼šæ‹’ç»åé¢çš„è¯·æ±‚</li>
</ol>
</li>
<li>Access-Control-Allow-Originï¼šå…è®¸é‚£äº›åŸŸæ¥è®¿é—®<ol>
<li><code>*</code>è¡¨ç¤ºæ‰€æœ‰çš„åŸŸè¯·æ±‚</li>
</ol>
</li>
<li>Access-Control-Allow-Methodï¼šå…è®¸é‚£äº›è¯·æ±‚æ–¹å¼</li>
<li>Access-Control-Allow-Headersï¼šå…è®¸é‚£äº›è¯·æ±‚å¤´å­—æ®µ</li>
<li>Access-Control-Credentialsï¼šæ˜¯å¦å…è®¸æºå¸¦Cookie</li>
</ol>
<h2 id="Spring-security-å®ç°CORS"><a href="#Spring-security-å®ç°CORS" class="headerlink" title="Spring security å®ç°CORS"></a>Spring security å®ç°CORS</h2><h3 id="CrossOrigin"><a href="#CrossOrigin" class="headerlink" title="CrossOrigin"></a>CrossOrigin</h3><h4 id="DemoApplication-java"><a href="#DemoApplication-java" class="headerlink" title="DemoApplication.java"></a>DemoApplication.java</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.CrossOrigin;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DemoApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&quot;)</span></span><br><span class="line">    <span class="meta">@CrossOrigin(origins = &quot;http://localhost:8080&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">index</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;The is Spring security world!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(DemoApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="WebMvcConfigurerAdapter"><a href="#WebMvcConfigurerAdapter" class="headerlink" title="WebMvcConfigurerAdapter"></a>WebMvcConfigurerAdapter</h3><h4 id="WebCorsConfig-java"><a href="#WebCorsConfig-java" class="headerlink" title="WebCorsConfig.java"></a>WebCorsConfig.java</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.CorsRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurerAdapter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebCorsConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> WebMvcConfigurer <span class="title function_">webMvcConfigurer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">WebMvcConfigurerAdapter</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addCorsMappings</span><span class="params">(CorsRegistry registry)</span> &#123;</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                    addMapping æ‰€æœ‰åŸŸéƒ½èƒ½è®¿é—®</span></span><br><span class="line"><span class="comment">                    allowedOrigins é‚£äº›åŸŸå¯ä»¥è¢«è®¿é—®</span></span><br><span class="line"><span class="comment">                    allowedMethods å…è®¸é‚£äº›è¯·æ±‚</span></span><br><span class="line"><span class="comment">                    allowedHeaders å…è®¸é‚£äº›è¯·æ±‚å­—æ®µ</span></span><br><span class="line"><span class="comment">                    allowCredentials æ˜¯å¦å…è®¸æºå¸¦Cookie</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                registry.addMapping(<span class="string">&quot;/**&quot;</span>)</span><br><span class="line">                .allowedOrigins(<span class="string">&quot;http://localhost:8080&quot;</span>)</span><br><span class="line">                .allowedMethods(<span class="string">&quot;POST&quot;</span>,<span class="string">&quot;GET&quot;</span>)</span><br><span class="line">                .allowedHeaders(<span class="string">&quot;*&quot;</span>)</span><br><span class="line">                .allowCredentials(<span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
	

	

</article>




	<article>
	
		<h1><a href="/2022/04/21/java/spring security/7.Spring security å¯†ç åŠ å¯†/">Spring security å¯†ç åŠ å¯†</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2022-04-21</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-none-link" href="/tags/java/" rel="tag">java</a> <a class="article__tag-none-link" href="/tags/spring-security/" rel="tag">spring security</a>
			</span>
		
	</div>

	

	
		<p>åœ¨æ³¨å†Œçš„è¿‡ç¨‹ä¸­ï¼Œé€šå¸¸ä¼šæœ‰ä¸€å®šçš„å…¥åº“å¤„ç†æœºåˆ¶ï¼Œä»¥é’Ÿå±±è®¡ç®—æœºç«¯å£å®‰å…¨è”åˆä¼—æµ‹å¹³å°ä¸ºä¾‹ï¼Œå¯†ç å…¥åº“æ—¶éƒ½æ˜¯ç”±MD5è¿ç®—åŠ å¯†åçš„å¯†æ–‡ï¼Œä»¥é˜²æ­¢ä¸æ³•åˆ†å­é€šè¿‡ç›¸å…³æŠ€æœ¯æ‰‹æ®µå¯¹ç«™ç‚¹è¿›è¡Œè„«åº“æ—¶æ˜æ–‡å¯†ç çš„ç›´æ¥è·å–ã€‚é€šè¿‡ä½¿ç”¨å¯†æ–‡ç»™ä¸æ³•åˆ†å­å¢åŠ æŠ€æœ¯éš¾åº¦ä»è€Œç•™æœ‰ä¸€å®šçš„è§£å¯†æ—¶é—´æ¥æé†’ç”¨æˆ·å°½å¿«ä¿®æ”¹å¯†ç ç­‰å…¬å‘Šçš„å‘å¸ƒä¸é€šçŸ¥ã€‚åœ¨ç›®å‰ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šä½¿ç”¨MD5ã€SHAç­‰æ‘˜è¦ç®—æ³•ï¼Œå°½ç®¡æœ‰å¾ˆå¤šåœ¨çº¿è§£å¯†çš„ç«™ç‚¹ï¼Œé€šå¸¸åœ¨å¯†ç åŠ å¯†çš„åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬ä¼šå°†ç”¨æˆ·è¾“å…¥çš„æ˜æ–‡å¯†ç è¿›è¡ŒMD5æˆ–HASè¿ç®—åå­˜å‚¨åˆ°æ•°æ®åº“ï¼Œä¹‹ååœ¨ç”¨æˆ·ç™»å½•çš„æ—¶å€™å°†æ•°æ®å’Œæ•°æ®åº“ä¸­çš„dataè¿›è¡Œå¯¹æ¯”çš„è¿™ç§æ–¹æ¡ˆã€‚</p>
<h2 id="å¯†æ–‡çš„è§£å¯†æ–¹å¼"><a href="#å¯†æ–‡çš„è§£å¯†æ–¹å¼" class="headerlink" title="å¯†æ–‡çš„è§£å¯†æ–¹å¼"></a>å¯†æ–‡çš„è§£å¯†æ–¹å¼</h2><p>é€šå¸¸æˆ‘ä»¬å¯é€šè¿‡ç¢°æ’ï¼Œå³å­˜åœ¨ä¸¤ä¸ªç”šè‡³å¤šä¸ªå¾—åˆ°åŒä¸€ç›´çš„æƒ…å†µä¸‹å°±ä¼šå­˜åœ¨è¢«ç¢°æ’çš„å¯èƒ½æ€§ã€‚å½“ç„¶è¿˜æœ‰å°±æ˜¯æœ€ç›´æ¥çš„æ–¹æ³•æ„å»ºä¸€å¼ åæŸ¥è¡¨ï¼Œå°±æ˜¯è¯´å°†å¯†ç ç»è¿‡md5åè¿ç®—å‡ºçš„ç›´æ¥è¿›è¡Œç©·ä¸¾ï¼Œå¦‚æœè¯¥ç«™ç‚¹æ•°æ®åº“ä¸­æœ‰éƒ¨åˆ†å¯†ç å’ŒåæŸ¥è¡¨ä¸­å¤§éƒ¨åˆ†æ•°æ®æ”¶å½•ï¼Œåˆ™å¾ˆå®¹æ˜“è¢«è¿›è¡Œç ´è§£è‡³æ˜æ–‡ã€‚åœ¨æˆ–è€…è¿˜æœ‰ä¸€ç§éå¸¸æš´åŠ›çš„æ–¹å¼åˆ™æ˜¯â€œæš´åŠ›ç ´è§£â€ï¼Œä¸»è¦ä¾é çš„æ˜¯å¼ºå¤§çš„å­—å…¸è€Œä¸æ˜¯ä½¿ç”¨è€…çš„æŠ€æœ¯å®åŠ›ï¼ŒæŒ‰ç…§é“ç†æ¥è®²ï¼Œåªè¦ä½ çš„å­—å…¸è¶³å¤Ÿä¸°å¯Œä¸”å®Œå–„ï¼ŒæˆåŠŸç‡å°±è¶Šé«˜ï¼Œå¦‚æœä½ çš„å­—å…¸è·‘å®Œäº†è¿˜æ²¡æœ‰ç ´è§£æˆåŠŸçš„è¯ï¼Œé‚£åŸºæœ¬ä¸Šæ˜¯æ„å‘³ç€å¤±è´¥äº†ã€‚</p>
<h3 id="å½©è™¹è¡¨"><a href="#å½©è™¹è¡¨" class="headerlink" title="å½©è™¹è¡¨"></a>å½©è™¹è¡¨</h3><p>èµ·åˆé»‘å®¢ä»¬é€šè¿‡å­—å…¸ã€ç¢°æ’çš„æ–¹å¼è¿›è¡Œç ´è§£ï¼Œå¯¹äºç®€å•çš„å¯†ç åˆ™éå¸¸æœ‰ç”¨ï¼Œä½†æ˜¯å¦‚æœé‡åˆ°å¤æ‚çš„å¯†ç å’Œå¯†ç ç³»ç»Ÿï¼Œå°±ä¼šäº§ç”Ÿè¾ƒå¤§çš„å­—å…¸ï¼Œä¸ºäº†è§£å†³é€†å‘ç ´è§£çš„éš¾é¢˜ï¼Œå¹¶å¢åŠ è¡¨çš„å®¹é‡ï¼Œç‘å£«æ´›æ¡‘è”é‚¦æŠ€æœ¯å­¦é™¢çš„Philippe Oechslinå°±æå‡ºäº†ä¸€ç§ä¼˜åŒ–å‹çš„æ—¶é—´ä¸å†…å­˜äº¤æ¢ç®—æ³•ã€‚</p>
<p>è¿™è®©è¡¨ä¸åœ¨æ˜¯åªå­˜å‚¨ç±³å—¯é—®ä¸å¯†æ–‡çš„ä¸€ä¸€å¯¹åº”å…³ç³»ï¼Œè€Œæ˜¯ä¸€ä¸ªå¯†ç å¯¹çš„é›†åˆï¼Œå¹¶åœ¨æœ‰é™çš„å†…å­˜ä¸­ä»¥æé«˜çš„æ•ˆç‡ç ´è§£æ›´å¤šå¯èƒ½çš„å¯†ç ï¼Œè¿™ä¹Ÿè¢«ä¸€äº›é»‘å®¢æ”¹è¿›äº†éƒ¨åˆ†æµç¨‹ï¼Œæœ€åæˆä¸ºäº†ä¸€ç§å½©è™¹è¡¨ã€‚</p>
<p>å½©è™¹è¡¨çš„å¤§å°é€šå¸¸éƒ½è¶…è¿‡äº†100gä»¥ä¸Šï¼Œå½©è™¹è¡¨æ¯ä¸€æ¡æ•£åˆ—é“¾éƒ½ä¼šä»£è¡¨ä¸€ç»„ç›¸åŒç‰¹å¾çš„é“­æ–‡ï¼Œä½†æ¯ä¸€æ¡æ•£åˆ—é“¾å¹¶ä¸éœ€è¦å®Œæ•´çš„å­˜å‚¨ï¼Œä»…ä»…å­˜å‚¨å¼€å§‹èŠ‚ç‚¹å’Œç»“æŸèŠ‚ç‚¹å³å¯ã€‚ä¾‹å¦‚å›¾ä¸­çš„Håˆ™ä»£è¡¨ä¸€æ¬¡æ•£åˆ—è®¡ç®—ï¼ŒR1\R2\R3ä»£è¡¨ä¸€æ¬¡é€’å½’æ€§è´¨çš„çº¦å‡è®¡ç®—Ræ—è¾¹çš„å­—æ¯åˆ™ä¼šä»£è¡¨ä¸€æ¡æ•£åˆ—é“¾ä¼šç»å†3æ¬¡çº¦å‡ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™æ¡æ•£åˆ—é“¾å¯ä»¥æºå¸¦ä¸‰æ¡é“­æ–‡ï¼Œåé¢çš„éƒ½ä¼šç”±Kæ‰€æŒ‡ä»£ã€‚å½“æˆ‘ä»¬éœ€è¦ç ´è§£ä¸€ä¸ªæ•£åˆ—çš„æ—¶å€™ï¼Œåªéœ€è¦å¯¹å…¶åšç›¸åº”çš„çº¦å‡è®¡ç®—ï¼Œä¾¿å¯ä»¥æ¨å¯¼å‡ºå…¶æ‰€åœ¨çš„æ•£åˆ—é“¾ï¼Œå†æœ‰æ•£åˆ—é“¾æ­£æ¨å°±å¯èƒ½ä¼šå¾—åˆ°è¯¥æ•£åˆ—é“¾çš„æ˜æ–‡ï¼Œç”±äºKçš„å­˜åœ¨ï¼Œæ‰€ä»¥å¯ä»¥æºå¸¦æ›´å¤šçš„æ•°æ®ã€‚<code>è™½ç„¶å½©è™¹è¡¨çœ‹ä¼¼å¦‚æ­¤å¼ºå¤§ï¼Œä½†æ˜¯å¦‚æœå½“é‡åˆ°è¢«åŠ ç›çš„æ—¶å€™ï¼Œä¹Ÿæ˜¯ä¼šå˜å¾—å¼±ä¸ç¦é£çš„ã€‚</code></p>
<h2 id="å®ç°å¯†ç åŠ å¯†"><a href="#å®ç°å¯†ç åŠ å¯†" class="headerlink" title="å®ç°å¯†ç åŠ å¯†"></a>å®ç°å¯†ç åŠ å¯†</h2><h3 id="UserServiceImpl-java"><a href="#UserServiceImpl-java" class="headerlink" title="UserServiceImpl.java"></a>UserServiceImpl.java</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.zhongce.service;</span><br><span class="line"><span class="keyword">import</span> com.example.zhongce.model.User;</span><br><span class="line"><span class="keyword">import</span> com.example.zhongce.repository.RoleRepository;</span><br><span class="line"><span class="keyword">import</span> com.example.zhongce.repository.UserRepository;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserRepository userRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RoleRepository roleRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> BCryptPasswordEncoder bCryptPasswordEncoder;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">(User user)</span> &#123;</span><br><span class="line">        user.setPassword(bCryptPasswordEncoder.encode(user.getPassword()));</span><br><span class="line">        user.setRoles(<span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;(roleRepository.findAll()));</span><br><span class="line">        userRepository.save(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">findByUsername</span><span class="params">(String username)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userRepository.findByUsername(username);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…·ä½“ä»£ç å¯é€šè¿‡é˜…è¯»æˆ–æµè§ˆé’Ÿå±±è®¡ç®—æœºç«¯å£å®‰å…¨è”åˆä¼—æµ‹å¹³å°è¿›è¡Œå¾—çŸ¥ï¼š<a target="_blank" rel="noopener" href="https://gitee.com/zhongshan_union/Zhongshan-computer-port-security-joint-public-testing-platform/blob/master/src/main/java/com/example/zhongce/service/UserServiceImpl.java">https://gitee.com/zhongshan_union/Zhongshan-computer-port-security-joint-public-testing-platform/blob/master/src/main/java/com/example/zhongce/service/UserServiceImpl.java</a></p>

	

	

</article>




	<article>
	
		<h1><a href="/2022/04/21/java/spring security/6.Spring security ä¼šè¯ç®¡ç†/">Spring security ä¼šè¯ç®¡ç†</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2022-04-21</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-none-link" href="/tags/java/" rel="tag">java</a> <a class="article__tag-none-link" href="/tags/spring-security/" rel="tag">spring security</a>
			</span>
		
	</div>

	

	
		<p>ä¼šè¯ç®¡ç†çš„åŸºæœ¬æ¦‚å¿µå¯ä»¥ç†è§£ä¸ºï¼Œç®¡ç†ä¼šè¯çš„é™åˆ¶ï¼Œå°±æ¯”å¦‚åœ¨å¤§å‹çš„ç«™ç‚¹ä¹‹ä¸­ï¼ŒåŸºæœ¬ä¸Šéƒ½æ˜¯ä¸å…è®¸å¤šä¸ªå¸å·åŒæ—¶ç™»å½•çš„ï¼Œå°±æ¯”å¦‚è…¾è®¯QQï¼Œå‡å¦‚PC1å·²ç»ç™»å…¥QQï¼ŒPC2å†æ¬¡ç™»å…¥QQåˆ™ä¼šå‡ºç°PC1QQå·²ç»è¢«è¸¢ä¸‹çº¿çš„æƒ…å†µã€‚è€Œåœ¨ç½‘ç»œè®¾å¤‡ä¸­ï¼Œåªè¦è¯¥è®¾å¤‡è¢«ç™»å½•ï¼Œå°±ä¸ä¼šå…è®¸å†æ¬¡ç™»å½•çš„è¿™ç§åŠŸèƒ½æ•ˆæœï¼ŒSpring securityä¸ºæˆ‘ä»¬æä¾›äº†å®Œå–„çš„ä¼šè¯ç®¡ç†åŠŸèƒ½ï¼Œå’Œå®‰å…¨é˜²å¾¡æ‰‹æ®µå¦‚ï¼šä¼šè¯å›ºå®šæ”»å‡»ï¼Œä¼šè¯è¶…æ—¶æ£€æµ‹ä»¥åŠä¼šè¯å¹¶å‘æ§åˆ¶ç­‰ã€‚</p>
<h2 id="ä»€ä¹ˆæ˜¯ä¼šè¯ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯ä¼šè¯ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯ä¼šè¯ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯ä¼šè¯ï¼Ÿ</h2><p>ä¼šè¯ï¼ˆsessionï¼‰å³æ— çŠ¶æ€çš„HTTPå®ç°ç”¨æˆ·çŠ¶æ€å¯ç»´æŒçš„ä¸€ç§è§£å†³æ–¹æ¡ˆï¼Œåœ¨é€šå¸¸çš„æƒ…å†µæ¯ä¸ªè¯·æ±‚ä¹‹é—´éƒ½æ²¡æœ‰ç›¸äº’çš„å…³è”æ€§ï¼Œä¹Ÿå°±æ˜¯è¯´ç”¨æˆ·è®¿é—®çš„æ—¶å€™æ²¡æœ‰ä¸€ä¸ªèº«ä»½è®°å½•ï¼Œä¹Ÿå°±æ˜¯è¯´è°éƒ½è®¿é—®äº†ï¼Œä½†æ˜¯æˆ‘ä¸çŸ¥é“ä¹ŸæŸ¥ä¸åˆ°ã€‚sessionçš„å‡ºç°è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼ŒæœåŠ¡å™¨é€šè¿‡ä¸ç”¨æˆ·è¾¾æˆä¸€ä¸ªçº¦å®šï¼Œ<code>æ¯ä¸ªè¯·æ±‚ä¹‹é—´éƒ½æºå¸¦ç€ä¸€ä¸ªidç±»çš„ä¿¡æ¯</code>ã€‚</p>
<p><strong>åœ¨ç”¨æˆ·é¦–æ¬¡è®¿é—®çš„æ—¶å€™ï¼Œç³»ç»Ÿä¼šä¸ºè¯¥ç¨‹åºç”Ÿæˆä¸€ä¸ªsessionIdï¼Œå¹¶å› æ­¤æ·»åŠ è‡³cookieä¹‹ä¸­</strong>ï¼Œå½“ç”¨æˆ·çš„ä¼šè¯æœŸé™å†…ï¼Œæ¯ä¸ªè¯·æ±‚éƒ½ä¼šè‡ªåŠ¨æºå¸¦è¯¥cookieï¼Œå› æ­¤ç³»ç»Ÿä¼šè½»æ˜“çš„åˆ¤æ–­è¿™ä¸ªè¯†åˆ«æ˜¯æ¥æ­¤é‚£ä¸ªä¸€ä¸ªç”¨æˆ·çš„è¯·æ±‚ã€‚</p>
<h2 id="Spring-security-çš„ä¼šè¯å›ºå®šæ”»å‡»é˜²å¾¡"><a href="#Spring-security-çš„ä¼šè¯å›ºå®šæ”»å‡»é˜²å¾¡" class="headerlink" title="Spring security çš„ä¼šè¯å›ºå®šæ”»å‡»é˜²å¾¡"></a>Spring security çš„ä¼šè¯å›ºå®šæ”»å‡»é˜²å¾¡</h2><p>åœ¨spring securityä¹‹ä¸­ï¼Œä¼šè¯å›ºå®šä¸ªæ”»å‡»çš„é˜²å¾¡æ‰‹æ®µä¹Ÿå¯é€šè¿‡ç”¨æˆ·ç™»å½•ä¹‹åé‡æ–°ç”Ÿæˆæ–°çš„sessionï¼Œåœ¨ç»§æ‰¿WebSecurityConfigurationAdapterçš„æ—¶å€™ï¼ŒSpring securityåˆ™å·²ç»å¯ç”¨äº†è¿™ç§é…ç½®ã€‚</p>
<h3 id="sessionManagement"><a href="#sessionManagement" class="headerlink" title="sessionManagement"></a>sessionManagement</h3><p>sessionManagementæ˜¯ä¸€ä¸ªä¼šè¯ç®¡ç†çš„é…ç½®å™¨ï¼Œå…¶ä¸­é˜²å¾¡ä¼šè¯å›ºå®šæ”»å‡»çš„ç­–ç•¥åˆ†ä¸ºå››ç§åˆ†åˆ«ä¸ºï¼š</p>
<ul>
<li>1.nuneï¼šä¸åšä»»ä½•æ”¹åŠ¨ï¼Œç™»å…¥ä¹‹åæ²¿ç”¨æ—§çš„session</li>
<li>2.newSessionï¼šç™»å½•ååˆ›å»ºä¸€ä¸ªæ–°çš„session</li>
<li>3.migrateSessionï¼šç™»å…¥ä¹‹ååˆ›å»ºä¸€ä¸ªæ–°çš„sessionï¼Œå¹¶å°†æ—§çš„sessionä¸­çš„æ•°æ®å¤åˆ¶è¿‡æ¥</li>
<li>4.changeSessionIdï¼šä¸åˆ›å»ºæ–°çš„ä¼šè¯ï¼Œè€Œæ˜¯ä½¿ç”¨ç”±Servletå®¹å™¨æä¾›çš„ä¼šè¯å›ºå®šä¿æŠ¤ã€‚</li>
</ul>
<h4 id="WebSecurityConfig-java"><a href="#WebSecurityConfig-java" class="headerlink" title="WebSecurityConfig.java"></a>WebSecurityConfig.java</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDetailsService userDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity httpSecurity)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        httpSecurity.authorizeRequests()</span><br><span class="line">               .anyRequest().authenticated()</span><br><span class="line">                .and().formLogin()</span><br><span class="line">                .and()</span><br><span class="line">                .rememberMe()</span><br><span class="line">                .userDetailsService(userDetailsService)</span><br><span class="line">                .and()</span><br><span class="line">             <span class="comment">// å¼€å¯sessionä¼šè¯ç®¡ç†</span></span><br><span class="line">            .sessionManagement()</span><br><span class="line">                .sessionFixation().none();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> å®é™…ä¸Šåœ¨Spring securityä¹‹ä¸­ï¼Œå³ä½¿æ²¡æœ‰é…ç½®ï¼Œä¹Ÿä¸éœ€è¦å¤ªè¿‡æ‹…å¿ƒä¼šè¯å›ºå®šæ”»å‡»ï¼Œå› ä¸ºSecurityä¹‹ä¸­çš„HTTPé˜²ç«å¢™æˆ–æ§åˆ¶å™¨ä¼šå¸®åŠ©æˆ‘ä»¬æ‹¦æˆªä¸€å®šçš„ä¸åˆæ³•URLè¯·æ±‚ï¼Œå°±æ¯”å¦‚æˆ‘å‹æ ¹æ²¡é…ç½®indexï¼Œä½ è®¿é—®äº†åªèƒ½æ˜¯Error Pageçš„é”™è¯¯é¡µã€‚</p>
<h2 id="Spring-security-ä¼šè¯ç®¡ç†é…ç½®"><a href="#Spring-security-ä¼šè¯ç®¡ç†é…ç½®" class="headerlink" title="Spring security ä¼šè¯ç®¡ç†é…ç½®"></a>Spring security ä¼šè¯ç®¡ç†é…ç½®</h2><p>åœ¨Spring securityä¹‹ä¸­ï¼Œæˆ‘ä»¬å¯é€šè¿‡<code>invalidSessionUrl</code>æ¥æŒ‡å®šä¼šè¯çš„å¤±æ•ˆæ—¶é‡å®šå‘çš„URL(é»˜è®¤é‡å®šå‘ç™»å½•é¡µé¢)ã€‚å½“ç„¶ä¹Ÿå¯é€šè¿‡<code>maximumSession</code>æ¥æŒ‡å®šç”¨æˆ·æœ€å¤§çš„å¹¶å‘æ•°é‡(-1è¡¨ç¤ºæ— é™åˆ¶)ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸»è¦åˆ—ä¸¾å‡ ä¸ªç®€å•çš„ä¾‹å­æ¥å®ç°ã€‚</p>
<h3 id="å¤±æ•ˆå¤„ç†ä¸å¤±æ•ˆæ—¶é—´"><a href="#å¤±æ•ˆå¤„ç†ä¸å¤±æ•ˆæ—¶é—´" class="headerlink" title="å¤±æ•ˆå¤„ç†ä¸å¤±æ•ˆæ—¶é—´"></a>å¤±æ•ˆå¤„ç†ä¸å¤±æ•ˆæ—¶é—´</h3><p>é€šè¿‡<code>sessionManagement().invalidSessionUrl();</code>æ¥è®¾ç½®ä¼šè¯å¤±æ•ˆåé‡å®šå‘çš„é¡µé¢ï¼Œè¿™é‡Œæˆ‘ä»¬åœ¨application.propertoesä¸­åˆ†åˆ«è®¾ç½®sessionä¸cokieçš„ç”Ÿå‘½å‘¨æœŸï¼š</p>
<h4 id="application-properties"><a href="#application-properties" class="headerlink" title="application.properties"></a>application.properties</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spring.security.user.name=kun</span><br><span class="line">spring.security.user.password=123</span><br><span class="line"></span><br><span class="line"># æ ¹æ®æç¤ºé»˜è®¤æ—¶é—´æ˜¯30min(å•ä½ä¸ºç§’)ï¼Œè¿™é‡Œæˆ‘ä»¬è®¾ç½®60m(ä¸€åˆ†é’Ÿï¼‰ï¼Œé€šè¿‡æŸ¥çœ‹ TomcatServletWebServerFactory</span><br><span class="line"># æˆ‘ä»¬å¯ä»¥å¾—çŸ¥sessionçš„é»˜è®¤æ—¶é—´æ˜¯1åˆ†é’Ÿ</span><br><span class="line">server.servlet.session.timeout=60</span><br><span class="line"># è¿™é‡Œæ˜¯cookieçš„ç”Ÿå‘½å‘¨æœŸï¼Œå•ä½ä¸ºç§’,-1æ˜¯æ— é™åˆ¶</span><br><span class="line">server.servlet.session.cookie.max-age=-1</span><br></pre></td></tr></table></figure>

<h4 id="WebSecurityConfig-java-1"><a href="#WebSecurityConfig-java-1" class="headerlink" title="WebSecurityConfig.java"></a>WebSecurityConfig.java</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDetailsService userDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity httpSecurity)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        httpSecurity.authorizeRequests()</span><br><span class="line">               .anyRequest().authenticated()</span><br><span class="line">                .and().formLogin()</span><br><span class="line">                .and()</span><br><span class="line">                .rememberMe()</span><br><span class="line">                .userDetailsService(userDetailsService)</span><br><span class="line">                .and()</span><br><span class="line">            .sessionManagement()</span><br><span class="line">                .invalidSessionUrl(<span class="string">&quot;/myLogin.html&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç”±äºæˆ‘ä»¬å¹¶æ²¡æœ‰è‡ªå®šä¹‰ç™»å½•é¡µé¢æ‰€ä»¥&#96;&#96;&#96;&#x2F;myLogin.html &#96;&#96; &#96;æ–‡ä»¶ååœ¨resource&#x2F;staticç›®å½•ä¸‹ä¸ºç©ºï¼Œæ‰€ä»¥åœ¨sessionä¼šè¯å¤±æ•ˆçš„æ—¶å€™è‡ªç„¶å°±è·³è½¬åˆ°äº†spring securityä¸ºæˆ‘ä»¬æä¾›çš„é»˜è®¤ç™»å½•é¡µé¢ä¹‹ä¸­ï¼Œè¯»è€…å¯æ ¹æ®éœ€æ±‚è‡ªè¡Œè¿›è¡Œä¿®æ”¹ä¸è°ƒæ•´ã€‚</p>
<h3 id="session-æœ€å¤§ä¼šè¯æ•°é‡"><a href="#session-æœ€å¤§ä¼šè¯æ•°é‡" class="headerlink" title="session æœ€å¤§ä¼šè¯æ•°é‡"></a>session æœ€å¤§ä¼šè¯æ•°é‡</h3><p>é€šè¿‡.maximumSessionsæˆ‘ä»¬å¯ä»¥ç®¡ç†sessionä¸­åŒä¸€ç”¨æˆ·çš„æœ€å¤§ä¼šè¯æ•°é‡ï¼Œå¦‚æœ.maximumSessionsè®¾ç½®ä¸ºâ€-1â€œåˆ™è¡¨ç¤ºæ— é™åˆ¶ï¼Œé™¤æ­¤ä¹‹å¤–çš„å…¶ä»–æ•°å­—éƒ½å°†ä¼šè¢«é™åˆ¶ã€‚è€Œæœ¬æ¬¡æˆ‘ä»¬é€šè¿‡WebSecurityConfig.javaä¸­çš„.invalidSessionUrlæ¥æŒ‡å®šå…¶åŒä¸€ç”¨æˆ·ç™»å…¥åå¦‚sessionæ²¡è¿‡æœŸçš„æƒ…å†µä¸‹è·³è½¬è‡³&#x2F;myLogin.htmlé¡µé¢ï¼Œè€Œ.maxSessionsPreventsLoginæ‰€è¡¨ç¤ºçš„åˆ™æ˜¯ï¼Œç”¨æˆ·sessionä¼šè¯è¾¾åˆ°.maximumSessionsçš„é™åˆ¶åï¼Œæ–°çš„è¯·æ±‚sessionå°†ä¼šè¢«æ‹’ç»ç™»å½•ã€‚</p>
<h4 id="WebSecurityConfig-java-2"><a href="#WebSecurityConfig-java-2" class="headerlink" title="WebSecurityConfig.java"></a>WebSecurityConfig.java</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDetailsService userDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity httpSecurity)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        httpSecurity.authorizeRequests()</span><br><span class="line">               .anyRequest().authenticated()</span><br><span class="line">                .and().formLogin()</span><br><span class="line">                .and()</span><br><span class="line">                .rememberMe()</span><br><span class="line">                .userDetailsService(userDetailsService)</span><br><span class="line">                .and()</span><br><span class="line">            .sessionManagement()</span><br><span class="line">                .invalidSessionUrl(<span class="string">&quot;/myLogin.html&quot;</span>)</span><br><span class="line">                .maximumSessions(<span class="number">1</span>).maxSessionsPreventsLogin(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
	

	

</article>




	<article>
	
		<h1><a href="/2022/04/21/java/spring security/5.Spring security è‡ªåŠ¨ç™»å½•/">Spring security è‡ªåŠ¨ç™»å½•</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2022-04-21</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-none-link" href="/tags/java/" rel="tag">java</a>
			</span>
		
	</div>

	

	
		<p>è‡ªåŠ¨ç™»å½•åœ¨å¾ˆå¤šç™»å…¥é¡µé¢ä¸­éƒ½æœ‰ä¸€å®šçš„éœ€æ±‚å’Œå­˜åœ¨ï¼Œæœ‰æ—¶å€™å¤„äºç«™ç‚¹çš„ç›¸å…³å¯†ç å®‰å…¨ç­‰çº§è®¾ç½®ï¼Œæ‰€ä»¥ä¼šè¦æ±‚ç”¨æˆ·åœ¨è¾“å…¥å¯†ç çš„æ—¶å€™è¦å¤§äºæˆ–ç­‰äºå¤šå°‘ä¸ªæ•°å­—æˆ–å­—æ¯ï¼Œæœ‰çš„ç”šè‡³ä¼šè¦æ±‚å¤§å°å†™å’Œä¸€äº›ç¬¦å·æ··åˆã€‚è¿™å°±ä¼šæ”¹å˜æˆ‘ä»¬ç»å¸¸ä½¿ç”¨çš„å¯†ç ï¼Œæ¯”å¦‚æˆ‘ç»å¸¸ä½¿ç”¨çš„å¯†ç æ˜¯<code>wwcx2022.</code>ï¼Œä½†è¯¥ç«™ç‚¹æ‰€è¦æ±‚çš„å¯†ç è§„èŒƒæ˜¯å¤§å°å†™ï¼Œæ‰€ä»¥å°±ä¼šæ”¹å˜æˆ<code>Wwcx2022.</code>ï¼Œæœ‰çš„ç”šè‡³ä¼šè¦æ±‚ä¸å…è®¸å¯†ç ç¬¦å·ï¼Œå¦‚é’Ÿå±±è®¡ç®—æœºç«¯å£å®‰å…¨è”åˆæ¼æ´å…±äº«å¹³å°ä¸­çš„å‰ç«¯å’Œåç«¯éªŒè¯éƒ½ä¸å…è®¸æ ‡ç‚¹ç¬¦å·çš„å­˜åœ¨ã€‚<br>æ‰€ä»¥åœ¨ç™»å½•çš„æ—¶å€™ä¼šå¤šä¸ªå¯†ç è¿›è¡Œé‡è¯•ï¼Œæœ‰çš„ç”šè‡³ä¼šé€‰æ‹©å¿˜è®°å¯†ç è€Œå¢åŠ ç«™ç‚¹çš„å¤„ç†ï¼Œä¸ºå‡å°‘ç”¨æˆ·é‡æ–°æäº¤è¡¨å•å’ŒåŠ ç¨‹åºå¤„ç†çš„é¢‘ç‡ï¼Œåœ¨ç³»ç»Ÿå¼€å‘ä¹‹ä¸­ä¼šè¦æ±‚ç”¨æˆ·è®°ä½å¯†ç ï¼ˆä¿—ç§°è‡ªåŠ¨ç™»å½•ï¼‰çš„åŠŸèƒ½ä½“éªŒï¼Œè¿™æ ·åšçš„å”¯ä¸€å¥½å¤„å°±æ˜¯å¯ä»¥å‡å°‘ç¨‹åºçš„å¤„ç†æ•°é‡å’Œç»™ç”¨æˆ·å¸¦æ¥ä¾¿åˆ©ï¼Œæœ¬æ–‡æˆ‘ä»¬ä½¿ç”¨Spring securityæ¥å®ç°è‡ªåŠ¨ç™»å½•ï¼Œå½“ç„¶è¿˜æœ‰ä¸€äº›ä½¿ç”¨æ•°æ®åº“æ¥å®ç°çš„è‡ªåŠ¨ç™»å½•ï¼Œç½‘ä¸Šæœ‰å¾ˆå¤šæ–‡ç« å¯ä»¥ç”¨äºå®ç°ï¼Œè¯»è€…å¯è‡ªè¡Œè¿›è¡Œå­¦ä¹ ï¼Œåœ¨é¡¹ç›®å¼€å‘çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬å»ºè®®è¾ƒå°‘çš„ä½¿ç”¨æ•°æ®åº“ï¼Œå‡å°‘ç³»ç»Ÿèµ„æºã€‚</p>
<h2 id="DemoApplication-java"><a href="#DemoApplication-java" class="headerlink" title="DemoApplication.java"></a>DemoApplication.java</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DemoApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">index</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;The is Spring security world!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(DemoApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="WebSecurityConfig-java"><a href="#WebSecurityConfig-java" class="headerlink" title="WebSecurityConfig.java"></a>WebSecurityConfig.java</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDetailsService userDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity httpSecurity)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        httpSecurity.authorizeRequests()</span><br><span class="line">               .anyRequest().authenticated()</span><br><span class="line">                .and().formLogin()</span><br><span class="line">                .and()</span><br><span class="line">                .rememberMe()</span><br><span class="line">                .userDetailsService(userDetailsService)</span><br><span class="line">                .and()</span><br><span class="line">                .csrf().disable();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

	

	

</article>




	<article>
	
		<h1><a href="/2022/04/21/java/spring security/4.Spring security éªŒè¯ç /">Spring security éªŒè¯ç </a></h1>
	
	<div class="article__infos">
		<span class="article__date">2022-04-21</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-none-link" href="/tags/java/" rel="tag">java</a> <a class="article__tag-none-link" href="/tags/spring-security/" rel="tag">spring security</a>
			</span>
		
	</div>

	

	
		<p>éªŒè¯ç ï¼ˆCompletely Autmated Public Turing test to tell Computers and Humans Apartï¼ŒCAPTCHAï¼‰ï¼Œä¸­æ–‡å…¨ç§°ä¸ºâ€œå…¨è‡ªåŠ¨åŒºåˆ†è®¡ç®—æœºå’Œäººç±»çš„å›¾çµæµ‹è¯•â€ï¼Œä¸»è¦è¿ç”¨åœ¨ç™»å½•ã€æ³¨å†Œã€æäº¤ç­‰è¡¨å•å¹¶ä»¥é˜²æ­¢å…¶æš´åŠ›ç ´è§£ä»¥åŠé¢‘ç¹æäº¤çš„ä¸€ç§åŠŸèƒ½ã€‚<br>åœ¨ç›®å‰ï¼ŒéªŒè¯ç æŠ€æœ¯å·²ç»è¡ç”Ÿåˆ°æ»‘å—éªŒè¯ã€å›¾å½¢éªŒè¯ã€æ‹¼å›¾éªŒè¯ç­‰ï¼Œä½†éªŒè¯ç ä¾ç„¶è¢«å¹¿æ³›ä½¿ç”¨ï¼Œå› å…¶ä¸ç¾è§‚è€Œè¢«æ»‘å—ç­‰éšè—çš„æ–¹å¼æ‰€æ›¿ä»£ï¼Œæœ¬ä¹¦ä½œè€…æœ¬æ¥æ˜¯ä¸æƒ³å°†éªŒè¯ç åŠ å…¥è¿›æ¥ï¼Œä½†å®åœ¨æ˜¯è§‰å¾—ä¸åº”è¯¥ï¼Œæ‰€ä»¥æ‰å†™ï¼Œæœ¬ä¹¦ä½¿ç”¨hutoolå·¥å…·é›†ç®€å•å®ç°éªŒè¯ç ã€‚</p>
<p>å†æ¬¡ä¹‹å‰æˆ‘ä»¬éœ€è¦åœ¨pom.xmlæ–‡ä»¶ä¸‹åŠ å…¥hutoolçš„ä¸ªä¾èµ–ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-captcha<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.3.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h2><h3 id="CaptchaController-java"><a href="#CaptchaController-java" class="headerlink" title="CaptchaController.java"></a>CaptchaController.java</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.captcha.CaptchaUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.captcha.CircleCaptcha;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CaptchaController</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">SESSION_KEY_IMAGE_CODE</span> <span class="operator">=</span> <span class="string">&quot;SESSION_KEY_IMAGE_CODE&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/code/image&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createCode</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        response.setCharacterEncoding(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        response.setHeader(<span class="string">&quot;Pragma&quot;</span>,<span class="string">&quot;No-chache&quot;</span>);</span><br><span class="line">        response.setHeader(<span class="string">&quot;Cache-Control&quot;</span>,<span class="string">&quot;no-chache&quot;</span>);</span><br><span class="line">        response.setDateHeader(<span class="string">&quot;Expires&quot;</span>,<span class="number">0</span>);</span><br><span class="line">        response.setContentType(<span class="string">&quot;image/jpeg&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            width @å®½</span></span><br><span class="line"><span class="comment">            height @é«˜</span></span><br><span class="line"><span class="comment">            codeCount @éªŒè¯ç ä½æ•°</span></span><br><span class="line"><span class="comment">            circleCount @å¾ªç¯æ¬¡æ•°</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">CircleCaptcha</span> <span class="variable">captcha</span> <span class="operator">=</span> CaptchaUtil.createCircleCaptcha(<span class="number">100</span>,<span class="number">20</span>,<span class="number">4</span>,<span class="number">3</span>);</span><br><span class="line">        System.out.println(captcha.getCode());</span><br><span class="line"></span><br><span class="line">        request.getSession().setAttribute(SESSION_KEY_IMAGE_CODE, captcha.getCode());</span><br><span class="line">        log.info(<span class="string">&quot;Captcha:&quot;</span> + captcha.getCode() + <span class="string">&quot;,already arrive deposit HttpSession&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">OutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> response.getOutputStream();</span><br><span class="line">        captcha.write(outputStream);</span><br><span class="line">        outputStream.flush();</span><br><span class="line">        outputStream.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="configuration"><a href="#configuration" class="headerlink" title="configuration"></a>configuration</h2><h3 id="WebSecurityConfiguration-java"><a href="#WebSecurityConfiguration-java" class="headerlink" title="WebSecurityConfiguration.java"></a>WebSecurityConfiguration.java</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span> <span class="params">(HttpSecurity httpSecurity)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        httpSecurity.authorizeRequests()</span><br><span class="line">                .antMatchers(<span class="string">&quot;/code/image&quot;</span>).permitAll()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">                .formLogin()</span><br><span class="line">                .loginPage(<span class="string">&quot;/myLogin.html&quot;</span>)</span><br><span class="line">                .permitAll()</span><br><span class="line">                .and()</span><br><span class="line">                .csrf().disable();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="resources"><a href="#resources" class="headerlink" title="resources"></a>resources</h2><h3 id="static"><a href="#static" class="headerlink" title="static"></a>static</h3><h4 id="myLogin-html"><a href="#myLogin-html" class="headerlink" title="myLogin.html"></a>myLogin.html</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Loing - by Spring security<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>The is Spring security by html<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;/myLogin&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;user&quot;</span>/&gt;</span><span class="symbol">&amp;nbsp;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;pass&quot;</span>/&gt;</span></span><br><span class="line">    <span class="symbol">&amp;nbsp;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;Captcha&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;/code/image&quot;</span>&gt;</span><span class="symbol">&amp;nbsp;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;login go&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

	

	

</article>




	<article>
	
		<h1><a href="/2022/04/21/java/spring security/3.Spring security æˆæƒ/">Spring security æˆæƒ</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2022-04-21</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-none-link" href="/tags/java/" rel="tag">java</a> <a class="article__tag-none-link" href="/tags/spring-security/" rel="tag">spring security</a>
			</span>
		
	</div>

	

	
		<h2 id="controller"><a href="#controller" class="headerlink" title="controller"></a>controller</h2><h3 id="AdminController-java"><a href="#AdminController-java" class="headerlink" title="AdminController.java"></a>AdminController.java</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.dome.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/admin/api&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AdminController</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;index&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">index</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello, admin&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Userontroller-java"><a href="#Userontroller-java" class="headerlink" title="Userontroller.java"></a>Userontroller.java</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.dome.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user/api&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;index&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">index</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello, user&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="AppController-java"><a href="#AppController-java" class="headerlink" title="AppController.java"></a>AppController.java</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.dome.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/app/api&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppController</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;index&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">index</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello, app&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="configuration"><a href="#configuration" class="headerlink" title="configuration"></a>configuration</h2><h3 id="WebSecurityConfig-java"><a href="#WebSecurityConfig-java" class="headerlink" title="WebSecurityConfig.java"></a>WebSecurityConfig.java</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.dome.configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span> <span class="params">(HttpSecurity httpSecurity)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        httpSecurity.authorizeRequests()</span><br><span class="line">                .antMatchers(<span class="string">&quot;/admin/api/**&quot;</span>).hasRole(<span class="string">&quot;ADMIN&quot;</span>)</span><br><span class="line">                .antMatchers(<span class="string">&quot;/user/aip/**&quot;</span>).hasRole(<span class="string">&quot;USER&quot;</span>)</span><br><span class="line">                .antMatchers(<span class="string">&quot;/app/api/**&quot;</span>).permitAll()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">        .formLogin();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡ä¸Šè¿°æˆ‘ä»¬æ‰€å®šä¹‰çš„ä¸åŒæƒé™ï¼Œåˆ†åˆ«ä¸ºç®¡ç†å‘˜ã€ç”¨æˆ·ã€åŒ¿åï¼Œæ‰€åˆ†é…çš„æƒé™ä¸åŒï¼Œè€Œç®¡ç†å‘˜å’Œç”¨æˆ·æ˜¯éœ€è¦ç™»å…¥æ‰å¯ä»¥è®¿é—®çš„ï¼ŒåŒ¿åå¸å·appåˆ™å¯è®¿é—®æ‹¥æœ‰æƒé™ä¸‹çš„æ‰€æœ‰èµ„æºã€‚é€šè¿‡è®¿é—®localhost:8080&#x2F;user&#x2F;api&#x2F;indexæˆ‘ä»¬å¯ä»¥å¾—çŸ¥ï¼ŒSpring securityçš„é»˜è®¤å¸å·è§’è‰²ï¼Œå°±æ˜¯userã€‚</p>
<blockquote>
<p>HTTP çŠ¶æ€ç ï¼ˆHTTP Status Codeï¼‰æ˜¯ç”±RFC 2016å®šä¹‰çš„ä¸€ç§ç”¨äºè¡¨ç¤ºä¸€ä¸ªHTTPè¯·æ±‚å“åº”çŠ¶æ€çš„è§„èŒƒï¼Œæ€»å…±ç”±ä¸‰ä½æ•°å­—ç»„æˆã€‚é€šå¸¸ç”±2XXè¡¨ç¤ºæ“ä½œæˆåŠŸã€4XXè¡¨ç¤ºå®¢æˆ·ç«¯å¯¼è‡´çš„å¤±è´¥ï¼Œ5xxè¡¨ç¤ºæœåŠ¡å™¨å¼•èµ·é”™è¯¯ã€‚</p>
</blockquote>
<h2 id="å¤šç”¨æˆ·"><a href="#å¤šç”¨æˆ·" class="headerlink" title="å¤šç”¨æˆ·"></a>å¤šç”¨æˆ·</h2><h3 id="WebSecurityConfig-java-InMemoryUserDetailsManager"><a href="#WebSecurityConfig-java-InMemoryUserDetailsManager" class="headerlink" title="WebSecurityConfig.java (InMemoryUserDetailsManager)"></a>WebSecurityConfig.java (InMemoryUserDetailsManager)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.dome.configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.password.NoOpPasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.password.PasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.provisioning.InMemoryUserDetailsManager;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span> <span class="params">(HttpSecurity httpSecurity)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        httpSecurity.authorizeRequests()</span><br><span class="line">                .antMatchers(<span class="string">&quot;/admin/api/**&quot;</span>).hasRole(<span class="string">&quot;ADMIN&quot;</span>)</span><br><span class="line">                .antMatchers(<span class="string">&quot;/user/aip/**&quot;</span>).hasRole(<span class="string">&quot;USER&quot;</span>)</span><br><span class="line">                .antMatchers(<span class="string">&quot;/app/api/**&quot;</span>).permitAll()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">        .formLogin();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> UserDetailsService <span class="title function_">userDetailsService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">InMemoryUserDetailsManager</span> <span class="variable">inMemoryUserDetailsManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryUserDetailsManager</span>();</span><br><span class="line">        inMemoryUserDetailsManager.createUser(User.withUsername(<span class="string">&quot;user&quot;</span>).password(<span class="string">&quot;123&quot;</span>).roles(<span class="string">&quot;USER&quot;</span>).build());</span><br><span class="line">        inMemoryUserDetailsManager.createUser(User.withUsername(<span class="string">&quot;admin&quot;</span>).password(<span class="string">&quot;123&quot;</span>).roles(<span class="string">&quot;USER&quot;</span>,<span class="string">&quot;ADMIN&quot;</span>).build());</span><br><span class="line">        <span class="keyword">return</span> inMemoryUserDetailsManager;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> PasswordEncoder <span class="title function_">passwordEncoder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> NoOpPasswordEncoder.getInstance();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯¹äºSpring securityä¸­çš„å¤šç”¨æˆ·ï¼Œå®é™…ä¸Šspring securityä¸»è¦æ‹¥æœ‰ä¸‰ç§æƒé™ï¼Œåˆ†åˆ«ä¸ºç®¡ç†å‘˜ï¼ˆadminï¼‰ï¼Œç”¨æˆ·ï¼ˆuserï¼‰ä»¥åŠåŒ¿å&#x2F;è®¿å®¢ï¼ˆvisitorï¼‰ï¼Œå¯é€šè¿‡æ•°æ®åº“æˆ–Spring securityä¸­çš„é…ç½®ç±»è¿›è¡Œå®ç°ã€‚åœ¨å†™é¡¹ç›®çš„è¿‡ç¨‹ä¸­å»ºè®®è¿™ç§æˆæƒæƒ…å†µä¸è¦ä½¿ç”¨æ•°æ®åº“è¿›è¡Œæˆæƒï¼Œé€šè¿‡é…ç½®æ–‡ä»¶å°±å¯ä»¥å®ç°ï¼Œé¦–å…ˆç¡®å®šç®¡ç†å‘˜å’Œç”¨æˆ·ï¼Œ</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://gitee.com/zhongshan_union/Zhongshan-computer-port-security-joint-public-testing-platform/blob/master/src/main/java/com/example/zhongce/WebSecurityConfig.java">https://gitee.com/zhongshan_union/Zhongshan-computer-port-security-joint-public-testing-platform/blob/master/src/main/java/com/example/zhongce/WebSecurityConfig.java</a></p>
</blockquote>
<p>ç„¶åè®¿å®¢æƒé™å¯é€šè¿‡<code>antMatchers</code>æ¥å®ç°è®¿å®¢æƒé™å¯ä»¥è®¿é—®çš„é¡µé¢ï¼Œè¿™ç§æ–¹å¼ä¹Ÿè¢«å¼€æºé¡¹ç›®é’Ÿå±±è®¡ç®—æœºç«¯å£å®‰å…¨è”åˆä¼—æµ‹å¹³å°ä½¿ç”¨ã€‚</p>

	

	

</article>




	<article>
	
		<h1><a href="/2022/04/21/java/spring security/2.Spring security ç™»å½•ä¸è‡ªå®šä¹‰/">Spring security åˆ›å»ºé¡¹ç›®ä¸è‡ªå®šä¹‰ç™»é™†é¡µ</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2022-04-21</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-none-link" href="/tags/java/" rel="tag">java</a> <a class="article__tag-none-link" href="/tags/spring-security/" rel="tag">spring security</a>
			</span>
		
	</div>

	

	
		<p>æœ¬æ–‡é€šè¿‡ideaè¿›è¡Œä¸€äº›å®ä¾‹æ¼”ç¤ºï¼Œé€šè¿‡Spring Initializerå·¥å…·æ¥åˆ›å»ºspring securityé¡¹ç›®çš„ä¾‹å­ï¼Œé¦–å…ˆæˆ‘ä»¬åœ¨è‡ªåŠ¨æ„å»ºé¡¹ç›®ä¸­é€‰æ‹© Spring security ä»¥åŠ Spring Webï¼Œç„¶åç‚¹å‡»nextå³å¯è¿›è¡Œä¸‹ä¸€æ­¥ï¼Œé€šè¿‡Spring Initializeræ¥é€‰å®šä¸€äº›å¸¸ç”¨çš„é¡¹ç›®ä»¥æ¥ï¼Œå½“åˆ›å»ºé¡¹ç›®å®Œæˆåï¼ŒIdeaå°†ä¼šè‡ªåŠ¨ç”Ÿæˆpom.xmlæ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¯¥æ–‡ä»¶çœ‹å‡ºSpring Initializræ€»å…±å¼•å…¥äº†é‚£äº›ä¾èµ–ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.security<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-security-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="DomeApplication-class"><a href="#DomeApplication-class" class="headerlink" title="DomeApplication.class"></a>DomeApplication.class</h2><p>åœ¨ç¨‹åºçš„å¯åŠ¨ç±»ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾ç½®ä¸€ä¸ªç¨‹åºå…¥å£æ¥è®¿é—®ï¼Œä¹‹åSpring securityä¼šåœ¨è®¿é—®çš„æ—¶å€™ç›´æ¥ä½¿ç”¨å…¶è‡ªå¸¦çš„ç™»å…¥é¡µé¢ï¼Œè€Œç™»å…¥é¡µé¢çš„å¸å·åŠå…¶å¯†ç åˆ™é€šè¿‡application.propertieså³springå…¨å±€é…ç½®æ–‡ä»¶ä¸­è¿›è¡Œé…ç½®ï¼Œå¯åŠ¨ç±»ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.dome;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DomeApplication</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">index</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Helo,world,the is Spring security world.&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(DomeApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="application-properties"><a href="#application-properties" class="headerlink" title="application.properties"></a>application.properties</h2><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">//</span> <span class="string">user@å¸å· passowrd@å¯†ç </span></span><br><span class="line"><span class="attr">spring.security.user.name</span>=<span class="string">kun</span></span><br><span class="line"><span class="attr">spring.security.user.password</span>=<span class="string">123</span></span><br></pre></td></tr></table></figure>

<h2 id="è‡ªå®šä¹‰ç™»é™†é¡µ"><a href="#è‡ªå®šä¹‰ç™»é™†é¡µ" class="headerlink" title="è‡ªå®šä¹‰ç™»é™†é¡µ"></a>è‡ªå®šä¹‰ç™»é™†é¡µ</h2><h3 id="WebSecurityConfig-class"><a href="#WebSecurityConfig-class" class="headerlink" title="WebSecurityConfig.class"></a>WebSecurityConfig.class</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.dome.configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configurers.ExpressionUrlAuthorizationConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configurers.FormLoginConfigurer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span> <span class="params">(HttpSecurity httpSecurity)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ExpressionUrlAuthorizationConfigurer.<span class="type">ExpressionInterceptUrlRegistry</span> <span class="variable">expressionInterceptUrlRegistry</span> <span class="operator">=</span> httpSecurity.authorizeRequests();</span><br><span class="line">        ExpressionUrlAuthorizationConfigurer.<span class="type">AuthorizedUrl</span> <span class="variable">authorizedUrl</span> <span class="operator">=</span> (ExpressionUrlAuthorizationConfigurer.AuthorizedUrl) expressionInterceptUrlRegistry.anyRequest();</span><br><span class="line">        authorizedUrl.authenticated();</span><br><span class="line"></span><br><span class="line">        FormLoginConfigurer&lt;HttpSecurity&gt; formLoginConfigurer =</span><br><span class="line">                httpSecurity.formLogin();</span><br><span class="line">        formLoginConfigurer.loginPage(<span class="string">&quot;/myLogin.html&quot;</span>);</span><br><span class="line">        formLoginConfigurer.permitAll();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.dome.configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configurers.ExpressionUrlAuthorizationConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configurers.FormLoginConfigurer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span> <span class="params">(HttpSecurity httpSecurity)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        httpSecurity.authorizeRequests()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">        .formLogin()</span><br><span class="line">                .loginPage(<span class="string">&quot;/myLogin.html&quot;</span>)</span><br><span class="line">                .permitAll()</span><br><span class="line">                .and()</span><br><span class="line">        .csrf().disable();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™è¿™é‡Œæˆ‘ä»¬ä¸»è¦æä¾›äº†ä¸¤ç§æ–¹æ³•ï¼Œé€šå¸¸æˆ‘ä»¬åœ¨å†™é¡¹ç›®çš„æ—¶å€™éƒ½ä¼šä½¿ç”¨ç¬¬äºŒç§æ–¹æ³•ï¼Œè€Œç¬¬ä¸€ç§æ–¹æ³•è¿™æ˜¯ä¸€ä¸ªéå¸¸ä»¤äººæ— è¯­çš„äº‹æƒ…ï¼Œä½¿ç”¨äº†HttpSecurityå®é™…ä¸Šæ˜¯å¯¹åº”äº†Spring securityå‘½åç©ºé—´çš„é…ç½®æ–¹å¼ï¼Œå…è®¸æˆ‘ä»¬ç‰¹å®šçš„HTTPPè¯·æ±‚é…ç½®å®‰å…¨ç­–ç•¥ï¼Œæ‰€ä»¥ç›¸å¯¹ç¬¬äºŒç§æ–¹æ³•è€Œè®²ï¼Œæˆ‘ä»¬å–œæ¬¢ç¬¬äºŒç§ï¼ŒHttpSecurityæä¾›äº†å¾ˆå¤šé…ç½®çš„ç›¸å…³æ–¹æ³•ã€‚åˆ†åˆ«å¯¹åº”å‘½åç©ºé—´é…ç½®ä¸­çš„å­æ ‡ç­¾åˆ†<http>å¦‚ï¼š</p>
<table>
<thead>
<tr>
<th>ID</th>
<th>DA</th>
</tr>
</thead>
<tbody><tr>
<td>authorizeRequest()</td>
<td><code>&lt;intercept-url&gt;</code></td>
</tr>
<tr>
<td>formLogin()</td>
<td><code>&lt;form-login&gt;</code></td>
</tr>
<tr>
<td>httpBasic()</td>
<td><code>&lt;http-basic&gt;</code></td>
</tr>
<tr>
<td>csrf()</td>
<td><code>&lt;csrf&gt;</code></td>
</tr>
</tbody></table>
<p>é€šè¿‡è°ƒç”¨è¿™äº›æ–¹æ³•åï¼Œé™¤äº†ä½¿ç”¨and()æ–¹æ³•æ¥ç»“æŸå½“å‰æ ‡ç­¾ï¼Œæ‰ä¼šè¿”å›åˆ°Httpsecurityï¼Œå¦åˆ™å°†ä¼šè‡ªåŠ¨è¿›å…¥å¯¹åº”æ ‡ç­¾åŸŸã€‚authorizeRequests()æ–¹æ³•å®é™…æ’’æ±—åŠŸèƒ½è¿”å›äº†ä¸€ä¸ªurlæ‹¦æˆªæ³¨å†Œå™¨ï¼Œå¯ä»¥è°ƒç”¨å®ƒæä¾›çš„anyanyRequest()ã€antMatchers()å’ŒregexMatchers()æ–¹æ³•æ¥è¿›è¡ŒåŒ¹é…ç³»ç»Ÿçš„urlï¼Œå¹¶ä¸ºå…¶æŒ‡å®šå®‰å…¨ç­–ç•¥ã€‚</p>
<p>formLogin()æ–¹æ³•å’ŒhttpBasic()æ–¹æ³•éƒ½å°†å£°æ˜éœ€è¦Spring securityæä¾›è¡¨å•è®¤è¯æ–¹å¼ï¼Œåˆ†åˆ«è¿”å›å¯¹åº”çš„é…ç½®å™¨ï¼Œå…¶ä¸­formLogin().loginPage()ä¸ºæŒ‡å®šè‡ªå®šä¹‰ç™»é™†é¡µé¢ï¼ŒåŒæ—¶Spring securityä¼šæ³¨å†Œä¸€ä¸ªè·¯ç”±ç”¨äºæ¥å—è¯·æ±‚ï¼Œè€Œcsrf()æ–¹æ³•åˆ™æ˜¯Spring securityæ‰€æä¾›çš„å¤¸ç«™è¯·æ±‚ä¼ªé€  é˜²æŠ¤å…¬é¥ï¼Œå½“WebSeecurityConfigç»§æ‰¿WebSecurityConfigurerAdapterçš„æ—¶å€™å°†ä¼šé»˜è®¤å¼€å¯csrf()æ–¹æ³•ã€‚</p>
<h3 id="myLogin-html"><a href="#myLogin-html" class="headerlink" title="myLogin.html"></a>myLogin.html</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- static/myLogin.html --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Loing - by Spring security<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>The is Spring security by html<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;/login&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;user&quot;</span>/&gt;</span><span class="symbol">&amp;nbsp;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;pass&quot;</span>/&gt;</span></span><br><span class="line">    <span class="symbol">&amp;nbsp;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;login go&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="æŒ‡å®šç™»é™†å¤„ç†è·¯å¾„"><a href="#æŒ‡å®šç™»é™†å¤„ç†è·¯å¾„" class="headerlink" title="æŒ‡å®šç™»é™†å¤„ç†è·¯å¾„"></a>æŒ‡å®šç™»é™†å¤„ç†è·¯å¾„</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.dome.configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configurers.ExpressionUrlAuthorizationConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configurers.FormLoginConfigurer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span> <span class="params">(HttpSecurity httpSecurity)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        httpSecurity.authorizeRequests()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">        .formLogin()</span><br><span class="line">                .loginPage(<span class="string">&quot;/myLogin.html&quot;</span>)</span><br><span class="line">                .loginProcessingUrl(<span class="string">&quot;/login&quot;</span>) <span class="comment">// æŒ‡å®šå¤„ç†è·¯å¾„</span></span><br><span class="line">                .permitAll()</span><br><span class="line">                .and()</span><br><span class="line">        .csrf().disable();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ç™»å½•æˆåŠŸä¸ç™»å…¥å¤±è´¥é€»è¾‘-successHandler-and-failureHandler"><a href="#ç™»å½•æˆåŠŸä¸ç™»å…¥å¤±è´¥é€»è¾‘-successHandler-and-failureHandler" class="headerlink" title="ç™»å½•æˆåŠŸä¸ç™»å…¥å¤±è´¥é€»è¾‘ (successHandler and failureHandler)"></a>ç™»å½•æˆåŠŸä¸ç™»å…¥å¤±è´¥é€»è¾‘ (successHandler and failureHandler)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.dome.configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configurers.ExpressionUrlAuthorizationConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configurers.FormLoginConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.Authentication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.AuthenticationException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.AuthenticationFailureHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.AuthenticationSuccessHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span> <span class="params">(HttpSecurity httpSecurity)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        httpSecurity.authorizeRequests()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">        .formLogin()</span><br><span class="line">                .loginPage(<span class="string">&quot;/myLogin.html&quot;</span>)</span><br><span class="line">                .loginProcessingUrl(<span class="string">&quot;/login&quot;</span>) <span class="comment">// æŒ‡å®šå¤„ç†è·¯å¾„</span></span><br><span class="line">                <span class="comment">// ç™»å…¥æˆåŠŸå¤„ç†</span></span><br><span class="line">                .successHandler(<span class="keyword">new</span> <span class="title class_">AuthenticationSuccessHandler</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAuthenticationSuccess</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Authentication authentication)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">                        httpServletResponse.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">                        <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> httpServletResponse.getWriter();</span><br><span class="line">                            out.write(<span class="string">&quot;&#123;\&quot;error_code\&quot;:\&quot;0\&quot;,\&quot;message\&quot;:\&quot;Hello login -by spring security\&quot;&#125;&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">                <span class="comment">// ç™»å…¥å¤±è´¥å¤„ç†</span></span><br><span class="line">                .failureHandler(<span class="keyword">new</span> <span class="title class_">AuthenticationFailureHandler</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAuthenticationFailure</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, AuthenticationException e)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">                        httpServletResponse.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">                        httpServletResponse.setStatus(<span class="number">401</span>);</span><br><span class="line">                        <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> httpServletResponse.getWriter();</span><br><span class="line">                        <span class="comment">// cause</span></span><br><span class="line">                        out.write(<span class="string">&quot;&#123;\&quot;error_code\&quot;:\&quot;401\&quot;,\&quot;name\&quot;:\&quot;&quot;</span> + e.getClass() + <span class="string">&quot;\&quot;, \&quot;message\&quot;:\&quot;&quot;</span> + e.getMessage() + <span class="string">&quot;\&quot;&#125;&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">                .permitAll()</span><br><span class="line">                .and()</span><br><span class="line">        .csrf().disable();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
	

	

</article>




	<article>
	
		<h1><a href="/2022/04/21/java/spring security/10.Spring Security OAuth/">Spring Security OAuth</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2022-04-21</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-none-link" href="/tags/java/" rel="tag">java</a> <a class="article__tag-none-link" href="/tags/spring-security/" rel="tag">spring security</a>
			</span>
		
	</div>

	

	
		<p>å¼€æ”¾æˆæƒï¼ˆOpen Authorizationï¼‰æ˜¯ä¸€ç§å¼€æ”¾çš„åè®®ï¼Œå³åœ°æ¡‘æˆ¿å¯ä»¥ä½¿ç”¨ç¬¬ä¸‰æ–¹åº”ç”¨ä»£è¡¨èµ„æºæ‰€æœ‰è€…è·å–æœ‰é™çš„è®¿é—®æˆæƒæœºåˆ¶ï¼Œåœ¨æ•´ä¸ªæˆæƒçš„è¿‡ç¨‹ä¸­ï¼Œç¬¬ä¸‰æ–¹ç«™ç‚¹æ— éœ€æ¶‰åŠç”¨æˆ·çš„å¯†ç å³å¯è·å–éƒ¨åˆ†çš„èµ„æºã€‚åœ¨å¾ˆå¤šçš„ç«™ç‚¹åœºæ™¯ä¹‹ä¸­ï¼Œéƒ½æä¾›äº†ç¬¬ä¸‰æ–¹ç™»å…¥ç­‰ç›¸å…³ä¿¡æ¯ï¼Œå¦‚QQã€å¾®ä¿¡æ‰«ç ç™»å½•ç­‰æœºåˆ¶ï¼Œè€Œè¿™å½“æˆ‘ä»¬ç‚¹å‡»ç¬¬ä¸‰æ–¹ç™»å½•æ—¶ä¼šè·³è½¬åˆ°æˆæƒçš„ç™»å½•é¡µé¢ï¼Œç„¶åç™»å…¥æˆåŠŸå°±ä¼šè·³è½¬åˆ°è®¿é—®çš„ç›®æ ‡ç«™ç‚¹ä¹‹ä¸­ï¼Œè€Œè¿™è¿‡ç¨‹ä¸­è¯¥ç«™ç‚¹å°±ä¸ä¼šè·å–åˆ°ç”¨æˆ·çš„å¯†ç ç­‰ç›¸å…³ä¿¡æ¯ï¼Œä¸»è¦æµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>å®¢æˆ·ç«¯è¦æ±‚ç”¨æˆ·æä¾›æˆæƒè®¸å¯</li>
<li>ç”¨æˆ·åŒæ„å‘å®¢æˆ·ç«¯æä¾›æˆæƒè®¸å¯</li>
<li>å®¢æˆ·ç«¯æºå¸¦ç”¨æˆ·æ‰€æä¾›çš„æˆæƒè®¸å¯å‘æˆæƒæœåŠ¡å™¨ç”³è¯·è®¿é—®ä»¤ç‰Œ</li>
<li>æˆæƒæœåŠ¡å™¨éªŒè¯å®¢æˆ·ç«¯æ˜¯å¦æºå¸¦æˆæƒè®¸å¯ï¼Œå¦‚æœ‰æ•ˆåˆ™å‘æ”¾è®¿é—®ä»¤ç‰Œ</li>
<li>å®¢æˆ·ç«¯ä½¿ç”¨è®¿é—®ä»¤ç‰Œç”³è¯·æœåŠ¡å™¨èµ„æº</li>
<li>èµ„æºæœåŠ¡å™¨éªŒè¯è®¿é—®ä»¤ç‰Œï¼Œç¡®è®¤æ­£ç¡®åå‘å®¢æˆ·ç«¯æä¾›èµ„æºã€‚</li>
</ol>
<h2 id="å››ç§æˆæƒæ¨¡å¼"><a href="#å››ç§æˆæƒæ¨¡å¼" class="headerlink" title="å››ç§æˆæƒæ¨¡å¼"></a>å››ç§æˆæƒæ¨¡å¼</h2><h3 id="æˆæƒç æ¨¡å¼ï¼ˆAuthorization-Codeï¼‰"><a href="#æˆæƒç æ¨¡å¼ï¼ˆAuthorization-Codeï¼‰" class="headerlink" title="æˆæƒç æ¨¡å¼ï¼ˆAuthorization Codeï¼‰"></a>æˆæƒç æ¨¡å¼ï¼ˆAuthorization Codeï¼‰</h3><p>æˆæƒç æ¨¡å¼æ˜¯åŠŸèƒ½è¾ƒä¸ºå®Œæ•´ï¼Œå®‰å…¨æ€§å’Œç”¨æˆ·ä¿¡æ¯å­˜åœ¨åº”ç”¨æœåŠ¡å™¨å®æ¥¼é£é™©å°ã€æœåŠ¡å™¨ä¸æœåŠ¡å™¨ä¹‹é—´çš„è®¿é—®éš¾ä»¥è¢«æŠ“å–ç­‰ç›¸å…³ä¼˜ç‚¹ã€‚</p>
<ol>
<li><p>é‡å®šå‘åˆ°è®¤è¯æœåŠ¡å™¨</p>
</li>
<li><p>è®¤è¯æœåŠ¡å™¨ç”¨æˆ·æˆæƒ</p>
</li>
<li><p>è®¤è¯æœåŠ¡å™¨-&gt;åº”ç”¨æœåŠ¡å™¨é‡å®šå‘åº”ç”¨æœåŠ¡å™¨ï¼Œå¸¦ä¸Šæˆæƒç </p>
</li>
<li><p>åº”ç”¨æœåŠ¡å™¨-&gt;è®¤è¯æœåŠ¡å™¨è·å–è®¿é—®ä»¤ç‰Œï¼ˆç”¨æˆæƒç æ¢å¾—ï¼‰</p>
</li>
<li><p>è®¤è¯æœåŠ¡å™¨-&gt;åº”ç”¨æœåŠ¡å™¨è®¤è¯æœåŠ¡å™¨è·å–è®¿é—®ä»¤ç‰Œ</p>
</li>
<li><p>åº”ç”¨æœåŠ¡å™¨-&gt;èµ„æºæœåŠ¡å™¨è®¿é—®èµ„æºæœåŠ¡å™¨</p>
</li>
</ol>
<h3 id="éšå¼æˆæƒï¼ˆImplicit-Grantï¼‰"><a href="#éšå¼æˆæƒï¼ˆImplicit-Grantï¼‰" class="headerlink" title="éšå¼æˆæƒï¼ˆImplicit Grantï¼‰"></a>éšå¼æˆæƒï¼ˆImplicit Grantï¼‰</h3><p>éšå¼æˆæƒæ¨¡å¼æ˜¯æŒ‡è®¿é—®ä»¤ç‰Œé€šè¿‡é‡å®šå‘çš„æ–¹å¼ä¼ é€’åˆ°ç”¨æˆ·æµè§ˆå™¨ä¹‹ä¸­ï¼Œä¹‹åé€šè¿‡jsè·å–è®¿é—®ä»¤ç‰Œã€‚é€šè¿‡ä½¿ç”¨éšå£«éªŒè¯æˆ‘ä»¬å¯ä»¥å…äºåå°å’Œå­˜å‚¨ï¼Œå°†ä¿¡æ¯å­˜å‚¨ä¸Tokenæˆ–Cookieä¹‹ä¸­ï¼ŒåŸºæœ¬ä¸Šé€šè¿‡è®¤è¯åå¯ç›´æ¥è¿›è¡Œè®¿é—®ã€‚</p>
<h3 id="å¯†ç æˆæƒæ¨¡å¼ï¼ˆPassword-Credentialsï¼‰"><a href="#å¯†ç æˆæƒæ¨¡å¼ï¼ˆPassword-Credentialsï¼‰" class="headerlink" title="å¯†ç æˆæƒæ¨¡å¼ï¼ˆPassword Credentialsï¼‰"></a>å¯†ç æˆæƒæ¨¡å¼ï¼ˆPassword Credentialsï¼‰</h3><p>å¯†ç æˆæƒæ¨¡å¼å³é€šè¿‡æµè§ˆå™¨ç›´æ¥æºå¸¦ç”¨æˆ·çš„å¯†ç å‘æˆæƒæœåŠ¡å™¨ç”³è¯·ä»¤ç‰Œï¼Œè¿™ç§æˆæƒæ¨¡å¼ä¸ç”¨é€šè¿‡è·³è½¬åˆ°æˆæƒæœåŠ¡å™¨è¿›è¡Œï¼Œè€Œæ˜¯é€šè¿‡èµ„æºæœåŠ¡å™¨æä¾›çš„é¡µé¢è¿›è¡Œã€‚</p>
<h3 id="å®¢æˆ·ç«¯æˆæƒæ¨¡å¼ï¼ˆClient-Credentialsï¼‰"><a href="#å®¢æˆ·ç«¯æˆæƒæ¨¡å¼ï¼ˆClient-Credentialsï¼‰" class="headerlink" title="å®¢æˆ·ç«¯æˆæƒæ¨¡å¼ï¼ˆClient Credentialsï¼‰"></a>å®¢æˆ·ç«¯æˆæƒæ¨¡å¼ï¼ˆClient Credentialsï¼‰</h3><p>ä¸ä¸Šé¢ä¸‰ç§æ¨¡å¼ç›¸æ¯”ä¹‹ä¸‹ï¼Œå®¢æˆ·ç«¯æˆæƒæ¨¡å¼ç›¸å¯¹äºè¾ƒä¸ºç®€å•ï¼Œåªéœ€è¦å®¢æˆ·ç«¯è¯·åº”ç”¨å…¬é’¥ã€å¯†é’¥ç­‰æ´—è„‘æ´—æƒ³æˆæƒæœåŠ¡å™¨ç”³è¯·è®¿é—®ä»¤ç‰Œï¼Œä»è€Œè´§æ¸ é“æœåŠ¡å™¨æ‰€æä¾›çš„èµ„æºã€‚</p>
<h2 id="OAuth-2-0-github-and-login"><a href="#OAuth-2-0-github-and-login" class="headerlink" title="OAuth 2.0 github and login"></a>OAuth 2.0 github and login</h2><p>å¦‚æœè¦æ¥å…¥githubçš„æˆæƒï¼Œåˆ™éœ€è¦è®¿é—®<a target="_blank" rel="noopener" href="https://github.com/settings/applications/new%EF%BC%8C%E6%9D%A5%E7%94%B3%E8%AF%B7%E4%B8%80%E4%B8%AA%E5%BA%94%E7%94%A8%E5%B9%B6%E5%9C%A8%E6%AD%A4%E5%A1%AB%E5%86%99%E5%BA%94%E7%94%A8%E5%90%8D%E7%A7%B0%E3%80%81%E4%B8%BB%E9%A1%B5URL%E3%80%81%E5%BA%94%E7%94%A8%E8%AF%B4%E6%98%8E%E3%80%81%E8%AE%A4%E8%AF%81%E6%97%B6%E9%87%8D%E5%AE%9A%E5%90%91%E7%9A%84%E9%A1%B5%E9%9D%A2%E5%8D%B3%E5%8F%AF%E3%80%82%EF%BC%88%E9%9C%80%E8%A6%81%E6%B3%A8%E6%84%8F%E7%9A%84%E6%98%AF%E5%9C%A8%E6%9C%AC%E5%9C%B0%E5%BC%80%E5%8F%91%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E4%B8%BB%E9%A1%B5URL%E9%9C%80%E8%A6%81%E8%AE%BE%E7%BD%AE%E4%B8%BA%60%60%60http://localhost:8080%60%60%60%EF%BC%8C%E8%AE%A4%E8%AF%81%E9%87%8D%E5%AE%9A%E5%90%91%E5%9C%B0%E5%9D%80%E8%AE%BE%E7%BD%AE%E4%B8%BA%60%60%60http://localhost:8080/login/oauth2/code/github%60%60%60%EF%BC%89%E3%80%82">https://github.com/settings/applications/newï¼Œæ¥ç”³è¯·ä¸€ä¸ªåº”ç”¨å¹¶åœ¨æ­¤å¡«å†™åº”ç”¨åç§°ã€ä¸»é¡µURLã€åº”ç”¨è¯´æ˜ã€è®¤è¯æ—¶é‡å®šå‘çš„é¡µé¢å³å¯ã€‚ï¼ˆéœ€è¦æ³¨æ„çš„æ˜¯åœ¨æœ¬åœ°å¼€å‘çš„æ—¶å€™ï¼Œä¸»é¡µURLéœ€è¦è®¾ç½®ä¸º```http://localhost:8080```ï¼Œè®¤è¯é‡å®šå‘åœ°å€è®¾ç½®ä¸º```http://localhost:8080/login/oauth2/code/github```ï¼‰ã€‚</a><br>ç‚¹å‡»ç¡®å®šåå°†ä¼šè·³è½¬è‡³åº”ç”¨åˆ›å»ºæˆåŠŸé¡µé¢ï¼Œå¹¶è·å¾—åˆ°å®¢æˆ·ç«¯IDï¼ˆClient IDï¼‰ä»¥åŠå®¢æˆ·ç«¯å¯†ç ï¼ˆClient secretsï¼‰</p>
<blockquote>
<p>Client ID<br>****cd6dcb6f7289b5c56<br>****2a5b45fa0b528837b2181617e7</p>
</blockquote>
<p>Spring Security OAuthé»˜è®¤çš„é‡å®šå‘æ¨¡æ¿æ˜¯<code>&#123;baseUrl&#125;/login/oauth2/code&#123;registrationId&#125;</code>registrationIdæ˜¯Client Registrationaçš„å”¯ä¸€IDï¼Œé€šå¸¸æ¥å…¥çš„OAuthæœåŠ¡æä¾›å•†çš„ç®€ç§°æ¥å‘½åã€‚</p>
<h3 id="resources"><a href="#resources" class="headerlink" title="resources"></a>resources</h3><h4 id="application-yml"><a href="#application-yml" class="headerlink" title="application.yml"></a>application.yml</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">security:</span></span><br><span class="line">    <span class="attr">oauth2:</span></span><br><span class="line">      <span class="attr">client:</span></span><br><span class="line">        <span class="attr">registration:</span></span><br><span class="line">          <span class="attr">github:</span></span><br><span class="line">            <span class="attr">clientId:</span> <span class="string">&lt;clientid&gt;</span></span><br><span class="line">            <span class="attr">clientSecret:</span> <span class="string">&lt;clientSecret&gt;</span></span><br><span class="line">            <span class="comment"># éœ€è¦è·å–çš„ä¿¡æ¯</span></span><br><span class="line">            <span class="attr">scope:</span> <span class="string">read:user,</span> <span class="string">user:email</span></span><br></pre></td></tr></table></figure>
<h3 id="static"><a href="#static" class="headerlink" title="static"></a>static</h3><h4 id="login-html"><a href="#login-html" class="headerlink" title="login.html"></a>login.html</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Spring boot security and OAuth2.0 github login<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Login github&gt; <span class="tag">&lt;/<span class="name">h1</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/oauth2/authorization/github&quot;</span>&gt;</span>Go<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h3><h4 id="IndexController-java"><a href="#IndexController-java" class="headerlink" title="IndexController.java"></a>IndexController.java</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.client.OAuth2AuthorizedClientService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.security.Principal;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">IndexController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OAuth2AuthorizedClientService auth2AuthorizedClientService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">index</span><span class="params">(Principal principal)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hey,&quot;</span> + principal.getName();        <span class="comment">// getName ä¸ºè·å–å…¶github id</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Configuration"><a href="#Configuration" class="headerlink" title="Configuration"></a>Configuration</h3><h4 id="WebSecurityConfiguration-java"><a href="#WebSecurityConfiguration-java" class="headerlink" title="WebSecurityConfiguration.java"></a>WebSecurityConfiguration.java</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.util.matcher.AntPathRequestMatcher;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfiguration</span>  <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity httpSecurity)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        httpSecurity.authorizeRequests()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">            .oauth2Login()</span><br><span class="line">                .loginPage(<span class="string">&quot;/login.html&quot;</span>)</span><br><span class="line">                .defaultSuccessUrl(<span class="string">&quot;/&quot;</span>).permitAll()</span><br><span class="line">                .and()</span><br><span class="line">            .logout()</span><br><span class="line">                .logoutRequestMatcher(<span class="keyword">new</span> <span class="title class_">AntPathRequestMatcher</span>(<span class="string">&quot;/logout&quot;</span>,<span class="string">&quot;GET&quot;</span>))</span><br><span class="line">                .deleteCookies(<span class="string">&quot;true&quot;</span>)</span><br><span class="line">                .logoutSuccessUrl(<span class="string">&quot;/login.html?logout&quot;</span>)</span><br><span class="line">                .permitAll();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
	

	

</article>




	<article>
	
		<h1><a href="/2022/04/21/java/spring security/1.Spring security ç®€ä»‹/">Spring security</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2022-04-21</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-none-link" href="/tags/java/" rel="tag">java</a> <a class="article__tag-none-link" href="/tags/spring-security/" rel="tag">spring security</a>
			</span>
		
	</div>

	

	
		<p>Spring security æ˜¯ä¸€ä¸ªåŠŸèƒ½å‘¢ä¸ªå¼ºå¤§ä¸”é«˜åº¦å¯å®šåˆ¶çš„èº«ä»½éªŒè¯å’Œè®¿é—®æ§åˆ¶æ¡†æ¶ï¼Œä¸»è¦ç”¨äºä¿æŠ¤Springåº”ç”¨ç¨‹åºï¼Œå¹¶è‡´åŠ›äºä¸ºJavaåº”ç”¨æä¾›èº«ä»½éªŒè¯å’Œæˆæƒã€‚</p>
<blockquote>
<p>Spring Security is a powerful and highly customizable authentication and access-control framework. It is the de-facto standard for securing Spring-based applications.<br>Spring Security is a framework that focuses on providing both authentication and authorization to Java applications. Like all Spring projects, the real power of Spring Security is found in how easily it can be extended to meet custom requirements</p>
</blockquote>
<p>åœ¨Spring securityæˆä¸º Spring çš„å­é¡¹ç›®ä¹‹å‰ï¼Œä»–çš„å‰èº«åä¸ºâ€œAcegi Securityâ€ï¼Œåœ¨æˆä¸ºspringçš„å­é¡¹ç›®ä¹‹åæ›´åä¸ºæ­£å¼æ›´åä¸ºâ€œSpring securityâ€ã€‚</p>
<h2 id="è®¤è¯å’Œæˆæƒ"><a href="#è®¤è¯å’Œæˆæƒ" class="headerlink" title="è®¤è¯å’Œæˆæƒ"></a>è®¤è¯å’Œæˆæƒ</h2><p>spring securityä¸»è¦é’ˆå¯¹çš„å³æ˜¯è®¤è¯å’Œæˆæƒï¼Œåˆ†åˆ«é€šè¿‡è®¤è¯å’Œæˆæƒæ¥èµ·åˆ°ä¸€å®šçš„ä¿æŠ¤æ€§ä½œç”¨ï¼Œè€Œè¿™äº›é€šå¸¸ä¸æ˜¯spring securityæ‰€ç‹¬æœ‰çš„ï¼š</p>
<h3 id="è®¤è¯"><a href="#è®¤è¯" class="headerlink" title="è®¤è¯"></a>è®¤è¯</h3><p>è®¤è¯æ˜¯ç”¨äºç¡®è®¤ç”¨æˆ·æˆ–ä¸ªäººåœ¨æŸä¸ªç³»ç»Ÿæˆ–åœºåˆä¸­æ˜¯å¦åˆæ³•ï¼Œè¿™é‡Œä¸»è¦åº”ç”¨åœ¨ç™»å…¥ç³»ç»Ÿçš„ç”¨æˆ·ã€‚å¯ä»¥ä»æˆ‘ä»¬æ—¥å¸¸ç”Ÿæ´»ä¸­æ‰€äº†è§£ï¼Œå¼€é—¨éœ€è¦é’¥åŒ™ï¼Œåˆ™é€šè¿‡é’¥åŒ™è¿›å»åˆ™ä¸ºåˆæ³•ï¼Œè¿™é‡Œçš„é’¥åŒ™æ³›æŒ‡æ³¨å†Œï¼Œå¼€é—¨çš„åŠ¨ä½œæ³›æŒ‡ç™»å½•ã€‚spring securityæ”¯<br>æŒå¹¿æ³›çš„è®¤è¯æŠ€æœ¯ï¼Œè€Œè¿™äº›è®¤è¯æŠ€æœ¯å¤§å¤šç”±ç¬¬ä¸‰æ–¹ç»„ç»‡æˆ–ç›¸å…³æ ‡å‡†åŒ–ç»„ç»‡è¿›è¡Œå¼€å‘ï¼Œå¹¶ç”±spring securityè¿›è¡Œé›†æˆï¼Œç›®å‰å·²ç»é›†æˆçš„è®¤è¯æŠ€æœ¯å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th>ID</th>
<th>DA</th>
<th>FA</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>HTTP BASIC authentication haders</td>
<td>åŸºäºIEFT RFC çš„æ ‡å‡†è®¤è¯</td>
</tr>
<tr>
<td>2</td>
<td>HTTP Diget authentication headers</td>
<td>åŸºäºIETF RFC çš„æ ‡å‡†è®¤è¯</td>
</tr>
<tr>
<td>3</td>
<td>HTTP X.509 client certificate exchange</td>
<td>åŸºäºIETF RFC çš„æ ‡å‡†è®¤è¯</td>
</tr>
<tr>
<td>4</td>
<td>LDAP Lightweight Directory Access Protocol</td>
<td>å¸¸è§çš„è·¨å¹³å°èº«ä»½éªŒè¯æ–¹å¼</td>
</tr>
<tr>
<td>5</td>
<td>Form-based authentiation</td>
<td>ç”¨äºç®€å•çš„ç”¨æˆ·ç•Œé¢éœ€æ±‚</td>
</tr>
<tr>
<td>6</td>
<td>OpenID authentication</td>
<td>å»ä¸­å¿ƒåŒ–èº«ä»½éªŒè¯æ–¹å¼</td>
</tr>
<tr>
<td>7</td>
<td>Authentication based on pre-established request head</td>
<td>ä¸€ç§ç”¨æˆ·èº«ä»½éªŒè¯åŠæˆæƒçš„é›†ä¸­å¼çš„å®‰å…¨åŸºç¡€æ–¹æ¡ˆ</td>
</tr>
<tr>
<td>8</td>
<td>Jasig Ceantral Authentication Service</td>
<td>å•ç‚¹ç™»å…¥è§£å†³æ–¹æ¡ˆ</td>
</tr>
<tr>
<td>9</td>
<td>Transparent authentication context propagation for Remote Method Invocation (RIM) and HttpInvoker</td>
<td>Spring è¿œç¨‹è°ƒç”¨åè®®</td>
</tr>
<tr>
<td>10</td>
<td>Automatic â€œremember-meâ€ authentication</td>
<td>å…è®¸åœ¨æŒ‡å®šåˆ°æœŸå‰è‡ªè¡Œé‡æ–°ç™»å…¥</td>
</tr>
<tr>
<td>11</td>
<td>Anonymous authentication</td>
<td>å…è®¸åŒ¿åç”¨æˆ·ä½¿ç”¨ç‰¹å®šçš„èº«ä»½å®‰å…¨çš„è®¿é—®èµ„æº</td>
</tr>
<tr>
<td>12</td>
<td>Run-as authentication</td>
<td>å…è®¸åœ¨ä¼šè¯ä¸­å˜æ¢ç”¨æˆ·çš„èº«ä»½æœºåˆ¶</td>
</tr>
<tr>
<td>13</td>
<td>Java Authentication and Authorization Service JAAS</td>
<td>Java éªŒè¯å’ŒæˆæƒAPI</td>
</tr>
<tr>
<td>14</td>
<td>Java EE container authentication</td>
<td>å…è®¸ç³»ç»Ÿç»§ç»­ä½¿ç”¨å®¹å™¨ç®¡ç†è¿™ç§èº«ä»½éªŒè¯æ–¹å¼</td>
</tr>
<tr>
<td>15</td>
<td>Kerberos</td>
<td>ä½¿ç”¨å¯¹ç§°å¯†é’¥æœºåˆ¶ï¼Œå…è®¸å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ç›¸äº’ç¡®è®¤èº«ä»½éªŒè¯åè®®</td>
</tr>
</tbody></table>
<h3 id="æˆæƒ"><a href="#æˆæƒ" class="headerlink" title="æˆæƒ"></a>æˆæƒ</h3><p>æˆæƒçš„è¿‡ç¨‹æ˜¯æŒ‡ç”¨æˆ·é€šè¿‡è®¤è¯ä¹‹åï¼Œæ˜¯å¦å…è®¸å¯¹æŸä¸ªåŠŸèƒ½çš„æ“ä½œè¿‡ç¨‹ã€‚æˆ‘ä»¬å¯ä»¥å‡è®¾æˆæƒæ˜¯æŒ‡ä½ å®¶é‡Œçš„å®¢äººå¼€å®Œé—¨ä¹‹åï¼Œæ˜¯å¦å¯ä»¥è¿›å…¥ä½ çš„ä¸»å§ï¼Œéœ€è¦å¾å¾—ä½ çš„åŒæ„ã€‚è¿™é‡Œæˆ‘ä»¬å¯åˆ†ä¸ºç”¨æˆ·å’Œç®¡ç†å‘˜ä¸¤ä¸ªæ ¸å¿ƒçš„æ¦‚å¿µï¼Œä½ æ˜¯å®¶é‡Œçš„ä¸»äººï¼Œå³ç®¡ç†å‘˜ï¼Œå®¢äººæ˜¯ç”¨æˆ·ï¼Œæ˜¯å¦èƒ½è¿›å…¥æŸä¸ªåœ°æ–¹éœ€è¦å¾å¾—ä½ çš„åŒæ„ã€‚</p>
<p>é™¤ä»¥ä¸Šä¹‹å¤–ï¼ŒSpring securityè¿˜å¼•å…¥äº†å¾ˆå¤šçš„ç¬¬ä¸‰æ–¹åŒ…ç”¨äºæ”¯æŒæ›´å¤šçš„è®¤è¯æŠ€æœ¯ï¼ŒSpring securityå…è®¸ç¼–å†™è‡ªå·±ç‹¬ä¸€æ— äºŒçš„è®¤è¯æŠ€æœ¯ï¼Œåœ¨ç»å¤§çš„æƒ…å†µä¸‹ï¼Œæ—¢ç„¶ä½¿ç”¨ Spring boot ã€ spring å¼€å‘é¡¹ç›®ï¼Œä½¿ç”¨è‡ªå®¶çš„spring securityå²‚ä¸æ˜¯æ›´å¥½ï¼Ÿä¸”å®Œç¾ã€‚é™¤äº†è®¤è¯ä»¥å¤–ï¼Œåœ¨æˆæƒä¸Šï¼ŒSpring srcurityä¸ä»…ä»…æ”¯æŒåŸºäºURLçš„webè¯·æ±‚æˆæƒï¼Œè¿˜æ”¯æŒæ–¹æ³•è®¿é—®æˆæƒå¯¹è±¡æˆæƒç­‰ï¼Œè¦†ç›–äº†å¤§éƒ¨åˆ†çš„æˆæƒèŒƒå›´å’Œåœºæ™¯ã€‚</p>

	

	

</article>




	<article>
	
		<h1><a href="/2022/04/21/java/spring cloud/9.Spring cloud Gateway/">Spring cloud Gateway</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2022-04-21</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-none-link" href="/tags/java/" rel="tag">java</a> <a class="article__tag-none-link" href="/tags/spring-cloud/" rel="tag">spring cloud</a>
			</span>
		
	</div>

	

	
		<p><img src="https://49812933408852955071488026628034-1301075051.cos.ap-nanjing.myqcloud.com/20210708123502.png"><br>Gateway æ˜¯ Spring cloud å®˜æ–¹æ‰€æ¨å‡ºçš„ç¬¬äºŒä»£ç½‘å…³ï¼ˆAPI Gatewayï¼‰æ¡†æ¶ï¼Œåœ¨ä¸ºæœåŠ¡ç³»ç»Ÿä¸­ï¼Œç½‘å…³çš„ä¸»è¦ä½œç”¨å°±æ˜¯å½“ç”¨æˆ·è°ƒç”¨çš„æ‰€æœ‰å¾®æœåŠ¡ï¼Œéƒ½è¦ç»è¿‡ç½‘å…³ã€‚</p>
<blockquote>
<p>åœ¨ä¸ºæœåŠ¡ä¸­ï¼Œé™¤äºä¸åŒå¾®æœåŠ¡å¯èƒ½ä¼šå¸¦æ¥ä¸åŒçš„å¼€å‘è¯­è¨€å’Œåè®®ï¼Œå› æ­¤éœ€è¦é€šè¿‡ç½‘å…³æ¥å¤„ç†æœåŠ¡çš„è°ƒç”¨</p>
</blockquote>
<p>ç½‘å…³ç»Ÿä¸€å‘å¤–éƒ¨ç³»ç»Ÿæä¾› REST APIï¼Œåœ¨ Spring cloud ä¸­ï¼Œä½¿ç”¨ Zuulã€Gateway ç­‰ä½œä¸ºç½‘å…³å¯ä»¥å®ç°å‡ºåŠ¨æ€è·¯ç”±ã€ç›‘æ§ã€å›é€€ã€å®‰å…¨åŠŸèƒ½ç­‰ã€‚</p>
<h2 id="ç‰¹ç‚¹"><a href="#ç‰¹ç‚¹" class="headerlink" title="ç‰¹ç‚¹"></a>ç‰¹ç‚¹</h2><p>Gateway åŸºäº <code>Spring Framework 5ã€Project Reactor ã€Spring boot 2.0</code> æ„å»ºï¼Œå¯ä»¥åŒ¹é…ä»»ä½•è¯·æ±‚å±æ€§çš„è·¯ç”±ï¼Œèƒ½ç¼–å†™è°“è¯ï¼ˆPredicatesï¼‰ä»¥åŠè¿‡æ»¤å™¨ï¼ˆFiltersï¼‰ç­‰ã€‚</p>
<blockquote>
<p>è°“è¯ä¸»è¦æ˜¯ç”¨äºç¡®å®šç»™å®šè¾“å…¥çš„ true æˆ– falseï¼Œåœ¨ç½‘å…³ä¸­è°“è¯å’Œè¿‡æ»¤å™¨ä¹Ÿå¯ä»¥ç”¨äºç‰¹å®šçš„è·¯ç”±ã€‚</p>
<blockquote>
<p>è¿‡æ»¤å™¨å¯ä»¥é‡å†™æ•°æ®ï¼Œä½†ç”±äº Gateway æ˜¯å¼‚æ­¥çš„ï¼Œå¦‚æœéœ€è¦å¯¹å“åº”çš„ body è¿›è¡Œä¿®æ”¹éœ€è¦ä½¿ç”¨ <code>writeWith()</code> æ‰€æä¾›çš„ <code>GlobalFilterã€GatewayFilter</code> ç±»å‹ã€‚</p>
<blockquote>
<p>å…¶ä¸­ <code>GlobalFilter</code> æ˜¯å¯¹æ‰€æœ‰è·¯ç”±æœ‰æ•ˆçš„ï¼Œè€Œ <code> GatewayFilter</code> ç±»å‹ä»…å¯¹æŒ‡å®šèŒƒå›´ç”Ÿæ•ˆ</p>
</blockquote>
</blockquote>
</blockquote>
<p>é™¤æ­¤ä¹‹å¤– Gateway è¿˜æ”¯æŒè·¯å¾„é‡å†™ã€åŠ¨æ€è·¯ç”±å’Œé›†æˆäº† Hystrix æ–­è·¯å™¨ä»¥åŠ <code>DiscoveryClient</code> çš„é›†æˆå’Œé™æµã€‚</p>
<h2 id="å·¥ä½œæµç¨‹"><a href="#å·¥ä½œæµç¨‹" class="headerlink" title="å·¥ä½œæµç¨‹"></a>å·¥ä½œæµç¨‹</h2><p><img src="https://49812933408852955071488026628034-1301075051.cos.ap-nanjing.myqcloud.com/20210708123510.png"></p>
<p>é¦–å…ˆ HTTP&#x2F;HTTPS å¼ºæ±‚ Spring cloud Gatewayï¼Œ<code>DispatcherHandler</code> æ¥å—è¯·æ±‚ï¼Œå¹¶é€šè¿‡ <code>RoutePredicateHandlerMapping</code> è¿›è¡Œè·¯ç”±åŒ¹é…ï¼Œ<strong>å¦‚æœç½‘å…³è·¯ç”±ä¸è¯·æ±‚çš„è·¯ç”±è¿›è¡ŒåŒ¹é…</strong> åˆ™å°†è¯·æ±‚å‘é€åˆ° <code>FilteringWebHandler</code>ï¼Œå¦‚æœä¸åŒ¹é…ï¼Œé‚£ä¹ˆåˆ™å°†è¯·æ±‚å‘é€ç»™ <code>DispatcherHandler</code> è¿›è¡Œå¤„ç†ã€‚</p>
<p>æœ€å <code>FilteringWebHandler</code> é€šè¿‡è‡ªå®šä¹‰çš„è¿‡æ»¤å™¨æ¥å‘é€è¯·æ±‚ï¼Œè¿™ä¼šå°†è¯·æ±‚è½¬å‘åˆ°å…·ä½“çš„æœåŠ¡ä¸­ï¼Œæœ€åå¤„ç†ç»“æœç»™ç”¨æˆ·ã€‚</p>
<h2 id="è°“è¯æ¥å£å’Œè°“è¯å·¥å‚"><a href="#è°“è¯æ¥å£å’Œè°“è¯å·¥å‚" class="headerlink" title="è°“è¯æ¥å£å’Œè°“è¯å·¥å‚"></a>è°“è¯æ¥å£å’Œè°“è¯å·¥å‚</h2><p>è°“è¯ï¼ˆPredicateï¼‰ï¼Œåœ¨ Java 8 ä¸­å¼•å…¥çš„ä¸€ä¸ªå‡½æ•°å¼æ¥å£ï¼Œ<strong>ä¸»è¦ç”¨äºæ¥å—è¾“å…¥å‚æ•°å¹¶è¿”å›å¸ƒå°”å€¼çš„ç»“æœ</strong>ï¼ŒSpring cloud Gateway é€šè¿‡ Predicate æ¥å£æ¥åˆ¤æ–­å½“å‰è·¯ç”±æ˜¯å¦æ»¡è¶³æŒ‡å®šæ¡ä»¶ã€‚</p>
<blockquote>
<p>è°“è¯å·¥å‚ï¼ˆRoute Predicate Factoriesï¼‰ä¸»è¦ä½œç”¨å°±æ˜¯å½“ç¬¦åˆè°“è¯æ¡ä»¶å°±ä½¿ç”¨è¯¥è·¯ç”±è¿›è¡ŒåŒ¹é…ï¼Œå¦åˆ™å°±å¿½ç•¥ã€‚</p>
</blockquote>
<p>Spring cloud Gateway çš„è·¯ç”±è§„åˆ™æ˜¯ç”± <code>RouteDefinitionLocator</code> ç±»è¿›è¡Œç®¡ç†ï¼Œé»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨ Spring Boot çš„ <code>@ConfigurationProperties</code> æœºåˆ¶æ¥åŠ è½½å±æ€§ã€‚</p>
<h3 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h3><h4 id="Java-API"><a href="#Java-API" class="headerlink" title="Java API"></a>Java API</h4><p><img src="https://49812933408852955071488026628034-1301075051.cos.ap-nanjing.myqcloud.com/20210708123517.png"><br>å¯ä»¥é€šè¿‡æœ€ç®€å•çš„ Java API çš„æ–¹å¼æ¥æ„å»ºè·¯ç”±ï¼Œä¸»è¦é€šè¿‡ <code>@Bean</code> æ¥å®ç°ä¸€ä¸ªè‡ªå®šä¹‰çš„ <code>RouteLocator</code> ç±»æ¥å®ç° <strong>è‡ªå®šä¹‰è·¯ç”±è½¬å‘è§„åˆ™</strong>ã€‚åœ¨æ­¤ä¹‹å‰ï¼Œéœ€è¦é€šè¿‡æ·»åŠ  gateway ä¾èµ–æ¥å®Œæˆï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-gateway&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ç”±äº Spring cloud gateway ä½¿ç”¨çš„æ˜¯ <strong>Netty+WebFlux</strong> å®ç°çš„ï¼Œå› æ­¤ä¸éœ€è¦å¼•å…¥ Web æ¨¡å—ä¾èµ–ã€‚</p>
</blockquote>
<p>ä¹‹ååœ¨å¯åŠ¨ç±»æ·»åŠ è‡ªå®šä¹‰ RouteLocator ç±»å³å¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.route.RouteLocator;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.route.builder.RouteLocatorBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å°†è¯·æ±‚è½¬å‘ç»™ baidu.com</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> kunlun</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/7/8</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DemoApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(DemoApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RouteLocator <span class="title function_">routeLocator</span> <span class="params">(RouteLocatorBuilder builder)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> builder.routes().</span><br><span class="line">                route(<span class="string">&quot;guonei&quot;</span>, r -&gt; r.path(<span class="string">&quot;/guonei/**&quot;</span>)</span><br><span class="line">                        .uri(<span class="string">&quot;http://news.baidu.com/&quot;</span>)).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨ä¸Šè¿°çš„è¿‡ç¨‹ä¸­ï¼Œ<code>route</code> ä¸»è¦å°†ä¸ <strong>guonei</strong> è·¯ç”±æƒ³åŒ¹é…çš„é€šè¿‡ <code>Spring cloud Gateway</code> è½¬å‘åˆ°äº† <a target="_blank" rel="noopener" href="http://news.baidu.com/guonei">http://news.baidu.com/guonei</a> ä¸­ï¼Œå› æ­¤è®¿é—® <a target="_blank" rel="noopener" href="http://localhost:8081/guonei">http://localhost:8081/guonei</a> å°±æ˜¯è®¿é—® <a target="_blank" rel="noopener" href="http://news.baidu.com/guonei">http://news.baidu.com/guonei</a></p>
<p>å…¶ä¸­ <code>r.path</code> å‚æ•°ä¸‹çš„ <code>/guonei/**</code> æŒ‡çš„æ˜¯è¿™å°†ä¼šåŒ¹é…åŒ…å«æ‰€æœ‰ä»»ä½•åç¼€æºå¸¦ <code>/guonei</code> çš„è·¯å¾„æ¨¡å¼ï¼Œè¿˜éœ€è¦æ³¨æ„çš„æ˜¯ Spring cloud Gateway æ”¯æŒä¸¤ç§çš„é…ç½®ï¼Œä¸Šé¢æ‰€å®ç°çš„æ˜¯åŸºäºRouteLocator çš„å®ç°ï¼Œè¿˜æœ‰ properties é…ç½®æ–‡ä»¶çš„å®ç°</p>
<h4 id="application-yml-x2F-application-proerties"><a href="#application-yml-x2F-application-proerties" class="headerlink" title="application.yml &#x2F; application.proerties"></a>application.yml &#x2F; application.proerties</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">guonei</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://news.baidu.com/</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/guonei</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">GatewayForward</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8081</span></span><br></pre></td></tr></table></figure>

<p>ä¸ Java API ä¸€æ ·ï¼Œè®¿é—® <a target="_blank" rel="noopener" href="http://localhost:8081/guonei">http://localhost:8081/guonei</a> å°±æ˜¯è®¿é—® <a target="_blank" rel="noopener" href="http://news.baidu.com/guonei">http://news.baidu.com/guonei</a>ï¼ŒåŒæ ·çš„å®ç°äº†è·¯ç”±çš„åŠŸèƒ½ã€‚</p>
<h3 id="è·¯ç”±è°“è¯å·¥å‚æˆ–è·¯ç”±è§„åˆ™ï¼ˆRoutePredicateFactoryï¼‰"><a href="#è·¯ç”±è°“è¯å·¥å‚æˆ–è·¯ç”±è§„åˆ™ï¼ˆRoutePredicateFactoryï¼‰" class="headerlink" title="è·¯ç”±è°“è¯å·¥å‚æˆ–è·¯ç”±è§„åˆ™ï¼ˆRoutePredicateFactoryï¼‰"></a>è·¯ç”±è°“è¯å·¥å‚æˆ–è·¯ç”±è§„åˆ™ï¼ˆRoutePredicateFactoryï¼‰</h3><p>åœ¨ Gateway ä¸­ï¼Œä¸»è¦é€šè¿‡ RoutePredicateFactoryï¼ˆè°“è¯å·¥å‚ï¼‰æ¥åˆ›å»ºè°“è¯ï¼ˆPredicateï¼‰ï¼Œå› æ­¤ä¹Ÿæä¾›äº†å¾ˆå¤šç§è°“è¯å·¥å‚ï¼Œè¿™ä¹Ÿæ˜¯åœ¨ä¸Šé¢æ‰€æåˆ°çš„ï¼šâ€œè°“è¯å·¥å‚ï¼ˆRoute Predicate Factoriesï¼‰ä¸»è¦ä½œç”¨å°±æ˜¯å½“ç¬¦åˆè°“è¯æ¡ä»¶å°±ä½¿ç”¨è¯¥è·¯ç”±è¿›è¡ŒåŒ¹é…ï¼Œå¦åˆ™å°±å¿½ç•¥ã€‚â€ </p>
<p>é€šè¿‡è°“è¯å·¥å‚ï¼Œä½¿å¾—å¼€å‘äººå‘˜å¯ä»¥ç®€å•é…ç½®å³å¯è·å¾—å¾ˆå¤šéœ€è¦å’Œæƒ³è¦çš„è·¯ç”±è§„åˆ™ï¼ŒåŠè°“è¯ï¼ˆPredicateï¼‰ï¼Œè¿™äº›è·¯ç”±è§„åˆ™ä¼šæ ¹æ® HTTP è¯·æ±‚è¿›è¡Œä¸åŒå±æ€§æ¥åŒ¹é…ï¼Œå…¶ä¸­æœ€ä¸ºä¸»è¦çš„ä¸ºä¸‹è¿°å‡ ç±»ï¼š</p>
<table>
<thead>
<tr>
<th>RoutePredicateFactory</th>
<th>type</th>
<th>info</th>
</tr>
</thead>
<tbody><tr>
<td>AfterRouteâ€¦â€¦(çœç•¥ PredicateFactory)</td>
<td>datetime</td>
<td>è¯·æ±‚æ—¶é—´æ»¡è¶³åœ¨é…ç½®æ—¶é—´ä¹‹å</td>
</tr>
<tr>
<td>BeforeRoute</td>
<td>datetime</td>
<td>è¯·æ±‚æ—¶é—´æ»¡è¶³åœ¨é…ç½®æ—¶é—´ä¹‹å‰</td>
</tr>
<tr>
<td>BetweenRoute</td>
<td>datetime</td>
<td>è¯·æ±‚æ—¶é—´æ»¡è¶³åœ¨é…ç½®æ—¶é—´ä¹‹å‰</td>
</tr>
<tr>
<td>CookieRoute</td>
<td>Cookie</td>
<td>è¯·æ±‚æŒ‡å®šäº† Cookie æ­£åˆ™åŒ¹é…çš„æŒ‡å®šå€¼</td>
</tr>
<tr>
<td>HeaderRoute</td>
<td>Headerï¼ˆæ•°æ®å¤´ï¼‰</td>
<td>è¯·æ±‚æŒ‡å®šäº†è¯·æ±‚ä¸Šä¸‹æ–‡æ‰€åŒ¹é…çš„æŒ‡å®šå€¼</td>
</tr>
<tr>
<td>CloudFoundryRouteServiceRoute</td>
<td>Header</td>
<td>è¯·æ±‚ Headers æ˜¯å¦åŒ…å«äº†æŒ‡å®šçš„åç§°</td>
</tr>
<tr>
<td>MethodRoute</td>
<td>Methodï¼ˆæ–¹æ³•ï¼‰</td>
<td>è¯·æ±‚çš„æ–¹æ³•æ˜¯å¦åŒ¹é…é…ç½®çš„æ–¹æ³•</td>
</tr>
<tr>
<td>PathRoute</td>
<td>Pathï¼ˆè·¯å¾„ï¼‰</td>
<td>è¯·æ±‚è·¯å¾„æ˜¯å¦åŒ¹é…æŒ‡å®šå€¼</td>
</tr>
<tr>
<td>Query</td>
<td>Queryparamï¼ˆæŸ¥è¯¢å‚æ•°ï¼‰</td>
<td>è¯·æ±‚æŸ¥è¯¢çš„æŸ¥è¯¢å‚æ•°ä¸é…ç½®æ–‡ä»¶çš„ç›¸åŒ¹é…</td>
</tr>
<tr>
<td>RemoteAddreRoute</td>
<td>Remoteaddrï¼ˆè¿œç¨‹åœ°å€ï¼‰</td>
<td>è¿œç¨‹åœ°å€æ˜¯å¦åŒ¹é…æŒ‡å®šå€¼</td>
</tr>
<tr>
<td>HostRoute</td>
<td>Hostï¼ˆä¸»æœºï¼‰</td>
<td>è¯·æ±‚ä¸»æœºæ˜¯å¦åŒ¹é…æŒ‡å®šå€¼</td>
</tr>
</tbody></table>
<h4 id="After"><a href="#After" class="headerlink" title="After"></a>After</h4><p>AfterRoutePredicateFactoryï¼ˆAfterè·¯ç”±è°“è¯å·¥å‚ï¼‰æ˜¯ä¸€ä¸ª <code>datetimeï¼ˆæ—¥æœŸæ—¶é—´ï¼‰</code> ç±»å‹çš„ä¸ºæ­¤ï¼Œä»–ä¸»è¦è¡¨è¾¾çš„æ˜¯å¦‚æœè¯·æ±‚åœ¨é…ç½®æ–‡ä»¶ä¸­ <strong>æ—¶é—´åœ¨é…ç½®æ–‡ä»¶ä¹‹å</strong> å‘ç”Ÿçš„è¯·æ±‚å…è®¸ã€‚</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">after</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://news.baidu.com/</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">After=2022-01-20T18:06:06+08:00[Asia/Shanghai]</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">GatewayForward</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8081</span></span><br></pre></td></tr></table></figure>

<p>After çš„æ ¸å¿ƒæ„æ€å°±æ˜¯åªèƒ½åœ¨é…ç½®è§„å®šåçš„æ—¶é—´è¿›è¡Œè®¿é—®ï¼Œä½†åªèƒ½é€šè¿‡ UTC + æ—¶åŒºçš„æ–¹å¼æ¥æ·»åŠ è§„åˆ™ï¼Œå¦åˆ™å°†ç›´æ¥æŠ¥é”™ã€‚After çš„ä¸»è¦ä½œç”¨å°±æ˜¯åœ¨ 2021 å¹´ 1 æœˆ 20 æ—¥ä¹‹åæ‰å¯è¿›è¡Œè®¿é—®ï¼Œå¦åˆ™å°†ä¼šç›´æ¥æŠ¥é”™ï¼Œç›´æ¥è®¿é—® <a target="_blank" rel="noopener" href="http://localhost:8081/">http://localhost:8081/</a> å³å¯ã€‚</p>
<h4 id="Before"><a href="#Before" class="headerlink" title="Before"></a>Before</h4><p>Before ä¹Ÿæ˜¯å±äº <code>datetime</code> ç±»å‹ä¹‹ä¸€ï¼Œå…¶æ ¸å¿ƒå«ä¹‰æ˜¯å½“è¯·æ±‚æ»¡è¶³é…ç½®æ—¶é—´ä¹‹å‰ï¼Œè€Œä¹‹å‰çš„ <code>After</code> è·¯ç”±è°“è¯å·¥å‚åªæ˜¯æ»¡è¶³é…ç½®æ—¶é—´ä¹‹åï¼š</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">after</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://news.baidu.com/</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Before=2022-01-20T18:06:06+08:00[Asia/Shanghai]</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">GatewayForward</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8081</span></span><br></pre></td></tr></table></figure>

<h4 id="Between"><a href="#Between" class="headerlink" title="Between"></a>Between</h4><p>Between å¯ä»¥ç†è§£ä¸ºæ˜¯ä¸¤ä¸ª UTC æ—¶é—´ä¹‹é—´çš„è¯·æ±‚ï¼Œå› æ­¤ä»–æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯ datetime1 ä»¥åŠ datetime2 è¿™æ˜¯ä¸€ä¸ª ZonedDateTime å¯¹çº¿ï¼Œå› æ­¤è¯·æ±‚éœ€è¦æ»¡è¶³ datetione1 ä¹‹åä¸” datetime2 ä¹‹å‰çš„è¯·æ±‚ï¼š</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">after</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://news.baidu.com/</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Between=2019-01-20T18:06:06+08:00[Asia/Shanghai],2022-01-20T18:06:06+08:00[Asia/Shanghai]</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">GatewayForward</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å¦‚ä¸Šé¢çš„ <code>Between</code> è·¯ç”±è§„åˆ™æ˜¯ï¼Œåœ¨ 2019-01-20T18:06:06+08:00[Asia&#x2F;Shanghai] ä¹‹åï¼Œ2022-01-20T18:06:06+08:00[Asia&#x2F;Shanghai] ä¹‹å‰çš„è¯·æ±‚å°†ä¼šè¿›è¡ŒåŒ¹é…ï¼Œå¦åˆ™å°†ä¼šå¿½è§†ã€‚</p>
<h4 id="Cookie"><a href="#Cookie" class="headerlink" title="Cookie"></a>Cookie</h4><p>CookieRoutePredicateFactory ä¸»è¦ç”¨äºåŒ¹é…æŒ‡å®šå€¼ï¼Œè™½ç„¶å¾ˆå¤šä½œè€…è¯´ç›´æ¥å¯ä»¥ä¸€æ¡å‚æ•°èµ°åˆ°ä½ï¼š<code>mycookie,mycookievalue</code>ï¼Œä½†å¾ˆé—æ†¾å¹¶æ²¡æœ‰ä½œç”¨ï¼Œå› æ­¤åªèƒ½é€šè¿‡å…¨å±•å¼€çš„æ–¹å¼æ¥å®ç°ï¼š</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">after</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://news.baidu.com/</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Cookie</span></span><br><span class="line">              <span class="attr">args:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">meteor_login_token</span></span><br><span class="line">                <span class="attr">regexp:</span> <span class="string">ipQdtc89kEO7-JaBWLdgwPHzX9oDy6l-2qXmZ_OeHye</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">GatewayForward</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8081</span></span><br></pre></td></tr></table></figure>

<p>åœ¨ä¸Šè¿°çš„ cookie ä¸­ï¼Œä¸»è¦æŒ‡å®šäº† cookie åå­— <code>meteor_login_token</code>ï¼Œä»¥åŠ cookie_value <code>ipQdtc89kEO7-JaBWLdgwPHzX9oDy6l-2qXmZ_OeHye</code>ï¼Œå› æ­¤å¦‚æœè¯·æ±‚çš„ cookie ä¸é…ç½®æ–‡ä»¶ç›¸åŒ¹é…åˆ™é€šè¿‡ï¼Œå¦åˆ™å°†ä¼šå¿½ç•¥ã€‚</p>
<h4 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h4><p>Header å³è¯·æ±‚ä¸Šä¸‹æ–‡çš„å¤´éƒ¨ä¿¡æ¯ï¼Œå½“è¯·æ±‚ä¸é…ç½®çš„ Header ä¸€è‡´æ—¶è¿›è¡Œè½¬å‘ï¼Œåœ¨å®˜æ–¹æ–‡æ¡£ä¸­è¢«ç§°ä¹‹ä¸ºï¼š<code>X-Request-Id</code> ä¸æ­£åˆ™è¡¨è¾¾å¼åˆåœ¨ä¸€èµ·è¿›è¡ŒåŒ¹é…ï¼Œ<strong>ä½†å¹¶æ²¡æœ‰ä»€ä¹ˆä½œç”¨</strong>ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥ç†è§£ä¸º Header è¯·æ±‚å¤´æ˜¯æ ¹æ®ä¸Šä¸‹æ–‡å¤´éƒ¨ä¿¡æ¯æ¥æŒ‡å®šæœåŠ¡å™¨çš„åŸŸåå’ŒæœåŠ¡å™¨æ­£åœ¨ä¾¦å¬çš„ TCP ç«¯å£å·ï¼š</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">after</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://news.baidu.com/</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Header=Host,localhost:8081</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">GatewayForward</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8081</span></span><br></pre></td></tr></table></figure>

<p>å½“è¯·æ±‚çš„ä¸Šä¸‹æ–‡å¤´éƒ¨ä¿¡æ¯ä¸é…ç½®æ–‡ä»¶ç›¸äº’åŒ¹é…åˆ™å…è®¸è¯·æ±‚ï¼Œå¦åˆ™å°†ä¼šç›´æ¥è¿›è¡Œå¿½ç•¥ã€‚</p>
<h4 id="Host"><a href="#Host" class="headerlink" title="Host"></a>Host</h4><p>Host è·¯ç”±è°“è¯å·¥å‚ä¸ Header ç±»ä¼¼ï¼Œæˆ–è€…è¯´ä¸¤è€…éƒ½å¯ä»¥å®ç°å…¶æ•ˆæœï¼Œä½† Host è·¯ç”±è°“è¯å·¥å‚å¾ˆæ˜æ˜¾æ¯” Hedaer æ›´åŠ çš„ç®€å•ä¸”å¥½ç†è§£ã€‚å› æ­¤ä»–ä¸»è¦çš„ä½œç”¨å°±æ˜¯åŒ¹é…æ‰€è¯·æ±‚çš„ä¸»æœºæ˜¯å¦å’Œé…ç½®æ–‡ä»¶ç›¸äº’ä¸€è‡´ï¼Œå¦åˆ™å°†ä¸å…·å¤‡è½¬å‘åŠŸèƒ½ï¼š</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">after</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://news.baidu.com/</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Host=localhost:8081</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">GatewayForward</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8081</span></span><br></pre></td></tr></table></figure>

<p>åœ¨ä¸Šè¿°é…ç½®æ–‡ä»¶ä¸­ï¼Œè¯·æ±‚çš„ä¸»æœºæ˜¯ <code>localhost:8081</code> å› æ­¤ä¸é…ç½®æ–‡ä»¶çš„ä¿¡æ¯ç›¸äº’åŒ¹é…ï¼Œå¯ä»¥é€šè¿‡ç½‘å…³ä½¿ç”¨è·¯ç”±è¿›è¡Œè·³è½¬ã€‚</p>
<h4 id="Method"><a href="#Method" class="headerlink" title="Method"></a>Method</h4><p><img src="https://49812933408852955071488026628034-1301075051.cos.ap-nanjing.myqcloud.com/20210709153656.png"><br>Method è·¯ç”±è°“è¯å·¥å‚ç›¸æ¯”ä¸Šè¿°å‡ ä¸ª <code>header</code> ç±»å‹çš„è°“è¯å·¥å‚æ˜¾å¾—ç‰¹åˆ«å®ç”¨ï¼Œä»–ä¸»è¦ç”¨æŒ‡å®šè®¿é—®èµ„æºä»¥å“åº”é¢„æ£€è¯·æ±‚æ—¶å…è®¸çš„æ–¹æ³•ï¼š</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">after</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://news.baidu.com/</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Method=GET,POST</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">GatewayForward</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8081</span></span><br></pre></td></tr></table></figure>

<p>å°±æ¯”å¦‚ä¸Šè¿°çš„é…ç½®æ–‡ä»¶ï¼Œæˆ‘ä»¬å…è®¸äº† <code>GETï¼ŒPOST</code> æ–¹æ³•è¯·æ±‚ï¼Œä½†ä¸å…è®¸ <code>PUT</code> æ–¹æ³•è¯·æ±‚ï¼Œå› æ­¤ä½¿ç”¨è¯¥æ–¹æ³•è¯·æ±‚å°†ä¼šç›´æ¥è¢«ç½‘å…³æ‰€è¿›è¡Œæ‹¦æˆªã€‚</p>
<h4 id="Query"><a href="#Query" class="headerlink" title="Query"></a>Query</h4><p><img src="https://49812933408852955071488026628034-1301075051.cos.ap-nanjing.myqcloud.com/20210709230650.png"><br>Query è·¯ç”±è°“è¯å·¥å‚ä¸»è¦æ˜¯å½“ <strong>è¯·æ±‚æŸ¥è¯¢çš„æŸ¥è¯¢å‚æ•°ä¸é…ç½®æ–‡ä»¶çš„ç›¸åŒ¹é…</strong>ï¼Œå°±æ¯”å¦‚ <code>localhost:8081?name=111</code> æ­£å¥½ä¸é…ç½®æ–‡ä»¶ä¸­çš„ <code>query=name</code> çš„ <code>name</code> ç›¸äº’åŒ¹é…ï¼Œåˆ™å…è®¸è¯·æ±‚ï¼š</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">after</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://news.baidu.com/</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Query=name</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">GatewayForward</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8081</span></span><br></pre></td></tr></table></figure>

<h4 id="RemoteAddre"><a href="#RemoteAddre" class="headerlink" title="RemoteAddre"></a>RemoteAddre</h4><p><img src="https://49812933408852955071488026628034-1301075051.cos.ap-nanjing.myqcloud.com/20210709230658.png"></p>
<p>RemoteAddre ä¸ Header è·¯ç”±è°“è¯å·¥å‚ç±»ä¼¼ï¼Œç®€å•ç†è§£å°±æ˜¯ä»–ä»¬çš„è¿›é˜¶ç‰ˆï¼Œä»–å¯ä»¥æ ¹æ® CIDR è¡¨ç¤ºæ³•è¿›è¡ŒåŒ¹é…ï¼Œä¹Ÿå°±æ˜¯è¯´å½“ä½ å†™å…¥è§„åˆ™æ˜¯ <code>192.168.0.1/24</code> æ—¶ï¼Œä½  <code>192.168.0.104/24</code> ä¹Ÿå¯ä»¥è¯·æ±‚æ­¤æ¥å£ï¼Œä½†å¦‚æœä½ ä¸æ˜¯è¿™ä¸ªç½‘æ®µä¸‹çš„ï¼Œåˆ™ä¼šè¢«æ‹’ç»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">        - id: remoteaddr_route</span><br><span class="line">          uri: http:<span class="comment">//news.baidu.com</span></span><br><span class="line">          predicates:</span><br><span class="line">            - RemoteAddr=<span class="number">192.168</span><span class="number">.0</span><span class="number">.1</span>/<span class="number">24</span></span><br><span class="line"></span><br><span class="line">  application:</span><br><span class="line">    name: GatewayForward</span><br><span class="line"></span><br><span class="line">server:</span><br><span class="line">  port: <span class="number">8081</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>localhost æ˜¯ 127.0.0.1 çš„åœ°å€æ˜ å°„ï¼Œå› æ­¤åœ¨ RemoteAddr è·¯ç”±è°“è¯å·¥å‚è§„åˆ™ä¸­ä»–ä¼šè¢«ç›´æ¥æ‹’ç»ã€‚</p>
</blockquote>
<h4 id="Weight"><a href="#Weight" class="headerlink" title="Weight"></a>Weight</h4><p><img src="https://49812933408852955071488026628034-1301075051.cos.ap-nanjing.myqcloud.com/20210709232130.png"><br>Weight æ˜¯æƒé‡è·¯ç”±è°“è¯å·¥å‚ï¼Œå½“ Gateway ä¸­æœ‰å¤šä¸ªè·¯ç”±ç½‘å…³é…ç½®æ—¶å¯ä»¥å‘æŒ¥ä½œç”¨ï¼Œä»–ä¸»è¦åˆ†ä¸º <strong>ç»„ï¼ˆgroupï¼‰</strong> ä»¥åŠ <strong>æƒé‡ï¼ˆweightï¼‰</strong> è¿›è¡Œç»„åˆï¼š</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">weight_one</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://news.baidu.com</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Weight=group1,</span> <span class="number">1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">weight_two</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://baidu.com</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Weight=group1,</span> <span class="number">8</span></span><br></pre></td></tr></table></figure>

<p>å°±æ¯”å¦‚ä¸Šè¿°çš„é…ç½®ä¸­ï¼Œ<code>weight_two</code> çš„æƒé‡æ¯” <code>weight_one</code> é«˜ï¼Œå› æ­¤ç½‘å…³åŒ¹é…çš„æ˜¯ <code>weight_two</code> çš„è·¯ç”±ã€‚</p>
<h3 id="Gateway-consul-æœåŠ¡è½¬å‘"><a href="#Gateway-consul-æœåŠ¡è½¬å‘" class="headerlink" title="Gateway consul æœåŠ¡è½¬å‘"></a>Gateway consul æœåŠ¡è½¬å‘</h3><p><img src="https://49812933408852955071488026628034-1301075051.cos.ap-nanjing.myqcloud.com/20210710193849.png"><br>åœ¨æ­£å¸¸çš„å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œéƒ½ä¼šé€‰æ‹©ä¾èµ–æœåŠ¡ä¸­å¿ƒæ¥è¿›è¡Œæ³¨å†Œï¼Œè¿™é€šå¸¸éœ€è¦å¯¹æ¯ä¸ªæœåŠ¡æä¾›è€…è¿›è¡Œå•ç‹¬çš„é…ç½®ï¼ŒGateway çš„å‡ºç°çˆ±ä½ æä¾›äº†é»˜è®¤è½¬å‘çš„å·¥ä½œï¼Œ<strong>å½“ç½‘å…³æ³¨å†Œåˆ°æœåŠ¡ä¸­å¿ƒåï¼Œç½‘å…³åˆ™ä¼šä»£æ›¿æœåŠ¡ä¸­å¿ƒæ¥æä¾›è½¬å‘çš„æœåŠ¡</strong>ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-consul-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>


<h4 id="application-yml"><a href="#application-yml" class="headerlink" title="application.yml"></a>application.yml</h4><p>åœ¨ <code>application.yml</code> é…ç½®æ–‡ä»¶ä¸­ï¼Œéœ€è¦å¼€å¯æœåŠ¡è½¬å‘çš„é€‰é¡¹ï¼Œå³<code> spring.cloud.gateway.discovery.locator.enabled</code> å³å¯ï¼Œä¹‹ååœ¨å¯åŠ¨ç±»ä¸­æ·»åŠ  <code>@EnableDiscoveryClient</code> æ³¨è§£ä»¥æ­¤æ¥å®ç°æœåŠ¡å‘ç°ï¼š</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">Gateway</span> <span class="string">Consul</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">consul:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8500</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">locator:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8515</span></span><br></pre></td></tr></table></figure>


<h2 id="è¿‡æ»¤å™¨ï¼ˆFilterï¼‰"><a href="#è¿‡æ»¤å™¨ï¼ˆFilterï¼‰" class="headerlink" title="è¿‡æ»¤å™¨ï¼ˆFilterï¼‰"></a>è¿‡æ»¤å™¨ï¼ˆFilterï¼‰</h2><h3 id="è¿‡æ»¤å™¨çš„å­˜åœ¨"><a href="#è¿‡æ»¤å™¨çš„å­˜åœ¨" class="headerlink" title="è¿‡æ»¤å™¨çš„å­˜åœ¨"></a>è¿‡æ»¤å™¨çš„å­˜åœ¨</h3><p>è¿‡æ»¤å™¨ä¹‹æ‰€ä»¥åœ¨ç½‘å…³ä¸­å­˜åœ¨ï¼Œæ˜¯å› ä¸ºåœ¨å¾®æœåŠ¡ç³»ç»Ÿä¸­ï¼ŒæœåŠ¡æä¾›è€…éå¸¸çš„å¤šï¼Œå› æ­¤å¦‚æœåœ¨æ¯ä¸ªæœåŠ¡ä¸­éƒ½æœ‰è¯¸å¦‚é‰´æƒã€é™æµä»¥åŠæ—¥å¿—è¾“å‡ºç­‰åˆ™ä¼šå ç”¨æœåŠ¡çš„æ¶ˆè€—ï¼ˆä¹Ÿå°±æ˜¯è¯´æ¯ä¸ªæœåŠ¡æˆ‘éƒ½è¦å†™ä¸€éè¿™äº›åŠŸèƒ½ï¼Œåˆ™ä¼šè®©å¼€å‘å¾ˆçƒ¦èºï¼‰å› æ­¤å¯ä»¥ç›´æ¥é€šè¿‡ç½‘å…³æ¥è¿›è¡Œå¤„ç†ã€‚</p>
<blockquote>
<p>ç½‘å…³åº”å¯ä»¥å¤„ç†é‰´æƒã€é™æµç­‰å·¥ä½œ</p>
</blockquote>
<h4 id="PRE-and-POST"><a href="#PRE-and-POST" class="headerlink" title="PRE and POST"></a>PRE and POST</h4><h5 id="PRE"><a href="#PRE" class="headerlink" title="PRE"></a>PRE</h5><p>æ ¹æ®è¯·æ±‚çš„ç”Ÿå‘½å‘¨æœŸï¼Œåœ¨ Gateway ä¸­ï¼Œè¿‡æ»¤å™¨ä¼šåˆ†ä¸º <strong>PREã€POST</strong> ä¸¤ç§ï¼Œå…¶ä¸­ PRE ä»£è¡¨ <strong>åœ¨è·¯ç”±æ‰§è¡Œä¹‹å‰çš„è¯·æ±‚</strong> æ‰§è¡Œè¯¥è¿‡æ»¤ï¼Œå› æ­¤ä¸»è¦åº”ç”¨åœ¨å‚æ•°æ ¡éªŒã€é‰´æƒã€æµé‡ç›‘æ§ã€æ—¥å¿—è¾“å‡ºã€åè®®è½¬æ¢åŠŸèƒ½ã€‚</p>
<h5 id="POST"><a href="#POST" class="headerlink" title="POST"></a>POST</h5><p>POST ä¸»è¦æ˜¯åœ¨ <strong>è¯·æ±‚è¢«è·¯ç”±è·³åˆ°å¾®æœåŠ¡ä¹‹åæ‰€æ‰§è¡Œ</strong> çš„è¿‡æ»¤å™¨ï¼Œå› æ­¤è¿™ç§è¿‡æ»¤å™¨å¯ä»¥å®ç°å‡ºç›¸åº”å¤´ï¼ˆHTTP Headerï¼‰ä»¥åŠæ”¶é›†ç»Ÿè®¡ä¿¡æ¯å’ŒæŒ‡æ ‡ã€å“åº”è½¬å‘ã€æ—¥å¿—è¾“å‡ºã€æµé‡ç›‘æ§ç­‰åŠŸèƒ½ã€‚</p>
<h4 id="GatewayFilter-and-GlobalFilter"><a href="#GatewayFilter-and-GlobalFilter" class="headerlink" title="GatewayFilter and GlobalFilter"></a>GatewayFilter and GlobalFilter</h4><h5 id="GatewayFilter-ç½‘å…³è¿‡æ»¤å™¨"><a href="#GatewayFilter-ç½‘å…³è¿‡æ»¤å™¨" class="headerlink" title="GatewayFilter (ç½‘å…³è¿‡æ»¤å™¨)"></a>GatewayFilter (ç½‘å…³è¿‡æ»¤å™¨)</h5><p>è¿‡æ»¤å™¨åˆ†ä¸ºä¸¤ç±»ï¼Œå…¶ä¸­ç½‘å…³è¿‡æ»¤å™¨ï¼ˆGatewayFilterï¼‰åªä¼šåœ¨ <strong>å•ä¸ªè·¯ç”±æˆ–è€…åˆ†ç»„è·¯ç”±ä¸­</strong>ã€‚ç½‘å…³è¿‡æ»¤å™¨æ˜¯ä¸€ç§ <strong>å¯ä»¥ä¿®æ”¹è¯·æ±‚ä¼ å…¥çš„ HTTP è¯·æ±‚æˆ–è¾“å‡º HTTP ç›¸åº”</strong> çš„ç‰¹å®šè·¯ç”±ä½¿ç”¨ï¼ŒGateway å†…ç½®äº† 20 å¤šç§ç½‘å…³è¿‡æ»¤å™¨å·¥å‚æ¥ç¼–å†™ç½‘å…³è¿‡æ»¤å™¨ï¼š</p>
<table>
<thead>
<tr>
<th>Id</th>
<th>Name</th>
<th>type</th>
<th>Info</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>AddRequestHeader</td>
<td>Request</td>
<td>ç”¨äºåœ¨è¯·æ±‚å¤´ä¸­æ·»åŠ è‡ªå®šä¹‰çš„é”®å€¼å¯¹</td>
</tr>
<tr>
<td>2</td>
<td>AddRequestParameter</td>
<td>Request</td>
<td>ç”¨äºåœ¨è¯·æ±‚å‚æ•°ä¸­æ·»åŠ è¯·æ±‚å‚æ•°çš„é”®å€¼å¯¹</td>
</tr>
<tr>
<td>3</td>
<td>AddResponseHeader</td>
<td>Response</td>
<td>ç”¨äºåœ¨ç›¸åº”å¤´ä¸­æ·»åŠ </td>
</tr>
<tr>
<td>4</td>
<td>Hystrix</td>
<td>æ–­è·¯å™¨</td>
<td>ç”¨äºå°†æ–­è·¯å™¨å¼•å…¥ç½‘å…³è·¯ç”±ä¸­ï¼Œå¯ä»¥è®©æœåŠ¡å…å—çº§è”æ•…éšœå½±å“ï¼Œå¹¶åœ¨æ•…éšœæ—¶æä¾›å›é€€å“åº”ï¼ˆä½¿ç”¨æ—¶éœ€è¦ä½¿ç”¨åä¸º <code>HystrixCommand</code> çš„å‚æ•°ï¼‰</td>
</tr>
<tr>
<td>5</td>
<td>PrefixPath</td>
<td>Path</td>
<td>ç”¨äºä½¿ç”¨ç®€å•çš„ Prefix</td>
</tr>
<tr>
<td>6</td>
<td>PreserveHostHeader</td>
<td>Header</td>
<td>è®¾ç½®è·¯ç”±è¿‡æ»¤å™¨çš„è¯·æ±‚å±æ€§ï¼Œæ£€æŸ¥æ˜¯å¦å‘é€åŸä¸»æœºå¤´æˆ–ç”± HTTP å®¢æˆ·ç«¯ç¡®å®šä¸»æœºå¤´</td>
</tr>
<tr>
<td>7</td>
<td>RequestRateLimiter</td>
<td>Request</td>
<td>ç”¨äºç¡®å®šå½“å‰è¯·æ±‚æ˜¯å¦ç»§ç»­ï¼ˆå¦‚æœä¸å…è®¸åˆ™ä¼šè¿”å› <code>HTTP 429 - Too Many Request</code> ï¼‰</td>
</tr>
<tr>
<td>8</td>
<td>RedirectTo</td>
<td>Request</td>
<td>ç”¨äºæ¥å—è¯·æ±‚çš„çŠ¶æ€å’Œ URL å‚æ•°ï¼ˆè¯¥çŠ¶æ€æ˜¯ä¸€ä¸ªé‡å®šå‘çš„ 300 ç³»åˆ— HTTP ä»£ç ï¼Œç±»ä¼¼ä¸ 301ã€‚ä½† URL æ˜¯ Location å¤´éƒ¨çš„å€¼ï¼‰</td>
</tr>
<tr>
<td>9</td>
<td>RemoveNonProxyHeaders</td>
<td>Headers</td>
<td>ä»è½¬å‘çš„è¯·æ±‚ä¸­åˆ é™¤è¯·æ±‚å¤´</td>
</tr>
<tr>
<td>10</td>
<td>RemoveRequestHeader</td>
<td>Request</td>
<td>é€šè¿‡è¯·æ±‚å¤´ååˆ é™¤è¯·æ±‚å¤´</td>
</tr>
<tr>
<td>11</td>
<td>RemoveResponseHeader</td>
<td>Response</td>
<td>é€šè¿‡å“åº”å¤´ååˆ é™¤å“åº”å¤´</td>
</tr>
<tr>
<td>12</td>
<td>RewritePath</td>
<td>Path</td>
<td>é€šè¿‡ Java æ­£åˆ™è¡¨è¾¾å¼é‡å†™è¯·æ±‚è·¯å¾„</td>
</tr>
<tr>
<td>13</td>
<td>SaveSession</td>
<td>Session</td>
<td>åœ¨è½¬å‘ä¸‹æ¸¸è°ƒç”¨ä¹‹å‰ï¼Œå¼ºåˆ¶æ‰§è¡Œä¿å­˜ Session çš„æ“ä½œ</td>
</tr>
<tr>
<td>14</td>
<td>SecureHeaders</td>
<td>Headers</td>
<td>ä¸ºå“åº”å¤´æ·»åŠ å®‰å…¨å¤´</td>
</tr>
<tr>
<td>15</td>
<td>SetPath</td>
<td>Path</td>
<td>è¯¥æ–¹æ³•å…è®¸é€šè¿‡è·¯å¾„çš„æ¨¡æ¿æ®µæ¥æ“ä½œè¯·æ±‚è·¯å¾„ï¼Œä½¿ç”¨ Spring çš„ URI æ¨¡æ¿ï¼Œæ”¯æŒå¤šç§åŒ¹é…</td>
</tr>
<tr>
<td>16</td>
<td>SetResponseHeader</td>
<td>Response</td>
<td>éœ€è¦é€šè¿‡ Key-Value å¯¹æ¥è®¾ç½®å“åº”å¤´</td>
</tr>
<tr>
<td>17</td>
<td>SetStatus</td>
<td>Response</td>
<td>ç”¨äºè®¾ç½®è¯·æ±‚å“åº”çŠ¶æ€ï¼Œä½†éœ€è¦ <code>Status</code> å‚æ•°ï¼ˆéœ€è¦æœ‰æ•ˆçš„ <code>Spring HttpStatus</code>ï¼Œä¾‹å¦‚æ•´å½¢çš„ 404 æˆ–æšä¸¾ç±»å‹å­—ç¬¦ä¸² <code>NOT_FOUND</code>ï¼‰</td>
</tr>
<tr>
<td>18</td>
<td>StripPrefix</td>
<td>Request</td>
<td>ç”¨äºå‰¥ç¦»å‰ç¼€ï¼ˆéœ€è¦ <code>parts</code> å‚æ•°ï¼Œç”¨äºè¡¨æ˜è¯·æ±‚è¢«å‘é€åˆ°ä¸‹æ¸¸ä¹‹å‰ä»è¯·æ±‚è·¯å¾„ä¸­æ‰€å‰¥ç¦»çš„å…ƒç´ æ•°é‡ï¼‰</td>
</tr>
<tr>
<td>19</td>
<td>Retry</td>
<td>Request</td>
<td>ä¸»è¦ç”¨äºé‡è¯•ï¼Œä½†éœ€è¦ Retriesã€Statusesã€Methodsã€Series ç­‰å‚æ•°</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td>Retriesï¼šé‡è¯•çš„æ¬¡æ•°</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td>Statusesï¼šé‡è¯•çš„ HTTP çŠ¶æ€ç ï¼ˆé€šè¿‡ <code>org.springframework.http.HttpStatus</code> è¡¨ç¤ºï¼‰</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td>Methodsï¼šé‡è¯•çš„ HTTP çŠ¶æ€ç ï¼ˆé€šè¿‡ <code>org.springframework.http.HttpMethod</code> è¡¨ç¤ºï¼‰</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td>Seriesï¼šé‡è¯•çš„çŠ¶æ€ç ï¼ˆé€šè¿‡ <code>org.springframework.http.HttpStatus.Series</code> è¡¨ç¤ºï¼‰</td>
</tr>
<tr>
<td>20</td>
<td>RequestSize</td>
<td>Request</td>
<td>ç”¨äºé™åˆ¶è¯·æ±‚å¤§å°ï¼Œå½“è¯·æ±‚è¶…è¿‡é™åˆ¶æ—¶å¯ç”¨ï¼Œé™åˆ¶è¯·æ±‚è¾¾åˆ°ä¸‹æ¸¸æœåŠ¡ï¼Œè¯¥è¿‡æ»¤å™¨å°† RequestSize ä½œä¸ºå‚æ•°</td>
</tr>
</tbody></table>
<h6 id="AddRequestHeaderï¼ˆåœ¨è¯·æ±‚å¤´ä¸­æ·»åŠ è‡ªå®šä¹‰çš„é”®å€¼å¯¹ï¼‰"><a href="#AddRequestHeaderï¼ˆåœ¨è¯·æ±‚å¤´ä¸­æ·»åŠ è‡ªå®šä¹‰çš„é”®å€¼å¯¹ï¼‰" class="headerlink" title="AddRequestHeaderï¼ˆåœ¨è¯·æ±‚å¤´ä¸­æ·»åŠ è‡ªå®šä¹‰çš„é”®å€¼å¯¹ï¼‰"></a>AddRequestHeaderï¼ˆåœ¨è¯·æ±‚å¤´ä¸­æ·»åŠ è‡ªå®šä¹‰çš„é”®å€¼å¯¹ï¼‰</h6><p><img src="https://49812933408852955071488026628034-1301075051.cos.ap-nanjing.myqcloud.com/20210713131356.png"></p>
<p>AddRequestHeader å³ä¸»è¦åœ¨è¯·æ±‚å¤´ä¸­æ¥æ·»åŠ è‡ªå®šä¹‰çš„é”®å€¼å¯¹ï¼Œå…¶ä¸»è¦å°†åº”ç”¨è¿‡æ»¤å™¨ <code>AddRequestHeader=X-Request-Name,X-Request-Value</code> åº”ç”¨å¹¶æ·»åŠ è‡³è¯·æ±‚å¤´ä¸­ï¼š</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">Gateway</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">/guonei</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://news.baidu.com</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Method=GET</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">AddRequestHeader=X-Request-Name,X-Request-Value</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8210</span></span><br><span class="line"></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">ROOT:</span> <span class="string">DEBUG</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><figcaption><span>ä¼šå°† ```X-Request-Name</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">###### AddRequestParameter (æ·»åŠ è¯·æ±‚å‚æ•°)</span><br><span class="line">![](https://49812933408852955071488026628034-1301075051.cos.ap-nanjing.myqcloud.com/20210713131345.png)</span><br><span class="line"></span><br><span class="line">AddRequestParameter ä¸»è¦çš„ä½œç”¨å°±æ˜¯åœ¨è¯·æ±‚å¤´ï¼ˆHeaderï¼‰ä¸­æ·»åŠ è¯·æ±‚å‚æ•°çš„é”®å€¼å¯¹ï¼Œå³å°† ```RouteDefinition /guonei``` è¿‡æ»¤å™¨ ```_genkey_0=KEY_NAME, _genkey_1=KEY_VALUE``` åº”ç”¨åœ¨ ```AddRequestParameter``` ï¼ˆæ·»åŠ è¯·æ±‚å‚æ•°ï¼‰ä¸­</span><br><span class="line"></span><br><span class="line">```yml</span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: Gateway</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">        - id: /guonei</span><br><span class="line">          uri: http://news.baidu.com</span><br><span class="line">          predicates:</span><br><span class="line">            - Method=GET</span><br><span class="line">          filters:</span><br><span class="line">            - AddRequestParameter=KEY_NAME,KEY_VALUE</span><br><span class="line"></span><br><span class="line">server:</span><br><span class="line">  port: 8210</span><br><span class="line"></span><br><span class="line">logging:</span><br><span class="line">  level:</span><br><span class="line">    ROOT: DEBUG</span><br></pre></td></tr></table></figure>
<p>è¿™å›å°† <code>KEY_NAME=KEY_VALUE</code> æ·»åŠ åˆ°æ‰€æœ‰åŒ¹é…è¯·æ±‚çš„ä¸‹æ¸¸è¯·æ±‚æ‰€æŸ¥è¯¢çš„å­—ç¬¦ä¸²ä¸­ï¼Œ<code>AddRequestParameter</code> å³æ·»åŠ è¯·æ±‚å‚æ•°ä¼šç”¨äºåŒ¹é…è·¯å¾„æˆ–ä¸»æœºçš„ URI å˜é‡ã€‚</p>
<h6 id="AddResponseHeader-æ·»åŠ å“åº”å¤´"><a href="#AddResponseHeader-æ·»åŠ å“åº”å¤´" class="headerlink" title="AddResponseHeader (æ·»åŠ å“åº”å¤´)"></a>AddResponseHeader (æ·»åŠ å“åº”å¤´)</h6><p><img src="https://49812933408852955071488026628034-1301075051.cos.ap-nanjing.myqcloud.com/20210713202834.png"></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">Gateway</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">/guonei</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://news.baidu.com</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Method=GET</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">AddResponseHeader=X-Response-Name,X-Response-Value</span>    </span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8210</span></span><br><span class="line"></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">ROOT:</span> <span class="string">DEBUG</span></span><br></pre></td></tr></table></figure>

<p>æ­¤åˆ» <code>AddResponseHeader</code> ä¼šå°† <code>X-Response-Name=X-Response-Value</code> æ‰€æ·»åŠ è‡³å“åº”å¤´ä¸­ã€‚</p>
<h6 id="Hystrix"><a href="#Hystrix" class="headerlink" title="Hystrix"></a>Hystrix</h6><p><img src="https://49812933408852955071488026628034-1301075051.cos.ap-nanjing.myqcloud.com/20210716191257.png"><br>è·¯ç”±å®¹é”™æ§åˆ¶å™¨çš„ä¸»è¦çš„è¿ç”¨åœºæ™¯å°±æ˜¯åœ¨é‡åˆ°è¶…æ—¶ã€æœåŠ¡å™¨ç«¯é”™è¯¯æ¥å‘æŒ¥ä½œç”¨ï¼Œé€šè¿‡ Gateway æ¥é›†æˆ Hystrixï¼ˆå« resilience4jï¼‰é€šè¿‡è¿‡æ»¤å™¨æ¥åŠ å…¥ <code>fallbackUri</code> å¾—ä»¥å®ç°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å®¹é”™æ§åˆ¶å™¨</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> kunlun</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/7/16</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NotFoundController</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/fallback&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Map&lt;String, String&gt;&gt; <span class="title function_">notFound</span><span class="params">()</span> &#123;</span><br><span class="line">        Map&lt;String, String&gt; stringMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        stringMap.put(<span class="string">&quot;code&quot;</span>, <span class="string">&quot;503&quot;</span>);</span><br><span class="line">        stringMap.put(<span class="string">&quot;data&quot;</span>, <span class="string">&quot;Current service is unavailable&quot;</span>);</span><br><span class="line">        stringMap.put(<span class="string">&quot;gateway&quot;</span>, <span class="string">&quot;GatewayConfigurationFaultToleranceRouting&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> Mono.just(stringMap);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>.</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">GatewayConfigurationFaultToleranceRouting</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">hey</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://service-provider/hey</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/hey</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Method=GET</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">AddRequestParameter=name,key</span></span><br><span class="line">            <span class="comment"># æœåŠ¡ç†”æ–­åä½¿ç”¨çš„åœ°å€ @RequestMapping(value = &quot;/fallback&quot;)</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CircuitBreaker</span></span><br><span class="line">              <span class="attr">args:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">fallback</span></span><br><span class="line">                <span class="attr">fallbackUri:</span> <span class="string">forward:/fallback</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">locator:</span></span><br><span class="line">          <span class="comment"># å…è®¸æœåŠ¡å‘ç°</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">consul:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8500</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">service-name:</span> <span class="string">service-provider</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8210</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ç”±äºæˆ‘ä»¬è¿™ä¸ªæ˜¯ç†”æ–­ï¼Œéœ€è¦æœåŠ¡æä¾›è€…çš„å­˜åœ¨ï¼Œå› æ­¤ä½ å¯ä»¥å°†æœåŠ¡æä¾›è€…å¿«é€Ÿå…³é—­æ¥è¾¾åˆ°ä»–çŸ­æ—¶é—´æ— æ³•æä¾›æœåŠ¡ï¼Œä¹‹åç½‘å…³æ‰å¯è®¤å®šè¿™æ˜¯ç”±äºæœåŠ¡å‡ºé”™å¯¼è‡´çš„ï¼Œå¦‚æœç›´æ¥å…³é—­æœåŠ¡æä¾›è€…é‚£è¿”å›çš„åªæ˜¯ 404</p>
</blockquote>
<p>æœ€åå¯åŠ¨ consul é›†ç¾¤ä»¥åŠæœåŠ¡æä¾›è€…ï¼Œé€šè¿‡ GET æ–¹å¼è¯·æ±‚ <code>http://localhost/hey</code> å³å¯å®Œæˆè·¯ç”±å®¹é”™æ§åˆ¶å™¨çš„å®ç°ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥ç›´æ¥é€šè¿‡ <code>lb://service-provider</code> æ¥è¿›è¡Œé…ç½®ä½ çš„æœåŠ¡è·¯ç”±ã€‚</p>
<h5 id="GlobalFilter-å…¨å±€è¿‡æ»¤å™¨"><a href="#GlobalFilter-å…¨å±€è¿‡æ»¤å™¨" class="headerlink" title="GlobalFilter (å…¨å±€è¿‡æ»¤å™¨)"></a>GlobalFilter (å…¨å±€è¿‡æ»¤å™¨)</h5><p>å¦ä¸€ç§åˆ™ä¸ºå…¨å±€è¿‡æ»¤å™¨ï¼ˆGlobalFilterï¼‰è¿™ç§è¿‡æ»¤å™¨ä¸ç½‘å…³è¿‡æ»¤å™¨çš„åŒºåˆ«æ˜¯ä¼š <strong>åº”ç”¨åˆ°æ‰€æœ‰è·¯ç”±ä¸­</strong>ï¼Œåœ¨ Gateway å†…ç½®ä¸­ï¼Œæœ‰ä¹ç§å…¨å±€è¿‡æ»¤å™¨ï¼š</p>
<table>
<thead>
<tr>
<th>Id</th>
<th>Name</th>
<th>Info</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>Forward Routing Filter</td>
<td>åœ¨ exchange çš„ <code>ServerWebExchangeUtils.GATEWAY_REQUEST_URL_ATTR</code> å±æ€§å€¼ä¸­æŸ¥æ‰¾ URIï¼ˆå¦‚æœ URI æ˜¯ forward åè®®ï¼Œåˆ™å°†å®ƒç”¨äº DispatcherHandler (è°ƒåº¦ç¨‹åºå¤„ç†ç¨‹åº) å¤„ç†è¯·æ±‚ï¼‰</td>
</tr>
<tr>
<td>2</td>
<td>LoadBalancerClient Filter</td>
<td>åœ¨ exchange çš„ <code>ServerWebExchangeUtils.GATEWAY_REQUEST_URL_ATTR</code> å€¼ä¸­æŸ¥æ‰¾ URIï¼Œå¦‚æœ URI æ˜¯ lb åè®®ï¼Œåˆ™ä¼šä½¿ç”¨ Spring cloud LoadBalancerClient å°†åç§°ï¼ˆlb:&#x2F;&#x2F;myservice ä¸­çš„ myserviceï¼‰è§£æä¸ºå®é™…çš„ä¸»æœºå’Œç«¯å£ï¼Œå¹¶æ›¿æ¢ URI ä¸­ç›¸åŒå±æ€§ã€‚ï¼ˆé™¤æ­¤è¿‡æ»¤å™¨è¿˜ä¼šæŸ¥çœ‹ <code>ServerWebExchangeUä½“åŠ›æ˜¯ã€‚GATEWAY_SCHEME_PREFIX_ATTR</code> å±æ€§æ¥åˆ¤æ–­ä»–æ˜¯å¦ç­‰äº <strong>lb</strong> ï¼‰</td>
</tr>
<tr>
<td>3</td>
<td>Netty Routing Filter</td>
<td>å‡è®¾ <code>ServerWebExchangeUtils.GATEWAY_REQUEST_URL_ATTR</code> ä¸­çš„ URI ä½¿ç”¨çš„æ˜¯ HTTP æˆ– HTTPS åè®®ï¼Œåˆ™è¿è¡Œ Netty Routing Filterã€‚ä»–ç”¨ Netty HttpClient æ‰€å‘å‡ºçš„ä¸‹æ¸¸ä»£ç†è¯·æ±‚ã€‚ç›¸åº”åº”è¯¥æ”¾åœ¨ <code>ServerWebExchangeUtils.CLIENT_RESPONSE_ATTR</code> çš„ exchange ä¸­ä»¥ä¾¿åœ¨ä»¥åçš„è¿‡æ»¤å™¨ä¸­ä½¿ç”¨</td>
</tr>
<tr>
<td>4</td>
<td>Netty Write Response Filter</td>
<td>å½“ <code>ServerWebExchangeUtils.CLIENT_RESPONSE_ATTR</code> å€¼ä¸­å­˜åœ¨ <code>NettyHttpClientResponse</code> åˆ™ä¼šè¿è¡Œ Netty Write Response Filterã€‚ï¼ˆä»–åœ¨æ‰€æœ‰å…¶ä»–è¿‡æ»¤å™¨å®Œæˆåè¿è¡Œï¼Œå¹¶å°†ä»£ç†ç›¸åº”å†™å›åˆ°ç½‘å…³å®¢æˆ·ç«¯çš„å“åº”æ•°æ®ä¸­ï¼‰</td>
</tr>
<tr>
<td>5</td>
<td>RouteToRequestUriFilter</td>
<td>å¦‚æœ <code>ServerWebExchangeUtils.GATEWAY_ROUTE_ATTR</code> å€¼ä¸­å­˜åœ¨ Route å¯¹è±¡ï¼Œåˆ™ä¼šå°†è·¯ç”±åˆ°è¯·æ±‚åœ°å€ï¼Œä»–ä¼šæ ¹æ®è¯·æ±‚ URI åˆ›å»ºä¸€ä¸ªæ–°çš„ URIã€‚æ–°çš„ URI åˆ™ä¼šä½äº <code>ServerWebExchangeUtils.GATEWAY_REQUEST_URI_ATTR</code> å€¼ä¸­ï¼ˆå‡è®¾ URI å…·æœ‰åè®®å‰ç¼€ï¼Œå¦‚ <code>lb:ws://serviceid</code> åˆ™ä¼šå°†ä» URI ä¸­æ‰€å‰¥ç¦» lb åè®®ï¼Œå¹¶é˜²æ­¢åœ¨ <code>ServerWebExchangeUtils.GATEWAY_SCHEMEPREFIX_ATTR</code> ä¸­ä»¥ä¾¿ç¨ååœ¨è¿‡æ»¤å™¨ä¸­æ‰€ä½¿ç”¨ï¼‰</td>
</tr>
<tr>
<td>6</td>
<td>Websocket Routing Filter</td>
<td>å‡è®¾ <code>ServerWebExhcangeUtils.GATEWAY_REQUEST_URL_ATTR</code> å€¼ä¸­çš„ URI æ˜¯ ws æˆ– wss åè®®ï¼Œåˆ™è¿è¡Œ <code>Websocket Routing Filter</code> ï¼ˆåˆ©ç”¨ Spring Web Socket åº•å±‚ä»£ç å°† WebSocket è¯·æ±‚è½¬å‘åˆ°ä¸‹æ¸¸ï¼‰</td>
</tr>
<tr>
<td></td>
<td></td>
<td>ä¹Ÿå¯ä»¥é€šè¿‡ URI å‰é¢æ·»åŠ  lb æ¥å¯¹ Websocket æ¥è¿›è¡Œè´Ÿè½½å‡è¡¡ï¼Œå¦‚ <code>lb:ws://serviceid</code>ï¼ˆéœ€è¦æ³¨æ„çš„æ˜¯å¦‚æœåœ¨æ™®é€š HTTP ä¸Šä½¿ç”¨ SockJS æ¥ä½œä¸ºå›é€€ï¼Œåˆ™ä¼šåŒ¹é…æ­£å¸¸çš„ HTTP è·¯ç”±ä»¥åŠ <code>Websocket</code> è·¯ç”±ï¼‰</td>
</tr>
<tr>
<td>7</td>
<td>Gateway Metrics Filter</td>
<td>ä½¿ç”¨éœ€è¦æ·»åŠ  <code>spring-boot-starter-actuator</code> ä¾èµ–ï¼Œé»˜è®¤ä¼šé€šè¿‡ <code>spring.cloud.gateway.mertics.enable</code> è®¾ç½®ä¸º <code>false</code> Gateway Metrics Filter æ‰ä¼šè¿è¡Œã€‚è¯¥è¿‡æ»¤å™¨ä¼šæ·»åŠ ä¸€ä¸ªåä¸º <code>gateway.request</code> æŒ‡æ ‡ï¼ˆMetricsï¼‰ï¼Œå¹¶åŒ…å«å››ä¸ªå±æ€§ï¼š</td>
</tr>
<tr>
<td></td>
<td></td>
<td>routeIdï¼šè·¯ç”±å™¨ ID</td>
</tr>
<tr>
<td></td>
<td></td>
<td>routeUriï¼šAPIå°†ä¼šè¢«è·¯ç”±è½¬åˆ° URI</td>
</tr>
<tr>
<td></td>
<td></td>
<td>outcomeï¼šç”± <code>HttpStatus.Series</code> æ‰€åˆ†ç±»çš„ç»“æœ</td>
</tr>
<tr>
<td></td>
<td></td>
<td>statusï¼šHTTP è¯·æ±‚è¿”å›ç»™å®¢æˆ·ç«¯çš„çŠ¶æ€</td>
</tr>
<tr>
<td>8</td>
<td>Combined Global Filter and GatewayFilter Orderingï¼ˆç»„åˆæ˜¯å…¨å±€è¿‡æ»¤å™¨å’Œç½‘ç®¡è¿‡æ»¤å™¨æ’åºï¼‰</td>
<td>å½“è¯·æ±‚è¿›å…¥å¹¶åŒ¹é…åˆ°ä¸€ä¸ªè·¯ç”±æ—¶ï¼Œ Filtering Web Handler ä¼šå°† GlobalFilter çš„æ‰€æœ‰å®ä¾‹å’Œ GatewayFilter çš„æ‰€æœ‰è·¯ç”±ç‰¹å®šå®ä¾‹æ·»åŠ åˆ°è¿‡æ»¤å™¨é“¾ä¸­ã€‚ï¼ˆè¿™ä¸ªç»„åˆçš„è¿‡æ»¤å™¨é“¾ç”± <code>org.springframeworking.core.Ordered</code> æ¥å£çš„æ’åºï¼Œå¹¶é€šè¿‡ <code>gegOrder()</code> æ–¹æ³•æˆ–æ³¨è§£ <code>@Order</code> æ¥è®¾ç½®ï¼‰åŒæ—¶ç½‘å…³ä¹Ÿä¼šå¯¹è¿‡æ»¤å™¨é€»è¾‘æ‰§è¡Œçš„ â€œPREâ€ å’Œ â€POSTâ€œ é˜¶æ®µæ¥è¿›è¡ŒåŒºåˆ†</td>
</tr>
<tr>
<td>9</td>
<td>Marking An Exchange As Routed ï¼ˆè·¯ç”±äº¤æ¢ï¼‰</td>
<td>ç½‘å…³åœ¨è·¯ç”± WEB æœåŠ¡äº¤æ¢åï¼ˆServerWebExchangeï¼‰ï¼Œä¼šå°† <code>Gateway Already Routed</code> æ·»åŠ åˆ° exchange å±æ€§æ¥å°†è¯¥äº¤æ¢æ ‡è¯†ä¸º â€è·¯ç”±â€ï¼ˆä¸€æ—¦è¢«è¯·æ±‚æ ‡è¯†ä¸ºè·¯ç”±ï¼Œåˆ™å…¶ä»–çš„è·¯ç”±è¿‡æ»¤å™¨ä¼šè·³è¿‡è¯¥è¯·æ±‚ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä¾¿æºæ–¹æ³•å°†äº¤æ¢æ ‡è¯†ä¸ºè·¯ç”±ï¼Œæˆ–æ£€æŸ¥äº¤æ¢æ˜¯å¦å·²ç»æˆä¸ºè·¯ç”±ï¼‰</td>
</tr>
</tbody></table>
<blockquote>
<p>æ›´å¤šå¯ä»¥å‚è€ƒ <a target="_blank" rel="noopener" href="https://cloud.spring.io/spring-cloud-gateway/reference/html/#the-addrequestheader-gatewayfilter-factory">https://cloud.spring.io/spring-cloud-gateway/reference/html/#the-addrequestheader-gatewayfilter-factory</a> - Spring cloud gateway å®˜æ–¹æ–‡æ¡£</p>
</blockquote>
<h2 id="é™æµ"><a href="#é™æµ" class="headerlink" title="é™æµ"></a>é™æµ</h2><p><img src="https://49812933408852955071488026628034-1301075051.cos.ap-nanjing.myqcloud.com/20210723224018.png"></p>
<p>é™æµçš„ä¸»è¦ç›®çš„æ˜¯é˜²æ­¢è¿‡æ¸¡çš„æ¶ˆè€—èµ„æºï¼Œä»è€Œæ¥ä¿éšœæœåŠ¡å¯¹æ‰€æœ‰ç”¨æˆ·çš„å¯ç”¨æ€§ï¼Œå¸¸è§çš„é™æµæªæ–½å¦‚è¯¸ä»¥é™åˆ¶å¹¶å‘æ•°ä¸ºç›®çš„çš„æ•°æ®åº“è¿æ¥æ± &#x2F;çº¿ç¨‹æ± ï¼Œä»¥åŠç¬æ—¶å¹¶å‘æ•°çš„é™åˆ¶ï¼Œå’Œé™åˆ¶æ¯ç§’çš„å¹³å‡é€Ÿç‡éƒ½æ˜¯æœ€ä¸ºå¸¸è§çš„ã€‚è€Œè¿™äº›åŸºæœ¬ä¸Šéƒ½ä¼šåœ¨ç½‘å…³å±‚ä¸Šè¿›è¡Œå®ç°ï¼Œå¦‚ä½¿ç”¨ nginxã€zuulã€gatewayã€openrestyã€kong ç­‰æ–¹å¼è¿›è¡Œé™æµã€‚</p>
<blockquote>
<p>ä»¥ç»´åŸºç™¾ç§‘çš„è¯æ¥è¯´å°±æ˜¯åœ¨è®¡ç®—æœºç½‘ç»œä¸­ï¼Œæ§åˆ¶ç½‘ç»œæ¥å£è¯·æ±‚é€Ÿç‡</p>
</blockquote>
<p><img src="https://49812933408852955071488026628034-1301075051.cos.ap-nanjing.myqcloud.com/20210723224217.png"></p>
<p>å¦‚æœæ²¡æœ‰è¿›è¡Œé™æµçš„è¯ï¼Œåˆ™æœ‰å‡ ç‡ä¼šè¢«æ¶æ„æäº¤ï¼Œå¯¼è‡´åç»­æœåŠ¡æ— æ³•å¾—åˆ°æä¾›ï¼Œä»è€Œè¾¾åˆ°æ‹’ç»æœåŠ¡æ”»å‡»ï¼Œè€Œé™æµåœ¨é«˜å¹¶å‘ä¸­ï¼Œæ˜¯ä¸€ä¸ªå¿…ä¸å¯å°‘çš„ä¸€ä¸ªå› ç´ ä¹‹ä¸€ï¼Œé€šè¿‡é™æµå‘æŒ¥çš„ä½œç”¨ä»è€Œä¿æŠ¤ç”¨æˆ·çš„å¯ç”¨æ€§ï¼Œç”šè‡³é˜²æ­¢ä¸€äº›æ¶æ„è¯·æ±‚ç­‰é—®é¢˜çš„å‘ç”Ÿã€‚</p>
<h3 id="é™æµç®—æ³•"><a href="#é™æµç®—æ³•" class="headerlink" title="é™æµç®—æ³•"></a>é™æµç®—æ³•</h3><h4 id="è®¡æ•°å™¨ç®—æ³•ï¼ˆå›ºå®šçª—å£ï¼‰"><a href="#è®¡æ•°å™¨ç®—æ³•ï¼ˆå›ºå®šçª—å£ï¼‰" class="headerlink" title="è®¡æ•°å™¨ç®—æ³•ï¼ˆå›ºå®šçª—å£ï¼‰"></a>è®¡æ•°å™¨ç®—æ³•ï¼ˆå›ºå®šçª—å£ï¼‰</h4><p>è®¡æ•°å™¨ç®—æ³•æ˜¯ä¸€ä¸ªç®€å•ä»¥åŠæš´åŠ›çš„ï¼Œä»–ä»ç¬¬ä¸€ä¸ªè¯·æ±‚å¼€å§‹è®¡æ•°ï¼Œåœ¨å‡è®¾æˆ‘ä»¬è®¾ç½®ä¸€ä¸ª QPSï¼ˆæ¯ç§’æŸ¥è¯¢æ•°ä¸º 100ï¼‰ï¼Œä¸€ç§’å†…è¯·æ±‚è¶…è¿‡äº†è®¾å®šå€¼ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥çš„è¯·æ±‚éƒ½ä¼šè¢«æ‹’ç»ï¼Œç­‰è¿‡ä¸€ç§’åæ‰å¯ç»§ç»­æŸ¥è¯¢ï¼Œè¿™æ—¶ä¼šå°†è®¡æ•°æ¢å¤æˆ0ã€‚</p>
<p>çœ‹ä¼¼è¿™ä¸ªç®—æ³•å¾ˆå¥½ä¸”å¯ä»¥è§£å†³ä¸€äº›ç®€å•çš„é—®é¢˜ï¼Œä½†è¿™ä¸ªç®—æ³•ä¹Ÿå­˜åœ¨çš„ä¸€äº›é—®é¢˜ï¼Œå¦‚æˆ‘åœ¨ 100ms å†…é€šè¿‡äº† 100 ä¸ªè¯·æ±‚ï¼Œåˆ™åç»­çš„ 900ms å†…çš„è¯·æ±‚éƒ½ä¼šè¢«æ‹’ç»ï¼Œå› æ­¤è¿™ç§ç°è±¡ä¹Ÿè¢«ç§°ä¹‹ä¸º â€œçªåˆºç°è±¡â€ã€‚è™½ç„¶æˆ‘ä»¬å¯ä»¥é€šè¿‡å°†å•ä½æ—¶é—´è®¾ç½®çš„æ›´çŸ­ï¼Œä½†ä¾æ—§æ— æ³•è§£å†³æ ¸å¿ƒçš„é—®é¢˜ï¼Œè¿™æ—¶å°±è¯ç”Ÿäº†æ¼æ¡¶ç®—æ³•å’Œä»¤ç‰Œæ¡¶ç®—æ³•ã€‚</p>
<h4 id="è®¡æ•°å™¨ç®—æ³•ï¼ˆæ»‘åŠ¨çª—å£ï¼‰"><a href="#è®¡æ•°å™¨ç®—æ³•ï¼ˆæ»‘åŠ¨çª—å£ï¼‰" class="headerlink" title="è®¡æ•°å™¨ç®—æ³•ï¼ˆæ»‘åŠ¨çª—å£ï¼‰"></a>è®¡æ•°å™¨ç®—æ³•ï¼ˆæ»‘åŠ¨çª—å£ï¼‰</h4><p><img src="https://49812933408852955071488026628034-1301075051.cos.ap-nanjing.myqcloud.com/20210723224029.png"></p>
<p>æ»‘åŠ¨çª—å£åˆæ˜¯è®¡æ•°å™¨ç®—æ³•çš„ä¸€ä¸ªæ”¹è¿›ï¼Œä¸»è¦è§£å†³äº†å›ºå®šçª—å£ä¸Šçš„ <strong>ä¸´ç•Œå€¼</strong> çš„é—®é¢˜ï¼Œå°†ä¸€ä¸ªè®¡æ—¶å™¨åˆ†ä¸ºäº†è¯ºå¹²ä¸ªå°çš„è®¡æ—¶å™¨ï¼Œè¿™äº›è®¡æ—¶å™¨éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œå½“è¯·æ±‚æ—¶é—´å¤§äºç¬¬ä¸€ä¸ªè®¡æ—¶å™¨æœ€å¤§æ—¶é—´æ—¶ï¼Œé‚£ä¹ˆå°†ä¼šå‘å‰å¹³ç§»ä¸€ä¸ªè®¡æ—¶å™¨ï¼ˆåŒæ—¶å°†å‰ä¸€ä¸ªè®¡æ—¶å™¨ä¸¢å¼ƒï¼Œç„¶åå°†å½“å‰çš„è®¡æ—¶å™¨è®¾ç½®ä¸ºç¬¬ä¸€ä¸ªè®¡æ—¶å™¨ï¼‰ã€‚</p>
<p>å¦‚ä¸Šå›¾ä¸­ï¼Œçª—å£å¤§å°ä¸º 1sï¼Œé‚£ä¹ˆæ¯è¿‡ 0.2mså°±ä¼šåˆ é™¤å‰ä¸€ä¸ªæ ¼å­ï¼Œä»è€Œå‘å³ç§»ä¸€ä¸ªæ ¼å­ï¼Œæ»‘åŠ¨çª—å£æœ€ä¸ºä¸»è¦çš„å°±æ˜¯ä»–çš„æ»‘åŠ¨ï¼Œä½¿å¾—å¯ä»¥æ§åˆ¶çš„æ›´åŠ ç»†å¯†ï¼Œä»¥æ­¤æ¥è§£å†³ä¸´ç•Œå€¼çš„é—®é¢˜ï¼Œä½†æ»‘åŠ¨çª—å£å’Œå›ºå®šçª—å£éƒ½æ— æ³•è§£å†³çªåˆºç°è±¡è¿™ä¸€é—®é¢˜ã€‚</p>
<h4 id="æ¼æ¡¶ç®—æ³•"><a href="#æ¼æ¡¶ç®—æ³•" class="headerlink" title="æ¼æ¡¶ç®—æ³•"></a>æ¼æ¡¶ç®—æ³•</h4><p><img src="https://49812933408852955071488026628034-1301075051.cos.ap-nanjing.myqcloud.com/20210717200946.png"></p>
<p>æ¼æ¡¶ç®—æ³•ï¼ˆLeaky Bucketï¼‰å†…ä¸»è¦æœ‰ä¸¤ä¸ªå˜é‡ï¼Œåˆ†åˆ«ä¸º <strong>æ¡¶çš„å¤§å°ä»¥åŠæ¼æ´ï¼ˆå­”çš„å¤§å°ï¼‰çš„å¤§å°</strong>ï¼Œå¯ä»¥å°†è¯·æ±‚æ¯”å–»æ°´ï¼Œå½“æ°´å€’å…¥æ¼æ¡¶ä¸­ï¼Œéœ€è¦æœ‰ä¸€å®šçš„å¤„ç†é€Ÿåº¦ï¼ˆå­”çš„å¤§å°å†³å®šå¤„ç†çš„é€Ÿåº¦ï¼‰ï¼Œè€Œæ¡¶çš„å¤§å°å†³å®šäº†å¯ä»¥å®¹çº³è¯·æ±‚çš„å¤§å°ï¼Œå¦‚æœè¯·æ±‚å¤ªå¤§ï¼Œåˆ™ä¼šå¯¼è‡´æ¼æ¡¶è£…ä¸ä¸‹è¯·æ±‚ä»è€Œæ‹’ç»åç»­çš„è¯·æ±‚ã€‚</p>
<h4 id="ä»¤ç‰Œæ¡¶ç®—æ³•"><a href="#ä»¤ç‰Œæ¡¶ç®—æ³•" class="headerlink" title="ä»¤ç‰Œæ¡¶ç®—æ³•"></a>ä»¤ç‰Œæ¡¶ç®—æ³•</h4><p><img src="https://49812933408852955071488026628034-1301075051.cos.ap-nanjing.myqcloud.com/20210717200956.png"></p>
<p>ä»¤ç‰Œæ¡¶ç®—æ³•ï¼ˆToken Bucketï¼‰è¿™ç§ç®—æ³•å’Œæˆ‘ä»¬åœ¨åŒ»é™¢æ’é˜Ÿå«å·æ¯”è¾ƒç›¸ä¼¼ï¼Œå½“è¯·æ±‚åˆ°è¾¾çš„æ—¶å€™ï¼Œä¼šå»ä»¤ç‰Œæ¡¶ï¼ˆç”±ä»¤ç‰Œå·¥å‚ç”Ÿäº§ä»¤ç‰Œï¼‰ä¸­å–å¾—ä¸€ä¸ªä»¤ç‰Œï¼Œä¹‹åç­‰å¾…å“åº”ã€‚</p>
<p>è¿™ä¹Ÿè¾¾åˆ°äº†ä¸€å®šé™æµçš„ç›®çš„ï¼Œé¦–å…ˆæˆ‘ä»¬å¯ä»¥å†³å®šä»¤ç‰Œå·¥å‚æ”¾å…¥ä»¤ç‰Œçš„é€Ÿç‡ï¼Œä¹Ÿå¯ä»¥å®šæ—¶æˆ–è€…æ ¹æ®ä¸€äº›ç‰¹å®šçš„è§„åˆ™æ¥è¾¾åˆ°ç›®çš„ï¼Œä»è€Œè¾¾åˆ°å¢åŠ &#x2F;å‡å°‘ä»¤ç‰Œçš„æ•°é‡è¾¾åˆ°é™æµçš„æ•ˆæœã€‚</p>
<h3 id="é™æµçš„å®ç°"><a href="#é™æµçš„å®ç°" class="headerlink" title="é™æµçš„å®ç°"></a>é™æµçš„å®ç°</h3><p>Spring cloud Gateway å†…ç½®äº†é™æµå·¥å‚ <code>RequestRateLimiterGatewayFilterFactory</code> åº•å±‚ä½¿ç”¨ redis lua è„šæœ¬è¿›è¡Œå®ç°ï¼Œå› æ­¤éœ€è¦æ·»åŠ  Consulã€Gatewayã€Redis çš„ä¾èµ–ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-data-redis-reactive --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-data-redis-reactive&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;2.5.2&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-gateway&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-consul-discovery&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>ä¹‹åç¼–å†™æˆ‘ä»¬çš„é™æµé…ç½®ç±»ï¼Œä¸»è¦é€šè¿‡åç§°ã€åœ°å€ã€ä»¥åŠ API è¿›è¡Œé™æµä¸‰ç§ï¼Œä¹Ÿå¯ä»¥æ ¹æ®ä¸åŒçš„çŠ¶å†µè‡ªå®šä¹‰é…ç½®ï¼ˆè¿˜æœ‰ä¸€ä¸ªè·Ÿå‡ CPU è¿›è¡Œé™æµçš„ï¼Ÿï¼‰</p>
<h4 id="LimitConfig-java"><a href="#LimitConfig-java" class="headerlink" title="LimitConfig.java"></a>LimitConfig.java</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.filter.ratelimit.KeyResolver;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Primary;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é™æµé…ç½®æ–‡ä»¶ï¼Œæ ¹æ®åç§°ã€åœ°å€ã€API</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> kunlun</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/7/23</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LimitConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    KeyResolver <span class="title function_">userKeyResolver</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> exchange -&gt;</span><br><span class="line">                Mono.just(exchange.getRequest().getQueryParams().</span><br><span class="line">                        getFirst(<span class="string">&quot;user&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    KeyResolver <span class="title function_">ipKeyResolver</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> exchange -&gt;</span><br><span class="line">                Mono.just(exchange.getRequest().getRemoteAddress().</span><br><span class="line">                        getHostName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    KeyResolver <span class="title function_">apiKeyResolver</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> exchange -&gt;</span><br><span class="line">                Mono.just(exchange.getRequest().getPath().</span><br><span class="line">                        value());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="application-yml-1"><a href="#application-yml-1" class="headerlink" title="application.yml"></a>application.yml</h5><p>æœ€åé€šè¿‡é…ç½®æ–‡ä»¶ <code>application.yml</code> æ¥é“¾æ¥ consulã€redis ä»¥åŠé…ç½®è·¯ç”±è§„åˆ™å’Œå…¨å±€è¿‡æ»¤ç­‰ã€‚</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">GatewayLimit</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">    <span class="attr">database:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">toor</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">hey</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://service-provider/hey</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/hey</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Method=GET</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">RequestRateLimiter</span>                <span class="comment"># ç”¨äºç¡®å®šå½“å‰è¯·æ±‚æ˜¯å¦ç»§ç»­ï¼ˆå¦‚æœä¸å…è®¸åˆ™ä¼šè¿”å› 429</span></span><br><span class="line">              <span class="attr">args:</span></span><br><span class="line">                <span class="attr">key-resolver:</span> <span class="string">&#x27;#&#123;@ipKeyResolver&#125;&#x27;</span></span><br><span class="line">                <span class="attr">redis-rate-limiter.replenishRate:</span> <span class="number">1</span>   <span class="comment"># ä»¤ç‰Œæ¡¶æ¯ç§’å¡«å……çš„å¹³å‡é€Ÿç‡</span></span><br><span class="line">                <span class="attr">redis-rate-limiter.burstCapacity:</span> <span class="number">3</span>   <span class="comment"># ä»¤ç‰Œæ¡¶æ€»æµé‡</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">locator:</span></span><br><span class="line">          <span class="comment"># å…è®¸æœåŠ¡å‘ç°</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">consul:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8500</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">service-name:</span> <span class="string">service-provider</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8210</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>ä¿è¯ redisã€consul ç­‰å·²ç»å¯åŠ¨ä¸”å¯æä¾›æœåŠ¡</p>
</blockquote>
<h3 id="ç«¯ç‚¹"><a href="#ç«¯ç‚¹" class="headerlink" title="ç«¯ç‚¹"></a>ç«¯ç‚¹</h3><p><img src="https://49812933408852955071488026628034-1301075051.cos.ap-nanjing.myqcloud.com/20210724001731.png"></p>
<p>ç«¯ç‚¹åœ¨ Spring cloud Gateway ä¸­ä¸»è¦æä¾›çš„ä½œç”¨å°±æ˜¯æ–¹ä¾¿å¼€å‘æˆ–è€…è¿ç»´äººå‘˜è¿›è¡Œè°ƒè¯•ï¼Œä»¥æ­¤æ¥è·å–è¿‡æ»¤å™¨åˆ—è¡¨ã€è·¯ç”±åˆ—è¡¨ã€è·¯ç”±ä¿¡æ¯ã€åˆ·æ–°è·¯ç”±ä¿¡æ¯ä»¥åŠæ·»åŠ \åˆ é™¤è·¯ç”±ç­‰æ“ä½œï¼Œè¿™ä¾èµ–äº <code>Spring boot Actuator</code> ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¿™äº›ç«¯ç‚¹éƒ½ä¼šåœ¨ <code>/actuator/gateway</code> è·¯å¾„ä¸‹ï¼Œåˆ†åˆ«æä¾›å¯¹åº”çš„æœåŠ¡ï¼š</p>
<table>
<thead>
<tr>
<th>Id</th>
<th>Name</th>
<th>Method</th>
<th>Info</th>
<th>Uri</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>globalfilters</td>
<td>GET</td>
<td>å±•ç¤ºæ‰€æœ‰å…¨å±€è¿‡æ»¤å™¨</td>
<td><code>/actuator/gateway/globalfilters</code></td>
</tr>
<tr>
<td>2</td>
<td>routefilters</td>
<td>GET</td>
<td>å±•ç¤ºæ‰€æœ‰è¿‡æ»¤å™¨å·¥å‚</td>
<td><code>/actuator/gateway/routefilters</code></td>
</tr>
<tr>
<td>3</td>
<td>refresh</td>
<td>POST</td>
<td>æ¸…ç©ºè·¯ç”±ç¼“å­˜</td>
<td><code>/actuator/gateway/refresh</code></td>
</tr>
<tr>
<td>4</td>
<td>routes</td>
<td>GET</td>
<td>è·å–è·¯ç”±åˆ—è¡¨</td>
<td><code>/actuator/gateway/routes</code></td>
</tr>
<tr>
<td>5</td>
<td>routes{name}</td>
<td>GET</td>
<td>è·å–æŒ‡å®šçš„è·¯ç”±ä¿¡æ¯</td>
<td><code>/actuator/gateway/routes/&#123;name&#125;</code></td>
</tr>
<tr>
<td>6</td>
<td>routes{name}</td>
<td>POST</td>
<td>æ·»åŠ ä¸€ä¸ªè·¯ç”±</td>
<td><code>/actuator/gateway/routes/&#123;name&#125;</code></td>
</tr>
<tr>
<td>7</td>
<td>routes{name}</td>
<td>DELETE</td>
<td>ç§»å‡ºä¸€ä¸ªè·¯ç”±</td>
<td><code>/actuator/gateway/routes/&#123;name&#125;</code></td>
</tr>
</tbody></table>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">    &lt;!-- https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-data-redis-reactive --&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-data-redis-reactive&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.5.2&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-cloud-starter-gateway&lt;/artifactId&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-cloud-starter-consul-discovery&lt;/artifactId&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;!-- https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-actuator --&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.5.2&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>.</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">â€¦â€¦</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span>  <span class="string">&#x27;*&#x27;</span></span><br></pre></td></tr></table></figure>

<p>å¼€å¯åï¼Œå¯ä»¥è®¿é—® <a target="_blank" rel="noopener" href="http://localhost:8210/actuator/gateway/routes/hey">http://localhost:8210/actuator/gateway/routes/hey</a> æ¥è¿›è¡Œæµ‹è¯•æ˜¯å¦å¯ä»¥è¯¥è·¯ç”±çš„ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰è¿”å›åˆ™å¯èƒ½æ˜¯ Actuator é…ç½®ä¸Šæœ‰ä¸€ç‚¹ç‚¹çš„é—®é¢˜</p>
<p>åœ¨ <code>management</code> ä¸­ï¼Œé»˜è®¤åªå¼€å¯äº†ä¸¤ä¸ªç«¯ç‚¹ï¼Œåˆ†åˆ«ä¸º healthã€info ä¸¤ä¸ª å› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸Šè¿°é…ç½®å¼€å¯å…¨éƒ¨çš„æ–­ç‚¹è®¿é—®ï¼Œæ›´è¯¦ç»†çš„å¯ä»¥æŸ¥é˜… Actuator API: <a target="_blank" rel="noopener" href="https://cloud.spring.io/spring-cloud-gateway/multi/multi__actuator_api.html">https://cloud.spring.io/spring-cloud-gateway/multi/multi__actuator_api.html</a></p>

	

	

</article>





	<span class="different-posts">ğŸ“– <a href="/page/14">more posts</a> ğŸ“–</span>



	</main>

	<footer class="footer">
	<div class="footer-content">
		
	      <div class="footer__element">
	<p>æ¬¢è¿æ¥åˆ°æˆ‘çš„ blog <br><br> é€šè¿‡ <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>+<a target="_blank" rel="noopener" href="https://github.com/HoverBaum/meilidu-hexo">MeiliDu</a> è¿›è¡Œæ„å»ºçš„ï¼Œå­˜æ”¾åœ¨ <a target="_blank" rel="noopener" href="https://github.com/vendanges/vendanges.github.io">Github</a> ä¸Šã€‚</p>
</div>

	    
	      <div class="footer__element">
	<h5>Check out</h5>
	<ul class="footer-links">
		<li class="footer-links__link"><a href="/archives">Archive</a></li>
		
		  <li class="footer-links__link"><a href="/atom.xml">RSS</a></li>
	    
		<li class="footer-links__link"><a href="/about">about page</a></li>
		<li class="footer-links__link"><a href="/tags">Tags</a></li>
		<li class="footer-links__link"><a href="/categories">Categories</a></li>
	</ul>
</div>

	    

		<div class="footer-credit">
			<span>Â© 2022 John Doe | Powered by <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> | Theme <a target="_blank" rel="noopener" href="https://github.com/HoverBaum/meilidu-hexo">MeiliDu</a></span>
		</div>

	</div>


</footer>



</body>

</html>
