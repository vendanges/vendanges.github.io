<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta name="theme-color" content="#33474d">
	<title>琼瑶</title>
	<link rel="stylesheet" href="/css/style.css" />
	
      <link rel="alternate" href="/atom.xml" title="琼瑶" type="application/atom+xml">
    
<meta name="generator" content="Hexo 6.1.0"></head>

<body>

	<header class="header">
		<nav class="header__nav">
			
				<a href="/" class="header__link" style="color: #fff">Home</a>
			
				<a href="/archives" class="header__link" style="color: #fff">Archive</a>
			
				<a href="/about" class="header__link" style="color: #fff">About</a>
			
		</nav>
		<!-- <h1 class="header__title"><a href="/">琼瑶</a></h1> -->
		<h1 class="header__title"><a href="/"><img style="width: 290px;" src="https://49812933408852955071488026628034-1301075051.cos.ap-nanjing.myqcloud.com/202204152017786.png"></a></h1>
		<h2 class="header__subtitle">梦入琼楼寒有月，行过石树冻无烟</h2>
	</header>

	<main>
		
	<span class="different-posts different-posts_earlier">📖 <a href="/page/4">earlier posts</a> 📖</span>




	<article>
	
		<h1><a href="/2022/04/21/javascript/node/2.Node.js 工作原理/">Node.js 工作原理</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2022-04-21</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-none-link" href="/tags/javascript/" rel="tag">javascript</a> <a class="article__tag-none-link" href="/tags/node-js/" rel="tag">node.js</a>
			</span>
		
	</div>

	

	
		<h2 id="运行时（Rutime-System）与-node-vm"><a href="#运行时（Rutime-System）与-node-vm" class="headerlink" title="运行时（Rutime System）与 node vm"></a>运行时（Rutime System）与 node vm</h2><h3 id="Runtime-system"><a href="#Runtime-system" class="headerlink" title="Runtime system"></a>Runtime system</h3><p>运行时系统（Runtime system），又称之为 “运行环境”，指将半编译的代码运行的环境。在 node 核心概念中指的是 <strong>数据类型的确定</strong> 由编译时推迟到了运行时，因此就出现了运行时系统（Rutime System）来处理编译后的代码。</p>
<p>因此这个概念和流程就是 JavaScript 引擎负责解析和即时编译（JIT），结合 Rutime 因此可以实现了 Window 、DOM API，存在与浏览器的 Runtime 中。</p>
<p>所以 Node.js 中的 Runtime 也包含了不同的库，例如 Cluster、FileSystem API，这里面的 Runtime 都包含了内置的数据类型和常用的工具，因此 Chrome 和 Node.js 同样使用 V8 引擎但不会使用同一个 Runtime。</p>
<blockquote>
<p>Cluster （集群）在 node v0.8 开始集成的内置模块，为解决单线程设计的瓶颈而生。</p>
<blockquote>
<p>System Runtime ：<a target="_blank" rel="noopener" href="https://designfirst.io/systemruntime/">https://designfirst.io/systemruntime/</a>，常见的运行时系统需要通过 C 或汇编而成，通过此项目可以简单构建</p>
</blockquote>
</blockquote>
<h3 id="VM"><a href="#VM" class="headerlink" title="VM"></a>VM</h3><p>VM 是 Node 核心模块之一，通过使用 V8 的 Virtual Machine Contexts 动态编译和执行代码，但代码的运行在上下文中是与当前隔离的，但他不是安全的，因此不要使用他来运行不受信任的代码。</p>
<p>不同与浏览器的沙箱环境， vm 提供了一系列的 API 用于在 V8 虚拟机中编译和运行代码，可以让 JavaScript 的代码被编译且立即运行或编译后保存运行：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义常量</span></span><br><span class="line"><span class="keyword">const</span> util = <span class="built_in">require</span>(<span class="string">&#x27;util&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> vm = <span class="built_in">require</span>(<span class="string">&#x27;vm&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一个新的 vm.Script 对象，将会编译 code 但不会运行，之后可以多次运行。</span></span><br><span class="line"><span class="keyword">const</span> script = <span class="keyword">new</span> vm.<span class="title class_">Script</span>(<span class="string">&#x27;globalVar += 1; anotherGlobalVar = 1;&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建沙盒并绑定上下文</span></span><br><span class="line"><span class="keyword">const</span> sandbox = &#123;<span class="attr">globalVar</span>: <span class="number">1</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建上下文并将沙盒(sandbox)绑定至到环境中</span></span><br><span class="line"><span class="keyword">const</span> contextifiedSandbox = vm.<span class="title function_">createContext</span>(sandbox);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 运行 vm.script 内包含的上下文对象，并返回结果</span></span><br><span class="line"><span class="keyword">const</span> result = script.<span class="title function_">runInContext</span>(contextifiedSandbox);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 是否沙盒绝对等于上下文沙盒 （true）</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`sandbox === contextifiedSandbox ? <span class="subst">$&#123;sandbox === contextifiedSandbox&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// sandbox: &#123; globalVar: 2, anotherGlobalVar: 1 &#125;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`sandbox: <span class="subst">$&#123;util.inspect(sandbox)&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// result: 1</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`result: <span class="subst">$&#123;util.inspect(result)&#125;</span>`</span>);</span><br></pre></td></tr></table></figure>

<p><code>vm.Script</code> 是新增于 node.js v0.3.1 类，用于绑定任何全局对象，之后可以多次运行，也就是说我们将 <code>sandbox</code> 对象创建了环境的上下文，将对象绑定到环境中，因此最后输出 <code> globalVar: 2, anotherGlobalVar: 1</code></p>
<p>这也就表明了 <code>script.runInContext</code> 在 <code>contextifiedSandbox</code> 上下文中运行，从而当 <code>console.log</code> 时，他的值已经改变了。</p>
<blockquote>
<p><code>util.inspect</code> 用于检查常量，除了 <code>script.runInContext</code> 以外，在 node.js v6.3.0 中也完全支持了更为简单的方法 <code>vm.runlnContext</code></p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> vm = <span class="built_in">require</span>(<span class="string">&#x27;vm&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置上下文全局变量为 1</span></span><br><span class="line"><span class="keyword">const</span> context = &#123;<span class="attr">globalVar</span>: <span class="number">1</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建上下文方法准备该对象，以便可以调用上下文</span></span><br><span class="line">vm.<span class="title function_">createContext</span>(context);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过 vm 方法编译 code，并运行上下文并返回结果</span></span><br><span class="line">vm.<span class="title function_">runInContext</span>(<span class="string">&#x27;globalVar += 1;&#x27;</span>, context)</span><br><span class="line"></span><br><span class="line"><span class="comment">// globalVar：2</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;globalVar：&#x27;</span> + context.<span class="property">globalVar</span>);</span><br></pre></td></tr></table></figure>

<h2 id="回调-同步-异步-阻塞-非阻塞"><a href="#回调-同步-异步-阻塞-非阻塞" class="headerlink" title="回调\同步\异步\阻塞\非阻塞"></a>回调\同步\异步\阻塞\非阻塞</h2><h3 id="回调函数"><a href="#回调函数" class="headerlink" title="回调函数"></a>回调函数</h3><p>在计算机的设计之初，基本上都是通过异步来进行的，在此之前我们需要知道异步的相关类别</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Info</th>
</tr>
</thead>
<tbody><tr>
<td>同步</td>
<td>按照需求内的一步一步进行执行</td>
</tr>
<tr>
<td>异步</td>
<td>可以同时执行多种事情</td>
</tr>
<tr>
<td>堵塞</td>
<td>按照需求内一步一步进行，当一个程序没有执行，下面所排队等待的程序都处于排队状态</td>
</tr>
<tr>
<td>非堵塞</td>
<td>当一个程序没有执行完毕，后面所排队的程序都会进行插队</td>
</tr>
</tbody></table>
<p>node.js 异步内的直接体现就在于回调，而回调就是，当你不知道用户何时会点击按钮，因此你为事件所定义了一个事件的处理程序，该事件会在处理时被触发调用即“回调”，我们以文件读取为例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 异步读取文件内容，通过 readFile() 缓冲整个文件</span></span><br><span class="line">fs.<span class="title function_">readFile</span>(<span class="string">&#x27;package.json&#x27;</span>, <span class="keyword">function</span> (<span class="params">err,data</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(err.<span class="property">stack</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(data.<span class="title function_">toString</span>() + <span class="string">&#x27;\n File echo success!&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>以上的 js 脚本中那个，主要通过 <code>fs.readFile</code> 函数来异步读取文件，如果文件不存在则直接通过 <code>err</code> 输出错误信息，如没有发生错误则会忽略 <code>err</code>对象进行输出，因此文件的内容就通过了回调函数输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ node vm.js </span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: &quot;demo&quot;,</span><br><span class="line">  &quot;version&quot;: &quot;1.0.0&quot;,</span><br><span class="line">  &quot;description&quot;: &quot;node demo&quot;,</span><br><span class="line">  &quot;main&quot;: &quot;index.js&quot;,</span><br><span class="line">  &quot;scripts&quot;: &#123;</span><br><span class="line">    &quot;test&quot;: &quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;repository&quot;: &#123;</span><br><span class="line">    &quot;type&quot;: &quot;git&quot;,</span><br><span class="line">    &quot;url&quot;: &quot;https://gitee.com/sif_one/node-demo&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;keywords&quot;: [</span><br><span class="line">    &quot;null&quot;</span><br><span class="line">  ],</span><br><span class="line">  &quot;author&quot;: &quot;sun likun&quot;,</span><br><span class="line">  &quot;license&quot;: &quot;ISC&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> File echo success!</span><br></pre></td></tr></table></figure>

<p>假设 <code>package.json</code> 文件并不存在，那么在经过 <code>s.readFile()</code> 方法时，<code>err</code> 对象就会输出错误信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ node vm.js </span><br><span class="line">Error: ENOENT: no such file or directory, open &#x27;pac1kage.json&#x27;</span><br></pre></td></tr></table></figure>

<h3 id="同步和异步的区别"><a href="#同步和异步的区别" class="headerlink" title="同步和异步的区别"></a>同步和异步的区别</h3><p>同步可以说是一个进程在执行某一个请求的时候，另一个进程则需要等待，等上一个请求完后，这个进程才可以执行。而异步则是另一个进程无需等待，无论其他进程状态是否，直接进程执行。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">__test</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">1000</span>);</span><br><span class="line">    &#125;,<span class="number">1000</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">test</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i=<span class="number">0</span>; i&lt;<span class="number">15</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">await</span> <span class="title function_">__test</span>();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;a&#x27;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">test</span>();</span><br></pre></td></tr></table></figure>

<p>首先我们需要注意的是，为了防止异步的出错，需要将 <code>await</code> 放到 <code>try……catch</code> 中，这就让 <code>__test</code> 与 <code>test</code> 两个函数同步起来，这样就会让输出的结果是<code>__test</code> 运行完了，<code>test</code> 还在等待的效果，正因这样，一个正常的运行结果才不会混乱。</p>
<h3 id="堵塞"><a href="#堵塞" class="headerlink" title="堵塞"></a>堵塞</h3><p><img src="https://49812933408852955071488026628034-1301075051.cos.ap-nanjing.myqcloud.com/1614962830_20210306004705386_912103280.png" alt="堵塞与非堵塞"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">var fs = require(&quot;fs&quot;)</span><br><span class="line"></span><br><span class="line">var data = fs.readFileSync(&#x27;hello.text&#x27;)</span><br><span class="line">fs.readFile(&#x27;hello.text&#x27;, (err,data)=&gt; &#123;</span><br><span class="line">    if (err != null) &#123;</span><br><span class="line">        console.log(&#x27;没有此文件&#x27;)</span><br><span class="line">        return</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">console.log(data.toString())</span><br><span class="line">console.log(&quot;程序执行结束!&quot;)</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hello</span><br><span class="line">程序执行结束!</span><br></pre></td></tr></table></figure>
<p>在以上的code中，首先并不存在 hesllo.text 文件，处理回调错误的同时，在node中，<strong>任何回调函数中的地一个参数都为错误对象</strong>在Node官方文档中被标注为<code>错误优先与回调</code>的说法。</p>
<h3 id="非堵塞"><a href="#非堵塞" class="headerlink" title="非堵塞"></a>非堵塞</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">var fs = require(&quot;fs&quot;)</span><br><span class="line"></span><br><span class="line">fs.readFile(&quot;hello.text&quot;, function(err,data) &#123;</span><br><span class="line">    if (err !== null) &#123;</span><br><span class="line">        console.log(err)</span><br><span class="line">        return</span><br><span class="line">    &#125;</span><br><span class="line">    console.log(data.toString())</span><br><span class="line">&#125;)</span><br><span class="line">console.log(&#x27;程序执行完成&#x27;)</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">程序执行完成</span><br><span class="line">hello</span><br></pre></td></tr></table></figure>
<p>本文通过堵塞与非堵塞来进行演示，通常情况下堵塞代码是<code>按照需求一步一步的执行，当一个步骤或没有完成时等待的程序处于排队状态</code>，而非堵塞则是<code>不当一步骤没有执行完毕后面所排队的程序都会依次进行插队</code>即处理更加的效率</p>
<h2 id="事件循环"><a href="#事件循环" class="headerlink" title="事件循环"></a>事件循环</h2><p>Node.js 基本上所以的事件机制都使用类似与设计模式中的观察者模式实现，而观察者模式又是一种行为设计模式，允许你定义一种订阅机制，可在对象事件发生时通知多个观察者的对象或其他对象。</p>
<p>观察者模式会在他本身的状态改变时发出通知，而这种呼叫各类观察者所提供的方式来实现，因此这种模式也被称之为事件处理系统。</p>
<p>在 node.js 中，所提供了 <code>events</code> 库，而他最主要的部分就是创建对象、事件处理、绑定事件以及最后的触发事件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> events = <span class="built_in">require</span>(<span class="string">&#x27;events&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建事件</span></span><br><span class="line"><span class="keyword">var</span> eventEmitter = <span class="keyword">new</span> events.<span class="title class_">EventEmitter</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建事件处理</span></span><br><span class="line"><span class="keyword">var</span> connectHandler = <span class="keyword">function</span> <span class="title function_">connected</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;1.连接成功&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 触发 data_received 事件</span></span><br><span class="line">    eventEmitter.<span class="title function_">emit</span>(<span class="string">&#x27;data_received&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将 connectHandler 绑定 connection</span></span><br><span class="line">eventEmitter.<span class="title function_">on</span>(<span class="string">&#x27;connection&#x27;</span>, connectHandler);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 绑定 &#x27;data_receiver&#x27;  事件</span></span><br><span class="line">eventEmitter.<span class="title function_">on</span>(<span class="string">&#x27;data_received&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;2.接受触发成功\n3.流程执行完毕&quot;</span>)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">eventEmitter.<span class="title function_">emit</span>(<span class="string">&#x27;connection&#x27;</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.连接成功</span><br><span class="line">2.接受触发成功</span><br><span class="line">3.流程执行完毕</span><br></pre></td></tr></table></figure>

<p>上述 code 中 <code>eventEmitter.emit()</code> 用于触发事件，同时他也允许将任意一组参数传递给监听器函数，之后通过<code>eventEmitter.on()</code> 函数来注册监听器 <strong>connection</strong> ，最后通过 <code>data_received</code> 的事件绑定被监听器发现，从而输出整套流程。</p>

	

	

</article>




	<article>
	
		<h1><a href="/2022/04/21/javascript/node/19.Node.js MySQL at Sequelize /">Node.js MySql at Sequelize</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2022-04-21</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-none-link" href="/tags/javascript/" rel="tag">javascript</a> <a class="article__tag-none-link" href="/tags/node-js/" rel="tag">node.js</a>
			</span>
		
	</div>

	

	
		<p>这是通过了 npm 注册中心所发布的 node.js 模块，并由 node.js 驱动，以 JavaScript 编写且并不需要编译，并 100% 遵循了 MIT 许可证，可直接使用 npm 进行安装：</p>
<blockquote>
<p>npm install mysql</p>
<p>在 MySQL 创建一个表和库</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&gt; create databases node</span><br><span class="line">&gt; use node</span><br><span class="line">&gt; create table user (</span><br><span class="line">    -&gt; id int COMMENT &quot;编号&quot;,</span><br><span class="line">    -&gt; name varchar(40) COMMENT &quot;名称&quot;</span><br><span class="line">    -&gt; );</span><br><span class="line">Query OK, 0 rows affected (0.015 sec)</span><br><span class="line"></span><br><span class="line">&gt; INSERT INTO user(id,name) value (&#x27;2&#x27;,&#x27;mysql_user&#x27;);</span><br><span class="line">Query OK, 1 row affected (0.003 sec)</span><br><span class="line"></span><br><span class="line">&gt; INSERT INTO user(id,name) value (&#x27;1&#x27;,&#x27;users_node&#x27;);</span><br><span class="line">Query OK, 1 row affected (0.003 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mysql = <span class="built_in">require</span>(<span class="string">&#x27;mysql&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> connection = mysql.<span class="title function_">createConnection</span>(&#123;</span><br><span class="line">    <span class="attr">host</span>: <span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">    <span class="attr">user</span>: <span class="string">&#x27;root&#x27;</span>,</span><br><span class="line">    <span class="attr">password</span>: <span class="string">&#x27;toor&#x27;</span>,</span><br><span class="line">    <span class="attr">database</span>: <span class="string">&#x27;node&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">connection.<span class="title function_">connect</span>(<span class="keyword">function</span> (<span class="params">err</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;connection is error&#x27;</span> + err.<span class="property">stack</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;threadId:&#x27;</span> + connection.<span class="property">threadId</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> showUser = <span class="string">&quot;SELECT * FROM user;&quot;</span></span><br><span class="line"></span><br><span class="line">connection.<span class="title function_">query</span>(showUser,<span class="keyword">function</span> (<span class="params">err, result</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;show user:&#x27;</span>,result[<span class="number">0</span>])</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">connection.<span class="title function_">end</span>() <span class="comment">// or connection.destory()</span></span><br></pre></td></tr></table></figure>

<h2 id="Sequelize"><a href="#Sequelize" class="headerlink" title="Sequelize"></a>Sequelize</h2><p><img src="https://49812933408852955071488026628034-1301075051.cos.ap-nanjing.myqcloud.com/javascript/node.js/19.node.js%20mysql%20at%20sequelize%20.md/1705434495801.png"></p>
<p>在 node.js 所提供的 <code>mysql</code> 库中，多基于命令形式并通过 <code>connection,query</code> 来实现与数据库的交互，并提供了很多链接方法，如连接池等，而对于开发项目来说这种方式和并不利于项目在生产环境的发布。</p>
<p>因此基于 <code>mysql</code> 所提供的接口，Node 提供了 ORM(Object-Relational Mapping) 来将数据库的表结构来映射到数据库中，这种方式不仅统一了风格还使得与 SQL 的操作变得规范，但核心还是基于 <code>mysql</code> 库。</p>
<p>Sequelize 是一个基于 Promise 的 Node.js ORM，并适用与 Postgres、MySQL、MariaDB、SQLite、Microsoft SQL Server。相对于直接使用原生 <code>mysql</code> 库，直接使用 ORM 格式显得更加的规范和简洁。在 Node.js 中使用 <code>Sequelize</code> 可以直接通过 npm 进行安装，同样的由于 Sequelize 是一个方法约定，因此需要安装 <code>mysql2</code> 作为主要依赖：</p>
<blockquote>
<p>npm install sequelize<br>npm install mysql2</p>
</blockquote>
<p>首先需要创建一个 <code>config.js</code> 文件用于作为配置文件并通过 <code>app.js</code> 进行连接。</p>
<blockquote>
<p>config.js</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">var</span> config = &#123;</span><br><span class="line">    <span class="attr">databases</span>: <span class="string">&#x27;node&#x27;</span>,</span><br><span class="line">    <span class="attr">username</span>: <span class="string">&#x27;root&#x27;</span>,</span><br><span class="line">    <span class="attr">password</span>: <span class="string">&#x27;toor&#x27;</span>,</span><br><span class="line">    <span class="attr">host</span>: <span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">    <span class="attr">port</span>: <span class="string">&#x27;3306&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = config</span><br></pre></td></tr></table></figure>

<blockquote>
<p>app.js</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Sequelize</span> = <span class="built_in">require</span>(<span class="string">&#x27;sequelize&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> mysql = <span class="built_in">require</span>(<span class="string">&#x27;mysql2&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">&#x27;./config&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> sequelize = <span class="keyword">new</span> <span class="title class_">Sequelize</span>(config.<span class="property">databases</span>, config.<span class="property">username</span>, config.<span class="property">password</span>, &#123;</span><br><span class="line">    <span class="attr">host</span>: config.<span class="property">host</span>,</span><br><span class="line">    <span class="attr">dialect</span>: <span class="string">&#x27;mysql&#x27;</span>,</span><br><span class="line">    <span class="attr">pool</span>: &#123;</span><br><span class="line">        <span class="attr">max</span>: <span class="number">5</span>,</span><br><span class="line">        <span class="attr">min</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">idle</span>: <span class="number">30000</span>     <span class="comment">// 连接在被释放之前可以空闲的最长时间（以毫秒为单位）。</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">sequelize</span><br><span class="line">    .<span class="title function_">authenticate</span>()</span><br><span class="line">.<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// Connection has been established successfully</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;连接已成功建立&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// Unable to connect to the database</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;无法连接到数据库&#x27;</span>, err)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="Data-Types"><a href="#Data-Types" class="headerlink" title="Data Types"></a>Data Types</h3><p>Sequelize 的数据类型主要分为 8 种，均代替原生数据库语法以进行统一并适配多种数据库写法，其中 mysql 的对应关系为：</p>
<table>
<thead>
<tr>
<th>Id</th>
<th>Name</th>
<th>MySql</th>
<th>Type</th>
<th>Info</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>DataTypes.STRING</td>
<td>VARCHAR(255)</td>
<td>Strings</td>
<td>长度在 1 到 ~ 字符之间的可变长度的字符串（VARCHAR 字段在创建时必须定义长度，Sequelize 默认的 VARCHAR 为 255）</td>
</tr>
<tr>
<td></td>
<td>DataTypes.STRING(1234)</td>
<td>VARCHAR(1234)</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>DataTypes.SIRING.BINARY</td>
<td>VARCHAR BINARY</td>
<td></td>
<td>BLOB 是“二进制大对象”，用于存储大量二进制数据，例如图像或其他类型的文件。</td>
</tr>
<tr>
<td>2</td>
<td>DataTypes.TEXT</td>
<td>TEXT</td>
<td></td>
<td>最大长度为 65535 个字符的字段。BLOB 是“二进制大对象”，用于存储大量二进制数据，例如图像或其他类型的文件， 定义为 TEXT 的字段也包含大量数据。 两者的区别在于对存储数据的排序和比较在 BLOB 中区分大小写，而在 TEXT 字段中不区分大小写。</td>
</tr>
<tr>
<td></td>
<td>DataTypes.TEXT(‘tiny’)</td>
<td>TINYTEXT</td>
<td></td>
<td>最大长度为 255 个字符的 BLOB 或 TEXT 列</td>
</tr>
<tr>
<td>4</td>
<td>DataTypes.Boolean</td>
<td>TINYINT(1)</td>
<td>Boolean</td>
<td>一个可以有符号或无符号的非常小的整数,如果有符号，则允许的范围是从 -128 到 127。如果是无符号，则允许的范围是从 0 到 255。</td>
</tr>
<tr>
<td>5</td>
<td>DataTypes.INTEGER</td>
<td>INTEGER</td>
<td>Numbers</td>
<td>一个可以有符号或无符号的非常小的整数,如果有符号，则允许的范围是从 -128 到 127。如果是无符号，则允许的范围是从 0 到 255。</td>
</tr>
<tr>
<td></td>
<td>DataTypes.INTEGER.UNSIGNED</td>
<td></td>
<td>Unsigned &amp; Zerofill integers(无符号和零填充整数)</td>
<td>一个可以有符号或无符号的非常小的整数</td>
</tr>
<tr>
<td></td>
<td>DataTypes.ZEROFILL</td>
<td></td>
<td></td>
<td>零填充</td>
</tr>
<tr>
<td></td>
<td>DataTypes.INTEGER.UNSIGNED.ZEROFILL</td>
<td></td>
<td></td>
<td>一个可以有符号或无符号的非常小的整数,且零填充</td>
</tr>
<tr>
<td>6</td>
<td>DataTypes.BIGINT</td>
<td>BIGINT</td>
<td></td>
<td>可以有符号或无符号的大整数。,如果有符号，则允许范围为 -9223372036854775808 到 9223372036854775807。如果没有符号，则允许范围为 0 到 18446744073709551615。</td>
</tr>
<tr>
<td>7</td>
<td>DataType.FLOAT</td>
<td>FLOAT</td>
<td></td>
<td>不能无符号的浮点数,可以定义显示长度 (M) 和小数位数 (D),这不是必需的，默认为 10,2，其中 2 是小数位数，10 是总位数（包括小数）,	对于 FLOAT，十进制精度可以达到 24 位。</td>
</tr>
<tr>
<td>8</td>
<td>DataType.DOUBLE</td>
<td>DOUBLE</td>
<td></td>
<td>不能无符号的双精度浮点数,您可以定义显示长度 (M) 和小数位数 (D),这不是必需的，默认为 16,4，其中 4 是小数位数。 DOUBLE 的十进制精度可以达到 53 位, REAL 是 DOUBLE 的同义词。</td>
</tr>
<tr>
<td>9</td>
<td>DataType.DECIMAL</td>
<td>DECIMAL</td>
<td></td>
<td>无法无符号的解压缩浮点数,在未压缩的十进制中，每个十进制对应一个字节。 需要定义显示长度 (M) 和小数位数 (D)。 NUMERIC 是 DECIMAL 的同义词。</td>
</tr>
<tr>
<td>10</td>
<td>DataType.DATE</td>
<td>DATETIME</td>
<td>Dates</td>
<td>日期和时间的组合。 格式：YYYY-MM-DD hh:mm:ss。 支持的范围是从“1000-01-01 00:00:00”到“9999-12-31 23:59:59”。 在列定义中添加 DEFAULT 和 ON UPDATE 以获取自动初始化并更新到当前日期和时间</td>
</tr>
<tr>
<td>11</td>
<td>DataType.DATEONLY</td>
<td>DATE</td>
<td></td>
<td>一个日期,格式:YYYY-MM-DD。支持的范围从“1000-01-01”到“99999 -12-31”</td>
</tr>
</tbody></table>
<p>sequelize 可通过 <code>sequlize.define</code> 来定义一个模型，之后通过 <code>model.create</code> 来创建模型的数据信息，之后使用 <code>sequlize.sync</code> 同步到数据库中。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Sequelize</span> = <span class="built_in">require</span>(<span class="string">&#x27;sequelize&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> mysql = <span class="built_in">require</span>(<span class="string">&#x27;mysql2&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">&#x27;./config&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> sequelize = <span class="keyword">new</span> <span class="title class_">Sequelize</span>(config.<span class="property">databases</span>, config.<span class="property">username</span>, config.<span class="property">password</span>, &#123;</span><br><span class="line">    <span class="attr">host</span>: config.<span class="property">host</span>,</span><br><span class="line">    <span class="attr">dialect</span>: <span class="string">&#x27;mysql&#x27;</span>,</span><br><span class="line">    <span class="attr">pool</span>: &#123;</span><br><span class="line">        <span class="attr">max</span>: <span class="number">5</span>,</span><br><span class="line">        <span class="attr">min</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">idle</span>: <span class="number">30000</span>     <span class="comment">// 连接在被释放之前可以空闲的最长时间（以毫秒为单位）。</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">sequelize</span><br><span class="line">    .<span class="title function_">authenticate</span>()</span><br><span class="line">.<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// Connection has been established successfully</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;连接已成功建立&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// Unable to connect to the database</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;无法连接到数据库&#x27;</span>, err)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个模型</span></span><br><span class="line"><span class="keyword">var</span> users = sequelize.<span class="title function_">define</span>(<span class="string">&#x27;users&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">id</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title class_">Sequelize</span>.<span class="title function_">STRING</span>(<span class="number">40</span>),</span><br><span class="line">        <span class="attr">primaryKey</span>: <span class="literal">true</span>,        <span class="comment">// 作为主键的字段一部分不可以包含 null value 且一个表中只能有一个</span></span><br><span class="line">        <span class="attr">uniqueKey</span>: <span class="literal">true</span>         <span class="comment">//  唯一键，该表没有两个不同的行或这些列的值相同的记录</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">name</span>: <span class="title class_">Sequelize</span>.<span class="title function_">STRING</span>(<span class="number">90</span>),</span><br><span class="line">    <span class="attr">gender</span>: <span class="title class_">Sequelize</span>.<span class="property">BOOLEAN</span>,</span><br><span class="line">    <span class="attr">createAt</span>: <span class="title class_">Sequelize</span>.<span class="property">BIGINT</span>,</span><br><span class="line">    <span class="attr">updateAt</span>: <span class="title class_">Sequelize</span>.<span class="property">BIGINT</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="attr">timestamps</span>: <span class="literal">false</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 当前时间戳的默认值</span></span><br><span class="line"><span class="keyword">var</span> now = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line"></span><br><span class="line">users.<span class="title function_">create</span>(&#123;</span><br><span class="line">    <span class="attr">id</span>: <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Administrator&#x27;</span>,</span><br><span class="line">    <span class="attr">gender</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">createAt</span>: now,</span><br><span class="line">    <span class="attr">updateAt</span>: now</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params">p</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;created:&#x27;</span> + <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(p))</span><br><span class="line">&#125;).<span class="title function_">catch</span>(<span class="keyword">function</span> (<span class="params">err</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;failed:&#x27;</span> + err)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 同步链接</span></span><br><span class="line">sequelize.<span class="title function_">sync</span>()</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id="CURD"><a href="#CURD" class="headerlink" title="CURD"></a>CURD</h3><h4 id="Select"><a href="#Select" class="headerlink" title="Select"></a>Select</h4><p>Sequelize 提供了两种查询方法，一种分别为 <code>sequlize.fn</code> 以及 <code>WHERE</code> 子句以及更为负责的 <code>Operator</code>，本文我们以最为常用的  <code>WHERE</code> 子句作为演示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Sequelize</span> = <span class="built_in">require</span>(<span class="string">&#x27;sequelize&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> mysql = <span class="built_in">require</span>(<span class="string">&#x27;mysql2&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">&#x27;./config&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> sequelize = <span class="keyword">new</span> <span class="title class_">Sequelize</span>(config.<span class="property">databases</span>, config.<span class="property">username</span>, config.<span class="property">password</span>, &#123;</span><br><span class="line">    <span class="attr">host</span>: config.<span class="property">host</span>,</span><br><span class="line">    <span class="attr">dialect</span>: <span class="string">&#x27;mysql&#x27;</span>,</span><br><span class="line">    <span class="attr">pool</span>: &#123;</span><br><span class="line">        <span class="attr">max</span>: <span class="number">5</span>,</span><br><span class="line">        <span class="attr">min</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">idle</span>: <span class="number">30000</span>     <span class="comment">// 连接在被释放之前可以空闲的最长时间（以毫秒为单位）。</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">sequelize</span><br><span class="line">    .<span class="title function_">authenticate</span>()</span><br><span class="line">.<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// Connection has been established successfully</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;连接已成功建立&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// Unable to connect to the database</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;无法连接到数据库&#x27;</span>, err)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个模型</span></span><br><span class="line"><span class="keyword">var</span> users = sequelize.<span class="title function_">define</span>(<span class="string">&#x27;users&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">id</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title class_">Sequelize</span>.<span class="title function_">STRING</span>(<span class="number">40</span>),</span><br><span class="line">        <span class="attr">primaryKey</span>: <span class="literal">true</span>,        <span class="comment">// 作为主键的字段一部分不可以包含 null value 且一个表中只能有一个</span></span><br><span class="line">        <span class="attr">uniqueKey</span>: <span class="literal">true</span>         <span class="comment">//  唯一键，该表没有两个不同的行或这些列的值相同的记录</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">name</span>: <span class="title class_">Sequelize</span>.<span class="title function_">STRING</span>(<span class="number">90</span>),</span><br><span class="line">    <span class="attr">gender</span>: <span class="title class_">Sequelize</span>.<span class="property">BOOLEAN</span>,</span><br><span class="line">    <span class="attr">createAt</span>: <span class="title class_">Sequelize</span>.<span class="property">BIGINT</span>,</span><br><span class="line">    <span class="attr">updateAt</span>: <span class="title class_">Sequelize</span>.<span class="property">BIGINT</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="attr">timestamps</span>: <span class="literal">false</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    find 1 tousers</span></span><br><span class="line"><span class="comment">    &#123;&quot;id&quot;:&quot;1&quot;,&quot;name&quot;:&quot;Administrator&quot;,&quot;gender&quot;:false,&quot;createAt&quot;:1631729482972,&quot;updateAt&quot;:1631729482972&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">tofind =  <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">var</span> tousers = <span class="keyword">await</span> users.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">        <span class="attr">where</span>: &#123;</span><br><span class="line">            <span class="attr">id</span>: <span class="number">1</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`find <span class="subst">$&#123;tousers.length&#125;</span> tousers`</span>)</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> u <span class="keyword">of</span> tousers) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(u))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">tofind</span>()</span><br></pre></td></tr></table></figure>

<h4 id="Add"><a href="#Add" class="headerlink" title="Add"></a>Add</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Sequelize</span> = <span class="built_in">require</span>(<span class="string">&#x27;sequelize&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> mysql = <span class="built_in">require</span>(<span class="string">&#x27;mysql2&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">&#x27;./config&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> sequelize = <span class="keyword">new</span> <span class="title class_">Sequelize</span>(config.<span class="property">databases</span>, config.<span class="property">username</span>, config.<span class="property">password</span>, &#123;</span><br><span class="line">    <span class="attr">host</span>: config.<span class="property">host</span>,</span><br><span class="line">    <span class="attr">dialect</span>: <span class="string">&#x27;mysql&#x27;</span>,</span><br><span class="line">    <span class="attr">pool</span>: &#123;</span><br><span class="line">        <span class="attr">max</span>: <span class="number">5</span>,</span><br><span class="line">        <span class="attr">min</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">idle</span>: <span class="number">30000</span>     <span class="comment">// 连接在被释放之前可以空闲的最长时间（以毫秒为单位）。</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">sequelize</span><br><span class="line">    .<span class="title function_">authenticate</span>()</span><br><span class="line">.<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// Connection has been established successfully</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;连接已成功建立&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// Unable to connect to the database</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;无法连接到数据库&#x27;</span>, err)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个模型</span></span><br><span class="line"><span class="keyword">var</span> users = sequelize.<span class="title function_">define</span>(<span class="string">&#x27;users&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">id</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title class_">Sequelize</span>.<span class="title function_">STRING</span>(<span class="number">40</span>),</span><br><span class="line">        <span class="attr">primaryKey</span>: <span class="literal">true</span>,        <span class="comment">// 作为主键的字段一部分不可以包含 null value 且一个表中只能有一个</span></span><br><span class="line">        <span class="attr">uniqueKey</span>: <span class="literal">true</span>         <span class="comment">//  唯一键，该表没有两个不同的行或这些列的值相同的记录</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">name</span>: <span class="title class_">Sequelize</span>.<span class="title function_">STRING</span>(<span class="number">90</span>),</span><br><span class="line">    <span class="attr">gender</span>: <span class="title class_">Sequelize</span>.<span class="property">BOOLEAN</span>,</span><br><span class="line">    <span class="attr">createAt</span>: <span class="title class_">Sequelize</span>.<span class="property">BIGINT</span>,</span><br><span class="line">    <span class="attr">updateAt</span>: <span class="title class_">Sequelize</span>.<span class="property">BIGINT</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="attr">timestamps</span>: <span class="literal">false</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> now = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// create:&#123;&quot;id&quot;:2,&quot;name&quot;:&quot;User&quot;,&quot;gender&quot;:true,&quot;createAt&quot;:1631731389401,&quot;updateAt&quot;:1631731389401&#125;</span></span><br><span class="line">tousers = <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">var</span> addusers = <span class="keyword">await</span> users.<span class="title function_">create</span>(&#123;</span><br><span class="line">        <span class="attr">id</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;User&#x27;</span>,</span><br><span class="line">        <span class="attr">gender</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">createAt</span>: now,</span><br><span class="line">        <span class="attr">updateAt</span>: now</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;create:&#x27;</span> + <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(addusers))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">tousers</span>()</span><br></pre></td></tr></table></figure>

<h4 id="Delete"><a href="#Delete" class="headerlink" title="Delete"></a>Delete</h4><p>通过 Sequelize 所提供的方法直接使用 <code>destory()</code> 对查询到的数据进行破坏即可完成删除需求：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Sequelize</span> = <span class="built_in">require</span>(<span class="string">&#x27;sequelize&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> mysql = <span class="built_in">require</span>(<span class="string">&#x27;mysql2&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">&#x27;./config&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> sequelize = <span class="keyword">new</span> <span class="title class_">Sequelize</span>(config.<span class="property">databases</span>, config.<span class="property">username</span>, config.<span class="property">password</span>, &#123;</span><br><span class="line">    <span class="attr">host</span>: config.<span class="property">host</span>,</span><br><span class="line">    <span class="attr">dialect</span>: <span class="string">&#x27;mysql&#x27;</span>,</span><br><span class="line">    <span class="attr">pool</span>: &#123;</span><br><span class="line">        <span class="attr">max</span>: <span class="number">5</span>,</span><br><span class="line">        <span class="attr">min</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">idle</span>: <span class="number">30000</span>     <span class="comment">// 连接在被释放之前可以空闲的最长时间（以毫秒为单位）。</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">sequelize</span><br><span class="line">    .<span class="title function_">authenticate</span>()</span><br><span class="line">.<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// Connection has been established successfully</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;连接已成功建立&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// Unable to connect to the database</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;无法连接到数据库&#x27;</span>, err)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个模型</span></span><br><span class="line"><span class="keyword">var</span> users = sequelize.<span class="title function_">define</span>(<span class="string">&#x27;users&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">id</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title class_">Sequelize</span>.<span class="title function_">STRING</span>(<span class="number">40</span>),</span><br><span class="line">        <span class="attr">primaryKey</span>: <span class="literal">true</span>,        <span class="comment">// 作为主键的字段一部分不可以包含 null value 且一个表中只能有一个</span></span><br><span class="line">        <span class="attr">uniqueKey</span>: <span class="literal">true</span>         <span class="comment">//  唯一键，该表没有两个不同的行或这些列的值相同的记录</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">name</span>: <span class="title class_">Sequelize</span>.<span class="title function_">STRING</span>(<span class="number">90</span>),</span><br><span class="line">    <span class="attr">gender</span>: <span class="title class_">Sequelize</span>.<span class="property">BOOLEAN</span>,</span><br><span class="line">    <span class="attr">createAt</span>: <span class="title class_">Sequelize</span>.<span class="property">BIGINT</span>,</span><br><span class="line">    <span class="attr">updateAt</span>: <span class="title class_">Sequelize</span>.<span class="property">BIGINT</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="attr">timestamps</span>: <span class="literal">false</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">todelete = <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">var</span> delUser = <span class="keyword">await</span> users.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">        <span class="attr">where</span>: &#123;</span><br><span class="line">            <span class="attr">id</span>: <span class="number">2</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> d <span class="keyword">of</span> delUser) &#123;</span><br><span class="line">        <span class="keyword">await</span> d.<span class="title function_">destroy</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">todelete</span>()</span><br></pre></td></tr></table></figure>

<h4 id="Updete"><a href="#Updete" class="headerlink" title="Updete"></a>Updete</h4><p>对于 Sequlize 的修改同样是先进行查询后使用其 <code>Model</code> 进行修改数据，并通过 <code>.save()</code> 进行保存，从而达到更改数据字段的效果</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Sequelize</span> = <span class="built_in">require</span>(<span class="string">&#x27;sequelize&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> mysql = <span class="built_in">require</span>(<span class="string">&#x27;mysql2&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">&#x27;./config&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> sequelize = <span class="keyword">new</span> <span class="title class_">Sequelize</span>(config.<span class="property">databases</span>, config.<span class="property">username</span>, config.<span class="property">password</span>, &#123;</span><br><span class="line">    <span class="attr">host</span>: config.<span class="property">host</span>,</span><br><span class="line">    <span class="attr">dialect</span>: <span class="string">&#x27;mysql&#x27;</span>,</span><br><span class="line">    <span class="attr">pool</span>: &#123;</span><br><span class="line">        <span class="attr">max</span>: <span class="number">5</span>,</span><br><span class="line">        <span class="attr">min</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">idle</span>: <span class="number">30000</span>     <span class="comment">// 连接在被释放之前可以空闲的最长时间（以毫秒为单位）。</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">sequelize</span><br><span class="line">    .<span class="title function_">authenticate</span>()</span><br><span class="line">.<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// Connection has been established successfully</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;连接已成功建立&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// Unable to connect to the database</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;无法连接到数据库&#x27;</span>, err)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个模型</span></span><br><span class="line"><span class="keyword">var</span> users = sequelize.<span class="title function_">define</span>(<span class="string">&#x27;users&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">id</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title class_">Sequelize</span>.<span class="title function_">STRING</span>(<span class="number">40</span>),</span><br><span class="line">        <span class="attr">primaryKey</span>: <span class="literal">true</span>,        <span class="comment">// 作为主键的字段一部分不可以包含 null value 且一个表中只能有一个</span></span><br><span class="line">        <span class="attr">uniqueKey</span>: <span class="literal">true</span>         <span class="comment">//  唯一键，该表没有两个不同的行或这些列的值相同的记录</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">name</span>: <span class="title class_">Sequelize</span>.<span class="title function_">STRING</span>(<span class="number">90</span>),</span><br><span class="line">    <span class="attr">gender</span>: <span class="title class_">Sequelize</span>.<span class="property">BOOLEAN</span>,</span><br><span class="line">    <span class="attr">createAt</span>: <span class="title class_">Sequelize</span>.<span class="property">BIGINT</span>,</span><br><span class="line">    <span class="attr">updateAt</span>: <span class="title class_">Sequelize</span>.<span class="property">BIGINT</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="attr">timestamps</span>: <span class="literal">false</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> now = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    MariaDB [node]&gt; select * from users;</span></span><br><span class="line"><span class="comment">    +----+---------------+--------+---------------+---------------+</span></span><br><span class="line"><span class="comment">    | id | name          | gender | createAt      | updateAt      |</span></span><br><span class="line"><span class="comment">    +----+---------------+--------+---------------+---------------+</span></span><br><span class="line"><span class="comment">    | 1  | Administrator |      1 | 1631729482972 | 1631731823059 |</span></span><br><span class="line"><span class="comment">    +----+---------------+--------+---------------+---------------+</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">toupdete = <span class="title function_">async</span>() =&gt; &#123;</span><br><span class="line">    <span class="keyword">var</span> upAdmin = <span class="keyword">await</span> users.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">        <span class="attr">where</span>: &#123;</span><br><span class="line">            <span class="attr">id</span>: <span class="number">1</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> u <span class="keyword">of</span> upAdmin) &#123;</span><br><span class="line">        u.<span class="property">gender</span> = <span class="literal">true</span></span><br><span class="line">        u.<span class="property">updateAt</span> = now</span><br><span class="line">        <span class="keyword">await</span> u.<span class="title function_">save</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">toupdete</span>()</span><br></pre></td></tr></table></figure>
	

	

</article>




	<article>
	
		<h1><a href="/2022/04/21/javascript/node/18.Node.js Mocha/">Node.js Mocha</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2022-04-21</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-none-link" href="/tags/javascript/" rel="tag">javascript</a> <a class="article__tag-none-link" href="/tags/node-js/" rel="tag">node.js</a>
			</span>
		
	</div>

	

	
		<p>Node.js 是一个面向服务端的 JavaScript，为了能够有效的持续保证代码质量，通过单元测试(Unit Testing) 来进行正确性校验的测试工作，Node.js 也有 <code>Mocha</code> 和 <code>Should</code> 以及 <code>SuperTest</code> 模块用于。</p>
<p>单元测试主要的目的就是这对程序模块中进行正确性检验测试工作，而程序单元是应用的最小测试部件。</p>
<blockquote>
<p>一个单元就是单个程序或者函数、过程等，而对于面向对象编程，则最小单元就是方法和超类、子类中的方法。</p>
</blockquote>
<p>在此之前，JavaScript 主要用于在前端，自从 node.js 起始以来 JavaScript 开始面向客户端以及跨平台的使用，这时单元测试就显得尤为重要。we</p>
<h2 id="BDD-or-TDD"><a href="#BDD-or-TDD" class="headerlink" title="BDD or TDD"></a>BDD or TDD</h2><h3 id="TDD"><a href="#TDD" class="headerlink" title="TDD"></a>TDD</h3><p><img src="https://49812933408852955071488026628034-1301075051.cos.ap-nanjing.myqcloud.com/javascript/node.js/18.node.js%20mocha.md/3274515149185.png"></p>
<p>单元测试主要分为 BDD（Behavior-Driven Development, 行为驱动开发），以及TDD（Test-Driven Development，测试驱动开发）</p>
<p>其中 TDD 原理是指在开发功能之前先编写单元测试的用例代码，TDD 也是 极限编程（Extreme programming,xp）的实现.</p>
<blockquote>
<p>极限编程是软件工程方法学中敏捷软件开发的一种，他更倾向与适应性以及可预测性，即在任何阶段去适应变化。</p>
</blockquote>
<h3 id="BDD"><a href="#BDD" class="headerlink" title="BDD"></a>BDD</h3><p>行为驱动开发（Behavior-driven development，BDD）是敏捷开发技术之一，他也是极限开发（Extreme Programming）鼓励软件项目的开发者和非技术人员和以及商业参与者之间的协作并保证最后的 QA（Quality Assurance）</p>
<p>这主要是出于 2009 年 Dan North 对 BDD 给出的定义：</p>
<blockquote>
<p>BDD是第二代的、由外及内的、基于拉(pull)的、多方利益相关者的(stakeholder)、多种可扩展的、高自动化的敏捷方法。它描述了一个交互循环，可以具有带有良好定义的输出（即工作中交付的结果）：已测试过的软件。</p>
</blockquote>
<h2 id="Mocha"><a href="#Mocha" class="headerlink" title="Mocha"></a>Mocha</h2><p><img src="https://49812933408852955071488026628034-1301075051.cos.ap-nanjing.myqcloud.com/javascript/node.js/18.node.js%20mocha.md/5488758059186.png"></p>
<p>Mocha 主要是用于 JavaScript 的测试框架，使得异步测试变得简单且 “有趣”。他最为重要的是 Mocha 测试是连续的，在正确的测试条件中遇到未捕获的异常时将会给出灵活且准确的报告。</p>
<h3 id="Assert"><a href="#Assert" class="headerlink" title="Assert"></a>Assert</h3><p>断言（Assertion）是单元测试中用来保证最小单元是否正常的测试方法之一，目的是验证开发者所预期的效果，当程序运行到断言位置时会返回布尔值，其中返回为真则表示正常，否则将会终止运行并给出错误消息。</p>
<p>是 Mocha 中的核心方法之一，这由 Node.js 官方库所进行提供，并在 Node.js 的 API 中定义了多种检测方法供开发者使用，将方法与 Mocha 进行配合来以低成本的方式进行单元测试。</p>
<table>
<thead>
<tr>
<th>Id</th>
<th>Name</th>
<th>Info</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>assert(value,[message])</td>
<td>当 value 为 false 时终止运行并返回错误</td>
</tr>
<tr>
<td></td>
<td>assert.ok(value,[message])</td>
<td><code>assert</code> 的别名</td>
</tr>
<tr>
<td>2</td>
<td>assert.ifError(value)</td>
<td>如果 value 不是 <code>null</code> 或 <code>undefined</code> 则报错并抛出 value</td>
</tr>
<tr>
<td>3</td>
<td>assert.match(value,regExp)</td>
<td>value 是否匹配正则表达式</td>
</tr>
<tr>
<td>4</td>
<td>assert.notEqual(actual,expected[,message])</td>
<td>严格匹配 actual !&#x3D; expected 则正常运行，否则抛出异常错误</td>
</tr>
<tr>
<td></td>
<td>assert.notStrictEqual(actual,expected[,message])</td>
<td><code>assert.notEqual</code> 的别名</td>
</tr>
<tr>
<td></td>
<td>assert.notDeepStricEqual(actual,expect[,message])</td>
<td>深度匹配 actual !&#x3D; expected 是否相等，<code>assert.notEqual</code> 的别名</td>
</tr>
<tr>
<td>5</td>
<td>assert.equal(actual,expected[,message])</td>
<td>严格匹配 actual 与 expected 是否相等</td>
</tr>
<tr>
<td></td>
<td>assert.strictEqual(actual,expected[,message])</td>
<td>Euqal 别名</td>
</tr>
<tr>
<td></td>
<td>assert.deepEqual(actual,expected[,message])</td>
<td>Equal 别名</td>
</tr>
<tr>
<td></td>
<td>assert.deepStrictEqual(actual,expected[,message])</td>
<td>Equal 别名</td>
</tr>
<tr>
<td>6</td>
<td>assert.throws(function[,error][,message])</td>
<td>判断代码快是否抛出异常并自定义异常错误</td>
</tr>
<tr>
<td></td>
<td>assert.doesNotThrow(function[,error][,message])</td>
<td>捕获错误然后重新抛出错误</td>
</tr>
</tbody></table>
<h4 id="assert-or-assert-ok"><a href="#assert-or-assert-ok" class="headerlink" title="assert or assert.ok"></a>assert or assert.ok</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> assert = <span class="built_in">require</span>(<span class="string">&#x27;assert&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    AssertionError [ERR_ASSERTION]: 当 assert 为 false 时终止运行并返回错误</span></span><br><span class="line"><span class="comment">        at Object.&lt;anonymous&gt; (/home/kunlun/Development/Web/Demo/node/test.js:3:8)</span></span><br><span class="line"><span class="comment">        at Module._compile (internal/modules/cjs/loader.js:1072:14)</span></span><br><span class="line"><span class="comment">        at Object.Module._extensions..js (internal/modules/cjs/loader.js:1101:10)</span></span><br><span class="line"><span class="comment">        at Module.load (internal/modules/cjs/loader.js:937:32)</span></span><br><span class="line"><span class="comment">        at Function.Module._load (internal/modules/cjs/loader.js:778:12)</span></span><br><span class="line"><span class="comment">        at Function.executeUserEntryPoint [as runMain] (internal/modules/run_main.js:76:12)</span></span><br><span class="line"><span class="comment">        at internal/main/run_main_module.js:17:47 &#123;</span></span><br><span class="line"><span class="comment">      generatedMessage: false,</span></span><br><span class="line"><span class="comment">      code: &#x27;ERR_ASSERTION&#x27;,</span></span><br><span class="line"><span class="comment">      actual: false,</span></span><br><span class="line"><span class="comment">      expected: true,</span></span><br><span class="line"><span class="comment">      operator: &#x27;==&#x27;</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//assert.ok(false,&#x27;当 assert 为 false 时终止运行并返回错误&#x27;) or</span></span><br><span class="line"><span class="title function_">assert</span>(<span class="literal">false</span>,<span class="string">&#x27;当 assert 为 false 时终止运行并返回错误&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="assert-ifError"><a href="#assert-ifError" class="headerlink" title="assert.ifError()"></a>assert.ifError()</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> assert = <span class="built_in">require</span>(<span class="string">&#x27;assert&#x27;</span>)</span><br><span class="line"></span><br><span class="line">assert.<span class="title function_">ifError</span>(<span class="literal">null</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    AssertionError [ERR_ASSERTION]: ifError got unwanted exception: &#x27;Error&#x27;</span></span><br><span class="line"><span class="comment">        at Object.&lt;anonymous&gt; (/home/kunlun/Development/Web/Demo/node/test.js:4:8)</span></span><br><span class="line"><span class="comment">        at Module._compile (internal/modules/cjs/loader.js:1072:14)</span></span><br><span class="line"><span class="comment">        at Object.Module._extensions..js (internal/modules/cjs/loader.js:1101:10)</span></span><br><span class="line"><span class="comment">        at Module.load (internal/modules/cjs/loader.js:937:32)</span></span><br><span class="line"><span class="comment">        at Function.Module._load (internal/modules/cjs/loader.js:778:12)</span></span><br><span class="line"><span class="comment">        at Function.executeUserEntryPoint [as runMain] (internal/modules/run_main.js:76:12)</span></span><br><span class="line"><span class="comment">        at internal/main/run_main_module.js:17:47 &#123;</span></span><br><span class="line"><span class="comment">      generatedMessage: false,</span></span><br><span class="line"><span class="comment">      code: &#x27;ERR_ASSERTION&#x27;,</span></span><br><span class="line"><span class="comment">      actual: &#x27;Error&#x27;,</span></span><br><span class="line"><span class="comment">      expected: null,</span></span><br><span class="line"><span class="comment">      operator: &#x27;ifError&#x27;</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">assert.<span class="title function_">ifError</span>(<span class="string">&#x27;Error&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="assert-match"><a href="#assert-match" class="headerlink" title="assert.match"></a>assert.match</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> assert = <span class="built_in">require</span>(<span class="string">&#x27;assert&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ok</span></span><br><span class="line">assert.<span class="title function_">match</span>(<span class="string">&#x27;hey,assert!&#x27;</span>, <span class="regexp">/[a-z]/</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    AssertionError [ERR_ASSERTION]: The input did not match the regular expression /[a-z]/. Input:</span></span><br><span class="line"><span class="comment">    &#x27;2021&#x27;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">assert.<span class="title function_">match</span>(<span class="string">&#x27;2021&#x27;</span>, <span class="regexp">/[a-z]/</span>)</span><br></pre></td></tr></table></figure>

<h4 id="assert-notEqual-or-assert-notStricteEqueal-at-assert-notDeepStrictEuqal"><a href="#assert-notEqual-or-assert-notStricteEqueal-at-assert-notDeepStrictEuqal" class="headerlink" title="assert.notEqual or assert.notStricteEqueal at assert.notDeepStrictEuqal"></a>assert.notEqual or assert.notStricteEqueal at assert.notDeepStrictEuqal</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> assert = <span class="built_in">require</span>(<span class="string">&#x27;assert&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ok</span></span><br><span class="line">assert.<span class="title function_">notEqual</span>(<span class="number">1</span>,<span class="number">2</span>,<span class="string">&#x27;ok&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// AssertionError [ERR_ASSERTION]: This is !=</span></span><br><span class="line">assert.<span class="title function_">notStrictEqual</span>(<span class="number">1</span>,<span class="number">1</span>,<span class="string">&#x27;This is !=&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ok</span></span><br><span class="line">assert.<span class="title function_">notDeepStrictEqual</span>(<span class="number">1</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;This is ok!&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="assert-equal-at-assert-strictEqual-or-deepEqual-and-deepStrictEqual"><a href="#assert-equal-at-assert-strictEqual-or-deepEqual-and-deepStrictEqual" class="headerlink" title="assert.equal at assert.strictEqual() or deepEqual() and deepStrictEqual()"></a>assert.equal at assert.strictEqual() or deepEqual() and deepStrictEqual()</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ok</span></span><br><span class="line">assert.<span class="title function_">equal</span>(<span class="number">1</span>,<span class="number">1</span>,<span class="string">&#x27;This is ok&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ok</span></span><br><span class="line">assert.<span class="title function_">strictEqual</span>(<span class="number">1</span>,<span class="number">1</span>,<span class="string">&#x27;This is ok&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ok</span></span><br><span class="line">assert.<span class="title function_">deepEqual</span>(<span class="number">1</span>,<span class="number">1</span>,<span class="string">&#x27;This is ok&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// AssertionError [ERR_ASSERTION]: This is error</span></span><br><span class="line">assert.<span class="title function_">deepStrictEqual</span>(<span class="number">1</span>,<span class="number">2</span>,<span class="string">&#x27;This is error&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="asset-throws"><a href="#asset-throws" class="headerlink" title="asset.throws()"></a>asset.throws()</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> assert = <span class="built_in">require</span>(<span class="string">&#x27;assert&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    AssertionError [ERR_ASSERTION]: Throw an exception error</span></span><br><span class="line"><span class="comment">        at Object.&lt;anonymous&gt; (/home/kunlun/Development/Web/Demo/node/test.js:4:8)</span></span><br><span class="line"><span class="comment">        at Module._compile (internal/modules/cjs/loader.js:1072:14)</span></span><br><span class="line"><span class="comment">        at Object.Module._extensions..js (internal/modules/cjs/loader.js:1101:10)</span></span><br><span class="line"><span class="comment">        at Module.load (internal/modules/cjs/loader.js:937:32)</span></span><br><span class="line"><span class="comment">        at Function.Module._load (internal/modules/cjs/loader.js:778:12)</span></span><br><span class="line"><span class="comment">        at Function.executeUserEntryPoint [as runMain] (internal/modules/run_main.js:76:12)</span></span><br><span class="line"><span class="comment">        at internal/main/run_main_module.js:17:47 &#123;</span></span><br><span class="line"><span class="comment">      generatedMessage: false,</span></span><br><span class="line"><span class="comment">      code: &#x27;ERR_ASSERTION&#x27;,</span></span><br><span class="line"><span class="comment">      actual: Error: Error value</span></span><br><span class="line"><span class="comment">          at assert.throws.code (/home/kunlun/Development/Web/Demo/node/test.js:6:15)</span></span><br><span class="line"><span class="comment">          at getActual (assert.js:765:5)</span></span><br><span class="line"><span class="comment">          at Function.throws (assert.js:911:24)</span></span><br><span class="line"><span class="comment">          at Object.&lt;anonymous&gt; (/home/kunlun/Development/Web/Demo/node/test.js:4:8)</span></span><br><span class="line"><span class="comment">          at Module._compile (internal/modules/cjs/loader.js:1072:14)</span></span><br><span class="line"><span class="comment">          at Object.Module._extensions..js (internal/modules/cjs/loader.js:1101:10)</span></span><br><span class="line"><span class="comment">          at Module.load (internal/modules/cjs/loader.js:937:32)</span></span><br><span class="line"><span class="comment">          at Function.Module._load (internal/modules/cjs/loader.js:778:12)</span></span><br><span class="line"><span class="comment">          at Function.executeUserEntryPoint [as runMain] (internal/modules/run_main.js:76:12)</span></span><br><span class="line"><span class="comment">          at internal/main/run_main_module.js:17:47,</span></span><br><span class="line"><span class="comment">      expected: &#123;</span></span><br><span class="line"><span class="comment">        code: 404,</span></span><br><span class="line"><span class="comment">        name: &#x27;TypeError&#x27;,</span></span><br><span class="line"><span class="comment">        message: &#x27;Error value&#x27;,</span></span><br><span class="line"><span class="comment">        info: &#123; nested: true, data: &#x27;nested ok&#x27; &#125;</span></span><br><span class="line"><span class="comment">      &#125;,</span></span><br><span class="line"><span class="comment">      operator: &#x27;throws&#x27;</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">assert.<span class="title function_">throws</span>(</span><br><span class="line">    <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Error value&#x27;</span>)</span><br><span class="line">    &#125;,&#123;</span><br><span class="line">        <span class="attr">code</span>: <span class="number">404</span>,</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;TypeError&#x27;</span>,</span><br><span class="line">        <span class="attr">message</span>: <span class="string">&#x27;Error value&#x27;</span>,</span><br><span class="line">        <span class="attr">info</span>: &#123;</span><br><span class="line">            <span class="attr">nested</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">data</span>: <span class="string">&quot;nested ok&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,<span class="string">&#x27;Throw an exception error&#x27;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h4 id="assert-doesNotThrow"><a href="#assert-doesNotThrow" class="headerlink" title="assert.doesNotThrow()"></a>assert.doesNotThrow()</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> assert = <span class="built_in">require</span>(<span class="string">&#x27;assert&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// AssertionError [ERR_ASSERTION]: Got unwanted exception: This will print erroras</span></span><br><span class="line">assert.<span class="title function_">doesNotThrow</span>(</span><br><span class="line">    <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(<span class="string">&#x27;Error value&#x27;</span>)</span><br><span class="line">    &#125;,<span class="string">&#x27;This will print error&#x27;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h3 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h3><h4 id="app-js"><a href="#app-js" class="headerlink" title="app.js"></a>app.js</h4><p>首先我们需要通过一个计算的函数来进行添加 <code>tests.js</code> 测试用例，并最终通过测试用例进行检测代码是否通过测试：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exports</span>.<span class="property">add</span> = <span class="keyword">function</span> (<span class="params">i,j</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> i + j</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">mul</span> = <span class="keyword">function</span> (<span class="params">i,j</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> i * j</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h4 id="appTests-js"><a href="#appTests-js" class="headerlink" title="appTests.js"></a>appTests.js</h4><p>在 Mocha 中，<code>describe</code> 方法的主要作用就是添加一段描述而 <code>it</code> 则是向测试回调方法中添加一个参数即 <code>done</code>，Mocha 将会等待调用此函数以完成测试，并接受 <code>Error</code> 实例。</p>
<blockquote>
<p>需要注意的 <code>it()</code> 任何东西都是无效使用并引发错误，这通常会导致测试失败</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> assert = <span class="built_in">require</span>(<span class="string">&#x27;assert&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> calc = <span class="built_in">require</span>(<span class="string">&#x27;./app&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">$ npm test</span></span><br><span class="line"><span class="comment">&gt; node@1.0.0 test /home/kunlun/Development/Web/Demo/node</span></span><br><span class="line"><span class="comment">&gt; mocha work.js</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  Calculator Tests</span></span><br><span class="line"><span class="comment">    Addition Tests</span></span><br><span class="line"><span class="comment">      ✔ returns 1 + 1 = 2</span></span><br><span class="line"><span class="comment">      ✔ should returns 1 + -1 = 0</span></span><br><span class="line"><span class="comment">      ✔ returns 0 * 4 = 4</span></span><br><span class="line"><span class="comment">      Multiplication Tests</span></span><br><span class="line"><span class="comment">        ✔ returns 2 * 2 = 4</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">describe</span>(<span class="string">&#x27;Calculator Tests&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title function_">describe</span>(<span class="string">&#x27;Addition Tests&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title function_">it</span>(<span class="string">&#x27;returns 1 + 1 = 2&#x27;</span>, <span class="keyword">function</span> (<span class="params">done</span>) &#123;</span><br><span class="line">            assert.<span class="title function_">equal</span>(calc.<span class="title function_">add</span>(<span class="number">1</span>,<span class="number">1</span>),<span class="number">2</span>)</span><br><span class="line">            <span class="title function_">done</span>();</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="title function_">it</span>(<span class="string">&#x27;should returns 1 + -1 = 0&#x27;</span>, <span class="keyword">function</span> (<span class="params">done</span>) &#123;</span><br><span class="line">            assert.<span class="title function_">equal</span>(calc.<span class="title function_">add</span>(<span class="number">1</span>,-<span class="number">1</span>),<span class="number">0</span>)</span><br><span class="line">            <span class="title function_">done</span>()</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="title function_">describe</span>(<span class="string">&#x27;Multiplication Tests&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="title function_">it</span>(<span class="string">&#x27;returns 2 * 2 = 4&#x27;</span>, <span class="keyword">function</span> (<span class="params">done</span>) &#123;</span><br><span class="line">                assert.<span class="title function_">equal</span>(calc.<span class="title function_">mul</span>(<span class="number">2</span>,<span class="number">2</span>),<span class="number">4</span>)</span><br><span class="line">                <span class="title function_">done</span>()</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="title function_">it</span>(<span class="string">&#x27;returns 0 * 4 = 4&#x27;</span>, <span class="keyword">function</span> (<span class="params">done</span>) &#123;</span><br><span class="line">            assert.<span class="title function_">equal</span>(calc.<span class="title function_">mul</span>(<span class="number">2</span>,<span class="number">2</span>),<span class="number">4</span>)</span><br><span class="line">            <span class="title function_">done</span>()</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>在上述 code 中，我们使用了 node.js 那种的 <code>assert</code> 模块，通常如果抛出一个 Error 就被执行工作，并向 <code>app.js</code> 添加 <code>i</code> 和 <code>j</code> 参数值。</p>
<h2 id="istanbul"><a href="#istanbul" class="headerlink" title="istanbul"></a>istanbul</h2><p>istanbul 是一个使用行计数器检测 ES5、ES6 的 JavaScript 代码，来跟踪单元测试和代码的执行情况（也就是单元测试对代码的覆盖率），可直接根据 mocha 来添加 istanbul：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev nyc</span><br></pre></td></tr></table></figure>

<p>之后在 <code>package.json</code> 中将 <code>nyc</code> 放入 <code>test</code> 之前即可：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;test&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nyc mocha work.js&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure>


<p>通过 <code>npm test</code> 运行后可以看到 instanbul 所提供的单元测试覆盖率检测：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">  Calculator Tests</span><br><span class="line">    Addition Tests</span><br><span class="line">      ✔ returns 1 + 1 = 2</span><br><span class="line">      ✔ should returns 1 + -1 = 0</span><br><span class="line">      ✔ returns 0 * 4 = 4</span><br><span class="line">      Multiplication Tests</span><br><span class="line">        ✔ returns 2 * 2 = 4</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  4 passing (5ms)</span><br><span class="line"></span><br><span class="line">----------|---------|----------|---------|---------|-------------------</span><br><span class="line">File      | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s </span><br><span class="line">----------|---------|----------|---------|---------|-------------------</span><br><span class="line">All files |     100 |      100 |     100 |     100 |                   </span><br><span class="line"> app.js   |     100 |      100 |     100 |     100 |                   </span><br><span class="line"> work.js  |     100 |      100 |     100 |     100 |                   </span><br><span class="line">----------|---------|----------|---------|---------|-------------------</span><br></pre></td></tr></table></figure>
	

	

</article>




	<article>
	
		<h1><a href="/2022/04/21/javascript/node/17.Node.js 错误处理/">Node.js error</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2022-04-21</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-none-link" href="/tags/javascript/" rel="tag">javascript</a> <a class="article__tag-none-link" href="/tags/node-js/" rel="tag">node.js</a>
			</span>
		
	</div>

	

	
		<p>对于错误的处理主要分为代码的错误和系统本身的问题其中包含内存不足或者打开文件过多、系统配置以及网络和远程服务问题，错误的处理需要加入到没有任何错误处理的程序中。</p>
<p>需要考虑到任何会导致失败所可能产生的结果，错误是一种 <code>Error</code> 的实例，从而抛出一个异常，或者通过 <code>callback</code> 进行无抛异常进而通过异常。</p>
<h2 id="Error-function"><a href="#Error-function" class="headerlink" title="Error function"></a>Error function</h2><table>
<thead>
<tr>
<th>Id</th>
<th>Name</th>
<th>Info</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>throw</td>
<td>以同步的方式传递异常，如果调用者通过 <code>try/catch</code> 异常就会被捕获，如果异常未被捕获则会被 <code>domains</code> 或者进程级的 <code>uncaughtExceptin</code> 捕获</td>
</tr>
<tr>
<td>2</td>
<td>callback</td>
<td>是基础的异步传递方式，用户传进来一个函数(callback) 之后当某个异步操作完成后调用 <code>callback</code> ，在正常情况下 <code>callback(err,result)</code> 的形式被调用，这两个参数自然有一个是非空的，这取决与成功还是失败</td>
</tr>
<tr>
<td>3</td>
<td>EventEmitter</td>
<td>最为主要的是 EventEmitter 是没有 <code>callback</code> 而是返回 <code>EventEmitter</code> 对象。</td>
</tr>
<tr>
<td></td>
<td></td>
<td><code>error</code> 当做一个可能会产生多个错误或多个结果的复杂操作时所返回的错误</td>
</tr>
<tr>
<td></td>
<td></td>
<td><code>row</code> callback 所返回的 <code>EventEmitter</code> 的结果将会触发一个 <code>row</code> 事件</td>
</tr>
<tr>
<td></td>
<td></td>
<td><code>end</code> 当 <code>row</code> 事件被触发的时候将会触发或返回一个 <code>end</code> 事件</td>
</tr>
</tbody></table>
<p>通常 <code>callback</code> 和 <code>EventEmitter</code> 将会归到同一个异步的错误传递，使用 <code>rhrow</code>和<code>callback</code> 以及 <code>EventEmitter</code> 取决与 <strong>该一场是操作失败还是系统所造成的 BUG</strong> 以及 <strong>该函数是同步和异步的</strong>。</p>
<p>其中即可以同步传递错误并抛出，又可以传递错误（通过传给一个回调函数或者触发 <code>EventEmitter</code> 的 <code>error</code> 事件）。或者选择回调函数 <code>try.catch</code> 两种具体取决与异常的传递。</p>
<h3 id="同步的异常捕获-try-x2F-catch"><a href="#同步的异常捕获-try-x2F-catch" class="headerlink" title="同步的异常捕获 (try&#x2F;catch)"></a>同步的异常捕获 (try&#x2F;catch)</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    捕获异常</span></span><br><span class="line"><span class="comment">    Error: error!!</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;error!!&#x27;</span>)</span><br><span class="line">&#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;捕获异常&#x27;</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(e)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="process-uncaughtException"><a href="#process-uncaughtException" class="headerlink" title="process uncaughtException"></a>process uncaughtException</h4><p>假设 <code>try/catch</code> 未被捕获，则可以通过 process 所提供的 <code>uncaughtException</code> 事件来监听未捕获的异常：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Error info&#x27;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;error is:&#x27;</span>, e.<span class="property">message</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">process.<span class="title function_">on</span>(<span class="string">&#x27;uncaughtException&#x27;</span>, <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;process error is:&#x27;</span>, e.<span class="property">message</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="events"><a href="#events" class="headerlink" title="events"></a>events</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> events = <span class="built_in">require</span>(<span class="string">&#x27;events&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    error is code</span></span><br><span class="line"><span class="comment">    Error: Code is error</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> emitter = <span class="keyword">new</span> events.<span class="title class_">EventEmitter</span>()</span><br><span class="line"></span><br><span class="line">emitter.<span class="title function_">addListener</span>(<span class="string">&#x27;error&#x27;</span>, <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;error is code&#x27;</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(e)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">emitter.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, <span class="keyword">new</span> <span class="title class_">Error</span>((<span class="string">&#x27;Code is error&#x27;</span>)))</span><br></pre></td></tr></table></figure>

<p>通过 <code>events</code> 库所提供的监听器来监听 <code>error</code> 的事件以及使用 <code>emitter.emit</code> 来发送错误并回调错误信息。</p>
<h4 id="callback"><a href="#callback" class="headerlink" title="callback"></a>callback</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    Error this process</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">fs.<span class="title function_">mkdir</span>(<span class="string">&#x27;/dir&#x27;</span>,<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (e) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Error this process&quot;</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;create dir&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="Promise"><a href="#Promise" class="headerlink" title="Promise"></a>Promise</h4><p>promise 的操作返回 promise 其主要是在异步中操作完成后或失败所最终完成的结果值，他提供了两个值 <code>resolve</code> 以及 <code>reject</code>，<code>reject</code> 方法返回一个带有拒绝原因的 Promise 对象，而 <code>resolve</code> 则是返回一个指定值解析后的 promise 对象。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    This is error</span></span><br><span class="line"><span class="comment">    Error: error</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;error&#x27;</span>)</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 逻辑处理</span></span><br><span class="line">&#125;).<span class="title function_">catch</span>(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;This is error&#x27;</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(e)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="Async-x2F-Await"><a href="#Async-x2F-Await" class="headerlink" title="Async&#x2F;Await"></a>Async&#x2F;Await</h4><p>Async&#x2F;Await 是基于 Promise 的更简洁的风格所编写，其中 <code>async</code> 韩式使用 async 关键字声明函数，从而避免了显式配置承诺链的作用。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> func = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;error&#x27;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    This is error</span></span><br><span class="line"><span class="comment">    Error: error</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">funAsync</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">await</span> <span class="title function_">func</span>()</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;This is error&#x27;</span>)</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(e)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">funAsync</span>()</span><br></pre></td></tr></table></figure>

<h3 id="domain"><a href="#domain" class="headerlink" title="domain"></a>domain</h3><p>domain 模块可以处理多个不同 IO 的操作作为一个组，并注册到事件和回调到 domain，当发生一个错误事件或错误时，<code>domain</code> 对象将会被通知，从而不会丢失上下文环境，也不会导致程序立即退出。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> doman = <span class="built_in">require</span>(<span class="string">&#x27;domain&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> d = doman.<span class="title function_">create</span>()</span><br><span class="line"></span><br><span class="line">d.<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;err&#x27;</span>,err.<span class="property">message</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(needSend.<span class="property">message</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> needSend = &#123;<span class="attr">message</span>: <span class="string">&#x27;To error data&#x27;</span>&#125;</span><br><span class="line">d.<span class="title function_">add</span>(needSend)</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">excute</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Error info&#x27;</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;error is&#x27;</span>, e.<span class="property">message</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">d.<span class="title function_">run</span>(excute)</span><br></pre></td></tr></table></figure>

	

	

</article>




	<article>
	
		<h1><a href="/2022/04/21/javascript/node/16.Node.js 多线程/">Node.js 多线程</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2022-04-21</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-none-link" href="/tags/javascript/" rel="tag">javascript</a> <a class="article__tag-none-link" href="/tags/node-js/" rel="tag">node.js</a>
			</span>
		
	</div>

	

	
		<h2 id="进程-线程-协程"><a href="#进程-线程-协程" class="headerlink" title="进程\线程\协程"></a>进程\线程\协程</h2><h3 id="进程"><a href="#进程" class="headerlink" title="进程"></a>进程</h3><p>在此之前，我们需要了解到进程、协程、以及并发、并行的概念。首先进程(process) 是指计算机中已运行的程序，进程的出现是指为了更好的利用 CPU 资源使得并发的可能性。</p>
<p>假设有两个任务，A 和 B ，A 遇到 I&#x2F;O 操作的时候 CPU 就会默默的等待任务 A 读取完成再去执行 B 任务，这样救护导致 CPU 资源造成了浪费。</p>
<p>因此就会有人在想，将任务 A 读取数据时让 B 任务执行，当任务 B 读取完整数据后又切换到任务 A 执行。</p>
<p>这时候因为 “切换” 的问题，需要涉及到保存和状态回复，以及 A 与 B 的系统资源不一，就需要有一个东西记录 A 和 B 分别需要什么样的资源和如何识别 A 和 B 等，因此进程就被创建出来</p>
<p>通过进程可以分配资系统资源、标识任务，以及分配 CPU 执行进程为调度，进程的状态记录、恢复。其中切换又被称之为 “上下文切换”，其中进程是指系统分配的最小单位，进程所占用的资源共有地址空间，全局变量、文件描述符、各种硬件资源等。</p>
<h3 id="线程"><a href="#线程" class="headerlink" title="线程"></a>线程</h3><p>线程(tread) 是操作系统能够进行运算调度的最小单位，大部分情况下他被包含在进程中，他的出现主要是为了降低上下文的消耗以提高系统的并发性，并解决一个进程只能完成一件任务的问题，使得进程内并发成为可能。</p>
<p>在之前进程处理任务的时候，当只有一个进程的时候只能干一件事，而假设有了多个进程，每个进程只能负责一个任务，A 负责接收一个信息，B 负责显示信息，C 负责保存信息，这里的各个进程之间就会涉及到进程通信的问题，假设共同维护一个文本内容或切换，则会造成性能上的消耗。</p>
<p>此时线程主要的作用就是使得 A、B、C 共享资源，并参与 CPU 的调度，同时进程也是线程的容器，当一个现成挂掉则全部线程也会失效。</p>
<h3 id="协程"><a href="#协程" class="headerlink" title="协程"></a>协程</h3><p>协程(coroutine) 通过线程中实现调度以避免陷入内核级别的上下文切换所造成的性能损失，进而突破了线程在 I&#x2F;O 上的性能瓶颈。</p>
<p>当涉及到较大的并发连接时，以线程作为处理单元（系统调度开销开始过大），当连接数过多时则需要大量的线程，可能部分的线程处于 ready(准备) 状态，系统会不断的进行上下文切换。</p>
<p>而瓶颈就是上下文切换，在线程中自己实现调度从而不陷入内核级的上下文切换，这也是协程的主要作用。</p>
<h2 id="并发与并行"><a href="#并发与并行" class="headerlink" title="并发与并行"></a>并发与并行</h2><h3 id="并发"><a href="#并发" class="headerlink" title="并发"></a>并发</h3><p>并发计算(Concurrent computing) 是一种程序的计算形式，通常是指有两个以上工作单位的计算在同时运行，这也是多核的前提，但单线程或单核是很难利用多进程达到并行状态。</p>
<h3 id="并行"><a href="#并行" class="headerlink" title="并行"></a>并行</h3><p>并行(parallel computing) 一般是指许多工作任务同时进行的计算模式，可以将计算的过程分为许多小部分，之后以并发来解决。</p>
<p>总结来说并发是指可以同时出发，而并行则是指一起执行，你可以理解为一边一吃饭一边玩游戏是并发。而你将外卖摆在桌上和游戏，你先吃饭再打游戏是并发。</p>
<h2 id="JavaScript-单线程的异步和非阻塞"><a href="#JavaScript-单线程的异步和非阻塞" class="headerlink" title="JavaScript 单线程的异步和非阻塞"></a>JavaScript 单线程的异步和非阻塞</h2><p><img src="https://49812933408852955071488026628034-1301075051.cos.ap-nanjing.myqcloud.com/javascript/node.js/16.node.js%20%E5%A4%9A%E7%BA%BF%E7%A8%8B.md/5095316069184.png"></p>
<h3 id="线程安全"><a href="#线程安全" class="headerlink" title="线程安全"></a>线程安全</h3><p>单线程的 JavaScript 保证了线程的绝对安全，不会单行同一个变量被多个线程读写从而造成崩溃，从而免去了在多线程开发中忘记对变量加锁或者解锁所造成的问题。</p>
<h3 id="单线程的异步非阻塞"><a href="#单线程的异步非阻塞" class="headerlink" title="单线程的异步非阻塞"></a>单线程的异步非阻塞</h3><p>Node.js 是一个单进程的，因此提供了一个 <code>libuv</code> 库来进行实现多进程，如在 <code>fs</code> 库中的多进程就通过 <code>libuv</code> 库进行实现，他主要提供了异步 I&#x2F;O 。</p>
<blockquote>
<p>虽然 node.js 是单线程异步非阻塞的，但在某一个情况下他采用的还是阻塞式的单线程</p>
</blockquote>
<h2 id="libuv"><a href="#libuv" class="headerlink" title="libuv"></a>libuv</h2><p><img src="https://49812933408852955071488026628034-1301075051.cos.ap-nanjing.myqcloud.com/javascript/node.js/16.node.js%20%E5%A4%9A%E7%BA%BF%E7%A8%8B.md/5724306626707.png"><br>libuv 是一个跨平台的 I&#x2F;O 库，用于实现和让 node.js 支持多线程，同时也被 <code>fs</code> 使用他主要提供事件循环（Event Loops）、文件系统（Filesystem）、网络支持（Networking）、线程（Threads）、进程（Process）以及其他工具（Utilities）</p>
<h2 id="Web-Worker-实现多进程"><a href="#Web-Worker-实现多进程" class="headerlink" title="Web Worker 实现多进程"></a>Web Worker 实现多进程</h2><p>实现多进程可以通过 Node API 中的 <code>child_process</code> ，所提供的 <code>fork</code> 方法来创建一个 Node.js 文件并将它作为 worker 文件，类似与 <code>express</code> 库:</p>
<h3 id="app-js"><a href="#app-js" class="headerlink" title="app.js"></a>app.js</h3><p>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> fork = <span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>).<span class="property">fork</span></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>()</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="keyword">function</span> (<span class="params">req,res</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> worker = <span class="title function_">fork</span>(<span class="string">&#x27;./work.js&#x27;</span>)  <span class="comment">// 创建进程</span></span><br><span class="line">    worker.<span class="title function_">on</span>(<span class="string">&#x27;message&#x27;</span>, <span class="keyword">function</span> (<span class="params">m</span>) &#123;     <span class="comment">// 接收计算结果</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&#x27;object&#x27;</span> === <span class="keyword">typeof</span> m &amp;&amp; m.<span class="property">type</span> == <span class="string">&#x27;fibo&#x27;</span>) &#123;</span><br><span class="line">            <span class="comment">// 发送关闭进程信号</span></span><br><span class="line">            worker.<span class="title function_">kill</span>()</span><br><span class="line">            res.<span class="title function_">send</span>(m.<span class="property">result</span>.<span class="title function_">toString</span>())   <span class="comment">// 返回结果</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    worker.<span class="title function_">send</span>(&#123;<span class="attr">type</span>:<span class="string">&#x27;fibo&#x27;</span>, <span class="attr">num</span>:~~req.<span class="property">query</span>.<span class="property">n</span> || <span class="number">1</span>&#125;)</span><br><span class="line">&#125;)</span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">8210</span>)</span><br></pre></td></tr></table></figure>

<p>其中 <code>worker.kill</code> 的用法是通过 work.js 中的 <code>process.on</code> 监听 <code>SIGHUP</code> 事件函数并通过 <code>process.exit</code> 从而使子进程推出的</p>
<h3 id="work-js"><a href="#work-js" class="headerlink" title="work.js"></a>work.js</h3><p>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义算法</span></span><br><span class="line"><span class="keyword">var</span> fibo = <span class="keyword">function</span> <span class="title function_">fibo</span>(<span class="params">n</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> n &gt; <span class="number">1</span> ? <span class="title function_">fibo</span>(n -<span class="number">1</span>) + <span class="title function_">fibo</span>(n -<span class="number">2</span>) :<span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 接受 app.js 主进程所发送的消息</span></span><br><span class="line">process.<span class="title function_">on</span>(<span class="string">&#x27;message&#x27;</span>, <span class="keyword">function</span> (<span class="params">m</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> m === <span class="string">&#x27;object&#x27;</span> &amp;&amp; m.<span class="title function_">type</span>() === <span class="string">&#x27;fibo&#x27;</span>) &#123;</span><br><span class="line">        <span class="comment">// 计算 fibo</span></span><br><span class="line">        <span class="keyword">var</span> num = <span class="title function_">fibo</span>(~~m.<span class="property">num</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 发送结果</span></span><br><span class="line">        process.<span class="title function_">send</span>(&#123;<span class="attr">type</span>:<span class="string">&#x27;fibo&#x27;</span>, <span class="attr">result</span>:num&#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 收到消息后进程退出</span></span><br><span class="line">process.<span class="title function_">on</span>(<span class="string">&#x27;SIGHUP&#x27;</span>,<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    process.<span class="title function_">exit</span>()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
	

	

</article>




	<article>
	
		<h1><a href="/2022/04/21/javascript/node/15.Node.js 异步 I-O/">Node.js 异步 I/O</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2022-04-21</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-none-link" href="/tags/javascript/" rel="tag">javascript</a> <a class="article__tag-none-link" href="/tags/node-js/" rel="tag">node.js</a>
			</span>
		
	</div>

	

	
		<p>Node 还有 异步&#x2F;IO、事件驱动、单线程等特点，其中 “单线程” 是指程序的主线程，也就是将所有阻塞的部分交给线程池进行处理，之后一个队列跟线程池进行协作。</p>
<p>对于 JavaScript Code 不再需要过多关注线程的问题，主要通过 <code>callback</code> 回调构成，当程序运行时主线开始不停的循环适中调用。</p>
<p>至于 node.js 所采用的单线程异步非阻塞模式，就是在异步非阻塞模式执行的过程中，I&#x2F;O 操作不会阻塞后面的程序执行或计算，当完成 I&#x2F;O 时，以事件的方式通知，继续执行。</p>
<h2 id="异步-I-x2F-O"><a href="#异步-I-x2F-O" class="headerlink" title="异步 I&#x2F;O"></a>异步 I&#x2F;O</h2><p>异步 I&#x2F;O 其实就是用户空间中的程序不用依赖内核空间中的 I&#x2F;O 即可操作完成并进行下一步操作，以同步作为对比来讲，假设两个任务的时间按分别为 <code>m</code> 和  <code>n</code>，如果程序采用同步的方式完成此操作则需要的任务时间为 <code>m+n</code>。</p>
<p>但如果是采用异步方式处理程序，则可以在两种 I&#x2F;O 并行的情况下完成任务的时间最大限度的不超过本身的处理最大限度，即同步完成任务的时间 <code>max(m,n)</code></p>
<h3 id="运行空间"><a href="#运行空间" class="headerlink" title="运行空间"></a>运行空间</h3><p>在操作系统中，程序的运行空间（又被称之为核心空间）主要分为内核空间（Kernel space）和用户空间，以 Linux 系统对自身进行划分为例，对于内核空间，是指对硬件设备具有访问权限，这个空间一部分核心软件独立于普通的应用程序，运行在最高或较高的权限级别中。</p>
<p>于此相对的还有一个用户空间（User space），在操作系统中，用户空间又被称之为 “虚拟内存” 或者 “使用者空间” 与核心空间共为运行空间中的两个区块</p>
<p>同样以 Linux 系统作为例子，除了对硬件设备具有访问的通常被称之为内核空间外，对于普通应用程序这部分的，就被称之为用户空间。</p>
<h3 id="必要性"><a href="#必要性" class="headerlink" title="必要性"></a>必要性</h3><p>以编程语言为例，为了设计的让应用程序调用方便，将程序设计为同步的 I&#x2F;O 模型，这就意味着程序中的后续任务都需要等待 I&#x2F;O 的完成。从而在等待的过程中无法充分的利用 CUP。</p>
<p>但为了充分利用 CPU 以使 I&#x2F;O 可以并行，可通过实现多线程、单线程以及单线成多进程来达到目的。</p>
<h4 id="多线程与单进程"><a href="#多线程与单进程" class="headerlink" title="多线程与单进程"></a>多线程与单进程</h4><p>多线程主要的设计理念就是为了共享在程序空间中实现并行处理任务，从而达到充分利用 CPU 空间的效果，但缺点就是在执行时上下文交换开销较大和同步的问题，但这样会让程序变得复杂化。</p>
<h4 id="单线程与多进程"><a href="#单线程与多进程" class="headerlink" title="单线程与多进程"></a>单线程与多进程</h4><p>此方法用于解决多线程与单进程使用的问题，有的语言为了单线程保持了调用的简单化和用户体验，采用多进程的方式来达到充分利用 CPU 和提升总体并行处理能力的行为，但缺点在于当应用程序稍微复杂时，因为业务逻辑无法分布多个进程之间，所以事物的处理能力较高。</p>
<p>但在设计程序时应该选择前者，后者相对与性能若后与前者，且没有优化的余地，而前者可以通过优化来解决开销较大和同步的问题。</p>
<p>还有一个非常主要的问题，在分布式系统或通过 API 方式来处理数据，因此数据的传递很难保持同步的状态，且干扰原因有很多，因此如果网络速度有边，则 <code>m</code> 和 <code>n</code> 的值都会变大，这时候同步的 I&#x2F;O 语言就会露出弱势。</p>
<p>在分布式系统场景下，异步 I&#x2F;O 将会体现出优势<code>max(m,n)</code> 的时间最大开销可以有效的缓解值增长所带来的问题。</p>
<h4 id="I-x2F-O-线程和状态"><a href="#I-x2F-O-线程和状态" class="headerlink" title="I&#x2F;O 线程和状态"></a>I&#x2F;O 线程和状态</h4><p>对于计算机内核 I&#x2F;O 而言，同步与异步是线程之间的关系，而阻塞、非阻塞则是对于某一个时刻中的一个状态，线程只能是阻塞或异步的状态，要么线程处于阻塞状态或非阻塞状态。</p>
<h5 id="I-x2F-O-的阻塞与非阻塞"><a href="#I-x2F-O-的阻塞与非阻塞" class="headerlink" title="I&#x2F;O 的阻塞与非阻塞"></a>I&#x2F;O 的阻塞与非阻塞</h5><p>阻塞模式的 I&#x2F;O 自如其名会造成应用程序的等待，直到阻塞完成，同时操作系统也将 I&#x2F;O 操作设置为非阻塞模式.</p>
<blockquote>
<p>在设置非阻塞模式时，可能在应用程序调用时没有拿到真正数据就返回了，为此需要多次调用才能确认 I&#x2F;O 操作完成</p>
</blockquote>
<h5 id="I-x2F-O-的同步和异步"><a href="#I-x2F-O-的同步和异步" class="headerlink" title="I&#x2F;O 的同步和异步"></a>I&#x2F;O 的同步和异步</h5><p>如果做阻塞的 I&#x2F;O 调用，应用程序的等待的调用完成的过程就是同步状态，反而 I&#x2F;O 为非阻塞模式时，应用程序将是异步的。</p>
<h2 id="异步-I-x2F-O-轮询"><a href="#异步-I-x2F-O-轮询" class="headerlink" title="异步 I&#x2F;O 轮询"></a>异步 I&#x2F;O 轮询</h2><p><img src="https://49812933408852955071488026628034-1301075051.cos.ap-nanjing.myqcloud.com/javascript/node.js/15.node.js%20%E5%BC%82%E6%AD%A5%20i-o%20at%20%E5%A4%9A%E7%BA%BF%E7%A8%8B.md/269531109182.png"></p>
<p>在进行非阻塞 I&#x2F;O 调用时，需要读到完整的数据，应用程序需要多次进行论寻，才可确保读取数据的完成，并进行下一步操作</p>
<blockquote>
<p>缺点在于应用程序需要主动调用，会造成占用较多的 CUP 时间片，性能较为低下</p>
</blockquote>
<h3 id="read"><a href="#read" class="headerlink" title="read"></a>read</h3><p>read 论寻技术用于同步非阻塞 I&#x2F;O 模型，每次论需只能获取一个 I&#x2F;O 操作对应的状态，轮询操作由用户进行负责，可通过 <code>read()</code> 系统调用，即用户线程需要在一定间隔内非阻塞的持续发起论寻请求来获取 I&#x2F;O 操作当前状态，所以他是由用户所负责的。</p>
<p>虽然用户线程不会被阻塞，但他需要被不停的触发来引起系统调用，直到用户数据可用为止，因此他是一个较为原始且性能较低（含数据吞吐量较低）且想对于阻塞式系统调用，消耗了额外的 CPU 资源。</p>
<h3 id="I-x2F-O-多路复用"><a href="#I-x2F-O-多路复用" class="headerlink" title="I&#x2F;O 多路复用"></a>I&#x2F;O 多路复用</h3><p>I&#x2F;O 多路复用（I&#x2F;O Multiplexing）是为实现和满足用户线程不需要进行不停的轮询，以避免消耗额外的 CPU资源，同时在数据就绪时，用户线程处于休眠状态（sleep）。</p>
<p>而当一个或多个文件描述符对应的 I&#x2F;O 操作数据准备完成时，用户线程将会被唤醒来处理这些 I&#x2F;O 操作，目前包括 select、poll、epoll 等都是采用多路服用技术来提高性能。</p>
<blockquote>
<p>文件描述符是一个非负整数，实际上是一个索引值，指向内核为没一个进程所维护的该进程打开文件的记录表，当程序打开一个现有的文件爱你或创建新文件时，该内核向进程返回一个文件描述符。</p>
</blockquote>
<h4 id="select"><a href="#select" class="headerlink" title="select"></a>select</h4><p>select 是一种 read 改进方案，也是一种 I&#x2F;O 多路复用模型，通过对文件描述符上的事件状态来判断。可以让内核在多个文件描述符对应的 I&#x2F;O 操作中任何一个完成或经过指定时间后唤醒（wake）并通知用户线程。</p>
<blockquote>
<p>在唤醒之前用户线程因为被阻塞而处于休眠状态。</p>
</blockquote>
<h4 id="poll"><a href="#poll" class="headerlink" title="poll"></a>poll</h4><p>poll 是 select 基础之上进行的改进，并改善了不需要的检查，但相对与文件描述符较多的时候，性能还是较为底下的，通过 poll 实现的轮询与 select 较为相似，但性能和限制都有所改善。</p>
<h4 id="epoll"><a href="#epoll" class="headerlink" title="epoll"></a>epoll</h4><p>epool 为解决 select 和 poll 中每一次检查监听的文件描述符变化时，都需要遍历一次用户传入的描述符集合，当文件描述符较多时，一次集合的遍历时间会非常耗时的问题。</p>
<p>为了解决这个问题，epool 在 select 和 poll 上的基础进行优化在 Linux kernel 2.6 中引入了 epoll（event poll）方法，他将文件描述符的检测和真正的检测进行了分离。</p>
<p>从实现的角度上来说 epoll 会创建一个 epoll 实例，之后 epoll 实例会床将一个对应的文件描述符（这个 epoll 实例中包含了文件描述符的集合，被称之为了 <code>epoll set</code> \ <code>interest list</code>）。</p>
<p>集合中存储了所有希望被监听的文件描述符，当某个描述符对应的 I&#x2F;O 操作时，文件描述符又会被放入 <code>ready list</code> 中</p>
<blockquote>
<p>ready list 是 epoll set 的子集</p>
</blockquote>
<h4 id="kqueue-IOCP-event-ports"><a href="#kqueue-IOCP-event-ports" class="headerlink" title="kqueue\IOCP\event ports"></a>kqueue\IOCP\event ports</h4><h5 id="kqueue"><a href="#kqueue" class="headerlink" title="kqueue"></a>kqueue</h5><p>kqueue 方法实现与 epoll 类似，不过他仅仅在 FreeBSD 系统下存在，但 macOS 也会使用</p>
<h5 id="IOCP"><a href="#IOCP" class="headerlink" title="IOCP"></a>IOCP</h5><p>IOCP 方法相当与 Windows 下的 epoll</p>
<h5 id="event-ports"><a href="#event-ports" class="headerlink" title="event ports"></a>event ports</h5><p>event ports 相当与 Solaris 下的 epoll</p>

	

	

</article>




	<article>
	
		<h1><a href="/2022/04/21/javascript/node/14.Node.js console at debug/">Node.js console at debug</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2022-04-21</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-none-link" href="/tags/javascript/" rel="tag">javascript</a> <a class="article__tag-none-link" href="/tags/node-js/" rel="tag">node.js</a>
			</span>
		
	</div>

	

	
		<h2 id="console-API"><a href="#console-API" class="headerlink" title="console API"></a>console API</h2><h3 id="log-error-info-warn"><a href="#log-error-info-warn" class="headerlink" title="log\error\info\warn"></a>log\error\info\warn</h3><p>Node 主要提供了四种常用的 API，其中主要分为 <code>console.log</code> 、<code>console.error</code>、<code>console.info</code>、<code>console.warn</code> 等&#x2F;14.Node.js%20console%20at%20debug.html)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    log: hey</span></span><br><span class="line"><span class="comment">    log: hey world</span></span><br><span class="line"><span class="comment">    log: hey world</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    error: hey</span></span><br><span class="line"><span class="comment">    error: hey error</span></span><br><span class="line"><span class="comment">    error: hey error</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    info: hey</span></span><br><span class="line"><span class="comment">    info: world</span></span><br><span class="line"><span class="comment">    info: world</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    warn: hey</span></span><br><span class="line"><span class="comment">    warn: hey error</span></span><br><span class="line"><span class="comment">    warn: hey error</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;log: hey&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;log: hey&#x27;</span>, <span class="string">&#x27;world&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;log: hey %s&#x27;</span>, <span class="string">&#x27;world&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;error: hey&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;error: hey&#x27;</span>, <span class="string">&#x27;error&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;error: hey %s&#x27;</span>, <span class="string">&#x27;error&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">info</span>(<span class="string">&#x27;info: hey&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">info</span>(<span class="string">&#x27;info: world&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">info</span>(<span class="string">&#x27;info: %s&#x27;</span>,<span class="string">&#x27;world&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;warn: hey&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;warn: hey&#x27;</span>, <span class="string">&#x27;error&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;warn: hey %s&#x27;</span>, <span class="string">&#x27;error&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>在这 <code>console.log</code> 同等于  <code>console.error</code> 、<code>console.info</code>、<code>console.warn</code> 等 API，当然可根据不同的场景和语法结构使用响应的方法。</p>
<h3 id="console-time-at-timeEnd"><a href="#console-time-at-timeEnd" class="headerlink" title="console.time at timeEnd"></a>console.time at timeEnd</h3><p>通常 <code>console.time</code> 和 <code>console.timeEnd</code> 将用于评估 <code>time</code> 和 <code>timeEnd</code> 两点之间的时间差（单位为：毫秒）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// timeLabel: 0.069ms</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">time</span>(<span class="string">&#x27;timeLabel&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">timeEnd</span>(<span class="string">&#x27;timeLabel&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="console-assert"><a href="#console-assert" class="headerlink" title="console.assert"></a>console.assert</h3><p>该 API 方法主要使用其 <code>console.assert</code> 进行断言（assertion），而断言主要是一种放在程序中的一阶逻辑，也就是结果为真或假的逻辑判断式。目的是为了表示与验证程序预期的结果，当程序运行到断言位置时，对应断言应为 <code>true</code>，假设程序终止并给出错误信息。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    Assertion failed: start wrong</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">assert</span>(<span class="literal">true</span>,<span class="string">&#x27;start&#x27;</span>,<span class="string">&#x27;wrong&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">assert</span>(<span class="literal">false</span>,<span class="string">&#x27;start&#x27;</span>,<span class="string">&#x27;wrong&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>或者直接通过异常进行处理：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Assertion failed: error</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">assert</span>(<span class="literal">false</span>,<span class="string">&#x27;error&#x27;</span>)</span><br><span class="line">&#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(e.<span class="property">message</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="console-trace"><a href="#console-trace" class="headerlink" title="console.trace"></a>console.trace</h3><p>这主要用于将字符串打印到 stderr（标准错误）中，然后以 <code>util.format()</code> 格式的消息和代码到当前的位置堆栈跟踪</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    Trace: This will output one end of the error stack</span></span><br><span class="line"><span class="comment">        at Object.&lt;anonymous&gt; (/home/kunlun/Development/Web/Demo/node/app.js:1:9)</span></span><br><span class="line"><span class="comment">        at Module._compile (internal/modules/cjs/loader.js:1072:14)</span></span><br><span class="line"><span class="comment">        at Object.Module._extensions..js (internal/modules/cjs/loader.js:1101:10)</span></span><br><span class="line"><span class="comment">        at Module.load (internal/modules/cjs/loader.js:937:32)</span></span><br><span class="line"><span class="comment">        at Function.Module._load (internal/modules/cjs/loader.js:778:12)</span></span><br><span class="line"><span class="comment">        at Function.executeUserEntryPoint [as runMain] (internal/modules/run_main.js:76:12)</span></span><br><span class="line"><span class="comment">        at internal/main/run_main_module.js:17:47</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">trace</span>(<span class="string">&#x27;This will output one end of the error stack&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="console-dir"><a href="#console-dir" class="headerlink" title="console.dir"></a>console.dir</h3><p>该方法主要用于深层次的打印，其中可以通过 <code>depth</code> 进行深层次的打印层级。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> obj = &#123;</span><br><span class="line">    <span class="attr">data</span>: &#123;</span><br><span class="line">        <span class="attr">main</span>: &#123;</span><br><span class="line">            <span class="attr">info</span>: &#123;</span><br><span class="line">                <span class="attr">hey</span>: <span class="string">&#x27;hey.dir&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    &#123; data: &#123; main: &#123; info: [Object] &#125; &#125; &#125;</span></span><br><span class="line"><span class="comment">    &#123;</span></span><br><span class="line"><span class="comment">      data: &#123; main: &#123; info: &#123; hey: &#x27;hey.dir&#x27; &#125; &#125; &#125;</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">dir</span>(obj)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">dir</span>(obj, &#123;<span class="attr">depth</span>:<span class="number">3</span>&#125;)</span><br></pre></td></tr></table></figure>


<h2 id="自定义-stdout"><a href="#自定义-stdout" class="headerlink" title="自定义 stdout"></a>自定义 stdout</h2><p>自定义 stdocut 即标准输出，基于 <code>console.Console</code> 将数据输出到指定的文件中，当然这其中会使用到 <code>fs</code> 模块。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> file = fs.<span class="title function_">createWriteStream</span>(<span class="string">&#x27;desfile.txt&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> logger = <span class="keyword">new</span> <span class="variable language_">console</span>.<span class="title class_">Console</span>(file, file);</span><br><span class="line">logger.<span class="title function_">log</span>(<span class="string">&#x27;hello,world&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>当运行之后，通过 <code>logger.log</code> 的内容数据将会直接写入到 <code>fs.createWriteStream</code> 方法中的 <code>path</code> 参数路径中。</p>
<blockquote>
<p>desfile.txt：“hello,world”</p>
</blockquote>
<h2 id="debug"><a href="#debug" class="headerlink" title="debug"></a>debug</h2><p>对于日志的调试，可以通过 <code>console.log</code> 输出调试日志，由于 <code>console.log</code> 可以支持服务端以及浏览器中使用，且非常的简洁易用，因此这种方法对日志的调试很好。</p>
<p>在开发中由于需要调试就需要多个 <code>console.log</code> 进行输出，之后上传到服务端中又注释 <code>console.log</code>，因此这就是一个加注释和去注释的过程。</p>
<p>但由于上述方法太过于低效，因此 <code>debug</code> 库就可以实现控制输出的调试，他主要的作用就是判断 <code>DEBUG</code> 环境变量，来调整程序的运行环境即可控制日志的是否输出，但他最为核心的还是对 <code>DEBUG</code> 环境变量进行解析，允许开发者选性的控制输出日志。</p>
<h3 id="project"><a href="#project" class="headerlink" title="project"></a>project</h3><h4 id="app-js"><a href="#app-js" class="headerlink" title="app.js"></a>app.js</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> debug = <span class="built_in">require</span>(<span class="string">&#x27;debug&#x27;</span>)(<span class="string">&#x27;http&#x27;</span>)</span><br><span class="line">    , http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    $ DEBUG=worker:* node app.js</span></span><br><span class="line"><span class="comment">      worker:a This is worka +0ms</span></span><br><span class="line"><span class="comment">      worker:b This is workb +0ms</span></span><br><span class="line"><span class="comment">      worker:a This is worka +239ms</span></span><br><span class="line"><span class="comment">      worker:a This is worka +40ms</span></span><br><span class="line"><span class="comment">    $ DEBUG=worker:a node app.js</span></span><br><span class="line"><span class="comment">      worker:a This is worka +0ms</span></span><br><span class="line"><span class="comment">      worker:a This is worka +260ms</span></span><br><span class="line"><span class="comment">      worker:a This is worka +42ms</span></span><br><span class="line"><span class="comment">    $ DEBUG=worker:b node app.js</span></span><br><span class="line"><span class="comment">      worker:b This is workb +0ms</span></span><br><span class="line"><span class="comment">      worker:b This is workb +1s</span></span><br><span class="line"><span class="comment">      worker:b This is workb +976ms</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">http.<span class="title function_">createServer</span>(<span class="keyword">function</span>(<span class="params">req, res</span>)&#123;</span><br><span class="line">    <span class="title function_">debug</span>(req.<span class="property">method</span> + <span class="string">&#x27; &#x27;</span> + req.<span class="property">url</span>);</span><br><span class="line">    res.<span class="title function_">end</span>(<span class="string">&#x27;hello\n&#x27;</span>);</span><br><span class="line">&#125;).<span class="title function_">listen</span>(<span class="number">3000</span>, <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title function_">debug</span>(<span class="string">&#x27;listening&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 引入 console.log 工厂</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&#x27;./worker&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h4 id="worker-js"><a href="#worker-js" class="headerlink" title="worker.js"></a>worker.js</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">var a = require(&#x27;debug&#x27;)(&#x27;worker:a&#x27;)</span><br><span class="line">    , b = require(&#x27;debug&#x27;)(&#x27;worker:b&#x27;);</span><br><span class="line"></span><br><span class="line">function work() &#123;</span><br><span class="line">    a(&#x27;doing lots of uninteresting work&#x27;);</span><br><span class="line">    setTimeout(work, Math.random() * 1000);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">work();</span><br><span class="line"></span><br><span class="line">function workb() &#123;</span><br><span class="line">    b(&#x27;doing some work&#x27;);</span><br><span class="line">    setTimeout(workb, Math.random() * 2000);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">workb();</span><br></pre></td></tr></table></figure>


<h3 id="条件的定义"><a href="#条件的定义" class="headerlink" title="条件的定义"></a>条件的定义</h3><p>有些方法和事件可以通过 <code>--conditions flag</code> 进行使用，但同样可以在 <code>debug</code> 下进行引入参数，来实现对生产环境日志开启条件，在本地环境下开启日志：</p>
<table>
<thead>
<tr>
<th>Id</th>
<th>Name</th>
<th>Info</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>browser(浏览器)</td>
<td>任何环境，实现了 Web 浏览器中 JavaScript 所提供的全局浏览器 API</td>
</tr>
<tr>
<td>2</td>
<td>development(开发环境&#x2F;本地环境)</td>
<td>可用于开发环境入口点，必须始终不与生产环境互斥</td>
</tr>
<tr>
<td>3</td>
<td>production(生产环境)</td>
<td>用于定义生产环经的切入点，并与本地&#x2F;开发环境互斥</td>
</tr>
</tbody></table>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> _ = <span class="built_in">require</span>(<span class="string">&#x27;lodash&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> debug = <span class="built_in">require</span>(<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> debugA = <span class="title function_">debug</span>(<span class="string">&#x27;A:&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> debugB = <span class="title function_">debug</span>(<span class="string">&#x27;B:&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">$ DEBUG=A: NODE_ENV=production node app.js</span></span><br><span class="line"><span class="comment">  A: hey,world! +0ms</span></span><br><span class="line"><span class="comment">$ DEBUG=B: NODE_ENV=production node app.js</span></span><br><span class="line"><span class="comment">  B: I am new to debug +0ms</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> === <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">    debugA.<span class="property">enable</span> = <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">debugA</span>(<span class="string">&#x27;hey,world!&#x27;</span>)</span><br><span class="line"><span class="title function_">debugB</span>(<span class="string">&#x27;I am new to debug&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="命名空间"><a href="#命名空间" class="headerlink" title="命名空间"></a>命名空间</h4><p>Node debug 支持对日志进行分类打印以及命名空间及通佩符，在下文中 <code>DEBUG=ap*</code> 表示将所有以 <code>ap</code> 为开头的调试日志都将会被打印</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> debug = <span class="built_in">require</span>(<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"><span class="keyword">var</span> appDebug = <span class="title function_">debug</span>(<span class="string">&#x27;app&#x27;</span>)</span><br><span class="line"><span class="keyword">var</span> apiDebug = <span class="title function_">debug</span>(<span class="string">&#x27;api&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">$ DEBUG=api node app.js</span></span><br><span class="line"><span class="comment">  api hey,ApiDebug +0ms</span></span><br><span class="line"><span class="comment">$ DEBUG=app node app.js</span></span><br><span class="line"><span class="comment">  app hey,AppDebug +0ms</span></span><br><span class="line"><span class="comment">$ DEBUG=app,api node app.js</span></span><br><span class="line"><span class="comment">  app hey,AppDebug +0ms</span></span><br><span class="line"><span class="comment">  api hey,ApiDebug +0ms</span></span><br><span class="line"><span class="comment">$ DEBUG=ap* node app.js</span></span><br><span class="line"><span class="comment">  app hey,AppDebug +0ms</span></span><br><span class="line"><span class="comment">  api hey,ApiDebug +0ms</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">appDebug</span>(<span class="string">&#x27;hey,AppDebug&#x27;</span>)</span><br><span class="line"><span class="title function_">apiDebug</span>(<span class="string">&#x27;hey,ApiDebug&#x27;</span>)</span><br></pre></td></tr></table></figure>

	

	

</article>




	<article>
	
		<h1><a href="/2022/04/21/javascript/node/13.Node events 事件触发器/">Node events 事件触发器</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2022-04-21</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-none-link" href="/tags/javascript/" rel="tag">javascript</a> <a class="article__tag-none-link" href="/tags/node-js/" rel="tag">node.js</a>
			</span>
		
	</div>

	

	
		<p>Node 是一个主要通过 API 使用异步事件模型的 I&#x2F;O 操作，某些类型对象或触发器周期的触发一个命名事件到 <strong>事件队列</strong>，如 <code>net.Server</code> 对象在每次连接时出发一个事件，以及 <code>fs.readStream</code> 对象在文件打开时也触发一个事件。</p>
<p>在这些过程中，所有能产生事件的对象都是 <code>events.EventEmitter</code> 实例，其中 events 模块中就只提供了一个 <code>events.EventEmitter</code> 对象，因此 EventEmitter 的核心就是事件的触发和事件的监听功能的封装。</p>
<h2 id="注册事件-amp-监听器"><a href="#注册事件-amp-监听器" class="headerlink" title="注册事件 &amp; 监听器"></a>注册事件 &amp; 监听器</h2><p>通过 <code>event.emit</code> 对象创建一个 <code>some_event</code> 对象，并在 3000ms 后触发该事件，然后通过 <code>event.on</code> 来触发该事件，此时 <code>event.on</code> 将是一个监听事件触发的作用。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">EventEmitter</span> = <span class="built_in">require</span>(<span class="string">&#x27;events&#x27;</span>).<span class="property">EventEmitter</span></span><br><span class="line"><span class="keyword">const</span> event = <span class="keyword">new</span> <span class="title class_">EventEmitter</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用 some_event 对象时触发回调</span></span><br><span class="line">event.<span class="title function_">on</span>(<span class="string">&#x27;some_event&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;some_event 事件触发&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3000ms 后向 &quot;event&quot; 对象发送事件 &quot;some_event&quot;</span></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    event.<span class="title function_">emit</span>(<span class="string">&#x27;some_event&#x27;</span>)</span><br><span class="line">&#125;,<span class="number">3000</span>)</span><br></pre></td></tr></table></figure>

<p>除此之外，EventEmitter 的每个事件由一个事件名和诺干的参数组成，事件名则是一个字符串形式，这通常表示一定的语义，对于每个事件、EventEmitter 还提供了一个支持多个事件的监听器，当该事件触发时，事件的监听器依次都会被调用，事件的参数会作为回调参数传递。</p>
<blockquote>
<p>对于多个事件，当事件被触发时将会依次被输出</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> events = <span class="built_in">require</span>(<span class="string">&#x27;events&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> emitter = <span class="keyword">new</span> events.<span class="title class_">EventEmitter</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    some_event1 参数1 参数2</span></span><br><span class="line"><span class="comment">    some_event2 参数1 参数2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">emitter.<span class="title function_">on</span>(<span class="string">&#x27;some_event&#x27;</span>, <span class="keyword">function</span> (<span class="params">args1,args2</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;some_event1&#x27;</span>, args1, args2)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">emitter.<span class="title function_">on</span>(<span class="string">&#x27;some_event&#x27;</span>, <span class="keyword">function</span> (<span class="params">args1,args2</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;some_event2&#x27;</span>, args1, args2)</span><br><span class="line">&#125;)</span><br><span class="line">emitter.<span class="title function_">emit</span>(<span class="string">&#x27;some_event&#x27;</span>, <span class="string">&#x27;参数1&#x27;</span>,<span class="string">&#x27;参数2&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="this"><a href="#this" class="headerlink" title="this"></a>this</h2><p>emit 方法允许为监听器传入任意参数，之后事件监听器中的 <code>this</code> 方法将会用于输出当前的事件属性和传入的方法等。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> events = <span class="built_in">require</span>(<span class="string">&#x27;events&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> eventEmitter = <span class="keyword">new</span> events.<span class="property">EventEmitter</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    some_event</span></span><br><span class="line"><span class="comment">    a b EventEmitter &#123;</span></span><br><span class="line"><span class="comment">      _events: [Object: null prototype] &#123; some_event: [Function (anonymous)] &#125;,</span></span><br><span class="line"><span class="comment">      _eventsCount: 1,</span></span><br><span class="line"><span class="comment">      _maxListeners: undefined,</span></span><br><span class="line"><span class="comment">      [Symbol(kCapture)]: false</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">eventEmitter.<span class="title function_">on</span>(<span class="string">&#x27;some_event&#x27;</span>, <span class="keyword">function</span> (<span class="params">a,b</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;some_event&#x27;</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(a,b, <span class="variable language_">this</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">eventEmitter.<span class="title function_">emit</span>(<span class="string">&#x27;some_event&#x27;</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;b&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="on-at-once"><a href="#on-at-once" class="headerlink" title="on at once"></a>on at once</h2><p>在 <code>event</code> 中，监听事件的方法可以通过 <code>on</code> 和 <code>once</code> 进行实现，两者的主要区别是后者只可以监听单次的 <code>listener</code> 函数，当下次在触发事件时，将会移出此监听器</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> event = <span class="built_in">require</span>(<span class="string">&#x27;events&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> eventEmitter = <span class="keyword">new</span> event.<span class="property">EventEmitter</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    eventEmitter some_event</span></span><br><span class="line"><span class="comment">    eventEmitter some_event</span></span><br><span class="line"><span class="comment">    eventEmitter someEvent</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">eventEmitter.<span class="title function_">on</span>(<span class="string">&#x27;some_event&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;eventEmitter some_event&#x27;</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">eventEmitter.<span class="title function_">emit</span>(<span class="string">&#x27;some_event&#x27;</span>)</span><br><span class="line">eventEmitter.<span class="title function_">emit</span>(<span class="string">&#x27;some_event&#x27;</span>)</span><br><span class="line"></span><br><span class="line">eventEmitter.<span class="title function_">once</span>(<span class="string">&#x27;someEvent&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;eventEmitter someEvent&#x27;</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">eventEmitter.<span class="title function_">emit</span>(<span class="string">&#x27;someEvent&#x27;</span>)</span><br><span class="line">eventEmitter.<span class="title function_">emit</span>(<span class="string">&#x27;someEvent&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="添加-x2F-移出监听器事件"><a href="#添加-x2F-移出监听器事件" class="headerlink" title="添加&#x2F;移出监听器事件"></a>添加&#x2F;移出监听器事件</h2><p>通过 <code>once</code> 创建一个事件，且侦听 <code>start</code> 事件，并通过 <code>eventEmitter.emit</code> 方法来进行调用此方法，因此输出的是 <code>netListener</code> 和 <code>start</code> 事件。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> events = <span class="built_in">require</span>(<span class="string">&#x27;events&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> eventEmitter = <span class="keyword">new</span> events.<span class="property">EventEmitter</span></span><br><span class="line"></span><br><span class="line">eventEmitter.<span class="title function_">once</span>(<span class="string">&#x27;newListener&#x27;</span>, <span class="keyword">function</span> (<span class="params">event, listener</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (event == <span class="string">&#x27;start&#x27;</span>) &#123;</span><br><span class="line">        eventEmitter.<span class="title function_">on</span>(<span class="string">&#x27;start&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;start 2&#x27;</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;start&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">eventEmitter.<span class="title function_">on</span>(<span class="string">&#x27;start&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;eventEmitter start&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用事件</span></span><br><span class="line">eventEmitter.<span class="title function_">emit</span>(<span class="string">&#x27;start&#x27;</span>)</span><br></pre></td></tr></table></figure>

	

	

</article>




	<article>
	
		<h1><a href="/2022/04/21/javascript/node/12.Node stream/">Node stream</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2022-04-21</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-none-link" href="/tags/javascript/" rel="tag">javascript</a> <a class="article__tag-none-link" href="/tags/node-js/" rel="tag">node.js</a>
			</span>
		
	</div>

	

	
		<p>流（Stream）是一种传输手段，其核心含义是指一个有始有终的数据传输结构，这通常是文件打开 -&gt; 关闭的过程，在 Node.js 中分为四个基本的流类型，分别为：</p>
<table>
<thead>
<tr>
<th>Id</th>
<th>Name</th>
<th>Info</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>Writable</td>
<td>可写入流（<code>fs.createWriteStream()</code>）</td>
</tr>
<tr>
<td>2</td>
<td>Readable</td>
<td>读取流 (<code>fs.createReadStream()</code>)</td>
</tr>
<tr>
<td>4</td>
<td>Duplex</td>
<td>可读流 (<code>net.Socket</code>)</td>
</tr>
<tr>
<td>4</td>
<td>Transorm</td>
<td>在读写的过程中可以修改和变换数据的可读写流（Duplex，<code>zlib.createDeflate()</code>）</td>
</tr>
</tbody></table>
<blockquote>
<p>对于体积较大的二进制文件，如音频、视频文件或以 GB 为单位来衡量大小的，则会容易造成 <strong>爆仓</strong> ，为避免爆仓的发生，读取体积大的文件应使用读一部分写一部分的方式进行。</p>
</blockquote>
<h2 id="Readable"><a href="#Readable" class="headerlink" title="Readable"></a>Readable</h2><p>对于 node 的可读取留，即通过 <code>fs.createReadStream</code> 方法创建一个读取流，其参数大多数可通过 <a target="_blank" rel="noopener" href="https://ks.jiangxue.team/2021/09/01/Node-js-File-System/">Node.js File System
</a> 进行参考，在这其中 <code>highWaterMark</code> 参数主要的作用是内部读取缓存区大小，这将在某些情况下，需要触发底层可读留机制的刷新，从而不消耗任何数据。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    Stream in open</span></span><br><span class="line"><span class="comment">    file data =&gt;  This is desfile.txt</span></span><br><span class="line"><span class="comment">    Stream in end</span></span><br><span class="line"><span class="comment">    Stream in close</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> rs = fs.<span class="title function_">createReadStream</span>(<span class="string">&#x27;desfile.txt&#x27;</span>,&#123;</span><br><span class="line">    <span class="attr">flags</span>: <span class="string">&#x27;r&#x27;</span>,</span><br><span class="line">    <span class="attr">mode</span>: <span class="number">0o666</span>, <span class="comment">// https://www.xuchao.org/docs/freebsd/permissions.html</span></span><br><span class="line">    <span class="attr">encoding</span>: <span class="string">&#x27;utf-8&#x27;</span>,</span><br><span class="line">    <span class="attr">start</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">end</span>: <span class="number">19</span>,</span><br><span class="line">    <span class="attr">highWaterMark</span>: <span class="number">1</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">rs.<span class="title function_">on</span>(<span class="string">&#x27;open&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Stream in open&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">rs.<span class="title function_">setEncoding</span>(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将可读流传出 data 事件</span></span><br><span class="line">rs.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="keyword">function</span> (<span class="params">data</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;file data =&gt; &#x27;</span>,data)</span><br><span class="line">    rs.<span class="title function_">pause</span>()  <span class="comment">// 切出流模式</span></span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        rs.<span class="title function_">resume</span>() <span class="comment">// 恢复流模式</span></span><br><span class="line">    &#125;, <span class="number">2000</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">rs.<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Stream in error&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">rs.<span class="title function_">on</span>(<span class="string">&#x27;end&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Stream in end&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">rs.<span class="title function_">on</span>(<span class="string">&#x27;close&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Stream in close&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>之后根据其 Stream 流程 open -&gt; data -&gt; error -&gt; end -&gt; close ，其中在监听 <code>data</code> 事件中，就可读取文件的内容并输出数据，边度边输的模式，这将会不停的通过 <code>data</code> 读取数据、触发 <code>data</code> 后再次读取。</p>
<p>在这个过程中主要的不是将文件的整体内容读取并输出，而是通过 <code>fs.createReadStream</code> 方法所设置的缓存区，大小默认为 64KB（这可通过 <code>highWaterMark</code> 参数进行设置）</p>
<h2 id="Writable"><a href="#Writable" class="headerlink" title="Writable"></a>Writable</h2><p>可写流（Writable Stream），主要通过使用 <code>fs.createWriteStream()</code> 方法进行创建，并通过 <code>ws.write</code> 进行写入，并当 <code>end</code> 事件后后使用 <code>finish</code> 事件来回调方法。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"><span class="keyword">var</span> ws = fs.<span class="title function_">createWriteStream</span>(<span class="string">&#x27;desfile.txt&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">flags</span>: <span class="string">&#x27;w&#x27;</span>,</span><br><span class="line">    <span class="attr">mode</span>: <span class="number">0o666</span>,</span><br><span class="line">    <span class="attr">start</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">highWaterMark</span>: <span class="number">1</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打开流</span></span><br><span class="line">ws.<span class="title function_">on</span>(<span class="string">&#x27;open&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Stream in open&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 写入流</span></span><br><span class="line">ws.<span class="title function_">write</span>(<span class="string">&#x27;hey,fs.createWriteStream()&#x27;</span>,<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 关闭流</span></span><br><span class="line">ws.<span class="title function_">on</span>(<span class="string">&#x27;close&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Stream in close&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 结束流</span></span><br><span class="line">ws.<span class="title function_">end</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 当 end 事件后且以刷新所有底层系统，则触发回调</span></span><br><span class="line">ws.<span class="title function_">on</span>(<span class="string">&#x27;finish&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Stream in end&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="管道流"><a href="#管道流" class="headerlink" title="管道流"></a>管道流</h2><p>管道流提供了一个输出和输入流的机制，这最为常用到的场景就是获取一个流的数据并写入另一个流当中。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"><span class="keyword">var</span> rs = fs.<span class="title function_">createReadStream</span>(<span class="string">&#x27;befile.txt&#x27;</span>)</span><br><span class="line"><span class="keyword">var</span> ws = fs.<span class="title function_">createWriteStream</span>(<span class="string">&#x27;desfile.txt&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rs.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="keyword">function</span> (<span class="params">chunk</span>) &#123;</span><br><span class="line">    ws.<span class="title function_">write</span>(chunk)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>或者通过其 <code>rs.pipe()</code> 方法，将可读流写到可写流当中，并触发 <code>pipe</code> 事件:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"><span class="keyword">var</span> rs = fs.<span class="title function_">createReadStream</span>(<span class="string">&#x27;befile.txt&#x27;</span>)</span><br><span class="line"><span class="keyword">var</span> ws = fs.<span class="title function_">createWriteStream</span>(<span class="string">&#x27;desfile.txt&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rs.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="keyword">function</span> (<span class="params">chunk</span>) &#123;</span><br><span class="line">    ws.<span class="title function_">write</span>(chunk)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

	

	

</article>




	<article>
	
		<h1><a href="/2022/04/21/javascript/node/11.Node.js Websocket/">Node.js Websocket</a></h1>
	
	<div class="article__infos">
		<span class="article__date">2022-04-21</span><br />
		
		
			<span class="article__tags">
			  	<a class="article__tag-none-link" href="/tags/javascript/" rel="tag">javascript</a> <a class="article__tag-none-link" href="/tags/node-js/" rel="tag">node.js</a>
			</span>
		
	</div>

	

	
		<p>Websocket 是从 HTML 5 开始所提供的一种浏览器与服务器之间的全双工通信网络技术，与 即WebSocket 协议在 HTML 5 上的实施，该协议可在 TCP 连接上进行全双工通信，该协议在 2111 年由 IETF 开始标准化为 <code>RFC6455</code>。</p>
<blockquote>
<p>双工（duplex）</p>
<blockquote>
<p>双工被分为 <strong>全双工（full-duplex）</strong> 或 <strong>半双工（half-duplex）</strong>，其中半双工的系统允许两台设备之间的双向资料的传输（但不能同时进行），若另一方需要发送，则需要等先前发送的消息处理完成后即可发送。</p>
<p>全双工（full-duplex）即允许两台设备之间同时进行双向的消息传输。</p>
<blockquote>
<p>频分双工（FDD，Frequency-Division Duplexing）通过频率分割多任务技术来分割发送和接收的信号，上传和下载区段之间所使用的 <strong>频率偏移（Frequency offset）</strong> 来分隔。</p>
</blockquote>
</blockquote>
</blockquote>
<blockquote>
<p>WebSocket 协议支持客户端之间的双向通信，在此之前，创建一个双向的 Web 应用程序客户端和服务器之间进行通信，需要通过 HTTP 论寻，同时以不同的方式发送上游通知 HTTP 调用。</p>
<p>于是一个更简单的解决方法就是单个 TCP 链接，两个方向的交通使用 WebSocket 协议进行提供，因此他代替了 HTTP 论寻的替代方法到远程服务器，实际上 WebSocket 协议旨在取代现有的使用 HTTP 作为传输的双向通信技术。</p>
</blockquote>
<h2 id="new-WebSocket-Server"><a href="#new-WebSocket-Server" class="headerlink" title="new WebSocket.Server"></a>new WebSocket.Server</h2><p><img src="https://49812933408852955071488026628034-1301075051.cos.ap-nanjing.myqcloud.com/javascript/node.js/11.node.js%20websocket.md/5079918269178.png"></p>
<h3 id="Server"><a href="#Server" class="headerlink" title="Server"></a>Server</h3><p>Node 所提供的 <code>ws</code>  (WebSocket,ws)，可通过 <code>new WebSocket.Server</code> 方法创建一个新的服务器实例，之后在通过其事件与方法来实现服务端。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">WebSocket</span> = <span class="built_in">require</span>(<span class="string">&#x27;ws&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = <span class="keyword">new</span> <span class="title class_">WebSocket</span>.<span class="title class_">Server</span>(&#123;</span><br><span class="line">    <span class="attr">port</span>:<span class="number">8210</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 当服务关闭时所返回的数据</span></span><br><span class="line">server.<span class="title function_">on</span>(<span class="string">&#x27;close&#x27;</span>, <span class="keyword">function</span> <span class="title function_">close</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Server close&quot;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听新的请求时返回回调函数</span></span><br><span class="line">server.<span class="title function_">on</span>(<span class="string">&#x27;connection&#x27;</span>, <span class="keyword">function</span> <span class="title function_">connection</span>(<span class="params">ws,req</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> ip = req.<span class="property">connection</span>.<span class="property">remoteAddress</span></span><br><span class="line">    <span class="keyword">const</span> port = req.<span class="property">connection</span>.<span class="property">remotePort</span></span><br><span class="line">    <span class="keyword">const</span> name = ip + port;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`%s is connected`</span>, name)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发送欢迎消息</span></span><br><span class="line">    ws.<span class="title function_">send</span>(<span class="string">&#x27;Welcome&#x27;</span> + name)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 服务器接收到消息时回调</span></span><br><span class="line">    ws.<span class="title function_">on</span>(<span class="string">&#x27;message&#x27;</span>, <span class="keyword">function</span> <span class="title function_">incoming</span>(<span class="params">message</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;received: %s from %s&#x27;</span>, message, name)</span><br><span class="line"></span><br><span class="line">        server.<span class="property">clients</span>.<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">client</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (client.<span class="property">readyState</span> === <span class="title class_">WebSocket</span>.<span class="property">OPEN</span>) &#123;</span><br><span class="line">                client.<span class="title function_">send</span>( name + <span class="string">&quot; -&gt; &quot;</span> + message);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">&lt;!<span class="variable constant_">DOCTYPE</span> html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;title&gt;WebSocket&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">    var socket</span><br><span class="line">    if (!window.WebSocket) &#123;</span><br><span class="line">        // Firefox 6.0 之前，部分引擎会认为 WebSocket 对象是错误的，因此被重命名为</span><br><span class="line">        // &quot;MozWebSocket&quot;</span><br><span class="line">        window.WebSocket = window.MozWebSocket</span><br><span class="line">    &#125;</span><br><span class="line">    if (window.WebSocket) &#123;</span><br><span class="line">        socket = new WebSocket(&quot;ws://localhost:8210/ws&quot;)</span><br><span class="line"></span><br><span class="line">        // 从服务器中接受到消息时回调</span><br><span class="line">        socket.onmessage = function (event) &#123;</span><br><span class="line">            var ta = document.getElementById(&#x27;responseText&#x27;)</span><br><span class="line">            ta.value = ta.value + &#x27;\n&#x27; + event.data</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 打开时回调</span><br><span class="line">        socket.onopen = function (event) &#123;</span><br><span class="line">            var ta = document.getElementById(&#x27;responseText&#x27;)</span><br><span class="line">            ta.value = &quot;链接开启&quot;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 关闭时回调</span><br><span class="line">        socket.onclose = function (event) &#123;</span><br><span class="line">            var ta = document.getElementById(&#x27;responseText&#x27;)</span><br><span class="line">            ta.value = ta.value + &quot;服务关闭&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        alert(&quot;浏览器不支持 WebSocket&quot;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 发送消息</span><br><span class="line">    function send(message) &#123;</span><br><span class="line">        if (!window.WebSocket) &#123;</span><br><span class="line">            return</span><br><span class="line">        &#125;</span><br><span class="line">        if (socket.readyState == WebSocket.OPEN) &#123;</span><br><span class="line">            socket.send(message)</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            alert(&quot;链接暂未开启&quot;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;form onsubmit=&quot;return false;&quot;&gt;</span><br><span class="line">    &lt;textarea id=&quot;responseText&quot;&gt;&lt;/textarea&gt;</span><br><span class="line">    &lt;br&gt;</span><br><span class="line">    &lt;input type=&quot;text&quot; name=&quot;message&quot; style=&quot;width: 300px&quot; value=&quot;Welcome&quot;&gt;</span><br><span class="line">    &lt;input type=&quot;button&quot; value=&quot;发送消息&quot; onclick=&quot;send(this.form.message.value)&quot;&gt;</span><br><span class="line">    &lt;input type=&quot;button&quot; onclick=&quot;javascript:document.getElementById(&#x27;responseText&#x27;).value=&#x27;&#x27;&quot; value=&quot;清空聊天记录&quot;&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>之后可以在其服务端和客户端中查看到发送的消息，这主要通过 <code>send</code> 方法来进行发送，但前提条件是浏览器支持 <code> WebSocket</code> 方法才可适用。</p>

	

	

</article>





	<span class="different-posts">📖 <a href="/page/6">more posts</a> 📖</span>



	</main>

	<footer class="footer">
	<div class="footer-content">
		
	      <div class="footer__element">
	<p>欢迎来到我的 blog <br><br> 通过 <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>+<a target="_blank" rel="noopener" href="https://github.com/HoverBaum/meilidu-hexo">MeiliDu</a> 进行构建的，存放在 <a target="_blank" rel="noopener" href="https://github.com/vendanges/vendanges.github.io">Github</a> 上。</p>
</div>

	    
	      <div class="footer__element">
	<h5>Check out</h5>
	<ul class="footer-links">
		<li class="footer-links__link"><a href="/archives">Archive</a></li>
		
		  <li class="footer-links__link"><a href="/atom.xml">RSS</a></li>
	    
		<li class="footer-links__link"><a href="/about">about page</a></li>
		<li class="footer-links__link"><a href="/tags">Tags</a></li>
		<li class="footer-links__link"><a href="/categories">Categories</a></li>
	</ul>
</div>

	    

		<div class="footer-credit">
			<span>© 2022 John Doe | Powered by <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> | Theme <a target="_blank" rel="noopener" href="https://github.com/HoverBaum/meilidu-hexo">MeiliDu</a></span>
		</div>

	</div>


</footer>



</body>

</html>
